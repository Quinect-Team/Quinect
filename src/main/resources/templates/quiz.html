<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="_csrf" th:content="${_csrf.token}">
	<meta name="_csrf_header" th:content="${_csrf.headerName}">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ÌÄ¥Ï¶à ÌíÄÏù¥</title>
	<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap" rel="stylesheet">
	<link th:href="@{/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet" type="text/css" />
	<link th:href="@{/css/sb-admin-2.css}" rel="stylesheet" />
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

	<style>
		* {
			font-family: 'Fredoka', sans-serif;
		}

		.quiz-header {
			background: linear-gradient(135deg, #1cc88a 0%, #20c9a6 100%);
			color: white;
		}

		.progress-bar-quiz {
			height: 6px;
			background: rgba(255, 255, 255, .3);
			border-radius: 3px;
		}

		.progress-fill {
			height: 100%;
			background: white;
			transition: width .3s ease;
			border-radius: 3px;
		}

		.question-text {
			font-size: 28px;
			font-weight: bold;
			color: #3a3b45;
			margin-bottom: 15px;
			line-height: 1.6;
		}

		.question-image {
			max-width: 100%;
			max-height: 300px;
			margin: 15px 0;
			border-radius: 10px;
		}

		.answer-textarea {
			font-family: 'Fredoka', sans-serif;
			min-height: 120px;
			border: 2px solid #e9ecef;
			border-radius: 10px;
			padding: 10px;
			font-size: 18px;
		}

		.answer-textarea:focus {
			border-color: #1cc88a;
			box-shadow: 0 0 10px rgba(28, 200, 138, .2);
			outline: none;
		}

		/* Ìèº Ï≤¥ÌÅ¨ Î†àÏù¥Î∏î ÌÅ¨Í∏∞ Ï°∞Ï†à */
		.form-check-label {
			font-size: 18px !important;
			margin-bottom: 0;
			cursor: pointer;
		}

		/* ÎùºÎîîÏò§ Î≤ÑÌäº ÌÅ¨Í∏∞ */
		.form-check-input {
			width: 22px;
			height: 22px;
			margin-top: 2px;
			cursor: pointer;
		}

		/* Î∞∞ÏßÄ ÌÅ¨Í∏∞ */
		.badge {
			font-size: 14px;
			padding: 8px 12px;
			line-height: 1.4;
		}



		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		.spinner {
			border: 4px solid #f3f3f3;
			border-top: 4px solid #1cc88a;
			border-radius: 50%;
			width: 40px;
			height: 40px;
			animation: spin 1s linear infinite;
			margin: 0 auto 15px;
		}

		.autosave-indicator {
			font-size: 13px;
			color: #6c757d;
			margin-top: 5px;
		}

		.autosave-indicator.saved {
			color: #1cc88a;
		}
	</style>
</head>

<body class="bg-gradient-success" th:attr="data-room-code=${roomCode},
         data-total-questions=${totalQuestions},
         data-user-id=${currentUser != null ? currentUser.id : 0}">

	<div class="container-fluid py-4">
		<div class="d-flex justify-content-between align-items-center mb-3">

			<a class="d-flex align-items-center text-decoration-none">
				<div class="rotate-n-15">
					<img src="/img/app_icon.png" style="width: 40px; height: 40px;">
				</div>
				<div class="mx-2 font-weight-bold text-white"
					style="font-size: 2.3rem; font-family: 'Fredoka', sans-serif;">
					Quinect
				</div>
			</a>

			<!-- Ïó¨Í∏∞Îã§Í∞Ä ÏûëÏóÖÌïòÏãúÎ©¥ Îê©ÎãàÎã§ ÎÇòÍ∞ÄÎäîÍ±∞ -->
			<a th:href="@{/}" class="text-decoration-none d-flex flex-column align-items-center"
				onclick="return confirm('Ï†ïÎßê ÌÄ¥Ï¶àÏóêÏÑú ÎÇòÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?');"
				onmouseover="this.querySelector('i').classList.replace('fa-door-closed', 'fa-door-open')"
				onmouseout="this.querySelector('i').classList.replace('fa-door-open', 'fa-do„Öâor-closed')">

				<i class="fas fa-door-closed text-white" style="font-size: 1.8rem"></i>

				<span class="text-white small font-weight-bold mt-1">ÎÇòÍ∞ÄÍ∏∞</span>
			</a>

		</div>
		<!-- Ìó§Îçî -->
		<div class="card shadow mb-4 quiz-header">
			<div class="card-body p-4">
				<div class="d-flex justify-content-between align-items-center mb-3">
					<div>
						<span class="text-white-50">üîë Î∞© ÏΩîÎìú:</span>
						<span class="h4 font-weight-bold" th:text="${roomCode}">ABCD</span>
					</div>
					<div class="text-white font-weight-bold fs-5">
						Î¨∏Ï†ú <span id="current-question">1</span> / <span th:text="${totalQuestions}"></span>
					</div>
				</div>
				<div class="progress-bar-quiz">
					<div class="progress-fill" id="progress-bar" style="width: 0%;"></div>
				</div>
			</div>
		</div>

		<!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
		<div class="row">
			<!-- Î¨∏Ï†ú ÏòÅÏó≠ -->
			<div class="col-lg-8">
				<div class="card shadow mb-4">
					<div id="error-message" class="alert alert-danger m-3" role="alert" style="display: none;"></div>

					<div id="loading-state" class="card-body text-center py-5">
						<div class="spinner"></div>
						<p class="text-muted mt-3 fs-5">Î¨∏Ï†úÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
					</div>

					<div id="question-area" class="card-body" style="display: none;">
						<div class="mb-4">
							<div class="question-text" id="question-text"></div>
							<img id="question-image" class="question-image" style="display: none;" src="" alt="Î¨∏Ï†ú Ïù¥ÎØ∏ÏßÄ">
							<span class="badge badge-success px-3 py-2" id="point-badge"
								style="font-size: 15px;"></span>
						</div>

						<div id="options-container" style="display: none;"></div>

						<div id="textarea-container" style="display: none;" class="mb-4">
							<textarea id="answer-textarea" class="form-control answer-textarea"
								placeholder="ÎãµÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
							<div class="autosave-indicator" id="autosave-status">ÏûÑÏãú Ï†ÄÏû• Ï§ë...</div>
						</div>

						<div class="text-right mt-4">
							<button class="btn btn-success btn-lg fs-5" id="submit-btn" onclick="submitAnswer()"
								style="font-size: 18px; padding: 12px 30px;">
								<i class="fas fa-paper-plane"></i> Ï†úÏ∂ú
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ -->
			<div class="col-lg-4">
				<div class="card shadow mb-4" id="ranking-container" style="display: none;">
					<div class="card-header bg-info py-3">
						<h6 class="m-0 font-weight-bold text-white fs-5">
							<i class="fas fa-chart-bar mr-2"></i>Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ
						</h6>
					</div>
					<div class="card-body p-3">
						<div id="ranking-list"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script th:src="@{/vendor/jquery/jquery.min.js}"></script>
	<script th:src="@{/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>

	<script th:inline="javascript">
		var roomCode = document.body.getAttribute('data-room-code');
		var totalQuestions = parseInt(document.body.getAttribute('data-total-questions'));
		var currentQuestionData = null;
		var userId = parseInt(document.body.getAttribute('data-user-id'));
		var stompClient = null;
		let autosaveTimer = null;

		function getAnswerValue() {
			if (!currentQuestionData) return null;
			if (currentQuestionData.quizTypeCode === 2) {
				const selected = document.querySelector('input[name="answer"]:checked');
				return selected ? selected.value : null;
			} else {
				return document.getElementById('answer-textarea').value;
			}
		}

		function debounceAutoSave() {
			if (autosaveTimer) clearTimeout(autosaveTimer);
			const indicator = document.getElementById('autosave-status');
			if (indicator) indicator.textContent = 'ÏûÑÏãú Ï†ÄÏû• Ï§ë...';

			autosaveTimer = setTimeout(() => {
				const answer = getAnswerValue();
				if (answer) {
					const key = `quiz_temp_${roomCode}_q${currentQuestionData.questionId}`;
					const data = {roomCode, questionId: currentQuestionData.questionId, answer: answer, timestamp: new Date().toISOString()};
					localStorage.setItem(key, JSON.stringify(data));
					if (indicator) {
						indicator.textContent = '‚úì ÏûêÎèô Ï†ÄÏû•Îê®';
						indicator.classList.add('saved');
						setTimeout(() => indicator.classList.remove('saved'), 2000);
					}
				}
			}, 500);
		}

		function attachAutoSaveEvents() {
			document.querySelectorAll('textarea').forEach(el => {
				el.removeEventListener('input', debounceAutoSave);
				el.removeEventListener('change', debounceAutoSave);
				el.addEventListener('input', debounceAutoSave);
				el.addEventListener('change', debounceAutoSave);
			});

			document.querySelectorAll('input[type="radio"][name="answer"]').forEach(el => {
				el.removeEventListener('change', debounceAutoSave);
				el.addEventListener('change', debounceAutoSave);
			});
		}

		function autoRestoreIfExists() {
			if (!currentQuestionData) return;
			const key = `quiz_temp_${roomCode}_q${currentQuestionData.questionId}`;
			const saved = localStorage.getItem(key);
			if (!saved) return;

			try {
				const data = JSON.parse(saved);
				if (currentQuestionData.quizTypeCode === 2) {
					const radio = document.querySelector(`input[name="answer"][value="${data.answer}"]`);
					if (radio) radio.checked = true;
				} else {
					document.getElementById('answer-textarea').value = data.answer || '';
				}
			} catch (e) {
				console.warn('[autosave] ÏûÑÏãúÎ≥∏ ÌååÏã± Ïã§Ìå®', e);
			}
		}

		function connectWebSocket() {
			var socket = new SockJS('/ws');
			stompClient = Stomp.over(socket);
			stompClient.connect({}, function (frame) {
				stompClient.subscribe('/topic/quiz/' + roomCode, function (message) {
					var data = JSON.parse(message.body);
					if (data.type === 'QUESTION') displayQuestion(data);
					else if (data.type === 'RANKING') displayRanking(data.ranking);
					else if (data.type === 'FINISH') finishQuiz();
				});
				stompClient.send('/app/quiz/next-question/' + roomCode, {}, {});
			});
		}

		function displayQuestion(question) {
			currentQuestionData = question;
			document.getElementById('loading-state').style.display = 'none';
			document.getElementById('question-area').style.display = 'block';
			document.getElementById('ranking-container').style.display = 'block';

			document.getElementById('current-question').textContent = question.questionNumber;
			document.getElementById('progress-bar').style.width = (question.questionNumber / totalQuestions * 100) + '%';
			document.getElementById('question-text').textContent = question.questionText;
			document.getElementById('point-badge').textContent = question.point + 'Ï†ê';

			if (question.imageUrl) {
				var img = document.getElementById('question-image');
				img.src = question.imageUrl;
				img.style.display = 'block';
			} else {
				document.getElementById('question-image').style.display = 'none';
			}

			if (question.quizTypeCode === 2) {
				document.getElementById('options-container').style.display = 'block';
				document.getElementById('textarea-container').style.display = 'none';
				displayMultipleChoice(question.options);
			} else if (question.quizTypeCode === 1) {
				document.getElementById('options-container').style.display = 'none';
				document.getElementById('textarea-container').style.display = 'block';
				document.getElementById('answer-textarea').value = '';
			}

			document.getElementById('error-message').style.display = 'none';
			autoRestoreIfExists();
			attachAutoSaveEvents();
		}

		function displayMultipleChoice(options) {
			var container = document.getElementById('options-container');
			container.innerHTML = '';

			if (!Array.isArray(options) || options.length === 0) {
				container.innerHTML = '<p class="text-danger fs-5">Í∞ùÍ¥ÄÏãù Î≥¥Í∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
				return;
			}

			options.forEach(function (option) {
				var optionHtml = `
		            <div class="mb-3">
		                <div class="option-box p-3 border rounded" 
		                     data-option="${option.optionNumber}"
		                     style="border: 2px solid #e9ecef; cursor: pointer; transition: all 0.2s ease; background-color: #fff;">
		                    <input type="radio" name="answer" 
		                           id="option${option.optionNumber}" 
		                           value="${option.optionNumber}"
		                           style="display: none;">
		                    <label style="cursor: pointer; display: flex; align-items: center; margin: 0; width: 100%;">
		                        <span class="badge badge-success px-3 py-2" style="font-size: 15px; min-width: 50px;">${option.optionNumber}</span>
		                        <span style="margin-left: 10px; font-size: 18px;">${option.optionText}</span>
		                    </label>
		                </div>
		            </div>
		        `;
				container.innerHTML += optionHtml;
			});

			// ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
			document.querySelectorAll('.option-box').forEach(box => {
				box.addEventListener('click', function () {
					const optionNum = this.getAttribute('data-option');
					const radio = document.getElementById(`option${optionNum}`);
					radio.checked = true;

					// Î™®Îì† Î∞ïÏä§Ïùò Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî
					document.querySelectorAll('.option-box').forEach(b => {
						b.style.borderColor = '#e9ecef';
						b.style.backgroundColor = '#fff';
					});

					// ÏÑ†ÌÉùÎêú Î∞ïÏä§ Í∞ïÏ°∞
					this.style.borderColor = '#1cc88a';
					this.style.backgroundColor = '#f0fff4';

					// ÏûêÎèô Ï†ÄÏû•
					debounceAutoSave();
				});
			});

			attachAutoSaveEvents();
		}


		function submitAnswer() {
			if (!currentQuestionData) return;
			var answer = getAnswerValue();

			if (!answer) {
				showError('ÎãµÏùÑ ÏÑ†ÌÉù/ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
				return;
			}

			document.getElementById('submit-btn').disabled = true;

			var payload = {
				userId: userId,
				questionId: currentQuestionData.questionId,
				selectedOption: currentQuestionData.quizTypeCode === 2 ? parseInt(answer) : null,
				textAnswer: currentQuestionData.quizTypeCode === 1 ? answer : null
			};

			stompClient.send('/app/quiz/answer/' + roomCode, {}, JSON.stringify(payload));

			const key = `quiz_temp_${roomCode}_q${currentQuestionData.questionId}`;
			localStorage.removeItem(key);

			setTimeout(function () {
				document.getElementById('submit-btn').disabled = false;
			}, 1000);
		}

		function displayRanking(ranking) {
			if (!ranking || ranking.length === 0) return;

			var rankingHtml = '';
			ranking.forEach(function (player) {
				rankingHtml += `
                    <div class="d-flex justify-content-between align-items-center pb-3 border-bottom">
                        <span class="badge badge-pill badge-success px-3 py-2" style="font-size: 14px;">${player.rank}</span>
                        <span class="font-weight-500 fs-6">${player.nickname}</span>
                        <span class="badge badge-success px-3 py-2" style="font-size: 14px;">${player.score || 0}Ï†ê</span>
                    </div>
                `;
			});

			document.getElementById('ranking-list').innerHTML = rankingHtml;
		}

		function finishQuiz() {
			alert('ÌÄ¥Ï¶àÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');
			window.location.href = '/quiz-result/' + roomCode;
		}

		function showError(message) {
			var errorDiv = document.getElementById('error-message');
			errorDiv.textContent = message;
			errorDiv.style.display = 'block';
			setTimeout(() => {errorDiv.style.display = 'none';}, 3000);
		}

		window.addEventListener('load', function () {connectWebSocket();});
		window.addEventListener('beforeunload', function () {
			if (stompClient && stompClient.connected) {
				stompClient.disconnect();
			}
		});
	</script>
</body>

</html>