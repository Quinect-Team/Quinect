<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í€´ì¦ˆ ëŒ€ê¸°ì‹¤</title>
    <link th:href="@{/css/sb-admin-2.css}" rel="stylesheet"/>
    <link th:href="@{/css/waitroom.css}" rel="stylesheet"/>
    <link th:href="@{/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet" type="text/css" />
	<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap" rel="stylesheet">
    <style>
        .draggable-participant {
            background-color: #007bff;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: move;
            user-select: none;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin: 5px;
        }

        .draggable-participant:hover {
            opacity: 0.8;
        }

        .team-box {
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            min-height: 150px;
            background-color: #f8f9fa;
        }

        .team-box.drag-over {
            background-color: #e9ecef;
            border-color: #007bff;
            border-width: 2px;
        }

        .team-member {
            background-color: #28a745;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            white-space: nowrap;
        }

        .gap-2 {
            gap: 8px;
        }
    </style>

    <script th:src="@{/vendor/jquery/jquery.min.js}"></script>
    <script th:src="@{/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/vendor/jquery-easing/jquery.easing.min.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

	<script th:inline="javascript">
	    // ========== 1ë‹¨ê³„: ëª¨ë“  ë³€ìˆ˜ ì„ ì–¸ ==========
	    var roomCode = /*[[${room.roomCode}]]*/ 'ABCD';
	    var username = /*[[${guestNickname}]]*/ 'Guest';
	    var isRoomMaster = /*[[${isRoomMaster}]]*/ false;
	    
	    var currentVoteId = null;
	    var currentVoteChoice = null;
	    var voteResults = { AGREE: 0, DISAGREE: 0 };
	    
	    var participants = [];
	    var teamAssignment = {};
	    var currentTeamMode = null;
	    var currentTeamCount = 0;

	    // ========== 2ë‹¨ê³„: WebSocket ì„¤ì • ==========
	    var socket = new SockJS('/ws');
	    var stompClient = Stomp.over(socket);

	    stompClient.connect({}, function(frame) {
	        console.log('Connected: ' + frame);
	        
	        var savedChats = JSON.parse(localStorage.getItem('chatMessages_' + roomCode) || '[]');
	        savedChats.forEach(function(chat) {
	            displayMessage(chat.sender, chat.content);
	        });

	        var savedVote = localStorage.getItem('currentVote_' + roomCode);
	        if (savedVote) {
	            var voteInfo = JSON.parse(savedVote);
	            currentVoteId = voteInfo.voteId;
	            
	            var savedResults = localStorage.getItem('voteResults_' + roomCode + '_' + voteInfo.voteId);
	            if (savedResults) {
	                voteResults = JSON.parse(savedResults);
	                displayVoteMessageInChat(voteInfo);
	            }
	        }

	        stompClient.subscribe('/topic/chat/' + roomCode, function(message) {
	            var msg = JSON.parse(message.body);
	            displayMessage(msg.sender, msg.content);
	        });

	        stompClient.subscribe('/topic/vote/' + roomCode, function(message) {
	            var voteData = JSON.parse(message.body);
	            handleVoteUpdate(voteData);
	        });

	        if (isRoomMaster) {
	            var voteBtnEl = document.getElementById('voteBtn');
	            if (voteBtnEl) {
	                voteBtnEl.style.display = 'inline-block';
	                voteBtnEl.onclick = function() {
	                    openCreateVoteModal();
	                };
	            }
	        }
			
			if (isRoomMaster) {
		        var teamSelectBtn = document.getElementById('teamSelectBtn');
		        if (teamSelectBtn) {
		            teamSelectBtn.style.display = 'inline-block';
		        }
		    } else {
		        var teamSelectBtn = document.getElementById('teamSelectBtn');
		        if (teamSelectBtn) {
		            teamSelectBtn.style.display = 'none';
		        }
		    }
	    }, function(error) {
	        console.error('Error: ' + error);
	    });

	    // ========== 3ë‹¨ê³„: ì±„íŒ… í•¨ìˆ˜ ==========
	    function displayMessage(sender, content) {
	        var messagesDiv = document.getElementById('messages');
	        var msgDiv = document.createElement('div');
	        msgDiv.innerHTML = '<strong>' + sender + ':</strong> ' + content;
	        msgDiv.style.padding = '8px';
	        msgDiv.style.marginBottom = '8px';
	        msgDiv.style.borderBottom = '1px solid #eee';
	        messagesDiv.appendChild(msgDiv);
	        messagesDiv.scrollTop = messagesDiv.scrollHeight;

	        var chatMessages = JSON.parse(localStorage.getItem('chatMessages_' + roomCode) || '[]');
	        chatMessages.push({
	            sender: sender,
	            content: content,
	            timestamp: new Date().getTime()
	        });
	        localStorage.setItem('chatMessages_' + roomCode, JSON.stringify(chatMessages));
	    }

	    function sendMessage() {
	        var input = document.getElementById('chat-input');
	        var text = input.value.trim();
	        if (text && stompClient.connected) {
	            var chatMessage = {
	                sender: username,
	                content: text
	            };
	            stompClient.send('/app/chat/' + roomCode, {}, JSON.stringify(chatMessage));
	            input.value = '';
	        }
	    }

	    function copyCode() {
	        var code = document.querySelector('.display-4').textContent;
	        navigator.clipboard.writeText(code)
	            .then(function() { alert("ë°© ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: " + code); });
	    }

	    // ========== 4ë‹¨ê³„: íˆ¬í‘œ í•¨ìˆ˜ ==========
	    function openCreateVoteModal() {
	        document.getElementById('voteTitle').value = '';
	        document.getElementById('voteContent').value = '';
	        $('#createVoteModal').modal('show');
	        document.getElementById('voteTitle').focus();
	    }

	    function submitVoteCreate() {
	        var title = document.getElementById('voteTitle').value.trim();
	        var content = document.getElementById('voteContent').value.trim();

	        if (!title) {
	            alert('íˆ¬í‘œ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
	            return;
	        }

	        if (stompClient.connected) {
	            var voteData = {
	                type: 'START',
	                voteId: Date.now(),
	                question: title,
	                description: content,
	                creator: username,
	                timestamp: new Date().getTime()
	            };

	            stompClient.send('/app/vote/start/' + roomCode, {}, JSON.stringify(voteData));
	            $('#createVoteModal').modal('hide');
	        } else {
	            alert('WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
	        }
	    }

	    function openParticipateVoteModal(voteId, question, description) {
	        currentVoteId = voteId;
	        currentVoteChoice = null;

	        document.querySelector('#voteQuestion h6').textContent = question;
	        document.getElementById('voteDescription').textContent = description || '';

	        document.querySelectorAll('.vote-agree-btn, .vote-disagree-btn').forEach(function(btn) {
	            btn.classList.remove('selected');
	        });

	        document.getElementById('voteResults').style.display = 'block';
	        updateVoteResults(voteResults);

	        $('#participateVoteModal').modal('show');
	    }

	    function submitVoteChoice(choice) {
	        if (choice === 'AGREE') {
	            document.querySelector('.vote-agree-btn').classList.add('selected');
	            document.querySelector('.vote-disagree-btn').classList.remove('selected');
	        } else {
	            document.querySelector('.vote-disagree-btn').classList.add('selected');
	            document.querySelector('.vote-agree-btn').classList.remove('selected');
	        }

	        currentVoteChoice = choice;

	        if (stompClient.connected) {
	            var voteSubmission = {
	                type: 'VOTE',
	                voteId: currentVoteId,
	                voter: username,
	                choice: choice,
	                timestamp: new Date().getTime()
	            };

	            stompClient.send('/app/vote/submit/' + roomCode, {}, JSON.stringify(voteSubmission));
	            localStorage.setItem('myVoteChoice_' + roomCode + '_' + currentVoteId, choice);
	        }
	    }

	    function displayVoteMessageInChat(voteData) {
	        var messagesDiv = document.getElementById('messages');
	        var msgDiv = document.createElement('div');
	        
	        msgDiv.className = 'vote-message';
	        msgDiv.innerHTML = '<div class="vote-message-title">ğŸ—³ï¸ ' + escapeHtml(voteData.question) + '</div>' +
	            (voteData.description ? '<div class="vote-message-desc">' + escapeHtml(voteData.description) + '</div>' : '') +
	            '<div class="vote-message-button" onclick="openParticipateVoteModal(' +
	            voteData.voteId + ', \'' + voteData.question.replace(/'/g, "\\'") + '\', \'' + 
	            (voteData.description || '').replace(/'/g, "\\'") + '\')">íˆ¬í‘œì— ì°¸ê°€í•˜ì„¸ìš” â†’</div>';
	        
	        messagesDiv.appendChild(msgDiv);
	        messagesDiv.scrollTop = messagesDiv.scrollHeight;
	    }

	    function handleVoteUpdate(voteData) {
	        console.log('íˆ¬í‘œ ì—…ë°ì´íŠ¸:', voteData);

	        if (voteData.type === 'START') {
	            displayVoteMessageInChat(voteData);
	            currentVoteId = voteData.voteId;
	            voteResults = { AGREE: 0, DISAGREE: 0 };
	            
	            localStorage.setItem('currentVote_' + roomCode, JSON.stringify({
	                voteId: voteData.voteId,
	                question: voteData.question,
	                description: voteData.description,
	                creator: voteData.creator
	            }));
	        } else if (voteData.type === 'UPDATE') {
	            updateVoteResults(voteData.results);
	            localStorage.setItem('voteResults_' + roomCode + '_' + voteData.voteId, JSON.stringify(voteData.results));
	        } else if (voteData.type === 'END') {
	            localStorage.removeItem('currentVote_' + roomCode);
	            localStorage.removeItem('voteResults_' + roomCode + '_' + currentVoteId);
	            localStorage.removeItem('myVoteChoice_' + roomCode + '_' + currentVoteId);
	            currentVoteId = null;
	        }
	    }

	    function updateVoteResults(results) {
	        voteResults = results;
	        var total = results.AGREE + results.DISAGREE || 1;
	        
	        var agreePercentage = ((results.AGREE / total) * 100).toFixed(1);
	        var disagreePercentage = ((results.DISAGREE / total) * 100).toFixed(1);

	        document.getElementById('agreeCount').textContent = results.AGREE + 'í‘œ';
	        document.getElementById('disagreeCount').textContent = results.DISAGREE + 'í‘œ';
	        
	        document.getElementById('agreeBar').style.width = agreePercentage + '%';
	        document.getElementById('agreePercent').textContent = agreePercentage + '%';
	        
	        document.getElementById('disagreeBar').style.width = disagreePercentage + '%';
	        document.getElementById('disagreePercent').textContent = disagreePercentage + '%';
	    }

	    function escapeHtml(text) {
	        var map = {
	            '&': '&amp;',
	            '<': '&lt;',
	            '>': '&gt;',
	            '"': '&quot;',
	            "'": '&#039;'
	        };
	        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
	    }

	    // ========== 5ë‹¨ê³„: íŒ€ ì„ íƒ í•¨ìˆ˜ ==========
	    function openTeamSelectModal() {
	        console.log('=== OPENING TEAM MODAL ===');
	        
	        participants = [];
	        teamAssignment = {};

	        var savedTeamAssignment = localStorage.getItem('teamAssignment_' + roomCode);
	        if (savedTeamAssignment) {
	            teamAssignment = JSON.parse(savedTeamAssignment);
	        }

	        var savedTeamMode = localStorage.getItem('teamMode_' + roomCode);
	        if (savedTeamMode) {
	            currentTeamMode = savedTeamMode;
	            currentTeamCount = parseInt(localStorage.getItem('teamCount_' + roomCode) || '0');
	        }

	        document.querySelectorAll('[data-user-id]').forEach(function(el) {
	            var userId = el.getAttribute('data-user-id');
	            var nicknameEl = el.querySelector('.font-weight-bold');
	            var nickname = nicknameEl ? nicknameEl.textContent : 'Unknown';
	            if (userId && nickname) {
	                participants.push({ id: parseInt(userId), nickname: nickname });
	            }
	        });

	        console.log('Participants:', participants);
	        initializeTeamModal();
	        $('#teamSelectModal').modal('show');
	    }

	    function initializeTeamModal() {
	        document.querySelectorAll('input[name="mode"]').forEach(function(el) { el.checked = false; });
	        document.querySelectorAll('input[name="teamCount"]').forEach(function(el) { el.checked = false; });

	        if (currentTeamMode) {
	            var modeEl = document.querySelector('input[name="mode"][value="' + currentTeamMode + '"]');
	            if (modeEl) modeEl.checked = true;
	            
	            if (currentTeamMode === 'TEAM') {
	                document.getElementById('teamCountDiv').style.display = 'block';
	                var countEl = document.querySelector('input[name="teamCount"][value="' + currentTeamCount + '"]');
	                if (countEl) countEl.checked = true;
	                setupDragDrop(currentTeamCount);
	                document.getElementById('dragDropArea').style.display = 'block';
	            }
	        }

	        document.querySelectorAll('input[name="mode"]').forEach(function(el) {
	            el.addEventListener('change', function() {
	                console.log('Mode changed to:', this.value);
	                currentTeamMode = this.value;
	                if (currentTeamMode === 'TEAM') {
	                    document.getElementById('teamCountDiv').style.display = 'block';
	                    document.getElementById('dragDropArea').style.display = 'none';
	                } else {
	                    document.getElementById('teamCountDiv').style.display = 'none';
	                    document.getElementById('dragDropArea').style.display = 'none';
	                    teamAssignment = {};
	                }
	            });
	        });

	        document.querySelectorAll('input[name="teamCount"]').forEach(function(el) {
	            el.addEventListener('change', function() {
	                console.log('Team count changed to:', this.value);
	                var teamCount = parseInt(this.value);
	                currentTeamCount = teamCount;
	                setupDragDrop(teamCount);
	                document.getElementById('dragDropArea').style.display = 'block';
	            });
	        });

	        renderUnassignedParticipants();
	    }

	    function renderUnassignedParticipants() {
	        var unassignedArea = document.getElementById('unassignedArea');
	        unassignedArea.innerHTML = '';

	        participants.forEach(function(participant) {
	            if (!teamAssignment[participant.id]) {
	                var participantEl = document.createElement('div');
	                participantEl.className = 'draggable-participant';
	                participantEl.draggable = true;
	                participantEl.setAttribute('data-user-id', participant.id);
	                participantEl.textContent = participant.nickname;

	                participantEl.addEventListener('dragstart', function(e) {
	                    e.dataTransfer.effectAllowed = 'move';
	                    e.dataTransfer.setData('userId', String(participant.id));
	                    console.log('ğŸ¯ DRAGSTART - userId:', participant.id);
	                });

	                participantEl.addEventListener('dragend', function(e) {
	                    console.log('ğŸ¯ DRAGEND');
	                });

	                unassignedArea.appendChild(participantEl);
	            }
	        });

	        console.log('Unassigned participants rendered');
	    }

	    function setupDragDrop(teamCount) {
	        console.log('Setting up drag drop for', teamCount, 'teams');
	        
	        var teamsContainer = document.getElementById('teamsContainer');
	        teamsContainer.innerHTML = '';

	        for (var i = 1; i <= teamCount; i++) {
	            var colDiv = document.createElement('div');
	            colDiv.className = 'col-md-6 mb-3';
	            
	            var teamBox = document.createElement('div');
	            teamBox.className = 'team-box';
	            teamBox.setAttribute('data-team-number', i);
	            teamBox.innerHTML = '<h6 class="font-weight-bold mb-3">íŒ€ ' + i + '</h6>' +
	                '<div class="team-members" data-team="' + i + '" style="min-height: 100px; padding: 10px; border: 2px dashed #ccc; border-radius: 6px;"></div>';
	            
	            colDiv.appendChild(teamBox);
	            teamsContainer.appendChild(colDiv);
	        }

	        document.querySelectorAll('.team-members').forEach(function(teamMembersDiv) {
	            var teamNum = teamMembersDiv.getAttribute('data-team');
	            console.log('Registering drop events for team', teamNum);

	            teamMembersDiv.addEventListener('dragover', function(e) {
	                e.preventDefault();
	                e.stopPropagation();
	                e.dataTransfer.dropEffect = 'move';
	                teamMembersDiv.closest('.team-box').classList.add('drag-over');
	                console.log('ğŸ”„ DRAGOVER - team:', teamNum);
	            });

	            teamMembersDiv.addEventListener('dragleave', function(e) {
	                e.stopPropagation();
	                teamMembersDiv.closest('.team-box').classList.remove('drag-over');
	            });

	            teamMembersDiv.addEventListener('drop', function(e) {
	                e.preventDefault();
	                e.stopPropagation();
	                
	                console.log('ğŸ’§ğŸ’§ğŸ’§ DROP EVENT FIRED ğŸ’§ğŸ’§ğŸ’§');
	                
	                var userId = e.dataTransfer.getData('userId');
	                var teamNumber = parseInt(teamMembersDiv.getAttribute('data-team'));

	                console.log('Drop data - userId:', userId, 'teamNumber:', teamNumber);

	                if (userId && teamNumber) {
	                    var userIdInt = parseInt(userId);
	                    teamAssignment[userIdInt] = teamNumber;
	                    console.log('âœ… Assigned userId', userIdInt, 'to team', teamNumber);
	                    console.log('Current assignments:', teamAssignment);
	                    
	                    renderTeamAssignment();
	                    renderUnassignedParticipants();
	                } else {
	                    console.log('âŒ Invalid userId or teamNumber');
	                }

	                teamMembersDiv.closest('.team-box').classList.remove('drag-over');
	            });
	        });

	        renderTeamAssignment();
	    }

	    function renderTeamAssignment() {
	        console.log('Rendering team assignments:', teamAssignment);
	        
	        document.querySelectorAll('.team-members').forEach(function(el) { el.innerHTML = ''; });

	        Object.keys(teamAssignment).forEach(function(userId) {
	            var teamNumber = teamAssignment[userId];
	            var participant = participants.find(function(p) { return p.id == userId; });

	            if (participant) {
	                var teamMemberEl = document.createElement('div');
	                teamMemberEl.className = 'team-member';
	                teamMemberEl.innerHTML = participant.nickname + ' <span class="ml-2" style="cursor:pointer; opacity:0.7; font-weight:bold;" onclick="removeFromTeam(' + userId + ')">âœ•</span>';

	                var targetTeam = document.querySelector('[data-team="' + teamNumber + '"]');
	                if (targetTeam) {
	                    targetTeam.appendChild(teamMemberEl);
	                }
	            }
	        });
	    }

	    function removeFromTeam(userId) {
	        console.log('Removing userId', userId, 'from teams');
	        delete teamAssignment[userId];
	        renderTeamAssignment();
	        renderUnassignedParticipants();
	    }
		
		// âœ… ì°¸ê°€ì ëª©ë¡ì— íŒ€ ì •ë³´ í‘œì‹œ
		function updateParticipantList() {
		    console.log('Updating participant list with team info');
		    
		    // ì €ì¥ëœ íŒ€ ì •ë³´ ë¡œë“œ
		    var savedTeamAssignment = localStorage.getItem('teamAssignment_' + roomCode);
		    var savedTeamNames = localStorage.getItem('teamNames_' + roomCode);
		    
		    if (!savedTeamAssignment || !savedTeamNames) {
		        console.log('No team assignment data found');
		        return;
		    }
		    
		    teamAssignment = JSON.parse(savedTeamAssignment);
		    var teamNames = JSON.parse(savedTeamNames);
		    
		    var participantCards = document.querySelectorAll('[data-user-id]');
		    
		    participantCards.forEach(function(card) {
		        var userId = parseInt(card.getAttribute('data-user-id'));
		        var teamNumber = teamAssignment[userId];
		        
		        // ê¸°ì¡´ íŒ€ ë°°ì§€ ì œê±°
		        var existingBadge = card.querySelector('.team-badge');
		        if (existingBadge) {
		            existingBadge.remove();
		        }
		        
		        // íŒ€ì´ ìˆìœ¼ë©´ ë°°ì§€ ì¶”ê°€
		        if (teamNumber && teamNames[teamNumber]) {
		            var badge = document.createElement('div');
		            badge.className = 'team-badge';
		            badge.style.cssText = 'position: absolute; top: 5px; right: 5px; background-color: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;';
		            badge.textContent = teamNames[teamNumber];
		            card.appendChild(badge);
		        }
		    });
		}


		function submitTeamAssignment() {
		    var mode = document.querySelector('input[name="mode"]:checked') ? 
		               document.querySelector('input[name="mode"]:checked').value : null;

		    if (!mode) {
		        alert('ê²Œì„ ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
		        return;
		    }

		    if (mode === 'TEAM') {
		        var teamCountEl = document.querySelector('input[name="teamCount"]:checked');
		        var teamCount = teamCountEl ? teamCountEl.value : null;
		        
		        if (!teamCount) {
		            alert('íŒ€ ê°œìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
		            return;
		        }

		        var unassignedCount = participants.length - Object.keys(teamAssignment).length;
		        if (unassignedCount > 0) {
		            alert('ëª¨ë“  ì°¸ê°€ìë¥¼ íŒ€ì— ë°°ì •í•´ì£¼ì„¸ìš”. (ë¯¸ë°°ì •: ' + unassignedCount + 'ëª…)');
		            return;
		        }

		        // âœ… íŒ€ ì´ë¦„ ìˆ˜ì§‘
		        var teamNames = {};
		        for (var i = 1; i <= parseInt(teamCount); i++) {
		            var teamNameInput = document.getElementById('teamName_' + i);
		            var teamName = teamNameInput ? teamNameInput.value.trim() : '';
		            teamNames[i] = teamName || ('íŒ€ ' + i);
		        }

		        localStorage.setItem('teamAssignment_' + roomCode, JSON.stringify(teamAssignment));
		        localStorage.setItem('teamMode_' + roomCode, 'TEAM');
		        localStorage.setItem('teamCount_' + roomCode, teamCount);
		        localStorage.setItem('teamNames_' + roomCode, JSON.stringify(teamNames));
		    } else {
		        localStorage.setItem('teamMode_' + roomCode, 'INDIVIDUAL');
		        localStorage.removeItem('teamAssignment_' + roomCode);
		        localStorage.removeItem('teamNames_' + roomCode);
		    }

		    alert('íŒ€ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
		    $('#teamSelectModal').modal('hide');
		    
		    // âœ… ì°¸ê°€ì ëª©ë¡ ì—…ë°ì´íŠ¸ (ì´ ë¶€ë¶„ ì¶”ê°€!)
		    updateParticipantList();
		}

	    // ========== 6ë‹¨ê³„: DOM ì¤€ë¹„ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ==========
	    document.addEventListener('DOMContentLoaded', function() {
	        var formEl = document.querySelector('form');
	        if (formEl) {
	            formEl.addEventListener('submit', function(e) {
	                e.preventDefault();
	                sendMessage();
	            });
	        }
	    });
	</script>

</head>

<body class="bg-gradient-success" 
th:attr="data-room-code=${room.roomCode},
           data-guest-nickname=${guestNickname},
           data-is-room-master=${isRoomMaster}">
<div class="container-fluid py-4">

    <!-- ìƒë‹¨ ì •ë³´ ì˜ì—­ -->
    <div class="row mb-3">
        <div class="col">
            <div class="card shadow border-left-success p-3 d-flex flex-row align-items-center">
                <h3 class="text-success mb-0 mr-4"><i class="fas fa-key"></i> ë°© ì½”ë“œ:</h3>
                <h1 class="display-4 font-weight-bold mr-3" th:text="${room.roomCode}">ABCD</h1>
                <button class="btn btn-outline-warning btn-sm ml-3" onclick="copyCode()"><i class="fas fa-copy"></i> ë³µì‚¬</button>
                <img th:if="${qrCodeBase64 != null}" th:src="'data:image/png;base64,' + ${qrCodeBase64}" alt="QR ì½”ë“œ" width="150" height="150"/>
                <span class="ml-auto pr-3 font-weight-bold">ë°© ìœ í˜•: <span th:text="${roomTypeName}">ê°ê´€ì‹</span></span>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸(ì°¸ê°€ì+ì±„íŒ…) -->
    <div class="row">
        <!-- ì°¸ê°€ì ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
        <div class="col-md-7">
            <div class="card shadow mb-4">
                <div class="card-header py-2 bg-info">
                    <h6 class="m-0 font-weight-bold text-white"><i class="fas fa-users"></i> ì°¸ê°€ì</h6>
                </div>
                <div class="card-body pb-1 d-flex flex-wrap">
                    <div class="card border-success m-2 text-center"
                         style="width: 114px; height: 180px; position: relative;"
                         th:each="user : ${participants}"
                         th:attr="data-user-id=${user.id}">
                        <div class="mt-2">
                            <img th:src="@{${user.avatarUrl}}" class="rounded-circle mb-2" width="55" height="55" alt="avatar">
                        </div>
                        <div class="font-weight-bold text-primary" th:text="${user.nickname}">ë‹‰ë„¤ì„</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì±„íŒ…ì°½ -->
        <div class="col-md-5">
            <div class="card shadow mb-4 h-100 d-flex flex-column">
                <div class="card-header py-2 bg-gradient-info">
                    <h6 class="m-0 font-weight-bold text-white"><i class="fas fa-comments"></i> ì±„íŒ…</h6>
                </div>
                <div class="card-body flex-fill px-2 py-2" id="messages" style="overflow-y:auto; height:260px;"></div>
                <div class="card-footer p-2 bg-light">
                    <form class="input-group mt-2" onsubmit="sendMessage(); return false;">
                        <input id="chat-input" type="text" class="form-control mr-2" placeholder="ë©”ì‹œì§€ ì…ë ¥" autocomplete="off" />
                        <button class="btn btn-warning font-weight-bold" type="submit">ì…ë ¥</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë²„íŠ¼ -->
    <div class="row mt-3">
        <div class="col text-right vote-btn-container">
            <button id="voteBtn" class="btn btn-danger btn-lg mr-2" style="display:none;" onclick="openCreateVoteModal()">
                <i class="fas fa-poll"></i> íˆ¬í‘œ ì‹œì‘
            </button>
            <button id="teamSelectBtn" class="btn btn-secondary btn-lg mr-2" onclick="openTeamSelectModal()">
				<i class="fas fa-users-cog"></i> íŒ€ ì„ íƒ
			</button>
            <button class="btn btn-primary btn-lg font-weight-bold"><i class="fas fa-flag-checkered"></i> READY</button>
        </div>
    </div>
</div>

<!-- ë°©ì¥ìš© íˆ¬í‘œ ì‹œì‘ ëª¨ë‹¬ -->
<div class="modal fade" id="createVoteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-poll"></i> íˆ¬í‘œ ë§Œë“¤ê¸°</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="voteTitle"><strong>íˆ¬í‘œ ì œëª©</strong></label>
                    <input type="text" class="form-control" id="voteTitle" placeholder="ì˜ˆ: ê²Œì„ ê·œì¹™ ë³€ê²½ì— ì°¬ì„±í•˜ë‚˜ìš”?" maxlength="100">
                </div>
                <div class="form-group">
                    <label for="voteContent"><strong>íˆ¬í‘œ ë‚´ìš© (ì„ íƒì‚¬í•­)</strong></label>
                    <textarea class="form-control" id="voteContent" rows="3" placeholder="íˆ¬í‘œì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-danger" onclick="submitVoteCreate()"><i class="fas fa-check"></i> íˆ¬í‘œ ì‹œì‘</button>
            </div>
        </div>
    </div>
</div>

<!-- ì‚¬ìš©ììš© íˆ¬í‘œ ì°¸ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="participateVoteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-poll"></i> íˆ¬í‘œ</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div id="voteQuestion" class="mb-3"><h6 class="font-weight-bold text-dark"></h6></div>
                <div id="voteDescription" class="mb-4 text-muted small"></div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary btn-lg btn-block vote-agree-btn" onclick="submitVoteChoice('AGREE')">
                            <i class="fas fa-check-circle"></i><br/><span>ì°¬ì„±</span>
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-danger btn-lg btn-block vote-disagree-btn" onclick="submitVoteChoice('DISAGREE')">
                            <i class="fas fa-times-circle"></i><br/><span>ë°˜ëŒ€</span>
                        </button>
                    </div>
                </div>

                <div id="voteResults" style="display:none;">
                    <hr>
                    <h6 class="font-weight-bold mb-3">ì‹¤ì‹œê°„ íˆ¬í‘œ ê²°ê³¼</h6>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-check-circle text-primary"></i> <strong>ì°¬ì„±</strong></span>
                            <span id="agreeCount" class="badge badge-primary">0í‘œ</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-primary" id="agreeBar" role="progressbar" style="width: 0%;"><span id="agreePercent">0%</span></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-times-circle text-danger"></i> <strong>ë°˜ëŒ€</strong></span>
                            <span id="disagreeCount" class="badge badge-danger">0í‘œ</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-danger" id="disagreeBar" role="progressbar" style="width: 0%;"><span id="disagreePercent">0%</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- íŒ€ ì„ íƒ ëª¨ë‹¬ -->
<div class="modal fade" id="teamSelectModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-users"></i> íŒ€ ì„ íƒ</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-4">
                    <label><strong>ê²Œì„ ëª¨ë“œ ì„ íƒ</strong></label>
                    <div class="btn-group btn-group-toggle d-flex" role="group">
                        <label class="btn btn-outline-primary flex-fill">
                            <input type="radio" name="mode" value="INDIVIDUAL" autocomplete="off"> ê°œì¸ì „
                        </label>
                        <label class="btn btn-outline-primary flex-fill">
                            <input type="radio" name="mode" value="TEAM" autocomplete="off"> ë‹¨ì²´ì „
                        </label>
                    </div>
                </div>

                <div class="form-group mb-4" id="teamCountDiv" style="display:none;">
                    <label><strong>íŒ€ ê°œìˆ˜ ì„ íƒ</strong></label>
                    <div class="btn-group btn-group-toggle d-flex" role="group">
                        <label class="btn btn-outline-info flex-fill">
                            <input type="radio" name="teamCount" value="2" autocomplete="off"> 2íŒ€
                        </label>
                        <label class="btn btn-outline-info flex-fill">
                            <input type="radio" name="teamCount" value="3" autocomplete="off"> 3íŒ€
                        </label>
                        <label class="btn btn-outline-info flex-fill">
                            <input type="radio" name="teamCount" value="4" autocomplete="off"> 4íŒ€
                        </label>
                    </div>
                </div>

                <div id="dragDropArea" style="display:none;">
                    <hr>
                    <h6 class="font-weight-bold mb-3">ì°¸ê°€ìë¥¼ íŒ€ìœ¼ë¡œ ë°°ì •í•˜ì„¸ìš” (ë“œë˜ê·¸ ì•¤ ë“œë¡­)</h6>
                    <div class="mb-3">
                        <div class="border rounded p-3" style="min-height: 100px; background-color: #f8f9fa;">
                            <small class="text-muted d-block mb-2"><strong>ë¯¸ë°°ì •</strong></small>
                            <div id="unassignedArea" class="d-flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                    <div id="teamsContainer" class="row"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-info" onclick="submitTeamAssignment()"><i class="fas fa-check"></i> ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

</body>
</html>