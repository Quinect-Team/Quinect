<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>퀴즈 대기실</title>
    <link rel="stylesheet" th:href="@{/css/sb-admin-2.css}" />
</head>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
<body class="bg-gradient-success">
<div class="container-fluid py-4">

    <!-- 상단 정보 영역 -->
    <div class="row mb-3">
        <div class="col">
            <div class="card shadow border-left-success p-3 d-flex flex-row align-items-center">
                <h3 class="text-success mb-0 mr-4"><i class="fas fa-key"></i> 방 코드:</h3>
                <h1 class="display-4 font-weight-bold mr-3" th:text="${room.roomCode}">ABCD</h1>
                <button class="btn btn-outline-warning btn-sm ml-3" onclick="copyCode()"><i class="fas fa-copy"></i> 복사</button>
				<img th:if="${qrCodeBase64 != null}" th:src="'data:image/png;base64,' + ${qrCodeBase64}" alt="QR 코드" width="150" height="150"/>
                <span class="ml-auto pr-3 font-weight-bold">방 유형: <span th:text="${roomTypeName}">객관식</span></span>
            </div>
        </div>
    </div>

    <!-- 메인(참가자+채팅) -->
    <div class="row">
        <!-- 참가자 리스트 -->
        <div class="col-md-7">
            <div class="card shadow mb-4">
                <div class="card-header py-2 bg-info">
                    <h6 class="m-0 font-weight-bold text-white"><i class="fas fa-users"></i> 참가자</h6>
                </div>
                <div class="card-body pb-1 d-flex flex-wrap">
                    <div class="card border-primary m-2 text-center" style="width: 114px; height: 125px;" th:each="user : ${participants}">
                        <div class="mt-2">
                            <img th:src="@{${user.avatarUrl}}" class="rounded-circle mb-2" width="55" height="55" alt="avatar">
                        </div>
                        <div class="font-weight-bold text-primary" th:text="${user.nickname}">닉네임</div>
                        <div th:if="${user.ready}" class="badge badge-success px-2 mt-1">READY</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 채팅창 -->
        <div class="col-md-5">
            <div class="card shadow mb-4 h-100 d-flex flex-column">
                <div class="card-header py-2 bg-gradient-info">
                    <h6 class="m-0 font-weight-bold text-white"><i class="fas fa-comments"></i> 채팅</h6>
                </div>
                <div class="card-body flex-fill px-2 py-2" id="messages" style="overflow-y:auto; height:260px;">
                    <!-- JS 또는 타임리프로 채팅 메시지 렌더링 -->
                </div>
                <div class="card-footer p-2 bg-light">
					<form class="input-group mt-2" onsubmit="sendMessage(); return false;">
					    <input id="chat-input" type="text" class="form-control mr-2" placeholder="메시지 입력" autocomplete="off" />
					    <button class="btn btn-warning font-weight-bold" type="submit">입력</button>
					</form>
                </div>
            </div>
        </div>
    </div>

    <!-- 하단 READY/팀선택 등 -->
    <div class="row mt-3">
        <div class="col text-right">
            <button class="btn btn-secondary btn-lg mr-2"><i class="fas fa-users-cog"></i> 팀 선택</button>
            <button class="btn btn-primary btn-lg font-weight-bold"><i class="fas fa-flag-checkered"></i> READY</button>
        </div>
    </div>
</div>
<script th:inline="javascript">
    // 타임리프로 roomCode와 username 변수를 채우는 예시
    let roomCode = /*[[${room.roomCode}]]*/ 'ABCD';
    let username = /*[['사용자명']*/ 'Guest';

    let socket = new SockJS('/ws');
    let stompClient = Stomp.over(socket);

    // 접속 및 구독하기
    stompClient.connect({}, function(frame) {
        console.log('Connected: ' + frame);
        stompClient.subscribe('/topic/chat/' + roomCode, function(message) {
            let msg = JSON.parse(message.body);
            displayMessage(msg.sender, msg.content);
        });
    }, function(error) {
        console.error('Error: ' + error);
    });

    // 메시지 출력 함수
    function displayMessage(sender, content) {
        let messagesDiv = document.getElementById('messages');
        let msgDiv = document.createElement('div');
        msgDiv.innerHTML = '<strong>' + sender + ':</strong> ' + content;
        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // 스크롤 최하단 유지
    }

    // 메시지 전송 함수
    function sendMessage() {
        let input = document.getElementById('chat-input');
        let text = input.value.trim();
        if (text && stompClient.connected) {
            let chatMessage = {
                sender: username,
                content: text,
            };
            stompClient.send('/app/chat/' + roomCode, {}, JSON.stringify(chatMessage));
            input.value = '';
        }
    }

    // 폼 submit에 이벤트 연결
    document.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });

    function copyCode() {
        const code = document.querySelector('.display-4').textContent;
        navigator.clipboard.writeText(code)
            .then(()=>alert("방 코드가 복사되었습니다: " + code));
    }
</script>
</body>
</html>
