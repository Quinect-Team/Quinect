<head>
	<meta name="_csrf" th:content="${_csrf.token}"/>
	<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<style>
	/* 문제 블록 전체 */
	#question-container {
	    max-width: 900px;
	    margin: 0 auto;
	    padding: 0 20px;
	    box-sizing: border-box;
	}

	.question-block {
	    border: 1px solid #ccc;
	    padding: 20px;
	    border-radius: 8px;
	    background: #f8f9fa;
	    margin: 20px auto;
	}

	.question-block input[type="text"] {
	    padding: 8px;
	    width: 100%;
	    border: 1px solid #adb5bd;
	    border-radius: 6px;
	}
	.question-block input[type="text"]:focus {
	    outline: none;
	    border-color: #6c757d;
	    box-shadow: 0 0 0 3px rgba(108,117,125,0.25);
	}

	.choice-buttons {
	    display: flex;
	    gap: 10px;
	    margin-top: 10px;
	}
	
	/* 문제 추가 버튼 */
	.add-question-area {
	    max-width: 900px;
	    margin: 0 auto;
	    display: flex;
	    gap: 10px;
	    justify-content: flex-end;
	}
	.add-question-area button {
	    width: 150px;
	    height: 40px;
	}
	
	/* 선지 추가 버튼 */
	#choices {
		padding: 8px;
		display: flex;
		margin-top: 10px;
		padding-right: 20px;
	}

	/* 문제 추가 버튼 */
	.submit-area {
	    max-width: 900px;
	    margin: 0 auto;
	    display: flex;
	    gap: 10px;
	    justify-content: flex-end;
		margin-top: 10px;
	}
	.submit-area button {
	    width: 150px;
	    height: 40px;
	}
	
	#question-sub{
		max-width: 900px;
		margin: 0 auto;
		padding: 0 20px;
		box-sizing: border-box;
	}
</style>


<!-- 부트스트랩 -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

<body>
<div id="question-sub" style="max-width:900px; margin:20px auto;">
    <input id="quiz-title" type="text" placeholder="퀴즈 제목을 입력하세요" style="width:100%; padding:10px; margin-bottom:10px;">
    <textarea id="quiz-desc" placeholder="퀴즈 설명을 입력하세요(선택)" style="width:100%; padding:10px;"></textarea>
</div>

<div id="question-container">

  <!-- 템플릿 문항 (첫 문항, 삭제버튼은 Q1에서 막음) -->
  <div class="question-block" data-qid="1">
    <div class="d-flex align-items-center" style="gap:10px;">
      <label class="q-label" style="margin:0; font-weight:bold;">Q1.</label>

      <input type="text" class="q-title" placeholder="문제를 입력하세요" style="flex:1;">
      <input type="number" class="q-point" placeholder="점수" style="width:80px;">

      <div class="btn-group dropright">
        <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">문제 유형</button>
        <div class="dropdown-menu">
          <a class="dropdown-item select-type" data-type="short_answer" href="#">서술형</a>
          <a class="dropdown-item select-type" data-type="multiple_choice" href="#">객관식</a>
        </div>
      </div>

      <button class="btn btn-danger delete-question" style="display:none;">삭제</button>
    </div>

    <div class="image-container" style="margin-top:10px;">
      <input type="file" class="image-input" accept="image/*">
    </div>

    <!-- 서술형 블록 (기본 노출) -->
    <div class="short-answer-block" style="margin-top:10px;">
      <input type="text" class="q-answer" placeholder="정답을 작성하세요." style="width:100%; padding:5px;">
    </div>

    <!-- 객관식 블록 (기본 숨김) -->
    <div class="multiple-choice-block" style="margin-top:10px; display:none;">
      <div class="option-list"></div>
      <button type="button" class="btn btn-primary add-option" style="margin-top:10px;">+ 보기 추가</button>
    </div>
  </div>

</div>

<!-- 조작 버튼들 -->
<div class="add-question-area" style="max-width:900px; margin:10px auto;">
  <button id="add-question" class="btn btn-secondary">문제 추가</button>
  <button id="load-question" class="btn btn-secondary">불러오기</button>
  <button id="remove-question" class="btn btn-secondary">문제 제거</button>
</div>

<div class="submit-area" style="max-width:900px; margin:10px auto;">
  <button id="temp-save" class="btn btn-secondary">임시 저장</button>
  <button id="save" class="btn btn-primary">저장</button>
</div>

<!-- Bootstrap & Script -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // 참조
  const container = document.getElementById("question-container");
  const addBtn = document.getElementById("add-question");
  const loadBtn = document.getElementById("load-question");
  const removeBtn = document.getElementById("remove-question");
  const tempSaveBtn = document.getElementById("temp-save");
  const saveBtn = document.getElementById("save");
  const quizTitle = document.getElementById("quiz-title");
  const quizDesc = document.getElementById("quiz-desc");

  const LOCAL_KEY = "quiz_temp_v1";

  // CSRF (있으면 사용)
  const csrfTokenMeta = document.querySelector("meta[name='_csrf']");
  const csrfHeaderMeta = document.querySelector("meta[name='_csrf_header']");
  const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute("content") : null;
  const csrfHeader = csrfHeaderMeta ? csrfHeaderMeta.getAttribute("content") : null;

  // 디바운스 자동저장 타이머
  let autosaveTimer = null;
  function debounceAutoSave() {
    if (autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => {
      const data = collectQuizDataForLocal();
      localStorage.setItem(LOCAL_KEY, JSON.stringify(data));
      console.log("[autosave] 로컬에 저장됨.", new Date().toISOString());
    }, 500);
  }

  // 초기: 기존 블록에 이벤트 연결 및 QID 설정
  setQidsAndAttachAll();

  // 자동 복구: 로컬에 임시본이 있으면 페이지 로드 시 자동 복원 (사용자 확인 없음)
  (function autoRestoreIfExists() {
    const saved = localStorage.getItem(LOCAL_KEY);
    if (!saved) return;
    try {
      const parsed = JSON.parse(saved);
      // 빈 상태일 때만 자동 복원 (혹은 항상 덮어쓰기를 원하면 조건 제거)
      // 여기서는 항상 복원하도록 함 (요청사항: 새로고침 시 자동 복구)
      loadQuizFromLocal(parsed);
      console.log("[autosore] 로컬 임시본 복원 완료.");
    } catch (e) {
      console.warn("로컬 임시본 파싱 실패", e);
    }
  })();


  // ========== 버튼 이벤트 ==========

  // 문제 추가
  addBtn.addEventListener("click", () => {
    const newBlock = createQuestionBlock();
    container.appendChild(newBlock);
    renumber();
    debounceAutoSave();
  });

  // 마지막 문제 제거
  removeBtn.addEventListener("click", () => {
    const blocks = container.querySelectorAll(".question-block");
    if (blocks.length <= 1) { alert("문항은 최소 1개 이상이어야 합니다."); return; }
    blocks[blocks.length -1].remove();
    renumber();
    debounceAutoSave();
  });

  // 임시 저장 (수동 버튼)
  tempSaveBtn.addEventListener("click", () => {
    const data = collectQuizDataForLocal();
    localStorage.setItem(LOCAL_KEY, JSON.stringify(data));
    alert("임시 저장 완료! (이미지 파일은 저장되지 않습니다)");
  });

  // 수동 불러오기 (버튼)
  loadBtn.addEventListener("click", () => {
    const saved = localStorage.getItem(LOCAL_KEY);
    if (!saved) { alert("임시 저장된 내용이 없습니다."); return; }
    if (!confirm("임시 저장된 문제를 불러오시겠습니까? 기존 내용은 덮어써집니다.")) return;
    const parsed = JSON.parse(saved);
    loadQuizFromLocal(parsed);
    alert("임시 저장본을 불러왔습니다!");
  });

  // 내용 변경 시 자동 임시 저장 (디바운스)
  document.addEventListener("input", debounceAutoSave);
  document.addEventListener("change", debounceAutoSave);

  // 저장 버튼 => 서버 전송 (기존 로직 재사용)
  saveBtn.addEventListener('click', async () => {
    try {
      const { quizJson, imagesMap } = collectForSave(true);
      // 이미지 업로드 (index 기준)
      for (let i = 0; i < imagesMap.length; i++) {
        const file = imagesMap[i];
        if (!file) continue;
        const fd = new FormData();
        fd.append("file", file);
        const headers = csrfToken ? { [csrfHeader]: csrfToken } : undefined;
        const upRes = await fetch("/quiz/upload-image", { method: "POST", headers: headers, body: fd });
        if (!upRes.ok) throw new Error("이미지 업로드 실패: " + upRes.status);
        const savedFileName = await upRes.text();
        if (quizJson.questions && quizJson.questions[i]) quizJson.questions[i].image = savedFileName;
      }

      // quizJson 전송
      const postHeaders = { "Content-Type": "application/json" };
      if (csrfToken && csrfHeader) postHeaders[csrfHeader] = csrfToken;

      const saveRes = await fetch("/quiz/save", { method: "POST", headers: postHeaders, body: JSON.stringify(quizJson) });
      if (!saveRes.ok) {
        const errText = await saveRes.text().catch(()=>null);
        throw new Error("서버 저장 실패: " + (errText || saveRes.status));
      }

      // 저장 성공하면 로컬 임시본 삭제 (선택적)
      localStorage.removeItem(LOCAL_KEY);
      alert("저장 성공! (로컬 임시본 제거됨)");
    } catch (err) {
      console.error("저장 중 오류:", err);
      alert("저장 실패: 콘솔을 확인하세요\n" + (err && err.message ? err.message : ""));
    }
  });

  // ----------------- 주요 함수들 -----------------

  // 화면의 모든 question-block에 이벤트 연결 및 qid 설정
  function setQidsAndAttachAll() {
    const blocks = container.querySelectorAll(".question-block");
    blocks.forEach((b, idx) => {
      b.dataset.qid = idx + 1;
      const del = b.querySelector(".delete-question");
      if (del) del.style.display = (idx === 0 ? "none" : "inline-block");
      attachEventsToBlock(b);
    });
    renumber();
  }

  // 한 블록에 필요한 이벤트 연결
  function attachEventsToBlock(block) {
    if (!block) return;

    // ensure qid
    if (!block.dataset.qid) block.dataset.qid = container.querySelectorAll(".question-block").length;

    // 삭제 버튼
    const delBtn = block.querySelector(".delete-question");
    if (delBtn) {
      delBtn.onclick = (e) => {
        const total = container.querySelectorAll(".question-block").length;
        if (total <= 1) { alert("문항은 최소 1개 이상이어야 합니다."); return; }
        block.remove();
        renumber();
        debounceAutoSave();
      };
    }

    // 문제 유형 선택
    const selects = block.querySelectorAll(".select-type");
    selects.forEach(a => {
      a.onclick = (ev) => {
        ev.preventDefault();
        const type = a.dataset.type;
        if (type === "short_answer") {
          block.querySelector(".short-answer-block").style.display = "block";
          block.querySelector(".multiple-choice-block").style.display = "none";
        } else {
          block.querySelector(".short-answer-block").style.display = "none";
          block.querySelector(".multiple-choice-block").style.display = "block";
          const list = block.querySelector(".option-list");
          if (list.children.length === 0) {
            list.appendChild(makeOptionElement(block.dataset.qid, 1));
            list.appendChild(makeOptionElement(block.dataset.qid, 2));
          }
        }
        debounceAutoSave();
      };
    });

    // 이미지 입력 (preview 없음, 선택만 로그)
    const imageInput = block.querySelector(".image-input");
    if (imageInput) {
      imageInput.onchange = () => {
        console.log("이미지 선택됨 for qid", block.dataset.qid, imageInput.files[0]);
        debounceAutoSave();
      };
    }

    // 보기 추가 버튼 (객관식)
    const addOptBtn = block.querySelector(".add-option");
    if (addOptBtn) {
      addOptBtn.onclick = (e) => {
        e.preventDefault();
        const list = block.querySelector(".option-list");
        const idx = list.children.length + 1;
        list.appendChild(makeOptionElement(block.dataset.qid, idx));
        debounceAutoSave();
      };
    }

    // 기존에 있는 삭제 옵션 버튼들
    block.querySelectorAll(".delete-option").forEach(btn => {
      btn.onclick = (ev) => {
        ev.preventDefault();
        const row = btn.closest(".option-item");
        if (row) { row.remove(); debounceAutoSave(); }
      };
    });

    // 입력 변화가 생기면 autosave 트리거 (개별 필드도 글로벌 이벤트로 잡혀있지만 블록 수준에서도 안전하게)
    block.querySelectorAll("input, textarea").forEach(inp => {
      inp.addEventListener("input", debounceAutoSave);
      inp.addEventListener("change", debounceAutoSave);
    });
  }

  // 새로운 question-block DOM 생성 (초기 템플릿과 동일한 구조)
  function createQuestionBlock() {
    const div = document.createElement("div");
    div.classList.add("question-block");

    div.innerHTML = `
      <div class="d-flex align-items-center" style="gap:10px;">
        <label class="q-label" style="margin:0; font-weight:bold;">Q?.</label>
        <input type="text" class="q-title" placeholder="문제를 입력하세요" style="flex:1;">
        <input type="number" class="q-point" placeholder="점수" style="width:80px;">
        <div class="btn-group dropright">
          <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">문제 유형</button>
          <div class="dropdown-menu">
            <a class="dropdown-item select-type" data-type="short_answer" href="#">서술형</a>
            <a class="dropdown-item select-type" data-type="multiple_choice" href="#">객관식</a>
          </div>
        </div>
        <button class="btn btn-danger delete-question">삭제</button>
      </div>

      <div class="image-container" style="margin-top:10px;">
        <input type="file" class="image-input" accept="image/*">
      </div>

      <div class="short-answer-block" style="margin-top:10px;">
        <input type="text" class="q-answer" placeholder="정답을 작성하세요." style="width:100%; padding:5px;">
      </div>

      <div class="multiple-choice-block" style="margin-top:10px; display:none;">
        <div class="option-list"></div>
        <button class="btn btn-secondary btn-sm add-option" style="margin-top:8px;">보기 추가</button>
      </div>
    `;

    div.dataset.qid = container.querySelectorAll(".question-block").length + 1;
    // attach events
    attachEventsToBlock(div);
    return div;
  }

  // 객관식 보기 한 항목 생성
  function makeOptionElement(qid, optNumber, text = "") {
    const div = document.createElement("div");
    div.className = "option-item";
    div.style.marginBottom = "8px";
    const radioName = `choice-${qid}-${Date.now()}`; // 고유 네임
    div.innerHTML = `
      <div class="d-flex align-items-center" style="gap:10px;">
        <input type="radio" name="${radioName}">
        <input type="text" class="option-text form-control" placeholder="선지 입력" style="flex:1;" value="${escapeHtml(text)}">
        <button class="btn btn-danger btn-sm delete-option">X</button>
      </div>
    `;
    const del = div.querySelector(".delete-option");
    del.onclick = (e) => { e.preventDefault(); div.remove(); debounceAutoSave(); };
    return div;
  }

  // q-label, radio name 등 순번 재정렬
  function renumber() {
    const blocks = container.querySelectorAll(".question-block");
    blocks.forEach((b, idx) => {
      b.dataset.qid = idx + 1;
      const label = b.querySelector(".q-label");
      if (label) label.textContent = `Q${idx + 1}.`;
      // option radio name 조정
      b.querySelectorAll(".option-list .option-item").forEach(opt => {
        const radio = opt.querySelector("input[type=radio]");
        if (radio) radio.name = `choice-${b.dataset.qid}`;
      });
      // first block delete 숨김
      const del = b.querySelector(".delete-question");
      if (del) del.style.display = (idx === 0 ? "none" : "inline-block");
    });
  }

  // 화면 상태를 localStorage용으로 수집
  function collectQuizDataForLocal() {
    const blocks = container.querySelectorAll(".question-block");
    const result = [];

    blocks.forEach((b, idx) => {
      const isMultiple = b.querySelector(".multiple-choice-block").style.display === "block";
      const item = {
        number: idx + 1,
        quizTypeCode: isMultiple ? 2 : 1,
        questionText: (b.querySelector(".q-title") || {}).value || "",
        point: Number((b.querySelector(".q-point") || {}).value || 0),
        subjectiveAnswer: !isMultiple ? (b.querySelector(".q-answer") || {}).value || "" : "",
        options: [],
        answerOption: null // 객관식이면 index (1-based)
      };

      if (isMultiple) {
        const optionEls = b.querySelectorAll(".option-list .option-item");
        optionEls.forEach((optEl, i) => {
          const txt = (optEl.querySelector(".option-text") || {}).value || "";
          const radio = optEl.querySelector("input[type=radio]");
          if (radio && radio.checked) item.answerOption = i + 1;
          item.options.push(txt);
        });
      }
      result.push(item);
    });

    return {
      title: quizTitle.value || "",
      description: quizDesc.value || "",
      questions: result
    };
  }

  // 로컬에서 불러온 데이터를 화면으로 복원
  function loadQuizFromLocal(list) {
    // 리스트 형식이 바로 questions 배열인지 대응
    const questions = list.questions || list;

    // 기존 모두 제거
    container.innerHTML = "";

    // 복원
    (questions || []).forEach((q, idx) => {
      const block = createQuestionBlock();
      container.appendChild(block);

      // 값 채우기
      block.querySelector(".q-title").value = q.questionText || q.question || "";
      block.querySelector(".q-point").value = q.point || q.points || 0;

      if (Number(q.quizTypeCode) === 2 || q.quizType === "multiple_choice") {
        block.querySelector(".short-answer-block").style.display = "none";
        block.querySelector(".multiple-choice-block").style.display = "block";
        const wrap = block.querySelector(".option-list");
        wrap.innerHTML = "";
        (q.options || []).forEach((optText, i) => {
          const opt = makeOptionElement(block.dataset.qid, i+1, optText);
          wrap.appendChild(opt);
        });
        // 정답 체크
        if (q.answerOption) {
          const idxAns = Number(q.answerOption) - 1;
          const radios = wrap.querySelectorAll("input[type=radio]");
          if (radios[idxAns]) radios[idxAns].checked = true;
        }
      } else {
        block.querySelector(".short-answer-block").style.display = "block";
        block.querySelector(".multiple-choice-block").style.display = "none";
        block.querySelector(".q-answer").value = q.subjectiveAnswer || q.answer || "";
      }
      // 이미지는 복원 불가 (파일 객체가 없기 때문에)
      block.querySelector(".image-input").value = "";
      attachEventsToBlock(block);
    });

    // 타이틀/설명도 채움
    quizTitle.value = list.title || "";
    quizDesc.value = list.description || "";

    renumber();
  }

  // 서버 전송용 수집 (원래 있던 collectForSave과 호환)
  function collectForSave(includeFiles) {
    const blocks = container.querySelectorAll(".question-block");
    const questions = [];
    const imagesMap = [];

    blocks.forEach((b, idx) => {
      const isMultiple = b.querySelector(".multiple-choice-block").style.display === "block";

      let options = null;
      let answerOption = null;
      if (isMultiple) {
        options = [];
        const optionEls = b.querySelectorAll(".option-list .option-item");
        optionEls.forEach((optEl, i) => {
          const txt = (optEl.querySelector(".option-text") || {}).value || "";
          options.push(txt);
          const radio = optEl.querySelector("input[type=radio]");
          if (radio && radio.checked) answerOption = i + 1;
        });
      }

      const fileInput = b.querySelector(".image-input");
      const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
      imagesMap.push(includeFiles ? file : null);

      const qDto = {
        quizTypeCode: isMultiple ? 2 : 1,
        questionText: (b.querySelector(".q-title") || {}).value || "",
        answerOption: isMultiple ? (answerOption !== null ? String(answerOption) : null) : null,
        point: Number((b.querySelector(".q-point") || {}).value || 0),
        subjectiveAnswer: !isMultiple ? (b.querySelector(".q-answer") || {}).value || null : null,
        image: null,
        options: options
      };

      questions.push(qDto);
    });

    const quizJson = {
      title: quizTitle.value || "",
      description: quizDesc.value || "",
      userId: 1,
      questions: questions
    };

    return { quizJson, imagesMap };
  }

  // HTML 값 삽입 시 안전을 위한 이스케이프
  function escapeHtml(str) {
    if (!str) return "";
    return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

}); // DOMContentLoaded
</script>
