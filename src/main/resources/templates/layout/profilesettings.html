<div class="settings-container" th:fragment="profilesettings">

	<div class="d-flex align-items-center justify-content-between mb-3">
		<div class="d-flex align-items-center">
			<a th:href="${source == 'main'} ? @{/main} : @{/profile}" class="text-decoration-none text-gray-800 mr-3">
				<i class="fas fa-arrow-left fa-2x"></i>
			</a>
			<h1 class="h3 mb-0 text-gray-800 font-weight-bold">설정</h1>
		</div>
	</div>

	<hr class="mb-4">

	<div class="row">
		<div class="col-md-3 mb-4">
			<div class="nav flex-column nav-pills settings-nav" id="v-pills-tab" role="tablist"
				aria-orientation="vertical">
				<span class="small text-gray-600 font-weight-bold text-uppercase px-3 mb-2 mt-2">프로필 설정</span>

				<a class="nav-link active" id="v-pills-profile-tab" data-toggle="pill" href="#v-pills-profile"
					role="tab" aria-controls="v-pills-profile" aria-selected="true">
					<i class="fas fa-user mr-2"></i> 기본 정보
				</a>
				<a class="nav-link" id="v-pills-theme-tab" data-toggle="pill" href="#v-pills-theme" role="tab"
					aria-controls="v-pills-theme" aria-selected="false">
					<i class="fas fa-palette mr-2"></i> 테마 변경
				</a>

				<hr class="w-100 my-3" style="border-color: #eaecf4;">

				<span class="small text-gray-600 font-weight-bold text-uppercase px-3 mb-2">일반 설정</span>
				<a class="nav-link" id="v-pills-general-tab" data-toggle="pill" href="#v-pills-general" role="tab"
					aria-controls="v-pills-general" aria-selected="false">
					<i class="fas fa-cog mr-2"></i> 일반
				</a>
			</div>
		</div>

		<div class="col-md-9">
			<div class="tab-content settings-content" id="v-pills-tabContent">

				<div class="tab-pane fade show active" id="v-pills-profile" role="tabpanel"
					aria-labelledby="v-pills-profile-tab">
					<form id="settingsForm" enctype="multipart/form-data">
						<h5 class="font-weight-bold text-gray-800 mb-4">기본 프로필 정보</h5>

						<div class="mb-3">
							<label for="nickname" class="form-label">닉네임</label>

							<input type="text" class="form-control" id="nickname" name="username"
								th:value="${user?.userProfile?.username}" th:disabled="${!canChangeNickname}"
								th:title="${nicknameMessage}">
							<input type="hidden" name="username" th:value="${user?.userProfile?.username}"
								th:if="${!canChangeNickname}">

							<span id="nicknameCheckMsg" class="small"></span>

							<span th:if="${!canChangeNickname}" class="small text-danger fw-bold ms-2">
								<i class="fas fa-clock"></i>
								<span th:text="${nicknameMessage}"></span>
							</span>
						</div>
						<div class="form-group">
							<label class="form-label">소속</label>
							<input type="text" class="form-control" name="organization"
								th:value="${user.userProfile.organization}">
						</div>
						<div class="form-group">
							<label class="form-label">한줄 소개 (Bio)</label>
							<input type="text" class="form-control" name="bio" th:value="${user.userProfile.bio}">
						</div>

						<hr class="my-4">

						<h5 class="font-weight-bold text-gray-800 mb-4">프로필 이미지 선택</h5>

						<label class="form-label text-success small">기본 캐릭터 선택</label>
						<div class="row mb-3" id="defaultProfileSection">
							<div class="col-3 mb-2">
								<div class="selection-box"
									th:classappend="${user.userProfile.profileImage == '/img/undraw_profile.svg'} ? 'active' : ''"
									onclick="selectDefaultProfile('/img/undraw_profile.svg', this)">
									<img src="/img/undraw_profile.svg" class="rounded-circle"
										style="width: 50px; height: 50px; object-fit: cover;">
								</div>
							</div>
							<div class="col-3 mb-2">
								<div class="selection-box"
									th:classappend="${user.userProfile.profileImage == '/img/undraw_profile_1.svg'} ? 'active' : ''"
									onclick="selectDefaultProfile('/img/undraw_profile_1.svg', this)">
									<img src="/img/undraw_profile_1.svg" class="rounded-circle"
										style="width: 50px; height: 50px; object-fit: cover;">
								</div>
							</div>
							<div class="col-3 mb-2">
								<div class="selection-box"
									th:classappend="${user.userProfile.profileImage == '/img/undraw_profile_2.svg'} ? 'active' : ''"
									onclick="selectDefaultProfile('/img/undraw_profile_2.svg', this)">
									<img src="/img/undraw_profile_2.svg" class="rounded-circle"
										style="width: 50px; height: 50px; object-fit: cover;">
								</div>
							</div>
							<div class="col-3 mb-2">
								<div class="selection-box"
									th:classappend="${user.userProfile.profileImage == '/img/undraw_profile_3.svg'} ? 'active' : ''"
									onclick="selectDefaultProfile('/img/undraw_profile_3.svg', this)">
									<img src="/img/undraw_profile_3.svg" class="rounded-circle"
										style="width: 50px; height: 50px; object-fit: cover;">
								</div>
							</div>
						</div>

						<div class="form-group">
							<label class="form-label text-gray-600 small">또는 직접 업로드</label>
							<div class="d-flex align-items-center">

								<div class="mr-3 position-relative">

									<img id="profilePreview"
										th:src="${user.userProfile.profileImage != null ? user.userProfile.profileImage : '/img/undraw_profile.svg'}"
										class="rounded-circle"
										th:style="${user.userProfile.profileImage != null and #strings.startsWith(user.userProfile.profileImage, '/img/')} ? 'width: 60px; height: 60px; object-fit: cover; border: 1px solid #ddd; display: none;' : 'width: 60px; height: 60px; object-fit: cover; border: 1px solid #ddd; display: block;'">

									<div id="profileIconPlaceholder"
										class="rounded-circle bg-gray-200 align-items-center justify-content-center"
										th:style="${user.userProfile.profileImage != null and #strings.startsWith(user.userProfile.profileImage, '/img/')} ? 'width: 60px; height: 60px; border: 1px solid #ddd; display: flex;' : 'width: 60px; height: 60px; border: 1px solid #ddd; display: none;'">
										<i class="fas fa-user fa-2x text-gray-400"></i>
									</div>

								</div>

								<div class="custom-file">
									<input type="file" class="custom-file-input" id="profileImageFile"
										name="profileImageFile" accept="image/*" onchange="previewImage(this)">
									<label class="custom-file-label" for="profileImageFile" data-browse="찾기">파일
										선택...</label>
								</div>
							</div>
							<small class="text-muted ml-2">직접 업로드 시 선택한 기본 캐릭터는 무시됩니다.</small>
						</div>

						<input type="hidden" name="defaultProfileImage" id="inputDefaultProfileImage">

						<input type="hidden" id="initialProfileImageValue"
							th:value="${user.userProfile.profileImage != null ? user.userProfile.profileImage : ''}">

						<div class="text-right mt-4">
							<button type="button" id="saveProfileBtn" disabled 
							        class="btn btn-secondary btn-icon-split">
							    <span class="icon text-white-50"><i class="fas fa-save"></i></span>
							    <span class="text">변경사항 저장</span>
							</button>
						</div>
					</form>
				</div>

				<div class="tab-pane fade" id="v-pills-theme" role="tabpanel" aria-labelledby="v-pills-theme-tab">

					<h5 class="font-weight-bold text-gray-800 mb-3">테두리 선택</h5>
					<div class="row mb-4" id="borderSection">
						<div class="col-3 mb-2">
							<div class="selection-box default-box" data-id="" onclick="selectItem('border', '', this)">
								<div style="height: 50px; display: flex; align-items: center; justify-content: center;">
									<i class="fas fa-ban fa-2x text-gray-400"></i>
								</div>
								<div class="small mt-2">기본</div>
							</div>
						</div>
						<div class="col-3 mb-2" th:each="inven : ${myBorders}">
							<div class="selection-box" th:classappend="${inven.equipped} ? 'active' : ''"
								th:data-id="${inven.item.id}"
								th:onclick="|selectItem('border', '${inven.item.id}', this)|">

								<img th:if="${inven.item.imageUrl}" th:src="${inven.item.imageUrl}" class="mb-2"
									style="width: 50px; height: 50px;">
								<i th:unless="${inven.item.imageUrl}"
									class="fas fa-certificate fa-2x mb-2 text-primary"></i>
								<div class="small" th:text="${inven.item.itemName}">이름</div>
							</div>
						</div>
					</div>

					<hr>

					<h5 class="font-weight-bold text-gray-800 mb-3">테마 선택</h5>
					<div class="row" id="themeSection">
						<div class="col-3 mb-2">
							<div class="selection-box default-box" data-id="" onclick="selectItem('theme', '', this)">
								<div style="height: 50px; background-color: #f8f9fc; border: 1px solid #ddd;"></div>
								<div class="small mt-2">기본</div>
							</div>
						</div>
						<div class="col-3 mb-2" th:each="inven : ${myThemes}">
							<div class="selection-box" th:classappend="${inven.equipped} ? 'active' : ''"
								th:data-id="${inven.item.id}"
								th:onclick="|selectItem('theme', '${inven.item.id}', this)|">

								<img th:if="${inven.item.imageUrl}" th:src="${inven.item.imageUrl}" class="mb-2"
									style="width: 100%; height: 50px; object-fit: cover;">
								<div style="height: 50px; background-color: #eee;" th:unless="${inven.item.imageUrl}">
								</div>
								<div class="small" th:text="${inven.item.itemName}">이름</div>
							</div>
						</div>
					</div>

					<div class="text-right mt-4">
						<button type="button" id="saveThemeBtn" disabled onclick="submitEquipForm()"
							class="btn btn-secondary btn-icon-split">
							<span class="icon text-white-50"><i class="fas fa-save"></i></span>
							<span class="text">변경사항 저장</span>
						</button>
					</div>
				</div>

				<div class="tab-pane fade" id="v-pills-general" role="tabpanel" aria-labelledby="v-pills-general-tab">

					<h5 class="font-weight-bold text-gray-800 mb-4">계정 관리</h5>

					<div class="card mb-4 py-3 border-left-danger shadow-sm">
						<div class="card-body">
							<div class="row align-items-center">
								<div class="col-md-9">
									<h6 class="font-weight-bold text-danger mb-2">
										<i class="fas fa-exclamation-triangle mr-2"></i>회원 탈퇴
									</h6>
									<p class="text-gray-600 small mb-0">
										탈퇴 버튼을 누르면 계정은 즉시 <strong>'비활성화(삭제 대기)'</strong> 상태로 변경됩니다.<br>
										데이터 보존 및 실수 방지를 위해 <strong>7일간의 유예 기간</strong>이 주어지며, <br>
										이 기간 내에 다시 로그인하면 탈퇴를 취소할 수 있습니다.
									</p>
								</div>
								<div class="col-md-3 text-right">
									<button type="button" class="btn btn-danger btn-icon-split" data-toggle="modal"
										data-target="#withdrawalModal">
										<span class="icon text-white-50">
											<i class="fas fa-user-times"></i>
										</span>
										<span class="text">탈퇴하기</span>
									</button>
								</div>
							</div>
						</div>
					</div>

				</div>

				<div class="modal fade" id="withdrawalModal" tabindex="-1" role="dialog"
					aria-labelledby="withdrawalModalLabel" aria-hidden="true">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header bg-danger text-white">
								<h5 class="modal-title" id="withdrawalModalLabel">회원 탈퇴 확인</h5>
								<button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<div class="text-center mb-4">
									<i class="fas fa-sad-tear fa-4x text-gray-300 mb-3"></i>
									<h5 class="font-weight-bold text-gray-800">정말로 떠나시겠습니까?</h5>
								</div>
								<p class="text-gray-800">
									회원님, 탈퇴하시기 전에 아래 내용을 꼭 확인해주세요.
								</p>
								<div class="alert alert-secondary small" role="alert">
									<ul class="mb-0 pl-3">
										<li>탈퇴 신청 즉시 로그아웃 되며 서비스 이용이 제한됩니다.</li>
										<li><strong>7일 이내</strong>에 재로그인 하시면 계정이 복구됩니다.</li>
										<li>7일 후에는 개인정보가 파기되거나 영구 삭제 처리됩니다.</li>
										<li>작성하신 퀴즈와 댓글은 유지되지만, 프로필은 '알 수 없음'으로 표시됩니다.</li>
									</ul>
								</div>
								<div class="custom-control custom-checkbox">
									<input type="checkbox" class="custom-control-input" id="checkWithdrawal"
										onchange="toggleWithdrawBtn()">
									<label class="custom-control-label text-danger font-weight-bold"
										for="checkWithdrawal">
										위 내용을 모두 확인하였으며, 탈퇴에 동의합니다.
									</label>
								</div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
								<form id="withdrawForm" method="post" action="/api/user/withdraw"> <button type="button"
										id="btnFinalWithdraw" class="btn btn-danger" disabled
										onclick="submitWithdrawal()">
										탈퇴 신청
									</button>
								</form>
							</div>
						</div>
					</div>
				</div>

			</div>
		</div>
	</div>
	<input type="hidden" id="inputBorderId">
	<input type="hidden" id="inputThemeId">
	<form id="equipForm" enctype="application/x-www-form-urlencoded">
		<input type="hidden" name="borderId" id="realBorderId">
		<input type="hidden" name="themeId" id="realThemeId">
	</form>
</div>