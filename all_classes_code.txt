1. CleanupRunner.java="
package com.project.quiz.config;

import com.project.quiz.service.UserHardDeleteService;
import lombok.RequiredArgsConstructor;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

import java.util.Arrays;

@Component
@RequiredArgsConstructor
public class CleanupRunner implements CommandLineRunner {

    private final UserHardDeleteService userHardDeleteService;

    @Override
    public void run(String... args) throws Exception {
        // ì‹¤í–‰ ì¸ìì— "--cleanup"ì´ ìˆëŠ”ì§€ í™•ì¸
        if (Arrays.asList(args).contains("--cleanup")) {
            System.out.println("ğŸš€ [Cleanup Mode] ë°ì´í„° ì •ë¦¬ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤...");
            
            userHardDeleteService.executeHardDeleteProcess();
            
            System.out.println("ğŸ [Cleanup Mode] ì‘ì—… ì™„ë£Œ. ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.");
            System.exit(0); // ì‘ì—… í›„ ì„œë²„ ì¢…ë£Œ
        }
    }
}
",

2. CustomLoginSuccessHandler.java="
package com.project.quiz.config;

import java.io.IOException;

import org.springframework.security.core.Authentication;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import org.springframework.stereotype.Component;

import com.project.quiz.domain.User;
import com.project.quiz.repository.UserRepository;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;

@Component
@RequiredArgsConstructor
public class CustomLoginSuccessHandler implements AuthenticationSuccessHandler {

    private final UserRepository userRepository;

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,
            Authentication authentication) throws IOException, ServletException {

        // 1. ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´ ì¡°íšŒ
        String email = authentication.getName();
        User user = userRepository.findByEmail(email).orElse(null);

        // 2. ê³„ì • ìƒíƒœ í™•ì¸
        if (user != null && "pending".equals(user.getStatus())) {
            // (A) íƒˆí‡´ ëŒ€ê¸° ì¤‘ì´ë©´ -> ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë‹¤ì‹œ ì´ë™ (íŒŒë¼ë¯¸í„° ì¶”ê°€)
            // ë¡œê·¸ì¸ ì„¸ì…˜ì€ ìœ ì§€ëœ ìƒíƒœì§€ë§Œ, í™”ë©´ë§Œ ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ ë³´ì—¬ì¤Œ
            response.sendRedirect("/login?status=pending");
        } else {
            // (B) ì •ìƒ íšŒì›ì´ë©´ -> ë©”ì¸ìœ¼ë¡œ ì´ë™
            response.sendRedirect("/main");
        }
    }
}
",

3. GeminiConfig.java="
package com.project.quiz.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import com.project.quiz.service.GeminiTestService; // ê¸°ì¡´êº¼
import com.project.quiz.service.QuizAiService;   // â­ [ì¶”ê°€] ìƒˆë¡œ ë§Œë“  ì¸í„°í˜ì´ìŠ¤

import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.googleai.GoogleAiGeminiChatModel;
import dev.langchain4j.service.AiServices;

@Configuration
public class GeminiConfig {
    
    @Value("${gemini.api.key}") // application.properties í™•ì¸ í•„ìˆ˜
    private String apiKey;

    // 1. ëª¨ë¸ ìƒì„±
    @Bean
    public ChatLanguageModel geminiChatModel() {
        return GoogleAiGeminiChatModel.builder()
                .apiKey(apiKey)
                .modelName("gemini-2.5-flash-lite") // â­ ëª¨ë¸ëª… í™•ì¸ (2.5ëŠ” ì•„ì§ ì—†ì„ ìˆ˜ ìˆìŒ, 1.5 flash ì¶”ì²œ)
                .temperature(0.7)
                .build();
    }

    // 2. ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ì„œë¹„ìŠ¤ (ìœ ì§€)
    @Bean
    public GeminiTestService geminiTestService(ChatLanguageModel model) {
        return AiServices.create(GeminiTestService.class, model);
    }

    // 3. â­ [ì¶”ê°€] í€´ì¦ˆ ìƒì„± ì„œë¹„ìŠ¤ ë“±ë¡
    @Bean
    public QuizAiService quizAiService(ChatLanguageModel model) {
        return AiServices.create(QuizAiService.class, model);
    }
}
",

4. GlobalControllerAdvice.java="
package com.project.quiz.config;

import java.security.Principal;
import java.util.List;

import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ModelAttribute;

import com.project.quiz.domain.NotificationRecipient;
import com.project.quiz.domain.User;
import com.project.quiz.repository.BoardRepository;
import com.project.quiz.repository.NotificationRecipientRepository;
import com.project.quiz.repository.UserRepository;

import lombok.RequiredArgsConstructor;

@RequiredArgsConstructor
@ControllerAdvice // ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ ì „ì—­ì—ì„œ ë™ì‘í•˜ê²Œ í•¨
public class GlobalControllerAdvice {

    private final UserRepository userRepository;
    private final NotificationRecipientRepository notificationRecipientRepository;
    private final BoardRepository boardRepository;

    // ëª¨ë“  ìš”ì²­ë§ˆë‹¤ ì´ ë©”ì„œë“œê°€ ë¨¼ì € ì‹¤í–‰ë˜ì–´ modelì— "user"ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì •ë³´ë¥¼ ë‹´ì•„ì¤Œ
    @ModelAttribute
    public void addUserDetails(Model model, Principal principal) {
    	boardRepository.findFirstByBoardTypeCodeOrderByCreatedAtDesc("notice")
        .ifPresent(notice -> model.addAttribute("latestNotice", notice));
    	
    	if (principal != null) {
            String email = principal.getName();
            User user = userRepository.findByEmail(email).orElse(null);
            
            if (user != null) {
                // 1. ë¡œê·¸ì¸ ìœ ì € ì •ë³´ ë‹´ê¸° (ê¸°ì¡´ ì½”ë“œ)
                model.addAttribute("user", user);

                // ----------------------------------------------------
                // [ì¶”ê°€] 2. ì•Œë¦¼ ë°ì´í„° ë‹´ê¸° (ìƒˆë¡œê³ ì¹¨ ì‹œ ìœ ì§€ìš©)
                // ----------------------------------------------------
                
                // (1) ë‚´ ì•Œë¦¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìµœì‹ ìˆœ)
                List<NotificationRecipient> notifications = 
                    notificationRecipientRepository.findByUserOrderByNotification_CreatedAtDesc(user);
                
                // (2) ì•ˆ ì½ì€ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
                long unreadCount = notificationRecipientRepository.countByUserAndIsReadFalse(user);

                // (3) HTML(topbar2.html)ì—ì„œ ì“¸ ì´ë¦„ìœ¼ë¡œ ëª¨ë¸ì— ì¶”ê°€
                model.addAttribute("notifications", notifications);
                model.addAttribute("unreadCount", unreadCount);
                // ----------------------------------------------------
            }
        }
    }
}
",

5. OAuth2SuccessHandler.java="
package com.project.quiz.config;

import java.io.IOException;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.security.web.authentication.SimpleUrlAuthenticationSuccessHandler;
import org.springframework.stereotype.Component;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;

@Component
public class OAuth2SuccessHandler extends SimpleUrlAuthenticationSuccessHandler {

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,
            Authentication authentication) throws IOException, ServletException {
        
        OAuth2User oAuth2User = (OAuth2User) authentication.getPrincipal();
        Boolean isNew = (Boolean) oAuth2User.getAttribute("isNew");

        if (Boolean.TRUE.equals(isNew)) {
            // â­ [ìˆ˜ì •] ì„¸ì…˜ì„ í­íŒŒí•˜ì§€ ì•Šê³ , 'ì¸ì¦ ì •ë³´'ë§Œ ì‚­ì œí•©ë‹ˆë‹¤.
            // ì´ë ‡ê²Œ í•˜ë©´ SecurityConfigì˜ invalidSessionUrl ê°ì§€ ë¡œì§ì— ê±¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
            
            // 1. ì‹œíë¦¬í‹° ì»¨í…ìŠ¤íŠ¸ ë¹„ìš°ê¸° (ì‹¤ì§ˆì  ë¡œê·¸ì•„ì›ƒ)
            SecurityContextHolder.clearContext();
            
            // 2. ì„¸ì…˜ì— ë‚¨ì•„ìˆëŠ” ì‹œíë¦¬í‹° ì†ì„±ë§Œ ì œê±° (ì„¸ì…˜ ìì²´ëŠ” ìœ ì§€)
            HttpSession session = request.getSession(false);
            if (session != null) {
                session.removeAttribute("SPRING_SECURITY_CONTEXT");
            }

            // 3. ì´ì œ ì•ˆì „í•˜ê²Œ ê°€ì… ì„±ê³µ í˜ì´ì§€ë¡œ ì´ë™ (ë¹„ë¡œê·¸ì¸ ìƒíƒœ)
            getRedirectStrategy().sendRedirect(request, response, "/signup/success");
            
        } else {
            // ê¸°ì¡´ íšŒì›ì€ ë¡œê·¸ì¸ ìœ ì§€í•œ ì±„ ë©”ì¸ìœ¼ë¡œ
            getRedirectStrategy().sendRedirect(request, response, "/main");
        }
    }
}
",

6. QRCodeService.java="
package com.project.quiz.config;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

import org.springframework.stereotype.Service;

import com.google.zxing.BarcodeFormat;
import com.google.zxing.EncodeHintType;
import com.google.zxing.WriterException;
import com.google.zxing.client.j2se.MatrixToImageWriter;
import com.google.zxing.common.BitMatrix;
import com.google.zxing.qrcode.QRCodeWriter;

@Service
public class QRCodeService {
    public byte[] generateQRCodeImage(String text, int width, int height) throws WriterException, IOException {
        QRCodeWriter qrCodeWriter = new QRCodeWriter();
        Map<EncodeHintType, Object> hints = new HashMap<>();
        hints.put(EncodeHintType.CHARACTER_SET, "UTF-8");
        BitMatrix bitMatrix = qrCodeWriter.encode(text, BarcodeFormat.QR_CODE, width, height, hints);

        ByteArrayOutputStream pngOutputStream = new ByteArrayOutputStream();
        MatrixToImageWriter.writeToStream(bitMatrix, "PNG", pngOutputStream);
        return pngOutputStream.toByteArray();
    }
}

",

7. SecurityConfig.java="
package com.project.quiz.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;

import com.project.quiz.service.CustomOAuth2UserService;

import lombok.RequiredArgsConstructor;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

	private final OAuth2SuccessHandler oAuth2SuccessHandler;
	private final CustomLoginSuccessHandler customLoginSuccessHandler;

	@Bean
	public SecurityFilterChain filterChain(HttpSecurity http, CustomOAuth2UserService customOAuth2UserService)
			throws Exception {
		http.authorizeHttpRequests((auth) -> auth
				// 1. í—ˆìš©í•  URL: ì¸ë±ìŠ¤, ë¡œê·¸ì¸, íšŒì›ê°€ì…, ì •ì  ë¦¬ì†ŒìŠ¤(css, js, ì´ë¯¸ì§€)
				.requestMatchers("/", "/index", "/login", "/signup/**", "/register", "/api/user/check-email",
						"/guest/**", "/css/**", "/js/**", "/images/**", "/vendor/**", "/joinroom", "/waitroom/**",
						"/ws/**", "/forgot/**", "/send", "/verify", "/check", "/reset", "/success", "/img/**",
						"/quiz/**", "/quiz-result/**")
				.permitAll().requestMatchers("/api/**").authenticated()

				.requestMatchers("/notice/write").hasRole("ADMIN")
				// [ì¶”ê°€] ê³µì§€ì‚¬í•­ ëª©ë¡/ìƒì„¸ëŠ” ëˆ„êµ¬ë‚˜(í˜¹ì€ ë¡œê·¸ì¸ ìœ ì €) í—ˆìš©
				.requestMatchers("/notice/**").permitAll()

				// 2. ê·¸ ì™¸ ìš”ì²­ì€ ì¸ì¦(ë¡œê·¸ì¸) í•„ìš”
				.anyRequest().authenticated()).formLogin((form) -> form.loginPage("/login") // ë¡œê·¸ì¸ í˜ì´ì§€ URL
						.usernameParameter("email") // HTML í¼ì˜ input name (ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ ì‹œ)
						.passwordParameter("password") // HTML í¼ì˜ input name
						.successHandler(customLoginSuccessHandler).failureUrl("/login?error").permitAll())

				.oauth2Login(oauth2 -> oauth2.loginPage("/login")
						.userInfoEndpoint(userInfo -> userInfo.userService(customOAuth2UserService))

						// â­ [ìˆ˜ì •] ì„±ê³µ ì‹œ í•¸ë“¤ëŸ¬ ì—°ê²° (ê¸°ì¡´ defaultSuccessUrl ëŒ€ì‹  ì‚¬ìš©)
						.successHandler(oAuth2SuccessHandler))
				.logout((logout) -> logout.logoutRequestMatcher(new AntPathRequestMatcher("/logout"))
						.logoutSuccessUrl("/login?logout") // ë¡œê·¸ì•„ì›ƒ ì„±ê³µ ì‹œ ì´ë™í•  í˜ì´ì§€
						.invalidateHttpSession(true).deleteCookies("JSESSIONID"))
				.sessionManagement((session) -> session
						// ì„¸ì…˜ì´ ëŠê¸´ ìƒíƒœë¡œ ì ‘ê·¼í•˜ë©´ ì´ ì£¼ì†Œë¡œ ë³´ëƒ„ (?expired íŒŒë¼ë¯¸í„° ì¶”ê°€)
						.invalidSessionUrl("/login?expired"));
		return http.build();
	}

	// ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ë¹ˆ ë“±ë¡ (DBì— ë¹„ë°€ë²ˆí˜¸ ì €ì¥ ì‹œ í•„ìˆ˜)
	@Bean
	public PasswordEncoder passwordEncoder() {
		return new BCryptPasswordEncoder();
	}
}
",

8. WebMvcConfig.java="
package com.project.quiz.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        // ë¸Œë¼ìš°ì €ì—ì„œ /uploads/** ë¡œ ìš”ì²­í•˜ë©´ -> ë¡œì»¬ì˜ uploads í´ë”ë¥¼ ë³´ì—¬ì¤Œ
        String uploadPath = "file:///" + System.getProperty("user.dir") + "/uploads/";
        
        registry.addResourceHandler("/uploads/**")
                .addResourceLocations(uploadPath);
    }
}
",

9. WebSocketConfig.java="
package com.project.quiz.config;

import java.util.Collections;

import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.Message;
import org.springframework.messaging.MessageChannel;
import org.springframework.messaging.simp.config.ChannelRegistration;
import org.springframework.messaging.simp.config.MessageBrokerRegistry;
import org.springframework.messaging.simp.stomp.StompCommand;
import org.springframework.messaging.simp.stomp.StompHeaderAccessor;
import org.springframework.messaging.support.ChannelInterceptor;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
import org.springframework.web.socket.config.annotation.StompEndpointRegistry;
import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;

import com.project.quiz.repository.UserRepository;

@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

	public WebSocketConfig(UserRepository userRepository) {
	}

	@Override
	public void registerStompEndpoints(StompEndpointRegistry registry) {
		registry.addEndpoint("/ws").withSockJS();
		registry.addEndpoint("/ws/vote").withSockJS();
		registry.addEndpoint("/ws/chat").withSockJS();
		registry.addEndpoint("/ws/friend-chat").withSockJS();
	}

	@Override
	public void configureMessageBroker(MessageBrokerRegistry registry) {
		registry.enableSimpleBroker("/topic", "/queue", "/user");
		registry.setApplicationDestinationPrefixes("/app");

		// notification ìš© ì¶”ê°€
		registry.setUserDestinationPrefix("/user");
	}

	@Override
	public void configureClientInboundChannel(ChannelRegistration registration) {
		registration.interceptors(new ChannelInterceptor() {
			@Override
			public Message<?> preSend(Message<?> message, MessageChannel channel) {
				StompHeaderAccessor accessor = StompHeaderAccessor.wrap(message);

				if (accessor.getCommand() == StompCommand.CONNECT) {

					try {
						// â­ getFirstNativeHeader() ì§ì ‘ ì‚¬ìš© (ì´ê±´ public)
						String userIdHeader = accessor.getFirstNativeHeader("X-User-ID");

						if (userIdHeader != null && !userIdHeader.isEmpty()) {
							String userId = userIdHeader;

							// â­ Principal ì„¤ì •
							UsernamePasswordAuthenticationToken token = new UsernamePasswordAuthenticationToken(userId,
									null, Collections.emptyList());

							accessor.setUser(token);
						}
					} catch (Exception e) {
						System.err.println("âŒ ì—ëŸ¬: " + e.getMessage());
						e.printStackTrace();
					}
				}
				return message;
			}
		});
	}
}

",

10. AchievementController.java="
package com.project.quiz.controller;

import java.security.Principal;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;

import com.project.quiz.domain.Achievement;
import com.project.quiz.domain.User;
import com.project.quiz.domain.UserAchievement;
import com.project.quiz.dto.AchievementDisplayDto;
import com.project.quiz.repository.AchievementRepository;
import com.project.quiz.repository.UserAchievementRepository;
import com.project.quiz.repository.UserRepository;

import lombok.RequiredArgsConstructor;

@Controller
@RequiredArgsConstructor
public class AchievementController {

	private final UserRepository userRepository;
    private final AchievementRepository achievementRepository;
    private final UserAchievementRepository userAchievementRepository;

    // âœ… ì´ ë¶€ë¶„ì´ ìˆì–´ì•¼ /achievement ìš”ì²­ì„ ë°›ì•„ì¤ë‹ˆë‹¤.
    @GetMapping("/achievement")
    public String achievementPage(Model model, Principal principal) {
        if (principal != null) {
            User user = userRepository.findByEmail(principal.getName()).orElse(null);
            if (user != null) {
                // 1. ì „ì²´ ì—…ì  ì¡°íšŒ
                List<Achievement> allAchievements = achievementRepository.findAll();

                // 2. ë‚´ ì§„í–‰ ìƒí™© ì¡°íšŒ
                Map<Long, UserAchievement> myProgressMap = userAchievementRepository.findAllByUser(user)
                        .stream()
                        .collect(Collectors.toMap(ua -> ua.getAchievement().getId(), ua -> ua));

                // 3. DTO ë¦¬ìŠ¤íŠ¸ ìƒì„±
                List<AchievementDisplayDto> displayList = new ArrayList<>();
                for (Achievement ach : allAchievements) {
                    UserAchievement progress = myProgressMap.get(ach.getId());
                    long current = (progress != null) ? progress.getCurrentValue() : 0;
                    boolean achieved = (progress != null) && progress.getIsAchieved();
                    displayList.add(AchievementDisplayDto.of(ach, current, achieved));
                }

                // 4. ì •ë ¬ (ë¯¸ë‹¬ì„± ìœ„, ë‹¬ì„± ì•„ë˜)
                displayList.sort(Comparator.comparing(AchievementDisplayDto::isAchieved)
                        .thenComparing(dto -> dto.getAchievement().getId()));

                model.addAttribute("achievements", displayList);

                // â–¼â–¼â–¼ [ì¶”ê°€] ìƒë‹¨ ìš”ì•½ìš© ê°œìˆ˜ ê³„ì‚° â–¼â–¼â–¼
                int totalCount = displayList.size();
                long achievedCount = displayList.stream().filter(AchievementDisplayDto::isAchieved).count();
                
                model.addAttribute("totalCount", totalCount);
                model.addAttribute("achievedCount", achievedCount);
                
                // í¼ì„¼íŠ¸(ì „ì²´ ì§„í–‰ë¥ ) ê³„ì‚° - 0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ë°©ì§€
                int totalPercent = (totalCount > 0) ? (int)((double)achievedCount / totalCount * 100) : 0;
                model.addAttribute("totalPercent", totalPercent);
            }
        }
        return "achievement";
    }
}
",

11. AttendanceController.java="
package com.project.quiz.controller;

import com.project.quiz.dto.AttendanceEventDto;
import com.project.quiz.service.AttendanceService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import java.security.Principal;
import java.util.List;

@Controller
@RequiredArgsConstructor
public class AttendanceController {

    private final AttendanceService attendanceService;

    // 1. ìƒì„¸ í˜ì´ì§€ í™”ë©´ ì´ë™
    @GetMapping("/attendance/detail")
    public String attendanceDetailPage() {
        return "attendancedetail";
    }

    // 2. [API] ë‹¬ë ¥ ë°ì´í„° ì œê³µ (FullCalendarê°€ ì´ê±¸ í˜¸ì¶œí•¨)
    @GetMapping("/api/attendance/events")
    @ResponseBody
    public ResponseEntity<List<AttendanceEventDto>> getAttendanceEvents(Principal principal) {
        if (principal == null) return ResponseEntity.badRequest().build();
        
        List<AttendanceEventDto> events = attendanceService.getMyAttendanceEvents(principal.getName());
        return ResponseEntity.ok(events);
    }
}
",

12. ChatController.java="
package com.project.quiz.controller;

import org.springframework.messaging.handler.annotation.*;
import org.springframework.stereotype.Controller;
import com.project.quiz.dto.ChatMessage;

@Controller
public class ChatController {

	// í´ë¼ì´ì–¸íŠ¸ê°€ /app/chat/{roomCode}ë¡œ ë©”ì‹œì§€ ì „ì†¡ ì‹œ í˜¸ì¶œë¨
	@MessageMapping("/chat/{roomCode}")
	@SendTo("/topic/chat/{roomCode}")
	public ChatMessage handleRoomChat(@DestinationVariable("roomCode") String roomCode, ChatMessage message) {
		// í•„ìš” ì‹œ ë©”ì‹œì§€ ê²€ì¦/í•„í„°ë§/ë¡œê·¸ ì €ì¥ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
		return message; // ê°™ì€ ë°© ì°¸ê°€ìì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
	}
}

",

13. ForgotController.java="
package com.project.quiz.controller;

import com.project.quiz.service.UserService;
import jakarta.servlet.http.HttpSession;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.security.Principal;
import java.time.LocalDateTime;
import java.time.temporal.ChronoUnit;

@Controller
@RequiredArgsConstructor
@RequestMapping("/forgot")
public class ForgotController {

    private final UserService userService;

    // 1. ì´ë©”ì¼ ì…ë ¥ í˜ì´ì§€
    @GetMapping
    public String forgotPage(Principal principal) {
        if (principal != null) return "redirect:/main";
        return "forgot";
    }

    // 2. [POST] ì´ë©”ì¼ ì „ì†¡ (ì„¸ì…˜ ì‹œì‘)
    @PostMapping("/send")
    public String sendVerificationCode(@RequestParam("email") String email, 
                                       HttpSession session, 
                                       Model model) {
        try {
            userService.sendVerificationCode(email);
            
            // â˜… ì¤‘ìš”: ë³€ìˆ˜ëª… í†µì¼ (verifyEmail, verifyExpireAt)
            session.setAttribute("verifyEmail", email);
            session.setAttribute("verifyExpireAt", LocalDateTime.now().plusSeconds(180));
            
            return "redirect:/forgot/verify";

        } catch (IllegalArgumentException e) {
            model.addAttribute("error", e.getMessage());
            return "forgot";
        }
    }

    // 3. [GET] ì¸ì¦ í˜ì´ì§€ (íƒ€ì´ë¨¸ ê³„ì‚°)
    @GetMapping("/verify")
    public String verifyPage(HttpSession session, Model model) {
        // â˜… ì¤‘ìš”: ì €ì¥í•œ ì´ë¦„ ê·¸ëŒ€ë¡œ êº¼ë‚´ê¸°
        String email = (String) session.getAttribute("verifyEmail");
        LocalDateTime expireAt = (LocalDateTime) session.getAttribute("verifyExpireAt");

        // ì„¸ì…˜ ì—†ìœ¼ë©´ í‡´ì¥
        if (email == null || expireAt == null) {
            return "redirect:/login?invalid";
        }

        // ì‹œê°„ ê³„ì‚°
        long remainingSeconds = ChronoUnit.SECONDS.between(LocalDateTime.now(), expireAt);

        if (remainingSeconds <= 0) {
            session.invalidate();
            return "redirect:/login?invalid";
        }

        model.addAttribute("remainingSeconds", remainingSeconds);
        return "verify";
    }

    // 4. [POST] ì½”ë“œ ê²€ì¦ (í‹€ë ¸ì„ ë•Œ ì²˜ë¦¬ í¬í•¨)
    @PostMapping("/check")
    public String checkCode(@RequestParam("code") String code, 
                            HttpSession session, 
                            Model model) {
        // â˜… ì¤‘ìš”: ì €ì¥í•œ ì´ë¦„ ê·¸ëŒ€ë¡œ êº¼ë‚´ê¸°
        String email = (String) session.getAttribute("verifyEmail");
        LocalDateTime expireAt = (LocalDateTime) session.getAttribute("verifyExpireAt");

        if (email == null || expireAt == null) {
            return "redirect:/login?invalid";
        }

        boolean isVerified = userService.verifyCode(email, code);

        if (isVerified) {
            // ì„±ê³µ
            session.setAttribute("isVerified", true);
            session.removeAttribute("verifyExpireAt"); // íƒ€ì´ë¨¸ ì œê±°
            return "redirect:/forgot/reset";
        } else {
            // ì‹¤íŒ¨: ì—ëŸ¬ ë©”ì‹œì§€ì™€ í•¨ê»˜ ë‹¤ì‹œ verify í˜ì´ì§€ë¡œ (íƒ€ì´ë¨¸ ìœ ì§€)
            model.addAttribute("error", "ì¸ì¦ ì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            
            long remaining = ChronoUnit.SECONDS.between(LocalDateTime.now(), expireAt);
            model.addAttribute("remainingSeconds", remaining);
            
            return "verify"; 
        }
    }

    // 5. [GET] ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í˜ì´ì§€
    @GetMapping("/reset")
    public String resetPasswordPage(HttpSession session) {
        if (session.getAttribute("verifyEmail") == null || session.getAttribute("isVerified") == null) {
            return "redirect:/login?invalid";
        }
        return "resetpassword";
    }

    // 6. [POST] ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìˆ˜í–‰
    @PostMapping("/reset")
    public String updatePassword(@RequestParam("password") String password, 
                                 HttpSession session) {
        String email = (String) session.getAttribute("verifyEmail");
        
        userService.updatePassword(email, password);

        session.removeAttribute("verifyEmail");
        session.removeAttribute("isVerified");
        
        return "redirect:/forgot/success"; 
    }

    // 7. ì„±ê³µ í˜ì´ì§€
    @GetMapping("/success")
    public String successPage() {
        return "resetsuccess";
    }
}
",

14. FriendMessageController.java="
package com.project.quiz.controller;

import java.util.*;
import org.springframework.http.ResponseEntity;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;
import org.springframework.transaction.annotation.Transactional;

import com.project.quiz.domain.*;
import com.project.quiz.dto.*;
import com.project.quiz.repository.*;
import com.project.quiz.service.*;

import lombok.RequiredArgsConstructor;

@RestController
@RequestMapping("/api/friend-messages")
@RequiredArgsConstructor
public class FriendMessageController {

	private final FriendMessageService friendMessageService;
	private final FriendMessageRepository friendMessageRepository;
	private final FriendshipRepository friendshipRepository;
	private final UserRepository userRepository;
	private final SimpMessagingTemplate messagingTemplate; // â­ WebSocket ì „ì†¡ìš©

	/**
	 * ë©”ì‹œì§€ ì „ì†¡ POST /api/friend-messages/send âœ… WebSocket + HTTP í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹
	 */
	@PostMapping("/send")
	@Transactional // â­ ì¶”ê°€: LAZY ë¡œë”© ë¬¸ì œ í•´ê²°
	public ResponseEntity<?> sendMessage(@RequestParam("friendshipId") Long friendshipId,
			@RequestParam("content") String content, Authentication authentication) {

		try {
			Long currentUserId = getCurrentUserId(authentication);

			if (currentUserId == null) {
				return ResponseEntity.badRequest().body("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
			}

			// â­ 1ë‹¨ê³„: Serviceë¡œ ë©”ì‹œì§€ ì €ì¥
			FriendMessageDTO dto = friendMessageService.sendMessage(friendshipId, currentUserId, content);

			dto.setFriendshipId(friendshipId);

			System.out.println("ğŸ” Serviceì—ì„œ ë°›ì€ DTO:");
			System.out.println("   - friendshipId: " + dto.getFriendshipId()); // nullì¸ê°€?
			System.out.println("   - senderName: " + dto.getSenderName()); // nullì¸ê°€?
			System.out.println("   - profileImage: " + dto.getProfileImage()); // nullì¸ê°€?

			// â­ 2ë‹¨ê³„: ë°œì‹ ì ì •ë³´ ì„¤ì • (userProfileì—ì„œ ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°)
			User sender = userRepository.findById(currentUserId).orElse(null);
			if (sender != null && sender.getUserProfile() != null) {
				dto.setSenderName(sender.getUserProfile().getUsername());
				dto.setProfileImage(sender.getUserProfile().getProfileImage());
			} else if (sender != null) {
				dto.setSenderName(sender.getEmail());
			} else {
				dto.setSenderName("ì•Œ ìˆ˜ ì—†ìŒ");
			}

			// â­ 3ë‹¨ê³„: ìƒëŒ€ë°©(ìˆ˜ì‹ ì) ì°¾ê¸°
			Friendship friendship = friendshipRepository.findById(friendshipId)
					.orElseThrow(() -> new IllegalArgumentException("ì¹œêµ¬ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤"));

			User receiver = friendship.getUser().getId().equals(currentUserId) ? friendship.getFriendUser()
					: friendship.getUser();

			try {
				messagingTemplate.convertAndSendToUser(receiver.getEmail(), // â† user ID ëŒ€ì‹  email!
						"/queue/friend-messages", dto);
				System.out.println("ğŸ” ìˆ˜ì‹ ì ID: " + receiver.getId());
				System.out.println("ğŸ” ìˆ˜ì‹ ì Email: " + receiver.getEmail());
				System.out.println("ğŸ” ë³´ë‚´ëŠ” principal: " + String.valueOf(receiver.getId()));

			} catch (Exception e) {
				System.out.println("âš ï¸ WebSocket ì „ì†¡ ì‹¤íŒ¨: " + e.getMessage());
			}

			return ResponseEntity.ok(dto);

		} catch (Exception e) {
			System.err.println("âŒ ì˜ˆì™¸ ë°œìƒ: " + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(500).body("ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: " + e.getMessage());
		}
	}

	/**
	 * í˜„ì¬ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
	 */
	private Long getCurrentUserId(Authentication authentication) {
		if (authentication == null || !authentication.isAuthenticated()) {
			return null;
		}

		// 1. Principal íƒ€ì… í™•ì¸ ì—†ì´ ë°”ë¡œ ì´ë¦„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. (ê°€ì¥ ì•ˆì „í•œ ë°©ë²•)
		// ì¼ë°˜ ë¡œê·¸ì¸: ì´ë©”ì¼/ID, OAuth2: ì´ë©”ì¼/Sub ID ë“±ì´ ë“¤ì–´ì˜´
		String emailOrUsername = authentication.getName();

		// 2. DBì—ì„œ ì¡°íšŒ
		User user = userRepository.findByEmail(emailOrUsername).orElse(null);

		// 3. ë§Œì•½ ì´ë©”ì¼ë¡œ ëª» ì°¾ì•˜ë‹¤ë©´, í˜¹ì‹œ ë‹‰ë„¤ì„ì¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì¶”ê°€ ë¡œì§ (í•„ìš” ì‹œ)
		// (ì§€ê¸ˆ êµ¬ì¡°ìƒ ì´ë©”ì¼ì´ IDë¼ë©´ ìœ„ ì½”ë“œë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤)

		if (user != null) {
			return user.getId();
		}

		return null;
	}

	/**
	 * â­ í˜„ì¬ ì‚¬ìš©ìì˜ ì•ˆ ì½ì€ ì¹œêµ¬ ë©”ì‹œì§€ 5ê°œ ì¡°íšŒ (ë“œë¡­ë‹¤ìš´ìš©) GET /api/friend-messages/unread/list
	 */
	@GetMapping("/unread/list")
	public ResponseEntity<List<Map<String, Object>>> getUnreadMessages(Authentication authentication) {
		try {
			Long currentUserId = getCurrentUserId(authentication);

			if (currentUserId == null) {
				return ResponseEntity.badRequest().body(new ArrayList<>());
			}

			// â­ ë°œì‹ ìë³„ ê·¸ë£¹í™”ëœ ë©”ì‹œì§€ ì¡°íšŒ
			List<Map<String, Object>> messages = friendMessageService.getUnreadMessages(currentUserId);

			return ResponseEntity.ok(messages);

		} catch (Exception e) {
			System.err.println("âŒ ì•ˆ ì½ì€ ë©”ì‹œì§€ ì¡°íšŒ ì‹¤íŒ¨: " + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(500).body(new ArrayList<>());
		}
	}

	/**
	 * ë©”ì‹œì§€ ì¡°íšŒ GET /api/friend-messages/{friendshipId}
	 * 
	 * âœ… friendshipIdë¡œ ì¡°íšŒí•˜ëŠ” ë²„ì „ (ê¸°ì¡´: friendUserIdë¡œ ì¡°íšŒ)
	 */
	@GetMapping("/{friendshipId}")
	public ResponseEntity<List<FriendMessageDTO>> getMessages(@PathVariable("friendshipId") Long friendshipId,
			Authentication authentication) {
		try {
			// â­ getCurrentUserId() ì‚¬ìš©
			Long currentUserId = getCurrentUserId(authentication);
			if (currentUserId == null) {
				return ResponseEntity.badRequest().body(new ArrayList<>());
			}

			// ë©”ì‹œì§€ ì¡°íšŒ
			List<FriendMessageDTO> messages = friendMessageService.getMessages(friendshipId, currentUserId);

			// â­ [ì¤‘ìš”] ëª¨ë“  ë©”ì‹œì§€ì— senderName ì„¤ì •
			for (FriendMessageDTO msg : messages) {
				if (msg.getSenderName() == null || msg.getSenderName().isEmpty()) {
					// senderIdë¡œ User ì¡°íšŒí•´ì„œ ì´ë¦„ ì„¤ì •
					User sender = userRepository.findById(msg.getSenderId()).orElse(null);
					if (sender != null && sender.getUserProfile() != null) {
						msg.setSenderName(sender.getUserProfile().getUsername());
					} else if (sender != null) {
						msg.setSenderName(sender.getEmail());
					} else {
						msg.setSenderName("Unknown");
					}
				}
			}

			return ResponseEntity.ok(messages);

		} catch (

		Exception e) {
			e.printStackTrace();
			return ResponseEntity.status(500).body(new ArrayList<>()); // â† ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
		}
	}

	/**
	 * ì¹œêµ¬ ì‚­ì œ
	 */
	@DeleteMapping("/friendship/{friendshipId}")
	@Transactional // â­ ì¶”ê°€
	public ResponseEntity<?> deleteFriendship(@PathVariable("friendshipId") Long friendshipId,
			Authentication authentication) {

		try {
			Long currentUserId = getCurrentUserId(authentication);

			if (currentUserId == null) {
				return ResponseEntity.badRequest().body("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
			}

			Friendship friendship = friendshipRepository.findById(friendshipId)
					.orElseThrow(() -> new IllegalArgumentException("ì¹œêµ¬ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤"));

			// ë³¸ì¸ì´ ì¹œêµ¬ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
			if (!friendship.getUser().getId().equals(currentUserId)
					&& !friendship.getFriendUser().getId().equals(currentUserId)) {
				return ResponseEntity.status(403).body("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤");
			}

			// ì¹œêµ¬ ì‚­ì œ
			friendMessageService.deleteFriendship(friendshipId);

			return ResponseEntity.ok("ì¹œêµ¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤");
		} catch (IllegalArgumentException e) {
			return ResponseEntity.badRequest().body(e.getMessage());
		} catch (Exception e) {
			System.err.println("âŒ ì¹œêµ¬ ì‚­ì œ ì‹¤íŒ¨: " + e.getMessage());
			return ResponseEntity.status(500).body("ì¹œêµ¬ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
		}
	}

	/**
	 * ì¹œêµ¬ ë³µêµ¬
	 */
	@PutMapping("/friendship/{friendshipId}/restore")
	@Transactional // â­ ì¶”ê°€
	public ResponseEntity<?> restoreFriendship(@PathVariable("friendshipId") Long friendshipId,
			Authentication authentication) {

		try {
			Long currentUserId = getCurrentUserId(authentication);

			if (currentUserId == null) {
				return ResponseEntity.badRequest().body("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
			}

			Friendship friendship = friendshipRepository.findById(friendshipId)
					.orElseThrow(() -> new IllegalArgumentException("ì¹œêµ¬ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤"));

			if (!friendship.getUser().getId().equals(currentUserId)
					&& !friendship.getFriendUser().getId().equals(currentUserId)) {
				return ResponseEntity.status(403).body("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤");
			}

			// ì¹œêµ¬ ë³µêµ¬
			friendMessageService.restoreFriendship(friendshipId);

			return ResponseEntity.ok("ì¹œêµ¬ê°€ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤");
		} catch (IllegalArgumentException e) {
			return ResponseEntity.badRequest().body(e.getMessage());
		} catch (Exception e) {
			System.err.println("âŒ ì¹œêµ¬ ë³µêµ¬ ì‹¤íŒ¨: " + e.getMessage());
			return ResponseEntity.status(500).body("ì¹œêµ¬ ë³µêµ¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
		}
	}

	@GetMapping("/friendships/find/{userId}")
	public ResponseEntity<?> findFriendshipIdByUserId(@PathVariable("userId") Long userId,
			Authentication authentication) {

		try {
			Long currentUserId = getCurrentUserId(authentication);

			System.out.println("ğŸ” findFriendshipIdByUserId í˜¸ì¶œ:");
			System.out.println("   - currentUserId (í˜„ì¬ ì‚¬ìš©ì): " + currentUserId);
			System.out.println("   - userId (ìƒëŒ€ë°©): " + userId);

			if (currentUserId == null) {
				return ResponseEntity.badRequest().body("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
			}

			// ì²« ë²ˆì§¸ ê²€ìƒ‰
			var result1 = friendshipRepository.findByUserIdAndFriendUserId(currentUserId, userId);
			System.out.println("   - ì²« ë²ˆì§¸ ê²€ìƒ‰ (í˜„ì¬, ìƒëŒ€): " + result1.isPresent());

			Friendship friendship = result1.orElseGet(() -> {
				var result2 = friendshipRepository.findByUserIdAndFriendUserId(userId, currentUserId);
				System.out.println("   - ë‘ ë²ˆì§¸ ê²€ìƒ‰ (ìƒëŒ€, í˜„ì¬): " + result2.isPresent());
				return result2.orElse(null);
			});

			System.out.println("   - ìµœì¢… friendship: " + (friendship != null ? friendship.getId() : "null"));

			if (friendship == null) {
				System.out.println("   âŒ Friendshipì´ ì—†ìŒ!");
				return ResponseEntity.status(404).body(Map.of("error", "ì¹œêµ¬ ê´€ê³„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤", "userId", userId));
			}

			System.out.println("   âœ… Friendship ì°¾ìŒ: " + friendship.getId());
			return ResponseEntity.ok(Map.of("id", friendship.getId(), "friendshipId", friendship.getId(), "status",
					friendship.getStatus()));

		} catch (Exception e) {
			System.err.println("âŒ friendshipId ì¡°íšŒ ì‹¤íŒ¨: " + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(500).body(Map.of("error", "friendshipId ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"));
		}
	}

	/**
	 * ì±„íŒ…ë°© ì—´ ë•Œ - í•´ë‹¹ ëŒ€í™”ì˜ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì½ìŒ ì²˜ë¦¬ PUT
	 * /api/friend-messages/friendship/{friendshipId}/mark-as-read
	 */
	@PutMapping("/friendship/{friendshipId}/mark-as-read")
	@Transactional
	public ResponseEntity<?> markFriendshipAsRead(@PathVariable("friendshipId") Long friendshipId,
			Authentication authentication) {
		try {
			Long currentUserId = getCurrentUserId(authentication);

			if (currentUserId == null) {
				return ResponseEntity.badRequest().body("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
			}

			Friendship friendship = friendshipRepository.findById(friendshipId)
					.orElseThrow(() -> new IllegalArgumentException("ì¹œêµ¬ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤"));

			if (!friendship.getUser().getId().equals(currentUserId)
					&& !friendship.getFriendUser().getId().equals(currentUserId)) {
				return ResponseEntity.status(403).body("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤");
			}

			List<FriendMessage> unreadMessages = friendMessageRepository
					.findByFriendshipIdAndSenderIdNotAndIsReadFalse(friendshipId, currentUserId);

			int messageCount = unreadMessages.size();

			// ì½ìŒ ì²˜ë¦¬
			friendMessageService.markChatRoomAsRead(friendshipId, currentUserId);

			// â­ ì½ìŒ ì´ë²¤íŠ¸ë¥¼ ë°œì‹ ìì—ê²Œ WebSocketìœ¼ë¡œ ì „ì†¡
			User sender = unreadMessages.stream().map(msg -> userRepository.findById(msg.getSenderId()).orElse(null))
					.filter(Objects::nonNull).findFirst().orElse(null);

			if (sender != null) {
				Map<String, Object> readEvent = Map.of("event", "message-read", "friendshipId", friendshipId, "readBy",
						currentUserId, "messageCount", messageCount);

				try {
					messagingTemplate.convertAndSendToUser(sender.getEmail(), "/queue/friend-messages-read", readEvent);
					System.out.println("âœ… ì½ìŒ ì´ë²¤íŠ¸ ì „ì†¡ë¨: " + sender.getEmail());
				} catch (Exception e) {
					System.out.println("âš ï¸ ì½ìŒ ì´ë²¤íŠ¸ ì „ì†¡ ì‹¤íŒ¨: " + e.getMessage());
				}
			}

			return ResponseEntity.ok(Map.of("message", "ì±„íŒ… ë©”ì‹œì§€ê°€ ì½ìŒ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤", "messageCount", messageCount));

		} catch (IllegalArgumentException e) {
			return ResponseEntity.badRequest().body(e.getMessage());
		} catch (Exception e) {
			System.err.println("âŒ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨: " + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(500).body("ì½ìŒ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
		}
	}

}
",

15. FriendshipController.java="
package com.project.quiz.controller;

import java.util.*;

import org.springframework.http.ResponseEntity;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;

import com.project.quiz.domain.User;
import com.project.quiz.dto.UserSearchResponse;
import com.project.quiz.service.FriendshipService;
import com.project.quiz.service.UserService;

import lombok.*;

@RestController
@RequestMapping("/api/friends")
@RequiredArgsConstructor
public class FriendshipController {

	private final FriendshipService friendshipService;
	private final UserService userService;

	/**
	 * â­ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
	 * 
	 * @AuthenticationPrincipal ëŒ€ì‹  SecurityContextHolder ì‚¬ìš©
	 */
	private Long getCurrentUserId() {
		// SecurityContextHolderì—ì„œ ì¸ì¦ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();

		System.out.println("Authentication: " + authentication);
		System.out.println("Authentication null? " + (authentication == null));

		if (authentication == null || !authentication.isAuthenticated()) {
			System.out.println("âŒ ì¸ì¦ë˜ì§€ ì•ŠìŒ");
			throw new RuntimeException("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
		}

		// ì¸ì¦ëœ ì‚¬ìš©ìì˜ ì´ë©”ì¼(username) ê°€ì ¸ì˜¤ê¸°
		String email = authentication.getName();
		System.out.println("ë¡œê·¸ì¸ ì´ë©”ì¼: " + email);

		// DBì—ì„œ ì‚¬ìš©ì ì¡°íšŒ
		User currentUser = userService.findByEmail(email);
		if (currentUser == null) {
			System.out.println("âŒ DBì—ì„œ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: " + email);
			throw new RuntimeException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		}

		System.out.println("âœ… í˜„ì¬ ì‚¬ìš©ì ID: " + currentUser.getId());
		return currentUser.getId();
	}

	/**
	 * ëª¨ë“  ì¹œêµ¬ ê´€ê³„ ì¡°íšŒ
	 */
	@GetMapping("/all")
	public ResponseEntity<?> getAllFriendships() {

		System.out.println("\n==============================");
		System.out.println("ìš”ì²­ URI: /api/friends/all");
		System.out.println("==============================\n");

		try {
			Long currentUserId = getCurrentUserId();

			// â­ ìˆ˜ì •: getAllFriendships() ì‚¬ìš©
			Map<String, Object> result = friendshipService.getAllFriendships(currentUserId);

			System.out.println("âœ… ì‘ë‹µ ë°˜í™˜ ì™„ë£Œ\n");
			return ResponseEntity.ok(result);
		} catch (Exception e) {
			System.err.println("âŒ ì—ëŸ¬: " + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(401).body(new ErrorResponse(e.getMessage()));
		}
	}

	/**
	 * ì‚¬ìš©ì ê²€ìƒ‰ (ì´ë©”ì¼ë¡œ)
	 */
	@GetMapping("/search")
	public ResponseEntity<?> searchUsers(@RequestParam("email") String email) {

		try {
			Long currentUserId = getCurrentUserId();
			List<UserSearchResponse> results = friendshipService.searchUsersByEmail(email, currentUserId);
			return ResponseEntity.ok(results);
		} catch (RuntimeException e) {
			return ResponseEntity.status(401).body(new ErrorResponse(e.getMessage()));
		}
	}

	/**
	 * ë‚´ê°€ ë°›ì€ ì¹œêµ¬ ìš”ì²­ ëª©ë¡
	 */
	@GetMapping("/requests/received")
	public ResponseEntity<?> getReceivedRequests() {

		try {
			Long currentUserId = getCurrentUserId();
			List<UserSearchResponse> requests = friendshipService.getReceivedRequests(currentUserId);
			return ResponseEntity.ok(requests);
		} catch (RuntimeException e) {
			return ResponseEntity.status(401).body(new ErrorResponse(e.getMessage()));
		}
	}

	/**
	 * ë‚´ê°€ ë³´ë‚¸ ì¹œêµ¬ ìš”ì²­ ëª©ë¡
	 */
	@GetMapping("/requests/sent")
	public ResponseEntity<?> getSentRequests() {

		try {
			Long currentUserId = getCurrentUserId();
			List<UserSearchResponse> requests = friendshipService.getSentRequests(currentUserId);
			return ResponseEntity.ok(requests);
		} catch (RuntimeException e) {
			return ResponseEntity.status(401).body(new ErrorResponse(e.getMessage()));
		}
	}

	/**
	 * ìˆ˜ë½ëœ ì¹œêµ¬ ëª©ë¡
	 */
	@GetMapping("/accepted")
	public ResponseEntity<?> getAcceptedFriends() {

		try {
			Long currentUserId = getCurrentUserId();
			List<UserSearchResponse> friends = friendshipService.getAcceptedFriends(currentUserId);
			return ResponseEntity.ok(friends);
		} catch (RuntimeException e) {
			return ResponseEntity.status(401).body(new ErrorResponse(e.getMessage()));
		}
	}

	/**
	 * ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸°
	 */
	@PostMapping("/request")
	public ResponseEntity<?> sendFriendRequest(@RequestParam("receiverId") Long receiverId) {

		try {
			Long currentUserId = getCurrentUserId();
			friendshipService.sendFriendRequest(currentUserId, receiverId);
			return ResponseEntity.ok("ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.");
		} catch (RuntimeException e) {
			return ResponseEntity.badRequest().body(new ErrorResponse(e.getMessage()));
		}
	}

	/**
	 * ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½
	 */
	@PostMapping("/{friendshipId}/accept")
	public ResponseEntity<?> acceptFriendRequest(@PathVariable("friendshipId") Long friendshipId) {

		try {
			Long currentUserId = getCurrentUserId();
			friendshipService.acceptFriendRequest(friendshipId, currentUserId);
			return ResponseEntity.ok("ì¹œêµ¬ ìš”ì²­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.");
		} catch (RuntimeException e) {
			return ResponseEntity.badRequest().body(new ErrorResponse(e.getMessage()));
		}
	}

	/**
	 * ì¹œêµ¬ ìš”ì²­ ê±°ì ˆ
	 */
	@PostMapping("/{friendshipId}/reject")
	public ResponseEntity<?> rejectFriendRequest(@PathVariable Long friendshipId) {

		try {
			Long currentUserId = getCurrentUserId();
			friendshipService.rejectFriendRequest(friendshipId, currentUserId);
			return ResponseEntity.ok("ì¹œêµ¬ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.");
		} catch (RuntimeException e) {
			return ResponseEntity.badRequest().body(new ErrorResponse(e.getMessage()));
		}
	}

	/**
	 * â­ ì¹œêµ¬ ìš”ì²­ ì°¨ë‹¨
	 */
	@PostMapping("/{friendshipId}/ban")
	public ResponseEntity<?> banFriendRequest(@PathVariable Long friendshipId) {

		try {
			Long currentUserId = getCurrentUserId();
			friendshipService.banFriendRequest(friendshipId, currentUserId);
			return ResponseEntity.ok("ì‚¬ìš©ìë¥¼ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.");
		} catch (RuntimeException e) {
			return ResponseEntity.badRequest().body(new ErrorResponse(e.getMessage()));
		}
	}

	/**
	 * ì¹œêµ¬ ì‚­ì œ
	 */
	@DeleteMapping("/{friendshipId}")
	public ResponseEntity<?> removeFriend(@PathVariable("friendshipId") Long friendshipId) {

		try {
			Long currentUserId = getCurrentUserId();
			friendshipService.removeFriend(friendshipId, currentUserId);
			return ResponseEntity.ok("ì¹œêµ¬ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");
		} catch (RuntimeException e) {
			return ResponseEntity.badRequest().body(new ErrorResponse(e.getMessage()));
		}
	}

}

// â­ ErrorResponse í´ë˜ìŠ¤
@Data
@NoArgsConstructor
@AllArgsConstructor
class ErrorResponse {
	private String message;
}

",

16. GuestUserController.java="
package com.project.quiz.controller;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;

import com.project.quiz.dto.GuestUserDto;
import com.project.quiz.service.GuestUserService;

import org.springframework.ui.Model;

import jakarta.servlet.http.HttpSession;

@Controller
@RequiredArgsConstructor
public class GuestUserController {

	private final GuestUserService guestUserService;

	// ë‹‰ë„¤ì„/ìºë¦­í„° ì„ íƒ í¼ ë³´ì—¬ì£¼ê¸°
	@GetMapping("/guest/setup")
	public String showSetupForm(@RequestParam(name = "next", required = false) String next, Model model) {
		model.addAttribute("next", next);
		return "guest_setup";
	}

	// ë‹‰ë„¤ì„/ìºë¦­í„° ì„ íƒ ì œì¶œ ì²˜ë¦¬
	@PostMapping("/guest/setup")
	public String submitGuestInfo(@RequestParam("nickname") String nickname,
			@RequestParam("characterImageUrl") String characterImageUrl,
			@RequestParam(name = "next", required = false) String next, HttpSession session, Model model) {
		// ìœ íš¨ì„± ì²´í¬
		if (!guestUserService.validateNickname(nickname) || !guestUserService.validateCharacter(characterImageUrl)) {
			model.addAttribute("error", "ë‹‰ë„¤ì„ ë˜ëŠ” ìºë¦­í„°ë¥¼ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.");
			return "guest_setup";
		}

		// ì„¸ì…˜ì— DTO ì €ì¥
		GuestUserDto guestUser = new GuestUserDto(nickname, characterImageUrl);
		// guestIdê°€ ìë™ìœ¼ë¡œ ì„¸íŒ…ë¨
		session.setAttribute("guestUser", guestUser);

		// next(ëª©ì ì§€)ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë°©ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
		if (next != null && !next.isEmpty()) {
			return "redirect:" + next;
		}
		// ì•„ë‹ˆë©´ ê¸°ë³¸ í˜ì´ì§€ë¡œ ì´ë™
		return "redirect:/";
	}

	// í€´ì¦ˆ ì¢…ë£Œ/í‡´ì¥ ì‹œ ì„¸ì…˜ì—ì„œ ì‚­ì œ
	@GetMapping("/exit")
	public String guestExit(HttpSession session) {
		session.removeAttribute("guestUser");
		return "redirect:/";
	}
}

",

17. LoginController.java="
package com.project.quiz.controller;

import java.security.Principal;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;

import com.project.quiz.dto.UserCreateForm;
import com.project.quiz.service.UserService;

import lombok.RequiredArgsConstructor;

@RequiredArgsConstructor // ìƒì„±ì ì£¼ì…ì„ ìœ„í•´ ì¶”ê°€
@Controller
public class LoginController {

	private final UserService userService; // ì„œë¹„ìŠ¤ ì£¼ì…

	@GetMapping("/login")
	public String loginPage(
	        @RequestParam(value = "status", required = false) String status, // â­ íŒŒë¼ë¯¸í„° ë°›ê¸°
	        Principal principal, 
	        Model model) {

	    // â­ [ìˆ˜ì •] ë¡œê·¸ì¸ì´ ë˜ì–´ìˆë”ë¼ë„, statusê°€ pendingì´ë©´ íŠ•ê²¨ë‚´ì§€ ì•ŠìŒ
	    if (principal != null && !"pending".equals(status)) {
	        return "redirect:/main";
	    }

	    // pending ìƒíƒœë¼ë©´ ëª¨ë¸ì— ê°’ì„ ë‹´ì•„ HTMLë¡œ ì „ë‹¬
	    if ("pending".equals(status)) {
	        model.addAttribute("isPending", true);
	    }
	    
	    return "login";
	}
	
	@GetMapping("/signup")
	public String signupPage(Principal principal) {
		if (principal != null) {
			return "redirect:/main";
		}
		return "signup"; // signup.html ë³´ì—¬ì¤Œ
	}

	// â–¼â–¼â–¼ íšŒì›ê°€ì… ì²˜ë¦¬ ë¡œì§ ì¶”ê°€ â–¼â–¼â–¼
	@PostMapping("/register")
    public String signup(UserCreateForm userCreateForm) {
        userService.create(userCreateForm.getUsername(), 
                           userCreateForm.getEmail(), 
                           userCreateForm.getPassword());
        
        // [ë³€ê²½] ë¡œê·¸ì¸ í˜ì´ì§€ê°€ ì•„ë‹ˆë¼ -> ê°€ì… ì„±ê³µ í˜ì´ì§€ë¡œ ì´ë™
        return "redirect:/signup/success"; 
    }

    // â–¼â–¼â–¼ [ì¶”ê°€] ê°€ì… ì„±ê³µ í˜ì´ì§€ ë§¤í•‘ â–¼â–¼â–¼
    @GetMapping("/signup/success")
    public String signupSuccess() {
        return "signupsuccess"; // templates/signupsuccess.html í˜¸ì¶œ
    }
}
",

18. MainController.java="
package com.project.quiz.controller;

import java.security.Principal;
import java.util.List;
import java.util.Map;

import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserProfile;
import com.project.quiz.repository.QuizRepository;
import com.project.quiz.repository.UserAchievementRepository;
import com.project.quiz.repository.UserRepository;
import com.project.quiz.service.AttendanceService;
import com.project.quiz.service.UserService;

import lombok.RequiredArgsConstructor;

@RequiredArgsConstructor
@Controller
public class MainController {

	private final AttendanceService attendanceService;
	private final UserAchievementRepository userAchievementRepository;
	private final UserRepository userRepository;
	private final QuizRepository quizRepository;
	private final UserService userService;

	// 1. ë£¨íŠ¸ ì ‘ì† ì‹œ /indexë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ë˜ëŠ” ë°”ë¡œ index ë³´ì—¬ì£¼ê¸°)
	@GetMapping("/")
	public String root(Principal principal) {
		// 1. ë¡œê·¸ì¸í•œ ì‚¬ìš©ì(Principalì´ nullì´ ì•„ë‹˜)ë¼ë©´ -> ë©”ì¸ìœ¼ë¡œ
		if (principal != null) {
			return "redirect:/main";
		}

		// 2. ë¡œê·¸ì¸ ì•ˆ í•œ ì†ë‹˜ì´ë¼ë©´ -> ì¸ë±ìŠ¤ë¡œ
		return "redirect:/index";
	}

	// 2. ì¸ë±ìŠ¤ í˜ì´ì§€ (ë¹„ë¡œê·¸ì¸ ì ‘ê·¼ ê°€ëŠ¥)
	@GetMapping("/index")
	public String index(Principal principal) {
		if (principal != null) {
			return "redirect:/main";
		}
		return "index";
	}

	// 3. ë©”ì¸ í˜ì´ì§€ (ë¡œê·¸ì¸ í›„ ì ‘ê·¼ í›„ ë°”ë¡œ ì¶œì„ì²´í¬ ë¶ˆëŸ¬ì˜´. ìˆ˜ì •-2025-11-27)
	@GetMapping("/main")
	public String mainPage(Model model, Principal principal) {
		if (principal != null) {
			// â­â­â­ ë””ë²„ê¹… ì‹œì‘ â­â­â­
			System.out.println("========== mainPage ì‹œì‘ ==========");
			System.out.println("principal.getName(): " + principal.getName());

			User user = userRepository.findByEmail(principal.getName()).orElse(null);

			System.out.println("DBì—ì„œ ì°¾ì€ user: " + user);

			if (user != null) {
				Long userId = user.getId();

				System.out.println("ì‚¬ìš©ì ID: " + userId);
				System.out.println("ì‚¬ìš©ì ì´ë©”ì¼: " + user.getEmail());
				System.out.println("ì‚¬ìš©ì ìƒíƒœ: " + user.getStatus());

				if ("pending".equals(user.getStatus())) {
					model.addAttribute("isAccountPending", true);
				}

				if ("deleted".equals(user.getStatus())) {
					SecurityContextHolder.clearContext();
					return "redirect:/login?error=deleted";
				}

				boolean checkedIn = attendanceService.hasCheckedInToday(principal.getName());
				model.addAttribute("checkedIn", checkedIn);

				long achievedCount = userAchievementRepository.countByUserAndIsAchievedTrue(user);
				model.addAttribute("achievedCount", achievedCount);

				long createdCount = quizRepository.countByUserId(userId);
				model.addAttribute("createdCount", createdCount);

				// â­â­â­ ì—¬ê¸°ì„œ userId í™•ì¸ â­â­â­
				System.out.println("getUserAnswerStats í˜¸ì¶œ ì „ userId: " + userId);

				Map<String, Long> stats = userService.getUserAnswerStats(userId);

				System.out.println("ì •ë‹µ ê°œìˆ˜: " + stats.get("correct"));
				System.out.println("ì˜¤ë‹µ ê°œìˆ˜: " + stats.get("wrong"));
				System.out.println("========== ë¡œë“œ ì™„ë£Œ ==========");

				model.addAttribute("correctCount", stats.get("correct"));
				model.addAttribute("wrongCount", stats.get("wrong"));
			} else {
				System.out.println("âŒ findByEmail ì‹¤íŒ¨ - ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!");
			}
		} else {
			System.out.println("âŒ principalì´ nullì…ë‹ˆë‹¤!");
		}

		List<UserProfile> topUsers = userService.getTopUsersByPointBalance();
		model.addAttribute("topUsers", topUsers);

		System.out.println("ğŸ“Š ë©”ì¸ í˜ì´ì§€ ë¡œë“œ - ìƒìœ„ " + topUsers.size() + "ëª… ë¦¬ë”ë³´ë“œ");

		return "main";
	}

	// ì¶œì„ì²´í¬ AJAX ìš”ì²­ ì²˜ë¦¬
	@PostMapping("/api/attendance/check")
	@ResponseBody
	public ResponseEntity<String> doAttendance(Principal principal) {
		try {
			attendanceService.checkIn(principal.getName());
			return ResponseEntity.ok("ì¶œì„ì²´í¬ ì™„ë£Œ! 100Pê°€ ì ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤.");
		} catch (IllegalStateException e) {
			return ResponseEntity.badRequest().body(e.getMessage());
		} catch (Exception e) {
			e.printStackTrace();
			return ResponseEntity.status(500).body("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		}
	}
}
",

19. NoticeController.java="
package com.project.quiz.controller;

import java.security.Principal;
import java.util.List;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import com.project.quiz.domain.BoardPost;
import com.project.quiz.service.BoardService;

import lombok.RequiredArgsConstructor;

@Controller
@RequestMapping("/notice")
@RequiredArgsConstructor
public class NoticeController {

    private final BoardService boardService;

    // 1. ê³µì§€ì‚¬í•­ ëª©ë¡
    @GetMapping
    public String noticeList(Model model) {
        List<BoardPost> notices = boardService.getNoticeList();
        model.addAttribute("notices", notices);
        
        // â­ ìˆ˜ì •ë¨: layout í´ë”ì˜ notice.htmlì„ ë°”ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.
        return "notice"; 
    }

    // 2. ê³µì§€ì‚¬í•­ ìƒì„¸
    @GetMapping("/{id}")
    public String noticeDetail(@PathVariable("id") Long id, Model model) {
        BoardPost post = boardService.getPost(id);
        model.addAttribute("post", post);
        return "noticedetail"; // ì´ê±´ ìƒì„¸ í˜ì´ì§€ìš© (ë‚˜ì¤‘ì— í•„ìš”í•˜ë©´ ìƒì„±)
    }

    // 3. ê³µì§€ì‚¬í•­ ì‘ì„± í¼ (ê´€ë¦¬ì)
    @GetMapping("/write")
    public String noticeWriteForm(Principal principal) {
        if (principal == null) return "redirect:/login";
        return "noticewrite"; // ê¸€ì“°ê¸° í¼ íŒŒì¼ ê²½ë¡œ
    }

    // 4. ì‘ì„± ì²˜ë¦¬
    @PostMapping("/write")
    public String noticeWrite(@RequestParam("title") String title,
                              @RequestParam("content") String content,
                              Principal principal) {
        if (principal == null) return "redirect:/login";
        boardService.writeNotice(principal.getName(), title, content);
        return "redirect:/notice";
    }
}
",

20. NotificationApiController.java="
package com.project.quiz.controller;

import com.project.quiz.domain.NotificationRecipient;
import com.project.quiz.repository.NotificationRecipientRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.transaction.annotation.Transactional;

@RestController
@RequestMapping("/api/notification")
@RequiredArgsConstructor
public class NotificationApiController {

    private final NotificationRecipientRepository recipientRepository;

    @PostMapping("/{id}/read")
    @Transactional
    public ResponseEntity<?> readNotification(@PathVariable("id") Long id) {
        NotificationRecipient recipient = recipientRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤."));
        
        recipient.markAsRead(); // isRead = true, readAt = now() ì²˜ë¦¬
        
        return ResponseEntity.ok().build();
    }
}
",

21. ParticipantController.java="
package com.project.quiz.controller;

import lombok.RequiredArgsConstructor;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;

import com.project.quiz.domain.Participant;
import com.project.quiz.domain.Room;
import com.project.quiz.service.ParticipantService;
import com.project.quiz.service.RoomService;

@Controller
@RequiredArgsConstructor
public class ParticipantController {
	private final ParticipantService participantService;
	@Autowired
	private final RoomService roomService;

	@PostMapping("/participant/save")
	@ResponseBody
	public String saveParticipant(@RequestBody Participant participant) {
		participantService.saveParticipant(participant);
		return "saved";
	}

	@GetMapping("/participant/list/{roomCode}")
	@ResponseBody
	public List<Participant> getParticipants(@PathVariable("roomCode") String roomCode) {
		Room room = roomService.getRoomByCode(roomCode); // ì¼ê´€ì„± ìˆê²Œ roomCode ì‚¬ìš©
		return participantService.findByRoom(room);
	}
}

",

22. PointApiController.java="
package com.project.quiz.controller;

import java.security.Principal;
import java.util.List;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import com.project.quiz.dto.PointHistoryDto;
import com.project.quiz.service.PointService;

import lombok.RequiredArgsConstructor;

@RestController
@RequiredArgsConstructor
public class PointApiController {

    private final PointService pointService;

    @GetMapping("/api/point/history")
    public ResponseEntity<List<PointHistoryDto>> getMyPointHistory(Principal principal) {
        if (principal == null) {
            return ResponseEntity.badRequest().build();
        }
        return ResponseEntity.ok(pointService.getPointHistory(principal.getName()));
    }
}
",

23. ProfileController.java="
package com.project.quiz.controller;

import java.security.Principal;
import java.time.LocalDateTime;
import java.util.List;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserAchievement;
import com.project.quiz.domain.UserActivityLog;
import com.project.quiz.domain.UserInventory;
import com.project.quiz.domain.UserProfile;
import com.project.quiz.dto.TimelineDto;
import com.project.quiz.repository.QuizSubmissionRepository;
import com.project.quiz.repository.UserAchievementRepository;
import com.project.quiz.repository.UserActivityLogRepository;
import com.project.quiz.repository.UserProfileRepository;
import com.project.quiz.repository.UserRepository;
import com.project.quiz.service.FriendshipService;
import com.project.quiz.service.InventoryService;
import com.project.quiz.service.TimelineService;
import com.project.quiz.service.UserService;

import lombok.RequiredArgsConstructor;

@Controller
@RequiredArgsConstructor
public class ProfileController {

	private final UserService userService;
	private final InventoryService inventoryService;
	private final UserRepository userRepository;// ì„œë¹„ìŠ¤ ì£¼ì…
	private final TimelineService timelineService;
	private final UserAchievementRepository userAchievementRepository;
	private final UserProfileRepository userProfileRepository;
	private final UserActivityLogRepository userActivityLogRepository;
	private final FriendshipService friendshipService;
    private final QuizSubmissionRepository quizSubmissionRepository;

	// í”„ë¡œí•„ í˜ì´ì§€ ì´ë™
	@GetMapping({ "/profile", "/profile/{profileId}" })
	public String profilePage(
	        @PathVariable(value = "profileId", required = false) String profileId,
	        Model model, 
	        Principal principal
	) { 
	    // 1. ë¡œê·¸ì¸ ì²´í¬ ë° ì‚¬ìš©ì ë¡œë“œ
	    User currentUser = null;
	    if (principal != null) {
	        currentUser = userRepository.findByEmail(principal.getName()).orElse(null);
	    }

	    // 2. ë³´ì—¬ì¤„ ëŒ€ìƒ(Target User) ê²°ì •
	    User targetUser = null;
	    if (profileId != null) {
	        // (A) íƒ€ì¸ í”„ë¡œí•„
	        UserProfile targetProfile = userProfileRepository.findById(profileId)
	                .orElseThrow(() -> new IllegalArgumentException("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í”„ë¡œí•„ì…ë‹ˆë‹¤."));
	        targetUser = targetProfile.getUser();
	    } else if (currentUser != null) {
	        // (B) ë‚´ í”„ë¡œí•„
	        targetUser = currentUser;
	    } else {
	        return "redirect:/login";
	    }

	    // =================================================================
	    // â–¼â–¼â–¼ [ìˆ˜ì •ë¨] íƒˆí‡´í•œ ìœ ì € ì²˜ë¦¬ ë¡œì§ (Alert ëŒ€ì‹  í™”ë©´ ë¶„ê¸°ìš© í”Œë˜ê·¸ ì „ë‹¬) â–¼â–¼â–¼
	    // =================================================================
	    if (targetUser != null && !"ACTIVE".equals(targetUser.getStatus())) {
	        model.addAttribute("isWithdrawn", true); // ğŸš© íƒˆí‡´ ìƒíƒœ í”Œë˜ê·¸
	        model.addAttribute("isOwner", false);    // íƒˆí‡´í•œ ê³„ì •ì€ ë‚´ ê³„ì •ì´ ì•„ë‹˜(ë˜ëŠ” ì ‘ê·¼ ë¶ˆê°€)
	        // ì—¬ê¸°ì„œ ë°”ë¡œ ë¦¬í„´í•˜ì—¬, ì•„ë˜ì˜ ì¸ë²¤í† ë¦¬/ì—…ì  ì¡°íšŒ ë¡œì§ì„ ê±´ë„ˆëœë‹ˆë‹¤.
	        // (íƒˆí‡´í•œ ìœ ì €ì˜ ì •ë³´ë¥¼ ì¡°íšŒí•˜ë‹¤ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ìŠ¤í‚µ)
	        return "profile"; 
	    }
	    // â–²â–²â–² ìˆ˜ì • ë â–²â–²â–²


	    // 3. ì •ìƒ íšŒì›ì¸ ê²½ìš° ë‚˜ë¨¸ì§€ ë°ì´í„° ë¡œë“œ (ê¸°ì¡´ ë¡œì§)
	    boolean isOwner = (currentUser != null && targetUser.getId().equals(currentUser.getId()));
	    
	    if (targetUser != null) {
	        model.addAttribute("user", targetUser); // ğŸš© ì •ìƒ ìœ ì € ì •ë³´ ë‹´ê¸°
	        model.addAttribute("isOwner", isOwner);
	        model.addAttribute("isWithdrawn", false);
	        
	        long solvedQuizCount = quizSubmissionRepository.countByUserId(targetUser.getId());
            model.addAttribute("solvedQuizCount", solvedQuizCount);

            // 2. ì¹œêµ¬ ìˆ˜ (FriendshipService í™œìš©)
            // (ê¸°ì¡´ ì„œë¹„ìŠ¤ ë©”ì„œë“œê°€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ .size()ë¡œ ê°œìˆ˜ íŒŒì•…)
            long friendCount = friendshipService.getAcceptedFriends(targetUser.getId()).size();
            model.addAttribute("friendCount", friendCount);

	        // ì¸ë²¤í† ë¦¬, ì—…ì , íƒ€ì„ë¼ì¸ ë“± ì¡°íšŒ
	        String borderUrl = inventoryService.getEquippedItemUrl(targetUser, "BORDER");
	        model.addAttribute("equippedBorderUrl", borderUrl);

	        String themeUrl = inventoryService.getEquippedItemUrl(targetUser, "THEME");
	        model.addAttribute("equippedThemeUrl", themeUrl);

	        List<UserAchievement> achievements = userAchievementRepository
	                .findByUserAndIsAchievedTrueOrderByAchievedAtAsc(targetUser);
	        model.addAttribute("achievements", achievements);

	        List<TimelineDto> timeline = timelineService.getProfileTimeline(targetUser.getEmail());
	        model.addAttribute("timelineList", timeline);
	    }

	    return "profile";
	}

	// ì„¤ì • í˜ì´ì§€ ì´ë™ // ì´ì œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì¶”ê°€ë¨
	@GetMapping("/profile/settings")
	public String settingsPage(Model model, Principal principal,
			// â–¼â–¼â–¼ [Back] ì–´ë””ì„œ ì™”ëŠ”ì§€ ì²´í¬ (ê¸°ë³¸ê°’: profile) â–¼â–¼â–¼
			@RequestParam(value = "source", defaultValue = "profile") String source) {

		if (principal != null) {
			User user = userRepository.findByEmail(principal.getName()).orElseThrow();
			
			boolean canChangeNickname = true;
            String nicknameMessage = null;

            UserActivityLog lastUpdate = userActivityLogRepository
                    .findTopByUserAndActivityTypeOrderByCreatedAtDesc(user, "UPDATE_NICKNAME")
                    .orElse(null);

            if (lastUpdate != null) {
                // ë§ˆì§€ë§‰ ë³€ê²½ ì‹œê°„ + 7ì¼
                LocalDateTime availableDate = lastUpdate.getCreatedAt().plusDays(7);
                
                // í˜„ì¬ ì‹œê°„ì´ ì œí•œ ì‹œê°„ë³´ë‹¤ ì´ì „ì´ë©´ -> ë³€ê²½ ë¶ˆê°€
                if (LocalDateTime.now().isBefore(availableDate)) {
                    canChangeNickname = false;
                    // ì˜ˆ: "2025-01-23 15:30 ì´í›„ ë³€ê²½ ê°€ëŠ¥"
                    nicknameMessage = availableDate.toString().replace("T", " ").substring(0, 16) + " ì´í›„ ë³€ê²½ ê°€ëŠ¥";
                }
            }

			List<UserInventory> myBorders = inventoryService.getMyInventoryByCategory(user, "BORDER");
			List<UserInventory> myThemes = inventoryService.getMyInventoryByCategory(user, "THEME");

			model.addAttribute("myBorders", myBorders);
			model.addAttribute("myThemes", myThemes);
			
			model.addAttribute("canChangeNickname", canChangeNickname);
            model.addAttribute("nicknameMessage", nicknameMessage);

			// í™”ë©´ì— source ì •ë³´ ì „ë‹¬ (ë’¤ë¡œê°€ê¸° ë²„íŠ¼ìš©)
			model.addAttribute("source", source);
		}
		return "profilesettings";
	}

	// â–¼â–¼â–¼ íƒ€ì„ë¼ì¸ í˜ì´ì§€ (ê¸°ì¡´ì— ìˆì—ˆìœ¼ë¯€ë¡œ ìœ ì§€) â–¼â–¼â–¼
	@GetMapping("/profile/timeline")
	public String timelinePage() {
		return "timeline"; // timeline.html ê»ë°ê¸°ë§Œ ë Œë”ë§
	}

	// â–¼â–¼â–¼ [POST] í”„ë¡œí•„ ì €ì¥ ë¡œì§ ì¶”ê°€ â–¼â–¼â–¼
	@PostMapping("/profile/settings/profilesave")
	public String saveProfile(@RequestParam("username") String username,
			@RequestParam("organization") String organization, @RequestParam("bio") String bio,
			@RequestParam(value = "profileImageFile", required = false) MultipartFile profileImageFile,
			@RequestParam(value = "defaultProfileImage", required = false) String defaultProfileImage, // [ì¶”ê°€]
			Principal principal) {

		if (principal != null) {
			// íŒŒë¼ë¯¸í„° 5ê°œ ëª¨ë‘ ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬
			userService.updateProfile(principal.getName(), username, organization, bio, profileImageFile,
					defaultProfileImage);
		}

		return "redirect:/profile/settings?status=success&next=/profile";
	}

	// [POST] ì¥ì°© ì €ì¥
	@PostMapping("/profile/settings/equip")
	public String equipItems(@RequestParam(value = "borderId", required = false) Long borderId,
			@RequestParam(value = "themeId", required = false) Long themeId, Principal principal) {

		User user = userRepository.findByEmail(principal.getName()).orElseThrow();

		inventoryService.equipItem(user, "BORDER", borderId);
		inventoryService.equipItem(user, "THEME", themeId);

		// â–¼â–¼â–¼ [Next] ì„±ê³µ ì‹ í˜¸ + ì´ë™í•  ëª©ì ì§€(profile) ì§€ì • â–¼â–¼â–¼
		return "redirect:/profile/settings?status=success&next=/profile";
	}
}
",

24. QuizAiController.java="
package com.project.quiz.controller;

import com.project.quiz.dto.AiGenRequest;
import com.project.quiz.service.QuizAiService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@Slf4j
@RestController
@RequestMapping("/api/quiz")
@RequiredArgsConstructor
public class QuizAiController {

    private final QuizAiService quizAiService;

    @PostMapping("/generate-ai")
    public ResponseEntity<?> generateQuizAi(@RequestBody AiGenRequest request) {
        try {
            // 1. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì˜¨ type ì½”ë“œ("multiple", "short", "mixed")ë¥¼ 
            //    AIê°€ ì´í•´í•˜ê¸° ì‰¬ìš´ 'êµ¬ì²´ì  ì§€ì‹œì‚¬í•­'ìœ¼ë¡œ ë³€í™˜
            String typeInstruction = switch (request.getType()) {
                case "multiple" -> "ëª¨ë“  ë¬¸ì œë¥¼ 4ì§€ì„ ë‹¤ ê°ê´€ì‹(quizTypeCode: 2)ìœ¼ë¡œë§Œ ì¶œì œí•˜ì„¸ìš”. ì£¼ê´€ì‹ì€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.";
                case "short" -> "ëª¨ë“  ë¬¸ì œë¥¼ ë‹¨ë‹µí˜• ì£¼ê´€ì‹(quizTypeCode: 1)ìœ¼ë¡œë§Œ ì¶œì œí•˜ì„¸ìš”. ê°ê´€ì‹ ë³´ê¸°ëŠ” ì ˆëŒ€ ë§Œë“¤ì§€ ë§ˆì„¸ìš”.";
                case "mixed" -> "ê°ê´€ì‹(quizTypeCode: 2)ê³¼ ì£¼ê´€ì‹(quizTypeCode: 1)ì„ ì ì ˆíˆ ì„ì–´ì„œ ì¶œì œí•˜ì„¸ìš”.";
                default -> "ê°ê´€ì‹ ìœ„ì£¼ë¡œ ì¶œì œí•˜ì„¸ìš”.";
            };

            // 2. ë³€í™˜ëœ ì§€ì‹œì‚¬í•­(typeInstruction)ì„ AI ì„œë¹„ìŠ¤ì— ì „ë‹¬
            String jsonResult = quizAiService.generateQuiz(
                    request.getTopic(),
                    request.getDifficulty(),
                    request.getCount(),
                    typeInstruction // â­ ì—¬ê¸°ê°€ í•µì‹¬! ("multiple" ëŒ€ì‹  ê¸´ ë¬¸ì¥ì´ ë“¤ì–´ê°)
            );

            // 3. ë§ˆí¬ë‹¤ìš´ ì œê±° í›„ ë°˜í™˜ (ê¸°ì¡´ ë¡œì§)
            if (jsonResult.contains("```json")) {
                jsonResult = jsonResult.replaceAll("```json", "").replaceAll("```", "");
            }
            jsonResult = jsonResult.trim();

            return ResponseEntity.ok()
                    .header("Content-Type", "application/json")
                    .body(jsonResult);

        } catch (Exception e) {
            log.error("AI ìƒì„± ì‹¤íŒ¨", e);
            return ResponseEntity.internalServerError().body("AI ë¬¸ì œ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        }
    }
}
",

25. QuizApiController.java="
package com.project.quiz.controller;

import lombok.RequiredArgsConstructor;

import java.util.List;

import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import com.project.quiz.config.SecurityConfig;
import com.project.quiz.domain.Quiz;
import com.project.quiz.dto.QuizDto;
import com.project.quiz.repository.QuizRepository;
import com.project.quiz.service.QuizService;

@RestController
@RequestMapping("/quiz")
@RequiredArgsConstructor
public class QuizApiController {


    private final QuizService quizService;
    private final QuizRepository quizRepository;



    
    @PostMapping("/save")
    public ResponseEntity<?> saveQuiz(@RequestBody QuizDto quizDto) {
        quizService.saveQuiz(quizDto);
        return ResponseEntity.ok("saved");
    }
    
    @PostMapping(value = "/upload-image", consumes = "multipart/form-data")
    public ResponseEntity<?> uploadImage(@RequestParam("file") MultipartFile file) {

        try {
            String fileName = quizService.storeImage(file);
            return ResponseEntity.ok(fileName);
        } catch (Exception e) {
            return ResponseEntity.status(500).body("Upload error");
        }
    }

    // JSON ONLY
    @ResponseBody
    @GetMapping("/api/{id}")
    public QuizDto getQuiz(@PathVariable("id") Long id) {
        return quizService.findQuizDto(id);
    }
    
    @GetMapping("/list")
    public List<QuizDto.ListResponse> getQuizList() {
        return quizService.findAll().stream()
                .map(QuizDto.ListResponse::fromEntity)
                .toList();
    }

    @GetMapping("/api/my")
    public List<QuizDto.ListResponse> myQuizzes() {
        return quizService.findMyQuizzes().stream()
                .map(QuizDto.ListResponse::fromEntity)
                .toList();
    }


    
}
",

26. QuizSubmitController.java="
package com.project.quiz.controller;

import java.security.Principal;
import java.util.Map;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.project.quiz.domain.QuizSubmission;
import com.project.quiz.domain.User;
import com.project.quiz.dto.QuizSubmitRequest;
import com.project.quiz.repository.QuizSubmissionRepository;
import com.project.quiz.service.QuizGradingService;
import com.project.quiz.service.QuizSubmitService;
import com.project.quiz.service.UserService;

import lombok.RequiredArgsConstructor;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/quiz")
public class QuizSubmitController {

    private final QuizSubmitService quizSubmitService;
    private final QuizGradingService quizGradingService;
    private final QuizSubmissionRepository quizSubmissionRepository;
    private final UserService userService; // â­ ìœ ì € ì •ë³´ ì¡°íšŒë¥¼ ìœ„í•´ ì¶”ê°€
    

    @PostMapping("/{quizId}/submit")
    public ResponseEntity<?> submit(
            @PathVariable("quizId") Long quizId,
            @RequestBody QuizSubmitRequest request,
            Principal principal // â­ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ (ì„¸ì…˜)
    ) {
        // 1. ë¡œê·¸ì¸ ì²´í¬ (ë¡œê·¸ì¸ ì•ˆ ëœ ìƒíƒœë©´ ì—ëŸ¬ ì²˜ë¦¬)
        if (principal == null) {
            return ResponseEntity.status(401).body("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }

        // 2. í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì´ë©”ì¼ë¡œ ì‹¤ì œ User ì •ë³´ ì¡°íšŒ
        // (í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë³´ë‚¸ userIdê°€ ë¬´ì—‡ì´ë“  ìƒê´€ì—†ì´, ì—¬ê¸°ì„œ ì§„ì§œ IDë¡œ ë®ì–´ì”ë‹ˆë‹¤.)
        User user = userService.getUserByEmail(principal.getName());
        request.setUserId(user.getId()); // â­ í•µì‹¬: ì§„ì§œ ìœ ì € IDë¡œ êµì²´

        // 3. ì œì¶œ ì €ì¥ (ì´ì œ requestì—ëŠ” ì˜¬ë°”ë¥¸ userIdê°€ ë“¤ì–´ìˆìŠµë‹ˆë‹¤)
        Long submissionId = quizSubmitService.submit(quizId, request);

        // 5. ì±„ì  ê²°ê³¼ ì¡°íšŒ
        QuizSubmission submission = quizSubmissionRepository.findById(submissionId)
                .orElseThrow(() -> new IllegalArgumentException("ì œì¶œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

        int score = submission.getTotalScore() != null ? submission.getTotalScore() : 0;

        // 6. ì´ì (ë§Œì ) ê³„ì‚°
        int maxScore = submission.getQuiz()
                .getQuestions()
                .stream()
                .mapToInt(q -> q.getPoint() != null ? q.getPoint() : 0)
                .sum();
        
        boolean scorePublic = submission.getQuiz().isScorePublic();
        

        // 7. ê²°ê³¼ ë°˜í™˜
        return ResponseEntity.ok(
                Map.of(
                        "submissionId", submissionId,
                        "score", score,
                        "maxScore", maxScore,
                        "scorePublic", scorePublic
                )
        );
    }
}
",

27. QuizViewController.java="
package com.project.quiz.controller;

import java.util.List;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.project.quiz.domain.Quiz;
import com.project.quiz.dto.QuizDto;
import com.project.quiz.service.QuizService;

import lombok.RequiredArgsConstructor;

@Controller
@RequiredArgsConstructor
public class QuizViewController {

//    private final TestGeminiController testGeminiController;
    private final QuizService quizService;

//    QuizViewController(TestGeminiController testGeminiController) {
//        this.testGeminiController = testGeminiController;
//		this.quizService = null;
//    }
	
	@GetMapping("/list")
    public String list(Model model) {

        List<Quiz> quizzes = quizService.findAll();

        System.out.println("===== quiz count: " + quizzes.size());

        model.addAttribute("quizzes", quizzes);
        return "/quiz_list";
    }
	
	@GetMapping("/setquestion")
	public String setquestion(
	        @RequestParam(value = "quizId", required = false) Long quizId,
	        Model model
	) {
	    model.addAttribute("quizId", quizId);
	    return "setquestion";
	}

	
	 // í…œí”Œë¦¿ ë°˜í™˜ ONLY
    @GetMapping("/view/{id}")
    public String view(@PathVariable("id") Long id, Model model) {
        model.addAttribute("quizId", id);
        return "layout/quiz_view"; 
    }
    
    @GetMapping("/my")
    public String myQuizPage() {
        return "/my_quiz";
    }
}
",

28. RoomController.java="
package com.project.quiz.controller;

import java.security.Principal;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

import org.apache.tomcat.util.codec.binary.Base64;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.handler.annotation.DestinationVariable;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.handler.annotation.SendTo;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import com.project.quiz.config.QRCodeService;
import com.project.quiz.domain.Quiz;
import com.project.quiz.domain.Room;
import com.project.quiz.domain.User;
import com.project.quiz.domain.UserProfile;
import com.project.quiz.dto.GuestUserDto;
import com.project.quiz.dto.VoteRequest;
import com.project.quiz.dto.VoteResponse;
import com.project.quiz.service.ParticipantService;
import com.project.quiz.service.QuizService;
import com.project.quiz.service.RoomQuizService;
import com.project.quiz.service.RoomService;
import com.project.quiz.service.UserService;
import com.project.quiz.service.VoteManager;

import jakarta.servlet.http.HttpSession;

@Controller
public class RoomController {
	@Autowired
	private RoomService roomService;

	@Autowired
	private QRCodeService qrCodeService;

	@Autowired
	private UserService userService;

	@Autowired
	private QuizService quizService; // âœ… QuizService ì£¼ì…

	@Autowired
	private RoomQuizService roomQuizService; // âœ… ì´ ì¤„ ì¶”ê°€

	@Autowired
	private ParticipantService participantService;

	@Autowired
	private VoteManager voteManager;

	@Autowired
	private SimpMessagingTemplate messagingTemplate;

	private final Map<String, Map<Long, Boolean>> roomReadyStatus = new ConcurrentHashMap<>();

	@GetMapping("/waitroom/create")
	public String createRoomPost(Principal principal, HttpSession session) {
		if (principal == null) {
			return "redirect:/login";
		}

		// í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´ì—ì„œ ID ê°€ì ¸ì˜¤ê¸°
		User user = userService.findByEmail(principal.getName());
		if (user == null) {
			return "redirect:/login";
		}

		// user.getId()ë¥¼ í˜¸ìŠ¤íŠ¸ìœ ì €ì•„ì´ë””ë¡œ ì‚¬ìš©
		Room room = roomService.createRoom(user.getId(), "opened");

		return "redirect:/waitroom/" + room.getRoomCode();
	}

	@GetMapping("/waitroom/{roomCode}")
	public String showRoomByCode(@PathVariable("roomCode") String roomCode, Model model, Principal principal,
			HttpSession session) {
		Room room = roomService.getRoomByCode(roomCode);
		if (room == null) {
			return "404"; // ë°© ì—†ìŒ ì²˜ë¦¬ í˜ì´ì§€
		}

		if ("CLOSED".equals(room.getStatusCode())) {
			return "room_closed"; // "ì´ ë°©ì€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤" ê°™ì€ ì•ˆë‚´ í…œí”Œë¦¿ ë§Œë“¤ê¸°
		}

		User user = null;
		String guestId = null;
		String nickname = null;
		String avatarUrl = null;

		GuestUserDto guestUser = (GuestUserDto) session.getAttribute("guestUser");

		if (guestUser != null) {
			guestId = guestUser.getGuestId();
			nickname = guestUser.getNickname();
			avatarUrl = guestUser.getCharacterImageUrl();
			System.out.println("ë°© ì°¸ê°€: guestId=" + guestId + ", nickname=" + nickname + ", avatarUrl=" + avatarUrl);
		}

		if (principal != null) {
			user = userService.findByEmail(principal.getName());
		}

		if (user != null) {
			UserProfile userProfile = user.getUserProfile();
			if (userProfile != null) {
				nickname = userProfile.getUsername(); // UserProfileì˜ username ì‚¬ìš©
				avatarUrl = userProfile.getProfileImage(); // UserProfileì˜ profileImage ì‚¬ìš©
				System.out.println("ë¡œê·¸ì¸ ì‚¬ìš©ì í”„ë¡œí•„: username=" + nickname + ", profileImage=" + avatarUrl);
			} else {
				// UserProfileì´ ì—†ìœ¼ë©´ email ì‚¬ìš©
				nickname = user.getEmail();
				avatarUrl = null;
				System.out.println("UserProfileì´ ì—†ìŒ, email ì‚¬ìš©: " + nickname);
			}
		}

		Long effectiveUserId = null;
		if (principal != null && user != null) {
			effectiveUserId = user.getId(); // íšŒì›: DB ID (ì˜ˆ: 2)
		} else if (guestUser != null) {
			effectiveUserId = (long) guestUser.getGuestId().hashCode(); // ê²ŒìŠ¤íŠ¸: í•´ì‹œ (511719744)
			System.out.println("ğŸ†” ê²ŒìŠ¤íŠ¸ effectiveUserId: " + effectiveUserId);
		}

		participantService.joinRoomIfNotExists(room, user, guestId, nickname, avatarUrl);

		List<?> participants = participantService.findByRoom(room);
		Map<String, Object> message = new HashMap<>();
		message.put("type", "PARTICIPANTUPDATE");
		message.put("participants", participants);
		messagingTemplate.convertAndSend("/topic/participants/" + roomCode, message);

		model.addAttribute("room", room);
		model.addAttribute("participants", participantService.findByRoom(room));
		model.addAttribute("guestNickname", nickname);
		model.addAttribute("guestAvatarUrl", avatarUrl);
		model.addAttribute("currentUser", user);
		model.addAttribute("guestId", guestId);
		model.addAttribute("effectiveUserId", effectiveUserId); // âœ… ì´ ì¤„ ì¶”ê°€!

		boolean isRoomMaster = (user != null && room.getHostUserId().equals(user.getId()));
		model.addAttribute("isRoomMaster", isRoomMaster);

		try {
			String url2 = "https://search.naver.com/search.naver?where=nexearch&sm=top_hty&fbm=0&ie=utf8&query="
					+ roomCode + "&ackey=088trqms"; // ë„ë©”ì¸ì— ë§ê²Œ ë³€ê²½!
			byte[] qrImage = qrCodeService.generateQRCodeImage(url2, 250, 250);
			@SuppressWarnings("deprecation")
			String qrCodeBase64 = Base64.encodeBase64String(qrImage);
			model.addAttribute("qrCodeBase64", qrCodeBase64);
		} catch (Exception e) {
			// ì—ëŸ¬ì‹œ ê¸°ë³¸ ê°’ ë“± ì²˜ë¦¬
			model.addAttribute("qrCodeBase64", null);
		}

		List<Quiz> quizzes = quizService.findAll();
		model.addAttribute("quizzes", quizzes);

		return "waitroom";
	}

	@GetMapping("/joinroom")
	public String joinRoom(Principal principal, HttpSession session) {
		if (principal == null && session.getAttribute("guestUser") == null) {
			return "redirect:/guest/setup?next=/joinroom";
		}
		return "joinroom";
	}

	@PostMapping("/waitroom/join")
	public String joinRoom(@RequestParam("roomCode") String roomCode, Principal principal, HttpSession session) {
		if (principal != null) {
			return "redirect:/waitroom/" + roomCode;
		}

		if (session.getAttribute("guestUser") == null) {
			return "redirect:/guest/setup?next=/waitroom/" + roomCode;
		}

		return "redirect:/waitroom/" + roomCode;
	}

	// ==================== WebSocket: íˆ¬í‘œ ì‹œì‘ ====================

	@MessageMapping("/vote/start/{roomCode}")
	@SendTo("/topic/vote/{roomCode}")
	public VoteResponse startVote(@DestinationVariable("roomCode") String roomCode, VoteRequest request) {

		// duration ê¸°ë³¸ê°’/ìµœëŒ€ê°’ ì²˜ë¦¬
		int duration = (request.getDuration() != null) ? request.getDuration() : 30;
		if (duration > 300)
			duration = 300; // ìµœëŒ€ 5ë¶„

		// VoteManagerì— ì‹¤ì œ íˆ¬í‘œ ì‹œì‘ ìœ„ì„ (íƒ€ì´ë¨¸ í¬í•¨)
		voteManager.startVote(roomCode, request.getVoteId(), request.getQuestion(), request.getDescription(),
				request.getCreator(), duration);

		// í´ë¼ì´ì–¸íŠ¸ë“¤ì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•  ì •ë³´
		return VoteResponse.builder().type("START").voteId(request.getVoteId()).question(request.getQuestion())
				.description(request.getDescription()).creator(request.getCreator()).duration(duration).build();
	}

	// ==================== WebSocket: íˆ¬í‘œ ì œì¶œ ====================

	@MessageMapping("/vote/submit/{roomCode}")
	public void submitVote(@DestinationVariable("roomCode") String roomCode, VoteRequest request) {
		// ì—¬ê¸°ì„œëŠ” ë°˜í™˜ê°’ ì—†ì´, VoteManagerê°€ ë‚´ë¶€ì—ì„œ UPDATE ë¸Œë¡œë“œìºìŠ¤íŠ¸
		voteManager.submitVote(roomCode, request.getVoteId(), request.getVoter(), request.getChoice());
	}

	@PostMapping("/waitroom/{roomCode}/close")
	@ResponseBody
	public String closeRoom(@PathVariable("roomCode") String roomCode, Principal principal) {
		Room room = roomService.getRoomByCode(roomCode);
		if (room == null) {
			return "NOT_FOUND";
		}

		if (principal == null) {
			return "UNAUTHORIZED";
		}

		User user = userService.findByEmail(principal.getName());
		if (user == null || !room.getHostUserId().equals(user.getId())) {
			return "FORBIDDEN";
		}

		roomService.closeRoom(roomCode);
		return "OK";
	}

	@MessageMapping("/ready/{roomCode}")
	@SendTo("/topic/ready/{roomCode}")
	public Map<String, Object> handleReadyStatus(@DestinationVariable("roomCode") String roomCode,
			Map<String, Object> readyData) {

		Long userId = ((Number) readyData.get("userId")).longValue();
		boolean isReady = (Boolean) readyData.get("isReady");

		roomReadyStatus.computeIfAbsent(roomCode, k -> new ConcurrentHashMap<>()).put(userId, isReady);

		System.out
				.println("Ready status received from room: " + roomCode + ", user: " + userId + ", ready: " + isReady);

		// 3. ëª¨ë“  ì°¸ê°€ì READYì¸ì§€ ì²´í¬
		Room room = roomService.getRoomByCode(roomCode);
		if (room != null) {
			var participants = participantService.findByRoom(room);
			var readyMap = roomReadyStatus.get(roomCode);

			boolean allReady = true;

			// âœ… ì¸ë¼ì¸ìœ¼ë¡œ ì²˜ë¦¬ (ì—”í‹°í‹° ìˆ˜ì • ì—†ìŒ!)
			for (var p : participants) {
				// âœ… ê²ŒìŠ¤íŠ¸ì™€ íšŒì› ëª¨ë‘ ì²˜ë¦¬
				Long pId = (p.getUser() != null) ? p.getUser().getId() : Long.valueOf(p.getGuestId().hashCode());

				System.out.println("ì°¸ê°€ì: " + p.getNickname() + ", pId: " + pId + ", ready: " + readyMap.get(pId));

				if (!Boolean.TRUE.equals(readyMap.get(pId))) {
					allReady = false;
					break;
				}
			}

			System.out.println("Room " + roomCode + " allReady: " + allReady);

			// ëª¨ë‘ READYë©´ í€´ì¦ˆ ì‹œì‘
			if (allReady) {
				Long quizId = roomQuizService.getLatestQuizIdByRoom(room.getId());
				if (quizId != null) {
					Map<String, Object> startSignal = new HashMap<>();
					startSignal.put("type", "QUIZ_START");
					startSignal.put("quizId", quizId);
					startSignal.put("countdown", 5);

					System.out.println("ğŸš€ QUIZ_START ì‹ í˜¸ ì „ì†¡: " + roomCode);
					messagingTemplate.convertAndSend("/topic/ready/" + roomCode, startSignal);
				} else {
					System.out.println("âŒ í€´ì¦ˆê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤");
				}
			}
		}

		return readyData;
	}

	// âœ… getParticipantId() ë©”ì„œë“œ ì‚­ì œ!

	/**
	 * ì¹œêµ¬ë¥¼ ëŒ€ê¸°ë°©ìœ¼ë¡œ ì´ˆëŒ€ (email ì‚¬ìš©)
	 */
	@PostMapping("/api/quiz/room/{roomCode}/invite") // â­ ê²½ë¡œ ìˆ˜ì •
	@ResponseBody
	public Map<String, Object> inviteFriendToRoom(@PathVariable("roomCode") String roomCode,
			@RequestParam("friendEmail") String friendEmail // â­ emailë¡œ ë³€ê²½
	) {
		Map<String, Object> response = new HashMap<>();

		try {
			// 1. ëŒ€ê¸°ë°© ì¡°íšŒ
			Room room = roomService.getRoomByCode(roomCode);
			if (room == null) {
				response.put("success", false);
				response.put("message", "ëŒ€ê¸°ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
				return response;
			}

			// 2. ì´ˆëŒ€ë°›ëŠ” ì‚¬ìš©ì ì¡°íšŒ (emailë¡œ)
			User invitedUser = userService.findByEmail(friendEmail); // â­ email ì‚¬ìš©
			if (invitedUser == null) {
				response.put("success", false);
				response.put("message", "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
				return response;
			}

			// 3. ì°¸ê°€ì ì¶”ê°€ (ì¤‘ë³µ ì œê±°)
			participantService.joinRoomIfNotExists(room, invitedUser, null,
					invitedUser.getUserProfile() != null ? invitedUser.getUserProfile().getUsername()
							: invitedUser.getEmail(),
					invitedUser.getUserProfile() != null ? invitedUser.getUserProfile().getProfileImage() : null);

			List<?> participants = participantService.findByRoom(room);
			Map<String, Object> wsMessage = new HashMap<>();
			wsMessage.put("type", "PARTICIPANTUPDATE");
			wsMessage.put("participants", participants);
			messagingTemplate.convertAndSend("/topic/participants/" + roomCode, wsMessage);

			response.put("success", true);
			System.out.println("âœ… ì¹œêµ¬ ì´ˆëŒ€ ì„±ê³µ - roomCode: " + roomCode + ", email: " + friendEmail);

		} catch (Exception e) {
			System.err.println("âŒ ì¹œêµ¬ ì´ˆëŒ€ ì‹¤íŒ¨: " + e.getMessage());
			e.printStackTrace();
			response.put("success", false);
			response.put("message", "ì´ˆëŒ€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage());
		}

		return response;
	}

	@PostMapping("/api/room/{roomCode}/select-quiz")
	@ResponseBody
	public Map<String, Object> selectQuiz(@PathVariable("roomCode") String roomCode,
			@RequestParam("quizId") Long quizId, Principal principal) {
		Map<String, Object> response = new HashMap<>();

		try {
			// 1. ë°© ì¡°íšŒ & ê¶Œí•œ í™•ì¸
			Room room = roomService.getRoomByCode(roomCode);
			if (room == null) {
				response.put("success", false);
				response.put("message", "ëŒ€ê¸°ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
				return response;
			}

			User user = userService.findByEmail(principal.getName());
			if (user == null || !room.getHostUserId().equals(user.getId())) {
				response.put("success", false);
				response.put("message", "ë°©ì¥ë§Œ í€´ì¦ˆë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
				return response;
			}

			// 2. í€´ì¦ˆ ì¡°íšŒ
			Quiz quiz = quizService.findById(quizId);
			if (quiz == null) {
				response.put("success", false);
				response.put("message", "ì„ íƒí•œ í€´ì¦ˆê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
				return response;
			}

			// 3. ê¸°ì¡´ í€´ì¦ˆ ì‚­ì œ í›„ ìƒˆë¡œ ì €ì¥ (ì¤‘ë³µ ë°©ì§€)
			roomQuizService.deleteByRoomId(room.getId());
			roomQuizService.saveRoomQuiz(room.getId(), quizId);

			// 4. ì„±ê³µ ì‘ë‹µ (í´ë¼ì´ì–¸íŠ¸ê°€ ê¸°ëŒ€í•˜ëŠ” í˜•ì‹)
			response.put("success", true);
			response.put("quizId", quizId);
			response.put("quizTitle", quiz.getTitle());

			// 5. WebSocketìœ¼ë¡œ ëª¨ë“  ì°¸ê°€ìì—ê²Œ ì•Œë¦¼
			Map<String, Object> quizNotification = new HashMap<>();
			quizNotification.put("type", "QUIZ_SELECTED");
			quizNotification.put("quizId", quizId);
			quizNotification.put("quizTitle", quiz.getTitle());
			messagingTemplate.convertAndSend("/topic/room/" + roomCode, quizNotification);

			System.out.println("âœ… [í€´ì¦ˆ ì„ íƒ] " + roomCode + " â†’ " + quiz.getTitle());

		} catch (Exception e) {
			System.err.println("âŒ í€´ì¦ˆ ì„ íƒ ì˜¤ë¥˜: " + e.getMessage());
			response.put("success", false);
			response.put("message", "í€´ì¦ˆ ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage());
		}

		return response;
	}

}
",

29. RoomQuizController.java="
package com.project.quiz.controller;

import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.Timer;
import java.util.TimerTask;
import java.util.concurrent.ConcurrentHashMap;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.handler.annotation.DestinationVariable;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

import com.project.quiz.domain.Participant;
import com.project.quiz.domain.Room;
import com.project.quiz.domain.User;
import com.project.quiz.dto.GuestUserDto;
import com.project.quiz.dto.QuizDto;
import com.project.quiz.dto.UserRank;
import com.project.quiz.repository.QuizRepository;
import com.project.quiz.repository.QuizSubmissionRepository;
import com.project.quiz.repository.UserActivityLogRepository;
import com.project.quiz.repository.UserRepository;
import com.project.quiz.service.ParticipantService;
import com.project.quiz.service.PointService;
import com.project.quiz.service.QuizService;
import com.project.quiz.service.QuizSubmitService;
import com.project.quiz.service.RoomQuizService;
import com.project.quiz.service.RoomService;

import jakarta.servlet.http.HttpSession;

@Controller
public class RoomQuizController {

	@Autowired
	private RoomService roomService;

	@Autowired
	private RoomQuizService roomQuizService;

	@Autowired
	private QuizService quizService;

	@Autowired
	private UserRepository userRepository; // UserProfileRepository ëŒ€ì‹  ì‚¬ìš© ê¶Œì¥

	@Autowired
	private ParticipantService participantService;

	@Autowired
	private QuizSubmitService quizSubmitService;

	@Autowired
	private SimpMessagingTemplate messagingTemplate;

	@Autowired
	private PointService pointService;

	@Autowired
	private UserActivityLogRepository userActivityLogRepository;

	@Autowired
	private QuizSubmissionRepository quizSubmissionRepository;

	@Autowired
	private QuizRepository quizRepository;

	// í˜„ì¬ ë¬¸ì œ ìƒíƒœ ê´€ë¦¬ (roomCode -> questionIndex)
	private final Map<String, Integer> roomCurrentQuestionIndex = new ConcurrentHashMap<>();

	private final Map<String, Set<Long>> roomSubmittedUsers = new ConcurrentHashMap<>();

	private final Map<String, Map<Long, Integer>> roomScores = new ConcurrentHashMap<>();

	private final Map<String, Integer> roomQuestionCallCount = new ConcurrentHashMap<>();
	
	private final Map<String, Map<Long, Set<Long>>> roomUserCorrectQuestions = new ConcurrentHashMap<>();

	@GetMapping("/quiz/{roomCode}")
	public String showQuiz(@PathVariable("roomCode") String roomCode, Model model, java.security.Principal principal,
			HttpSession session) {
		try {
			Room room = roomService.getRoomByCode(roomCode);
			if (room == null) {
				return "redirect:/waitroom/" + roomCode;
			}

			Long quizId = roomQuizService.getLatestQuizIdByRoom(room.getId());
			if (quizId == null) {
				return "redirect:/waitroom/" + roomCode;
			}

			QuizDto quiz = quizService.getQuizForPlay(quizId);
			if (quiz == null || quiz.getQuestions() == null || quiz.getQuestions().isEmpty()) {
				return "redirect:/waitroom/" + roomCode;
			}

			// âœ… effectiveUserId ê³„ì‚° ì¶”ê°€!
			Long effectiveUserId = null;
			GuestUserDto guestUser = (GuestUserDto) session.getAttribute("guestUser");

			if (principal != null) {
				Optional<User> userOpt = userRepository.findByEmail(principal.getName());
				if (userOpt.isPresent()) {
					User user = userOpt.get();
					model.addAttribute("currentUser", user);
					effectiveUserId = user.getId();
				}
			} else if (guestUser != null) {
				effectiveUserId = (long) guestUser.getGuestId().hashCode();
				System.out.println("ğŸ†” í€´ì¦ˆ ê²ŒìŠ¤íŠ¸ effectiveUserId: " + effectiveUserId);
			}

			model.addAttribute("effectiveUserId", effectiveUserId); // âœ… HTMLì— ì „ë‹¬!

			// âœ… ëª¨ë“  ì°¸ê°€ì ì ìˆ˜ 0ìœ¼ë¡œ ì´ˆê¸°í™” (íšŒì› + ê²ŒìŠ¤íŠ¸)
			List<Participant> participants = participantService.findByRoom(room);
			for (Participant p : participants) {
				Long pId = p.getUser() != null ? p.getUser().getId() : (long) p.getGuestId().hashCode();
				roomScores.computeIfAbsent(roomCode, k -> new ConcurrentHashMap<>()).put(pId, 0);
				System.out.println("ğŸ“Š ì´ˆê¸° ì ìˆ˜ ì„¤ì •: " + p.getNickname() + " (ID=" + pId + ") = 0ì ");
			}

			model.addAttribute("roomCode", roomCode);
			model.addAttribute("totalQuestions", quiz.getQuestions().size());

			// 2. ìƒíƒœ ì´ˆê¸°í™”
			if (!roomCurrentQuestionIndex.containsKey(roomCode)) {
				roomCurrentQuestionIndex.put(roomCode, -1);
			}
			if (!roomSubmittedUsers.containsKey(roomCode)) {
				roomSubmittedUsers.put(roomCode, Collections.synchronizedSet(new HashSet<>()));
			}

			return "quiz";

		} catch (Exception e) {
			System.err.println("âŒ í€´ì¦ˆ ì§„ì… ì—ëŸ¬: " + e.getMessage());
			e.printStackTrace();
			return "redirect:/waitroom/" + roomCode;
		}
	}

	// ë¬¸ì œë¥¼ ë¡œë“œí•˜ê³  ë¸Œë¡œë“œìºìŠ¤íŠ¸í•˜ëŠ” ë©”ì„œë“œ
	private void loadAndBroadcastQuestion(String roomCode, QuizDto quiz, int questionIndex) {
	    List<QuizDto.QuestionDto> questions = quiz.getQuestions();

	    // [ê²Œì„ ì¢…ë£Œ ì¡°ê±´]
	    if (questionIndex >= questions.size()) {
	        
	        // 1. ìˆœìœ„ ê³„ì‚°
	        List<UserRank> finalRanking = recalculateRanking(roomCode);
	        Room room = roomService.getRoomByCode(roomCode);
	        
	        Map<Long, Set<Long>> correctQuestions = roomUserCorrectQuestions.getOrDefault(roomCode, new HashMap<>());
	        
	        // 2. ê²°ê³¼ ì €ì¥ (Participant í…Œì´ë¸”)
	        participantService.saveQuizResults(room, finalRanking);

	        // â­ 3. [ìˆ˜ì •ë¨] ë³´ìƒ ë° ê¸°ë¡ ì €ì¥ (ì„œë¹„ìŠ¤ë¡œ ìœ„ì„í•˜ì—¬ íŠ¸ëœì­ì…˜ ë³´ì¥)
	        try {
	            // Serviceì— ìƒˆë¡œ ë§Œë“  ë©”ì„œë“œ í˜¸ì¶œ
	        	participantService.processQuizRewards(room, finalRanking, quiz.getQuizId(), correctQuestions);
	            System.out.println("ğŸ’° ë³´ìƒ ì§€ê¸‰ ë° DB ì €ì¥ ì™„ë£Œ");
	        } catch (Exception e) {
	            System.err.println("âŒ ë³´ìƒ ì§€ê¸‰ ì¤‘ ì—ëŸ¬ ë°œìƒ: " + e.getMessage());
	            e.printStackTrace();
	        }

	        // 4. ì¢…ë£Œ ì‹ í˜¸ ì „ì†¡
	        Map<String, Object> finishSignal = new HashMap<>();
	        finishSignal.put("type", "FINISH");
	        finishSignal.put("ranking", finalRanking);
	        messagingTemplate.convertAndSend("/topic/quiz/" + roomCode, finishSignal);

	        return;
	    }

		// â­ ë‚˜ë¨¸ì§€ ê¸°ì¡´ ì½”ë“œ (ë³€ê²½ ì—†ìŒ)
		QuizDto.QuestionDto question = questions.get(questionIndex);

		Map<String, Object> questionData = new HashMap<>();
		questionData.put("type", "QUESTION");
		questionData.put("questionNumber", questionIndex + 1);
		questionData.put("totalQuestions", questions.size());
		questionData.put("questionId", question.getQuestionId());
		questionData.put("questionText", question.getQuestionText());
		questionData.put("quizTypeCode", question.getQuizTypeCode());
		questionData.put("point", question.getPoint());
		questionData.put("imageUrl", question.getImage());

		if (question.getQuizTypeCode() == 2) {
			List<Map<String, Object>> options = new ArrayList<>();
			for (QuizDto.OptionDto option : question.getOptions()) {
				Map<String, Object> optionMap = new HashMap<>();
				optionMap.put("optionNumber", option.getOptionNumber());
				optionMap.put("optionText", option.getOptionText());
				options.add(optionMap);
			}
			questionData.put("options", options);
		}

		System.out.println("ğŸ“¢ [ë¬¸ì œ ì „ì†¡] " + roomCode + " / " + (questionIndex + 1) + "ë²ˆ ë¬¸ì œ");
		messagingTemplate.convertAndSend("/topic/quiz/" + roomCode, questionData);

		List<UserRank> currentRanking = recalculateRanking(roomCode);

		Map<String, Object> rankingData = new HashMap<>();
		rankingData.put("type", "RANKING");
		rankingData.put("ranking", currentRanking);

		System.out.println("ğŸ“¢ [ìˆœìœ„ ì „ì†¡] ë°ì´í„°: " + currentRanking);
		messagingTemplate.convertAndSend("/topic/quiz/" + roomCode, rankingData);
	}

	// ë‹¤ìŒ ë¬¸ì œ ë¡œë“œ
	@MessageMapping("/quiz/next-question/{roomCode}")
	public void nextQuestion(@DestinationVariable("roomCode") String roomCode) {
		Room room = roomService.getRoomByCode(roomCode);
		if (room == null)
			return;

		Long quizId = roomQuizService.getLatestQuizIdByRoom(room.getId());
		QuizDto quiz = quizService.getQuizForPlay(quizId);
		if (quiz == null)
			return;

		// âœ… ë°©ì— ì°¸ì—¬í•œ ì‹¤ì œ ì°¸ê°€ì ìˆ˜
		List<Participant> participants = participantService.findByRoom(room);
		int totalPlayers = participants.size();

		// âœ… í˜¸ì¶œ íšŸìˆ˜ ì¹´ìš´íŠ¸
		int callCount = roomQuestionCallCount.getOrDefault(roomCode, 0) + 1;
		roomQuestionCallCount.put(roomCode, callCount);

		System.out.println("ğŸ”” nextQuestion í˜¸ì¶œ: " + callCount + "/" + totalPlayers);

		// âœ… ì²« ë²ˆì§¸ í˜¸ì¶œì¼ ë•Œë§Œ ë¬¸ì œ ë¡œë“œ!
		if (callCount == 1) {
			int currentIndex = roomCurrentQuestionIndex.getOrDefault(roomCode, -1);
			int nextIndex = currentIndex + 1;

			System.out.println("âœ… ë¬¸ì œ ë¡œë“œ: nextIndex=" + nextIndex);

			roomCurrentQuestionIndex.put(roomCode, nextIndex);
			loadAndBroadcastQuestion(roomCode, quiz, nextIndex);
		} else {
			System.out.println("â­ï¸ ì•„ì§ ëŒ€ê¸° ì¤‘... (" + callCount + "/" + totalPlayers + ")");
		}

		// âœ… ëª¨ë“  ì°¸ê°€ìê°€ í˜¸ì¶œí–ˆìœ¼ë©´ ì´ˆê¸°í™”
		if (callCount >= totalPlayers) {
			roomQuestionCallCount.put(roomCode, 0);
			System.out.println("ğŸ”„ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”!");

			// â­ ëŠ¦ê²Œ ì˜¨ ì‚¬ëŒë“¤ì„ ìœ„í•´ ì¬ì „ì†¡!
			int currentIndex = roomCurrentQuestionIndex.getOrDefault(roomCode, -1);
			System.out.println("ğŸ”„ ì¬ì „ì†¡: ë¬¸ì œ " + (currentIndex + 1));
			loadAndBroadcastQuestion(roomCode, quiz, currentIndex);
		}

	}

	// ë‹µ ì œì¶œ
	@MessageMapping("/quiz/answer/{roomCode}")
	public void submitAnswer(@DestinationVariable("roomCode") String roomCode, Map<String, Object> data) {
		try {
			Long userId = Long.valueOf(data.get("userId").toString());
			Integer selectedOption = (Integer) data.get("selectedOption");
			String textAnswer = (String) data.get("textAnswer");

			// â­ 1. í˜„ì¬ í€´ì¦ˆ + ë¬¸ì œ ì •ë³´ ì •í™•íˆ ê°€ì ¸ì˜¤ê¸°
			Room room = roomService.getRoomByCode(roomCode);
			Long quizId = roomQuizService.getLatestQuizIdByRoom(room.getId());
			QuizDto quiz = quizService.getQuizForPlay(quizId); // ì „ì²´ í€´ì¦ˆ ë¡œë“œ
			int questionIndex = roomCurrentQuestionIndex.get(roomCode);
			Long questionId = quiz.getQuestions().get(questionIndex).getQuestionId(); // âœ… ì‹¤ì œ questionId!

			/*
			 * QuizSubmitRequest request = new QuizSubmitRequest();
			 * request.setUserId(userId); QuizSubmitRequest.AnswerRequest ar = new
			 * QuizSubmitRequest.AnswerRequest(); ar.setQuestionId(questionId); // âœ… ì‹¤ì œ
			 * questionId ì‚¬ìš©! ar.setSelectedOption(selectedOption);
			 * ar.setAnswerText(textAnswer); request.setAnswers(List.of(ar));
			 * quizSubmitService.submit(quizId, request);
			 */

			System.out.println("âœ… DB ì €ì¥: questionId=" + questionId);

			System.out.println("ğŸ“¤ ë‹µë³€ ìˆ˜ì‹ : userId=" + userId + ", option=" + selectedOption + ", text=" + textAnswer);

			// ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€ (ì ìˆ˜ ê³„ì‚°, ì •ë‹µ/ì˜¤ë‹µ ë“±)
			int index = roomCurrentQuestionIndex.get(roomCode);

			QuizDto.QuestionDto q = quiz.getQuestions().get(index);

			System.out
					.println("ğŸ“Œ í˜„ì¬ ë¬¸ì œ: index=" + index + ", type=" + q.getQuizTypeCode() + ", point=" + q.getPoint());

			// 1. ì œì¶œì ëª©ë¡ ê´€ë¦¬
			Set<Long> submitted = roomSubmittedUsers.computeIfAbsent(roomCode,
					k -> Collections.synchronizedSet(new HashSet<>()));
			if (submitted.contains(userId)) {
				System.out.println("âš ï¸ ì¤‘ë³µ ì œì¶œ ê°ì§€: userId=" + userId);
				return;
			}
			submitted.add(userId);

			// 2. ì ìˆ˜ ê³„ì‚°
			boolean correct = false;

			if (q.getQuizTypeCode() == 2) {
				// âœ… ê°ê´€ì‹
				System.out.println("ğŸ” ê°ê´€ì‹ ê²€ì¦");
				System.out.println(
						"   ì„ íƒí•œ ë‹µ: " + selectedOption + " (íƒ€ì…: " + selectedOption.getClass().getSimpleName() + ")");
				System.out.println("   ì •ë‹µ: " + q.getAnswerOption() + " (íƒ€ì…: "
						+ q.getAnswerOption().getClass().getSimpleName() + ")");

				if (q.getAnswerOption() != null) {
					try {
						Integer answerAsInt = Integer.parseInt(q.getAnswerOption());
						correct = answerAsInt.equals(selectedOption);
						System.out.println("   ê²°ê³¼: " + (correct ? "âœ… ì •ë‹µ" : "âŒ ì˜¤ë‹µ"));
					} catch (NumberFormatException e) {
						System.out.println("   âš ï¸ ì •ë‹µ ë³€í™˜ ì‹¤íŒ¨: " + q.getAnswerOption());
					}
				}
			} else if (q.getQuizTypeCode() == 1) {
				// âœ… ì„œìˆ í˜• (answerText ì •ë‹µ ì‚¬ìš©!)
				System.out.println("ğŸ” ì„œìˆ í˜• ê²€ì¦");
				System.out.println("   ì…ë ¥í•œ ë‹µ: " + textAnswer);
				System.out.println("   ì •ë‹µ: " + q.getSubjectiveAnswer()); // â† getAnswerOption() ì•„ë‹ˆë¼ getAnswerText()!

				if (q.getSubjectiveAnswer() != null && textAnswer != null) {
					correct = textAnswer.trim().equalsIgnoreCase(q.getSubjectiveAnswer().trim());
					System.out.println("   ê²°ê³¼: " + (correct ? "âœ… ì •ë‹µ" : "âŒ ì˜¤ë‹µ"));
				} else {
					System.out.println("   âš ï¸ ì •ë‹µ ë˜ëŠ” ì…ë ¥ê°’ ì—†ìŒ");
				}
			}

			// 3. ì •ë‹µì´ë©´ ì ìˆ˜ ì¶”ê°€
			if (correct) {
				Integer points = q.getPoint() != null ? q.getPoint() : 0;
				System.out.println("âœ… ì •ë‹µ! userId=" + userId + " ì—ê²Œ " + points + " ì  ì¶”ê°€");

				roomScores.computeIfAbsent(roomCode, k -> new ConcurrentHashMap<>()).merge(userId, points,
						Integer::sum);

				Integer currentScore = roomScores.get(roomCode).get(userId);
				System.out.println("ğŸ“Š ëˆ„ì  ì ìˆ˜: userId=" + userId + ", score=" + currentScore);
				
				roomUserCorrectQuestions
                .computeIfAbsent(roomCode, k -> new ConcurrentHashMap<>())
                .computeIfAbsent(userId, k -> new HashSet<>())
                .add(questionId);
			} else {
				System.out.println("âŒ ì˜¤ë‹µ: userId=" + userId);
			}

			// âœ… ì‹¤ì‹œê°„ ìˆœìœ„ ê°±ì‹  (ë§¤ ë‹µë³€ë§ˆë‹¤!)
			List<UserRank> currentRanking = recalculateRanking(roomCode);
			Map<String, Object> rankingData = new HashMap<>();
			rankingData.put("type", "RANKING");
			rankingData.put("ranking", currentRanking);
			System.out.println("ğŸ“Š [ì‹¤ì‹œê°„ ìˆœìœ„ ì „ì†¡] " + roomCode + ": " + currentRanking);
			messagingTemplate.convertAndSend("/topic/quiz/" + roomCode, rankingData);

			// ANSWER_RESULT (ì„ íƒì‚¬í•­ - ì •ë‹µ/ì˜¤ë‹µ í‘œì‹œ)
			messagingTemplate.convertAndSend("/topic/quiz/" + roomCode,
					Map.of("type", "ANSWER_RESULT", "userId", userId, "isCorrect", correct));

			List<Participant> participants = participantService.findByRoom(room);
			int totalPlayers = participants.size();
			int submittedCount = submitted.size();

			System.out.println("ğŸ“Š ì œì¶œ í˜„í™© [" + roomCode + "]: " + submittedCount + "/" + totalPlayers);

			if (submittedCount >= totalPlayers) {
				System.out.println("âœ… ëª¨ë“  ì¸ì› ì œì¶œ ì™„ë£Œ! ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™í•©ë‹ˆë‹¤.");

				submitted.clear();
				int next = index + 1;
				roomCurrentQuestionIndex.put(roomCode, next);

				new Timer().schedule(new TimerTask() {
					@Override
					public void run() {
						loadAndBroadcastQuestion(roomCode, quiz, next);
					}
				}, 2000);
			} else {
				System.out.println("â³ ë‹¤ë¥¸ ìœ ì €ì˜ ì œì¶œì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...");
			}

		} catch (Exception e) {
			System.out.println("âŒ ë‹µë³€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜");
			e.printStackTrace();
		}
	}

	// â­ ì´ ë©”ì„œë“œë¥¼ handleAnswerStatus() ì•„ë˜ì— ì¶”ê°€!
	private List<UserRank> recalculateRanking(String roomCode) {
		Map<Long, Integer> scores = roomScores.get(roomCode);
		if (scores == null || scores.isEmpty())
			return new ArrayList<>();

		List<Map.Entry<Long, Integer>> sortedScores = scores.entrySet().stream()
				.sorted((a, b) -> b.getValue().compareTo(a.getValue())).collect(Collectors.toList());

		// â­ ë°© ì°¸ê°€ì ëª©ë¡ (íšŒì› + ê²ŒìŠ¤íŠ¸)
		Room room = roomService.getRoomByCode(roomCode);
		List<Participant> participants = participantService.findByRoom(room);

		List<UserRank> ranking = new ArrayList<>();
		int rank = 1;

		for (Map.Entry<Long, Integer> entry : sortedScores) {
			Long keyId = entry.getKey(); // íšŒì›ì´ë©´ userId, ê²ŒìŠ¤íŠ¸ë©´ hashId

			String nickname;

			// 1) íšŒì› ë¨¼ì € ì‹œë„
			var userOpt = userRepository.findById(keyId);
			if (userOpt.isPresent()) {
				var user = userOpt.get();
				if (user.getUserProfile() != null) {
					nickname = user.getUserProfile().getUsername();
				} else {
					nickname = "ì´ë¦„ì—†ìŒ(" + keyId + ")";
				}
			} else {
				// 2) DBì— ì—†ìœ¼ë©´ ê²ŒìŠ¤íŠ¸ë¼ê³  ë³´ê³ , Participantì—ì„œ ì°¾ê¸°
				Participant guestP = participants.stream().filter(p -> p.getUser() == null) // íšŒì› ì•„ë‹Œ ì°¸ê°€ì
						.filter(p -> {
							Long guestHash = (long) p.getGuestId().hashCode();
							return guestHash.equals(keyId);
						}).findFirst().orElse(null);

				if (guestP != null) {
					nickname = guestP.getNickname(); // âœ… ê²ŒìŠ¤íŠ¸ ë‹‰ë„¤ì„
				} else {
					nickname = "ì•Œìˆ˜ì—†ìŒ";
				}
			}

			UserRank userRank = new UserRank();
			userRank.setUserId(keyId);
			userRank.setNickname(nickname);
			userRank.setScore(entry.getValue());
			userRank.setRank(rank++);
			ranking.add(userRank);
		}

		return ranking;
	}

	@GetMapping("/quiz-result/{roomCode}")
	public String showResult(@PathVariable("roomCode") String roomCode, Model model) {
		try {
			// 1. ë°© ì¡°íšŒ
			Room room = roomService.getRoomByCode(roomCode);
			if (room == null) {

				return "redirect:/";
			}

			// 2. í€´ì¦ˆ ì •ë³´ ì¡°íšŒ âœ… ì¶”ê°€
			Long quizId = roomQuizService.getLatestQuizIdByRoom(room.getId());
			QuizDto quiz = null;
			String quizTitle = "í€´ì¦ˆ";

			if (quizId != null) {
				quiz = quizService.getQuizForPlay(quizId);
				if (quiz != null) {
					quizTitle = quiz.getTitle();
				}
			}

			// 3. DBì—ì„œ ì €ì¥ëœ ì°¸ê°€ìë“¤ ì¡°íšŒ
			List<Participant> participants = participantService.findByRoom(room);

			// 4. ranking ìˆœì„œëŒ€ë¡œ ì •ë ¬
			participants.sort((a, b) -> {
				if (a.getRanking() == null || b.getRanking() == null)
					return 0;
				return a.getRanking().compareTo(b.getRanking());
			});

			// 5. ëª¨ë¸ì— ë‹´ê¸°
			model.addAttribute("roomCode", roomCode);
			model.addAttribute("quizTitle", quizTitle); // âœ… ì¶”ê°€
			model.addAttribute("ranking", participants);

			return "quizresult";

		} catch (Exception e) {

			return "redirect:/";
		}
	}

}
",

30. ShopController.java="
package com.project.quiz.controller;

import java.security.Principal;
import java.util.List;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.project.quiz.dto.ShopItemResponse;
import com.project.quiz.service.ShopService;

import lombok.RequiredArgsConstructor;

@Controller
@RequiredArgsConstructor
public class ShopController {

    private final ShopService shopService;

    // ìƒì  í˜ì´ì§€ (DB ì¡°íšŒ)
    @GetMapping("/shop")
    public String shopPage(Model model, Principal principal) {
        // ë¡œê·¸ì¸í•œ ì‚¬ëŒ(principal)ì´ ìˆìœ¼ë©´ ê·¸ ì‚¬ëŒ ê¸°ì¤€ìœ¼ë¡œ, ì—†ìœ¼ë©´ ê·¸ëƒ¥ ëª©ë¡ë§Œ(ëª¨ë‘ ë¯¸ë³´ìœ  ì²˜ë¦¬)
        String email = (principal != null) ? principal.getName() : "";
        
        // DTO ë¦¬ìŠ¤íŠ¸ ë°›ê¸°
        List<ShopItemResponse> items = shopService.getAvailableItems(email);
        
        model.addAttribute("items", items);
        return "shop";
    }

    // [POST] ì•„ì´í…œ êµ¬ë§¤ ì²˜ë¦¬
    @PostMapping("/shop/buy")
    public String buyItem(@RequestParam("itemId") Long itemId, 
                          Principal principal,
                          RedirectAttributes redirectAttributes) {
        try {
            shopService.buyItem(principal.getName(), itemId);
            redirectAttributes.addFlashAttribute("message", "êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        } catch (IllegalStateException e) {
            // í¬ì¸íŠ¸ ë¶€ì¡± ë“±ì˜ ì—ëŸ¬
            redirectAttributes.addFlashAttribute("error", e.getMessage());
        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("error", "êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
        return "redirect:/shop";
    }
}
",

31. TestGeminiController.java="
package com.project.quiz.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import com.project.quiz.dto.AiQuizResponse;
import com.project.quiz.service.GeminiTestService;
import lombok.RequiredArgsConstructor;

@RestController
@RequiredArgsConstructor
public class TestGeminiController {

    private final GeminiTestService geminiTestService;

    // í…ŒìŠ¤íŠ¸ ì£¼ì†Œ: http://localhost:8080/test/gemini?topic=í•œêµ­ì—­ì‚¬
    @GetMapping("/test/gemini")
    public AiQuizResponse testGemini(@RequestParam("topic") String topic) {
        System.out.println("Geminiì—ê²Œ ìš”ì²­ ë³´ëƒ„: " + topic);
        return geminiTestService.createQuiz(topic);
    }
}
",

32. TimelineApiController.java="
package com.project.quiz.controller;

import java.security.Principal;
import java.util.List;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.project.quiz.dto.TimelineDto;
import com.project.quiz.service.TimelineService;

import lombok.RequiredArgsConstructor;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/timeline")
public class TimelineApiController {

    private final TimelineService timelineService;

    // GET /api/timeline?page=0&size=10
    @GetMapping
    public ResponseEntity<List<TimelineDto>> getTimeline(
            @RequestParam(value = "page", defaultValue = "0") int page,
            @RequestParam(value = "size", defaultValue = "10") int size,
            Principal principal) {
        
        if (principal == null) return ResponseEntity.status(401).build();

        return ResponseEntity.ok(
            timelineService.getTimelineByPage(principal.getName(), page, size)
        );
    }
}
",

33. UserApiController.java="
package com.project.quiz.controller;

import java.security.Principal;
import java.util.HashMap;
import java.util.Map;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserProfile;
import com.project.quiz.repository.UserRepository;
import com.project.quiz.repository.UserProfileRepository;
import com.project.quiz.service.UserService;

import lombok.RequiredArgsConstructor;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/user")
// signup.htmlì—ì„œ ì‚¬ìš©í•¨ ë° ì‚¬ìš©ì ì¡°íšŒìš©
public class UserApiController {

	private final UserRepository userRepository;
	private final UserService userService;
	private final UserProfileRepository userProfileRepository; // â­ ì¶”ê°€

	@GetMapping("/check-email")
	public ResponseEntity<Boolean> checkEmail(@RequestParam("email") String email) {
		return ResponseEntity.ok(userRepository.existsByEmail(email));
	}

	// â­ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ë°˜í™˜
	@GetMapping("/current")
	public ResponseEntity<?> getCurrentUser(Principal principal) {
		if (principal == null) {
			return ResponseEntity.status(401).body("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤");
		}

		try {
			String email = principal.getName();
			System.out.println("í˜„ì¬ ì‚¬ìš©ì ì´ë©”ì¼: " + email);

			User user = userService.getUserByEmail(email);

			// â­ UserProfileì—ì„œ username ê°€ì ¸ì˜¤ê¸°
			UserProfile userProfile = userProfileRepository.findByUserId(user.getId()).orElse(null);

			String username = (userProfile != null) ? userProfile.getUsername() : user.getEmail();

			// ì‘ë‹µ JSON ìƒì„±
			Map<String, Object> response = new HashMap<>();
			response.put("id", user.getId());
			response.put("email", user.getEmail());
			response.put("username", username);
			return ResponseEntity.ok(response);
			
		} catch (Exception e) {
			e.printStackTrace();
			return ResponseEntity.status(500).body("ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
		}
	}
}

",

34. UserController.java="
package com.project.quiz.controller;

import com.project.quiz.service.UserService;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.security.Principal;

@RestController
@RequestMapping("/api/user")
@RequiredArgsConstructor
public class UserController {

    private final UserService userService;

    // 1. íƒˆí‡´ ë²„íŠ¼ í´ë¦­ ì‹œ
    @PostMapping("/withdraw")
    public ResponseEntity<?> withdraw(Principal principal, HttpServletRequest request) {
        if (principal == null) return ResponseEntity.status(401).build();

        // 1) DB ìƒíƒœ ë³€ê²½
        userService.withdraw(principal.getName());

        // 2) ê°•ì œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        SecurityContextHolder.clearContext();
        HttpSession session = request.getSession(false);
        if (session != null) {
            session.invalidate();
        }

        return ResponseEntity.ok("íƒˆí‡´ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // 2. ë³µêµ¬ ë²„íŠ¼ í´ë¦­ ì‹œ
    @PostMapping("/reactivate")
    public ResponseEntity<?> reactivate(Principal principal) {
        if (principal == null) return ResponseEntity.status(401).build();

        userService.reactivate(principal.getName());
        return ResponseEntity.ok("ê³„ì •ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
}
",

35. Achievement.java="
package com.project.quiz.domain;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.FetchType;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.Table;
import lombok.AccessLevel;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;

@Entity
@Table(name = "achievement")
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
@Builder
public class Achievement {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private String title;       // ì—…ì ëª… (ì˜ˆ: "ì„±ì‹¤í•œ ì¶œì„ëŸ¬")

    @Column(nullable = false)
    private String description; // ì„¤ëª… (ì˜ˆ: "ì¶œì„ 50íšŒ ë‹¬ì„± ì‹œ ì§€ê¸‰")

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private AchievementType achievementType; // ë‹¬ì„± ì¡°ê±´ íƒ€ì… (ATTENDANCE, QUIZ, etc.)

    @Column(nullable = false)
    private Long goalValue;     // ëª©í‘œ ìˆ˜ì¹˜ (ì˜ˆ: 50)

    // ë³´ìƒ ì•„ì´í…œ (ë©”ë‹¬ ë“±) - ShopItemê³¼ ì—°ê²° (ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ nullable)
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "reward_item_id")
    private ShopItem rewardItem;

    @Column(nullable = false)
    @Builder.Default
    private Boolean isActive = true; // ì§€ê¸ˆ ì§„í–‰ ì¤‘ì¸ ì—…ì ì¸ì§€ ì—¬ë¶€
}
",

36. AchievementType.java="
package com.project.quiz.domain;

public enum AchievementType {
    ATTENDANCE_COUNT,   // ëˆ„ì  ì¶œì„
    CONSECUTIVE_LOGIN,  // ì—°ì† ì¶œì„ (ë¡œì§ ë³µì¡)
    QUIZ_SOLVED,        // í€´ì¦ˆ í’€ê¸° (ì •ë‹µ ë¬´ê´€)
    QUIZ_CORRECT,       // í€´ì¦ˆ ì •ë‹µ
    ITEM_COLLECTOR      // ì•„ì´í…œ ìˆ˜ì§‘
}
",

37. BoardComment.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "board_comment")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class BoardComment {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long commentId;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "post_id", nullable = false)
    private BoardPost boardPost;      // FK

    @Column(nullable = false)
    private Long userId;              // FK, ì‹¤ì œ Userì™€ ì—°ê´€ê´€ê³„ í•„ìš”í•˜ë©´ ë§¤í•‘

    @Lob
    @Column(nullable = false)
    private String content;

    @Column(nullable = false)
    private LocalDateTime createdAt = LocalDateTime.now();

    @Column
    private LocalDateTime updatedAt;
}

",

38. BoardPost.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;
import java.util.List;

@Entity
@Table(name = "board_post")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class BoardPost {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long postId;

    @Column(length = 50, nullable = false)
    private String boardTypeCode;     // FKëŠ” ì—†ìœ¼ë¯€ë¡œ ë‹¨ìˆœ ë¬¸ìì—´

    @Column(nullable = false)
    private Long userId;              // FK, ì‹¤ì œ Userì™€ ì—°ê´€ê´€ê³„ í•„ìš”í•˜ë©´ ë§¤í•‘

    @Column(length = 255, nullable = false)
    private String title;

    @Lob
    @Column(nullable = false)
    private String content;

    @Column(nullable = false)
    private Integer viewCount = 0;

    @Column(nullable = false)
    private LocalDateTime createdAt = LocalDateTime.now();

    @Column
    private LocalDateTime updatedAt;

    // ëŒ“ê¸€ ì—°ê´€ê´€ê³„ (ì–‘ë°©í–¥ í•„ìš”ì‹œ)
    @OneToMany(mappedBy = "boardPost", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<BoardComment> comments;
}

",

39. CodeTable.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.*;

@Entity
@Table(name = "code_table")
@Getter
@Setter
public class CodeTable {
	@Id
	private String code;
	private String groupId;
	private String name;
	private String description;

}
",

40. FriendMessage.java="
package com.project.quiz.domain;

import lombok.*;
import java.time.LocalDateTime;
import jakarta.persistence.*;

@Entity
@Table(name = "friend_message")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class FriendMessage {

	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long id;

	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "friendship_id", nullable = false)
	private Friendship friendship;

	@Column(nullable = false)
	private Long senderId;

	@Column(columnDefinition = "TEXT")
	private String messageText;

	@Column(nullable = false)
	private Boolean isRead = false;

	@Column(nullable = false, updatable = false)
	private LocalDateTime sentAt;

	@PrePersist
	protected void onCreate() {
		this.sentAt = LocalDateTime.now();
	}

	public void markAsRead() {
		if (!this.isRead) {
			this.isRead = true;
		}
	}
}

",

41. Friendship.java="
package com.project.quiz.domain;

import lombok.*;
import jakarta.persistence.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "friendship")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Friendship {

	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	@Column(name = "id")
	private Long id;

	// ì¹œêµ¬ ìš”ì²­ì„ ë³´ë‚¸ ì‚¬ìš©ì
	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "user_id", nullable = false)
	private User user;

	// ì¹œêµ¬ ìš”ì²­ì„ ë°›ì€ ì‚¬ìš©ì
	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "friend_user_id", nullable = false)
	private User friendUser;

	// ì¹œêµ¬ ìƒíƒœ (pending, accepted, rejected, blocked)
	@Column(name = "status", length = 20, nullable = false)
	private String status;

	// ì¹œêµ¬ ì‹ ì²­ ë‚ ì§œ
	@Column(name = "created_at", nullable = false, updatable = false)
	private LocalDateTime createdAt;

	// ìˆ˜ë½/ê±°ì ˆ/ì°¨ë‹¨ ë‚ ì§œ
	@Column(name = "updated_at")
	private LocalDateTime updatedAt;

	@PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
        if (status == null) {
            status = "pending";
        }
    }
    
    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }

}

",

42. Notification.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "notification")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Notification {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // ë³´ë‚¸ ì‚¬ëŒ ID (ì‹œìŠ¤í…œ ì•Œë¦¼ì¸ ê²½ìš° null ë˜ëŠ” ê´€ë¦¬ì ID, í•„ìš”ì‹œ User ì—°ê´€ê´€ê³„ë¡œ ë³€ê²½ ê°€ëŠ¥)
    @Column(name = "sender_id")
    private Long senderId;

    @Column(nullable = false)
    private String title;

    @Column(columnDefinition = "TEXT")
    private String content;

    @Column(name = "notification_type", length = 50)
    private String notificationType; // ì˜ˆ: "ACHIEVEMENT", "NOTICE", "FRIEND_REQUEST"

    @Column(name = "is_broadcast")
    @Builder.Default
    private Boolean isBroadcast = false; // ì „ì²´ ê³µì§€ ì—¬ë¶€

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "expire_at")
    private LocalDateTime expireAt; // ì•Œë¦¼ ë§Œë£Œ ê¸°ê°„ (ì˜µì…˜)

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
    }
}
",

43. NotificationRecipient.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "notification_recipient")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class NotificationRecipient {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // ì–´ë–¤ ì•Œë¦¼ì¸ì§€ (FK)
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "notification_id", nullable = false)
    private Notification notification;

    // ëˆ„ê°€ ë°›ëŠ”ì§€ (FK)
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    @Column(name = "is_read", nullable = false)
    @Builder.Default
    private Boolean isRead = false; // ì½ìŒ ì—¬ë¶€

    @Column(name = "read_at")
    private LocalDateTime readAt; // ì½ì€ ì‹œê°„

    @Column(name = "delivered_at")
    private LocalDateTime deliveredAt; // ì „ì†¡(ìˆ˜ì‹ ) í™•ì¸ ì‹œê°„ (ì›¹ì†Œì¼“ ì „ì†¡ ì‹œì  ë“±)

    // í¸ì˜ ë©”ì„œë“œ: ì½ìŒ ì²˜ë¦¬
    public void markAsRead() {
        this.isRead = true;
        this.readAt = LocalDateTime.now();
    }
}
",

44. Participant.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

import com.fasterxml.jackson.annotation.JsonIgnore;

@Entity
@Table(name = "participant")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class Participant {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private LocalDateTime joinAt;

    // FK: room í…Œì´ë¸”
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "room_id", nullable = false)
    private Room room;

    // FK: user í…Œì´ë¸” (nullable í—ˆìš©)
    @JsonIgnore  
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = true)
    private User user;

    @Column(nullable = true, length = 100)
    private String guestId;     // ê²ŒìŠ¤íŠ¸ë§Œ ê°’(UUID ë“±)

    @Column(length = 50)
    private String nickname;

    @Column(length = 255)
    private String avatarUrl;

    private Long score;

    private Long ranking;
}

",

45. Quiz.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.Data;
import lombok.Getter;
import lombok.Setter;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

import com.fasterxml.jackson.annotation.JsonFormat;

@Data
@Entity
@Table(name = "quiz")
@Getter
@Setter
public class Quiz {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long quizId;

    private String title;

    private String description;

    @Column(name = "user_id", nullable = false)
    private Long userId;

    @JsonFormat(pattern = "yyyy-MM-dd")
    private LocalDateTime createdAt;

    @JsonFormat(pattern = "yyyy-MM-dd")
    private LocalDateTime updatedAt;

    @OneToMany(mappedBy = "quiz", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<QuizQuestion> questions = new ArrayList();
    
    public void addQuestion(QuizQuestion question) {
        questions.add(question);
        question.setQuiz(this);
    }

    @Column(name = "score_public", nullable = false)
    private boolean scorePublic = true;


}
",

46. QuizAnswer.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
@Entity
@Table(name = "quiz_answer")
public class QuizAnswer {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long answerId;

    /* ì–´ë–¤ ì œì¶œì— ì†í•œ ë‹µì•ˆì¸ì§€ */
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "submission_id", nullable = false)
    private QuizSubmission submission;

    /* ì–´ë–¤ ë¬¸ì œì— ëŒ€í•œ ë‹µì•ˆì¸ì§€ */
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "question_id", nullable = false)
    private QuizQuestion question;

    /* ì„œìˆ í˜• ë‹µì•ˆ */
    @Column(name = "answer_text", columnDefinition = "TEXT")
    private String answerText;

    /* ê°ê´€ì‹ ì„ íƒ ë²ˆí˜¸ */
    @Column(name = "selected_option")
    private Integer selectedOption;
    
    @OneToOne(mappedBy = "answer", cascade = CascadeType.ALL)
    private QuizGrading grading;
    
    public void setGrading(QuizGrading grading) {
        this.grading = grading;
        grading.setAnswer(this);
    }


}

",

47. QuizGrading.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

import java.time.LocalDateTime;

@Entity
@Table(name = "quiz_grading")
@Getter @Setter
public class QuizGrading {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long gradingId;

    /** ì±„ì  ëŒ€ìƒ ë‹µì•ˆ */
    @OneToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "answer_id", nullable = false, unique = true)
    private QuizAnswer answer;


    /** ì •ë‹µ ì—¬ë¶€ */
    @Column(nullable = false)
    private Boolean correct;

    /** íšë“ ì ìˆ˜ */
    @Column(nullable = false)
    private Integer score;

    /** ì±„ì ì */
    @Column(length = 20)
    private String grader;

    /** ì±„ì  ì‹œê° */
    @Column(name = "graded_at")
    private LocalDateTime gradedAt;
    
    
}

",

48. QuizOption.java="
package com.project.quiz.domain;

import java.util.ArrayList;
import java.util.List;

import jakarta.persistence.*;
import lombok.Data;
import lombok.Getter;
import lombok.Setter;

@Data
@Entity
@Table(name = "quiz_option")
@Getter
@Setter
public class QuizOption {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long optionId;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "question_id")
    private QuizQuestion question;

    private Integer optionNumber;
    private String optionText;
}
",

49. QuizQuestion.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.Data;
import lombok.Getter;
import lombok.Setter;

import java.util.ArrayList;
import java.util.List;

@Data
@Entity
@Table(name = "quiz_question")
@Getter @Setter
public class QuizQuestion {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long questionId;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "quiz_id")
    private Quiz quiz;

    @Column(name = "quiz_type_code", nullable = false)
    private Integer quizTypeCode;

    @Column(name = "question_text")
    private String questionText;

    @Column(name = "point")
    private Integer point;

    @Column(name = "answer_option")
    private String answerOption;

    @Column(name = "subjective_answer")
    private String subjectiveAnswer;

    @Column(name = "image")
    private String image;

    @OneToMany(mappedBy = "question", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<QuizOption> options = new ArrayList<>();

    
    public void addOption(QuizOption option) {
        options.add(option);
        option.setQuestion(this);
    }
}
",

50. QuizSubmission.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Getter
@Setter
@Entity
@Table(name = "quiz_submission")
public class QuizSubmission {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long submissionId;

    /* ì–´ë–¤ í€´ì¦ˆì— ëŒ€í•œ ì œì¶œì¸ì§€ */
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "quiz_id", nullable = false)
    private Quiz quiz;

    /* ì œì¶œì (ë¹„íšŒì›ì´ë©´ nullable ê°€ëŠ¥) */
    @Column(name = "user_id")
    private Long userId;

    /* ì´ì  (ì±„ì  í›„ ê³„ì‚°) */
    @Column(name = "total_score")
    private Integer totalScore;

    /* ì±„ì  ì™„ë£Œ ì—¬ë¶€ */
    @Column(nullable = false)
    private Boolean graded = false;

    @Column(name = "submitted_at")
    private LocalDateTime submittedAt = LocalDateTime.now();

    /* ë¬¸ì œë³„ ë‹µì•ˆ */
    @OneToMany(
        mappedBy = "submission",
        cascade = CascadeType.ALL,
        orphanRemoval = true
    )
    private List<QuizAnswer> answers = new ArrayList<>();
    
    public void addAnswer(QuizAnswer answer) {
        answers.add(answer);
        answer.setSubmission(this);
    }
}

",

51. Room.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;
import java.util.Random;

@Entity
@Table(name = "room")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Room {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "created_at", columnDefinition = "DATETIME(6)")
    private LocalDateTime createdAt;

    @Column(name = "host_user_id")
    private Long hostUserId;

    @Column(name = "status_code", length = 50)
    private String statusCode;

    @Column(name = "closed_at", columnDefinition = "DATETIME(6)")
    private LocalDateTime closedAt;

    @Column(name = "room_code", length = 4, unique = true)
    private String roomCode;

    // ë°© ìƒì„± ì‹œ 4ìë¦¬ ì˜ë¬¸ ëŒ€ë¬¸ì roomCode ìë™ ìƒì„±
    public static String generateRoomCode() {
        StringBuilder sb = new StringBuilder();
        Random rnd = new Random();
        for (int i = 0; i < 4; i++) {
            sb.append((char) ('A' + rnd.nextInt(26)));
        }
        return sb.toString();
    }

    // ì—”í‹°í‹° ìƒì„±ìš© íŒ©í† ë¦¬(ë¹Œë”)
    public static Room create(Long hostUserId, String roomTypeCode, String statusCode) {
        return Room.builder()
                .createdAt(LocalDateTime.now())
                .hostUserId(hostUserId)
                .statusCode(statusCode)
                .roomCode(generateRoomCode())
                .build();
    }
}

",

52. RoomQuiz.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "room_quiz")
@Data
@Builder  
@NoArgsConstructor  
@AllArgsConstructor 
public class RoomQuiz {

	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long id;

	@Column(name = "room_id", nullable = false)
	private Long roomId; // roomê³¼ì˜ ì™¸ë˜í‚¤

	@Column(name = "quiz_id", nullable = false)
	private Long quizId; // quizì™€ì˜ ì™¸ë˜í‚¤

	@Column(name = "assigned_at")
	private LocalDateTime assignedAt;

	// âœ… ê´€ê³„ ì„¤ì • (ì„ íƒì‚¬í•­)
	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "room_id", insertable = false, updatable = false)
	private Room room;

	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "quiz_id", insertable = false, updatable = false)
	private Quiz quiz;
}

",

53. ShopItem.java="
package com.project.quiz.domain;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;

@Entity
@Table(name = "shop_item")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class ShopItem {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "item_name", nullable = false)
    private String itemName;

    @Column(columnDefinition = "TEXT")
    private String description;

    @Column(nullable = false)
    private int price;

    @Column(name = "image_url")
    private String imageUrl;

    @Column(name = "is_available")
    private Boolean isAvailable; // íŒë§¤ ì¤‘ ì—¬ë¶€
    
    @Column(length = 50)
    private String category; // "BORDER" ë˜ëŠ” "THEME"
}

",

54. User.java="
package com.project.quiz.domain;

import java.time.LocalDateTime;

import com.fasterxml.jackson.annotation.JsonIgnore;

import jakarta.persistence.CascadeType;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.FetchType;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.OneToOne;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Entity
@Getter 
@Setter
@NoArgsConstructor 
@AllArgsConstructor 
@Builder
public class User {

    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false)
    private String email;
    
    @JsonIgnore
    private String password;
    
    private String provider;    // google, kakao
    private String providerId;  // sub, id
    private String role;        // USER, ADMIN
    private String status;      // ACTIVE, INACTIVE (ê³„ì • ìƒíƒœ ìœ ì§€)
    
    private LocalDateTime createdAt;
    private LocalDateTime statusChangedAt;

    // â–¼â–¼â–¼ í•µì‹¬: UserProfileê³¼ 1:1 ì—°ê²° â–¼â–¼â–¼
    // CascadeType.ALL: Userë¥¼ ì €ì¥í•˜ë©´ Profileë„ ê°™ì´ ì €ì¥ë¨
    // orphanRemoval = true: ì—°ê²° ëŠìœ¼ë©´ Profile ë°ì´í„°ë„ ì‚­ì œë¨
    @JsonIgnore
    @OneToOne(mappedBy = "user", cascade = CascadeType.ALL, orphanRemoval = true, fetch = FetchType.EAGER)
    private UserProfile userProfile;

    // í¸ì˜ ë©”ì„œë“œ: ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì„œë“œ (ì–‘ë°©í–¥ ì„¸íŒ…ìš©)
    public void setUserProfile(UserProfile profile) {
        this.userProfile = profile;
        if (profile != null) {
            profile.setUser(this);
        }
    }
}
",

55. UserAchievement.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "user_achievement",
       uniqueConstraints = {
           @UniqueConstraint(columnNames = {"user_id", "achievement_id"}) // ìœ ì €ë‹¹ ì—…ì ì€ í•˜ë‚˜ì”©ë§Œ
       })
@Getter
@Setter // ì§„í–‰ë„ëŠ” ê³„ì† ë°”ë€Œë¯€ë¡œ Setter í—ˆìš© (ë˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œ ì‚¬ìš©)
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
@Builder
public class UserAchievement {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "achievement_id", nullable = false)
    private Achievement achievement;

    @Column(nullable = false)
    @Builder.Default
    private Long currentValue = 0L; // í˜„ì¬ ë‹¬ì„± ìˆ˜ì¹˜ (ì˜ˆ: 35/50 ì´ë©´ 35)

    @Column(nullable = false)
    @Builder.Default
    private Boolean isAchieved = false; // ëª©í‘œ ë‹¬ì„± ì—¬ë¶€

    @Column(nullable = false)
    @Builder.Default
    private Boolean isRewarded = false; // ë³´ìƒ ìˆ˜ë ¹ ì—¬ë¶€ (ë³´ìƒë°›ê¸° ë²„íŠ¼ í´ë¦­ ì²´í¬ìš©)

    private LocalDateTime achievedAt; // ë‹¬ì„± ì‹œê°

    private LocalDateTime lastUpdatedAt; // ë§ˆì§€ë§‰ ì§„í–‰ ì‹œê°„ (ì—°ì† ì¶œì„ ì²´í¬ìš©)

    // í¸ì˜ ë©”ì„œë“œ: ì§„í–‰ë„ ì¦ê°€
    public void incrementValue() {
        this.currentValue++;
        this.lastUpdatedAt = LocalDateTime.now();
    }
    
    // í¸ì˜ ë©”ì„œë“œ: ë‹¬ì„± ì²˜ë¦¬
    public void markAchieved() {
        this.isAchieved = true;
        this.achievedAt = LocalDateTime.now();
    }

    // í¸ì˜ ë©”ì„œë“œ: ë³´ìƒ ìˆ˜ë ¹ ì²˜ë¦¬
    public void markRewarded() {
        this.isRewarded = true;
    }
}
",

56. UserActivityAttendance.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDate;

@Entity
@Table(name = "user_activity_attendance")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class UserActivityAttendance {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // â˜… í•µì‹¬: user_id ì»¬ëŸ¼ ì‚­ì œ! ì˜¤ì§ ë¡œê·¸ IDë¡œë§Œ ì—°ê²° (1:1)
    @OneToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "activity_log_id", nullable = false)
    private UserActivityLog userActivityLog;

    @Column(name = "check_in_date", nullable = false)
    private LocalDate checkInDate;

    @Column(name = "points_earned")
    private int pointsEarned;
}
",

57. UserActivityLog.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "user_activity_log")
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserActivityLog {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private User user;

    @Column(name = "activity_type")
    private String activityType; // ì˜ˆ: "PURCHASE", "QUIZ", "ATTENDANCE"

    @Column(name = "description")
    private String description; // ê°„ë‹¨ ì„¤ëª…

    @Column(name = "created_at")
    private LocalDateTime createdAt;
}
",

58. UserActivityPointChange.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.*;

@Entity
@Table(name = "user_activity_point_change")
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserActivityPointChange {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @OneToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "activity_log_id")
    private UserActivityLog userActivityLog; // ë¡œê·¸ì™€ 1:1 ì—°ê²°

    private int amount; // ë³€ë™ëŸ‰ (+500, -300)

    private String reason; // ìƒì„¸ ì‚¬ìœ  ("ì „ì„¤ì˜ ê²€ êµ¬ë§¤")
}
",

59. UserInventory.java="
package com.project.quiz.domain;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "user_inventory")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class UserInventory {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private User user;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "item_id")
    private ShopItem item;

    @Column(name = "purchased_at")
    private LocalDateTime purchasedAt;
    
    @Column(name = "is_equipped", nullable = false)
    private boolean isEquipped = false;
}
",

60. UserProfile.java="
package com.project.quiz.domain;

import org.hibernate.annotations.UuidGenerator;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.FetchType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.OneToOne;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Entity
@Getter @Setter
@NoArgsConstructor @AllArgsConstructor @Builder
public class UserProfile {

	@Id
    @UuidGenerator
    @Column(length = 36)
    private String id;

    // â–¼â–¼â–¼ User í…Œì´ë¸”ì˜ PKë¥¼ FKë¡œ ê°€ì§ (ì—¬ê¸°ê°€ ì£¼ì¸) â–¼â–¼â–¼
    @OneToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private User user;

    private String username;      // ë‹‰ë„¤ì„ (ì´ì‚¬ì˜´)
    
    @Builder.Default
    @Column(nullable = true)
    private String profileImage = "/img/undraw_profile.svg";  // ê¸°ë³¸ ì´ë¯¸ì§€
    
    @Builder.Default
    private Long pointBalance = 100L;    // í¬ì¸íŠ¸ (ì´ì‚¬ì˜´)
    
    @Column(length = 255)
    private String bio;           // ìƒíƒœ ë©”ì‹œì§€

    @Column(length = 100)
    private String organization;  // ì†Œì† (ìƒˆë¡œ ì¶”ê°€ë¨)
    
    public int getDisplayLength() {
        if (username == null) return 0;

        int length = 0;
        for (char c : username.toCharArray()) {
            // í•œê¸€ ë²”ìœ„ (Hangul Syllables) ì²´í¬
            if (c >= 'ê°€' && c <= 'í£') {
                length += 2; // í•œê¸€ì€ 2ë¡œ ê³„ì‚° (EUC-KR ì²˜ëŸ¼)
            } else {
                length += 1; // ì˜ì–´, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìëŠ” 1ë¡œ ê³„ì‚°
            }
        }
        return length;
    }
}
",

61. AchievementDisplayDto.java="
package com.project.quiz.dto;

import com.project.quiz.domain.Achievement;
import lombok.Builder;
import lombok.Getter;

@Getter
@Builder
public class AchievementDisplayDto {
    private Achievement achievement; // ì—…ì  ì •ë³´ (ì œëª©, ëª©í‘œì¹˜ ë“±)
    private long currentValue;       // ë‚´ í˜„ì¬ ìˆ˜ì¹˜ (ì˜ˆ: 12)
    private boolean isAchieved;      // ë‹¬ì„± ì—¬ë¶€
    private int percent;             // í¼ì„¼íŠ¸ (í”„ë¡œê·¸ë ˆìŠ¤ ë°”ìš©, 0~100)

    public static AchievementDisplayDto of(Achievement achievement, long currentValue, boolean isAchieved) {
        // í¼ì„¼íŠ¸ ê³„ì‚° (ëª©í‘œê°€ 0ì´ë©´ 0%)
        int percent = 0;
        if (achievement.getGoalValue() > 0) {
            percent = (int) ((double) currentValue / achievement.getGoalValue() * 100);
            if (percent > 100) percent = 100;
        }

        return AchievementDisplayDto.builder()
                .achievement(achievement)
                .currentValue(currentValue)
                .isAchieved(isAchieved)
                .percent(percent)
                .build();
    }
}
",

62. AiGenRequest.java="
package com.project.quiz.dto;
import lombok.Data;

@Data
public class AiGenRequest {
    private String topic;
    private String difficulty; // "ì´ˆê¸‰", "ì¤‘ê¸‰", "ê³ ê¸‰"
    private int count;         // 3, 6, 10
    private String type;       // "multiple", "short", "mixed"
}
",

63. AiQuizResponse.java="
package com.project.quiz.dto;

import java.util.List;

// AIê°€ ì´ êµ¬ì¡°ë¡œ JSONì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
public record AiQuizResponse(
    String title,
    String description,
    List<AiQuestion> questions
) {
    public record AiQuestion(
        String questionText,
        List<String> options, // ë³´ê¸° 4ê°œ
        int answerIndex,      // ì •ë‹µ ë²ˆí˜¸ (1~4)
        String explanation    // í•´ì„¤
    ) {}
}
",

64. AnswerResult.java="
package com.project.quiz.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class AnswerResult {
	private boolean isCorrect;
	private int points;
	private int questionPoint;
}

",

65. AttendanceEvent.java="
package com.project.quiz.dto;

import com.project.quiz.domain.User;

import lombok.AllArgsConstructor;
import lombok.Getter;

@Getter
@AllArgsConstructor
public class AttendanceEvent {
    private User user;
}

",

66. AttendanceEventDto.java="
package com.project.quiz.dto;

import com.project.quiz.domain.UserActivityAttendance;
import lombok.Getter;

@Getter
public class AttendanceEventDto {
    private String title; // ë‹¬ë ¥ì— í‘œì‹œë  ê¸€ì (ì˜ˆ: "+100P")
    private String start; // ë‚ ì§œ (YYYY-MM-DD)
    private String color; // ì´ë²¤íŠ¸ ë°°ê²½ìƒ‰ (ì´ˆë¡ìƒ‰)
    private String textColor; // ê¸€ììƒ‰ (í°ìƒ‰)
    private boolean allDay; // í•˜ë£¨ ì¢…ì¼ ì´ë²¤íŠ¸ ì—¬ë¶€ (true)

    public AttendanceEventDto(UserActivityAttendance entity) {
        this.title = "âœ… ì¶œì„"; // ë˜ëŠ” "+" + entity.getPointsEarned() + "P";
        this.start = entity.getCheckInDate().toString(); // LocalDate -> String
        this.color = "#1cc88a"; // sb-admin-2ì˜ success ìƒ‰ìƒ
        this.textColor = "#ffffff";
        this.allDay = true;
    }
}
",

67. ChatMessage.java="
package com.project.quiz.dto;

import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@NoArgsConstructor
public class ChatMessage {
	private String type; // ì˜ˆ: "CHAT", "JOIN", "LEAVE"
	private String content; // ë©”ì‹œì§€ ë‚´ìš©
	private String sender; // ë³´ë‚¸ ì‚¬ëŒ ì´ë¦„

}

",

68. FriendMessageDTO.java="
package com.project.quiz.dto;

import com.project.quiz.domain.FriendMessage;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class FriendMessageDTO {

	private Long id;
	private Long friendshipId; // â­ ì¶”ê°€
	private String messageText;
	private Boolean isRead;
	private LocalDateTime sentAt;
	private Long senderId;
	private String senderName;
	private String profileImage;

	public FriendMessageDTO(FriendMessage message) {
		this.id = message.getId();
		this.friendshipId = message.getFriendship().getId(); // â­ í•µì‹¬
		this.messageText = message.getMessageText();
		this.isRead = message.getIsRead();
		this.sentAt = message.getSentAt();
		this.senderId = message.getSenderId();
	}
}

",

69. FriendMessageRequest.java="
package com.project.quiz.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class FriendMessageRequest {

    /**
     * ë°›ëŠ” ì‚¬ëŒ ID
     * ì˜ˆ: 1 (Dolmeng_Eì˜ userId)
     */
    private Long recipientId;

    /**
     * ì¹œêµ¬ ê´€ê³„ ID (Friendship í…Œì´ë¸”ì˜ id)
     * ì˜ˆ: 1 (Alice â†” Dolmeng_E ê´€ê³„)
     */
    private Long friendshipId;

    /**
     * ë©”ì‹œì§€ ë‚´ìš©
     * ì˜ˆ: "ì•ˆë…•!"
     */
    private String content;
}
",

70. GuestUserDto.java="
package com.project.quiz.dto;

import lombok.*;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class GuestUserDto {
	private String guestId;
	private String nickname;
	private String characterImageUrl; // ìºë¦­í„° ì´ë¯¸ì§€ ê²½ë¡œ/URL

	// ë¹Œë”ë‚˜ ìƒì„±ìì—ì„œ ID ìë™ ìƒì„±í•˜ê³  ì‹¶ìœ¼ë©´ ì¶”ê°€
	public GuestUserDto(String nickname, String characterImageUrl) {
		this.nickname = nickname;
		this.characterImageUrl = characterImageUrl;
		this.guestId = generateGuestId(nickname);
	}

	// ê²ŒìŠ¤íŠ¸ ID ìƒì„± ë¡œì§
	private String generateGuestId(String nickname) {
		DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyMMddHHmm");
		String datetime = LocalDateTime.now().format(formatter);
		return nickname + datetime;
	}
}

",

71. ItemPurchasedEvent.java="
package com.project.quiz.dto;

import com.project.quiz.domain.User;

import lombok.AllArgsConstructor;
import lombok.Getter;

@Getter
@AllArgsConstructor
public class ItemPurchasedEvent {
    private User user;
}
",

72. NotificationResponse.java="
package com.project.quiz.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import java.time.LocalDateTime;

@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class NotificationResponse {
	private Long id;
    private String title;       // ì˜ˆ: "ì—…ì  ë‹¬ì„±!"
    private String content;     // ì˜ˆ: "[ì„±ì‹¤í•œ ì¶œì„ëŸ¬] ë©”ë‹¬ì„ íšë“í–ˆìŠµë‹ˆë‹¤."
    private String type;        // ì˜ˆ: "ACHIEVEMENT"
    private String url;         // í´ë¦­ ì‹œ ì´ë™í•  ë§í¬ (ì˜µì…˜)
    private LocalDateTime createdAt;
}
",

73. OAuthAttributes.java="
package com.project.quiz.dto;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserProfile;
import lombok.Builder;
import lombok.Getter;

import java.time.LocalDateTime;
import java.util.Map;
import java.util.UUID;

@Getter
public class OAuthAttributes {
    private Map<String, Object> attributes;
    private String nameAttributeKey;
    private String username;
    private String email;
    private String picture;
    private String provider;
    private String providerId;

    @Builder
    public OAuthAttributes(Map<String, Object> attributes, String nameAttributeKey, 
                           String username, String email, String picture, 
                           String provider, String providerId) {
        this.attributes = attributes;
        this.nameAttributeKey = nameAttributeKey;
        this.username = username;
        this.email = email;
        this.picture = picture;
        this.provider = provider;
        this.providerId = providerId;
    }

    // ì„œë¹„ìŠ¤ì—ì„œ í˜¸ì¶œí•˜ëŠ” ì§„ì…ì 
    public static OAuthAttributes of(String registrationId, String userNameAttributeName, Map<String, Object> attributes) {
        // "kakao"ë¡œ ë“¤ì–´ì˜¤ë©´ ì¹´ì¹´ì˜¤ ë¡œì§ ì‹¤í–‰
        if ("kakao".equals(registrationId)) {
            return ofKakao("id", attributes);
        }
        // ë‚˜ë¨¸ì§€ëŠ” êµ¬ê¸€ ë¡œì§ ì‹¤í–‰
        return ofGoogle(userNameAttributeName, attributes);
    }

    private static OAuthAttributes ofGoogle(String userNameAttributeName, Map<String, Object> attributes) {
        return OAuthAttributes.builder()
                .username((String) attributes.get("name"))
                .email((String) attributes.get("email"))
                .picture((String) attributes.get("picture"))
                .provider("google")
                .providerId((String) attributes.get("sub"))
                .attributes(attributes)
                .nameAttributeKey(userNameAttributeName)
                .build();
    }

    // â–¼â–¼â–¼ [í•µì‹¬] ì¹´ì¹´ì˜¤ ì „ìš© ë°ì´í„° ì¶”ì¶œ ë¡œì§ â–¼â–¼â–¼
    private static OAuthAttributes ofKakao(String userNameAttributeName, Map<String, Object> attributes) {
        // 1. kakao_account êº¼ë‚´ê¸°
        Map<String, Object> kakaoAccount = (Map<String, Object>) attributes.get("kakao_account");
        
        // 2. profile êº¼ë‚´ê¸° (ë‹‰ë„¤ì„ì€ ì—¬ê¸° ìˆìŒ)
        Map<String, Object> kakaoProfile = (Map<String, Object>) kakaoAccount.get("profile");

        return OAuthAttributes.builder()
                .username((String) kakaoProfile.get("nickname")) // ë‹‰ë„¤ì„
                .email((String) kakaoAccount.get("email"))       // ì´ë©”ì¼
                .picture((String) kakaoProfile.get("thumbnail_image_url"))
                .provider("kakao")
                .providerId(String.valueOf(attributes.get("id"))) // ì¹´ì¹´ì˜¤ì˜ ê³ ìœ  ID (ìˆ«ì)
                .attributes(attributes)
                .nameAttributeKey(userNameAttributeName)
                .build();
    }

    // toEntityëŠ” ì´ì „ì— ìˆ˜ì •í•œ ê²ƒ(User/UserProfile ë¶„ë¦¬ ë²„ì „) ê·¸ëŒ€ë¡œ ìœ ì§€
    public User toEntity() {
        User user = User.builder()
                .email(email)
                .role("USER")
                .status("ACTIVE")
                .provider(provider)
                .providerId(providerId)
                .password(UUID.randomUUID().toString()) 
                .createdAt(LocalDateTime.now())
                .build();

        UserProfile profile = UserProfile.builder()
                .username(username)
                .profileImage(null)  // ì‚¬ì§„ ì €ì¥ ì•ˆ í•¨
                .pointBalance(100L)
                .organization(null)  // ì†Œì† ë¹ˆì¹¸
                .build();

        user.setUserProfile(profile);

        return user;
    }
}
",

74. PointHistoryDto.java="
package com.project.quiz.dto;

import com.project.quiz.domain.UserActivityPointChange;
import lombok.Getter;
import java.time.format.DateTimeFormatter;

@Getter
public class PointHistoryDto {
    private String date;   // "2025.11.27"
    private String reason; // "ìƒì  ì•„ì´í…œ êµ¬ë§¤"
    private int amount;    // -500
    private String type;   // "USE" or "EARN" (ìƒ‰ìƒ êµ¬ë¶„ìš©)

    public PointHistoryDto(UserActivityPointChange entity) {
        // ë‚ ì§œ í¬ë§·íŒ… (yyyy.MM.dd)
        this.date = entity.getUserActivityLog().getCreatedAt()
                .format(DateTimeFormatter.ofPattern("yyyy.MM.dd"));
        
        this.reason = entity.getReason();
        this.amount = entity.getAmount();
        this.type = (entity.getAmount() > 0) ? "EARN" : "USE";
    }
}
",

75. QuizDto.java="
package com.project.quiz.dto;

import lombok.AllArgsConstructor;
import lombok.Data;

import java.time.LocalDateTime;
import java.util.List;

import com.project.quiz.domain.Quiz;
import com.project.quiz.domain.QuizOption;

@Data
public class QuizDto {

    /* ================== Quiz ================== */
    private Long quizId;
    private String title;
    private String description;
    private Long userId;
    private boolean scorePublic;


    private List<QuestionDto> questions;

    /* ================== Question ================== */
    @Data
    public static class QuestionDto {

        private Long questionId;

        /** 1: ì„œìˆ í˜•, 2: ê°ê´€ì‹ */
        private Integer quizTypeCode;

        private String questionText;
        private Integer point;

        /** ê°ê´€ì‹ ì •ë‹µ (option_number) */
        private String answerOption;

        /** ì„œìˆ í˜• ì •ë‹µ */
        private String subjectiveAnswer;

        private String image;

        /** ê°ê´€ì‹ ë³´ê¸° */
        private List<OptionDto> options;
    }

    /* ================== Option ================== */
    @Data
    public static class OptionDto {
        private Integer optionNumber;
        private String optionText;
    }

    /* ================== Entity â†’ DTO ================== */
    public static QuizDto fromEntity(Quiz quiz) {

        QuizDto dto = new QuizDto();
        dto.setQuizId(quiz.getQuizId());
        dto.setTitle(quiz.getTitle());
        dto.setDescription(quiz.getDescription());
        dto.setUserId(quiz.getUserId());
        dto.setScorePublic(quiz.isScorePublic());


        List<QuestionDto> questionDtos = quiz.getQuestions()
                .stream()
                .map(q -> {
                    QuestionDto qd = new QuestionDto();

                    qd.setQuestionId(q.getQuestionId());
                    qd.setQuizTypeCode(q.getQuizTypeCode());
                    qd.setQuestionText(q.getQuestionText());
                    qd.setPoint(q.getPoint());
                    qd.setAnswerOption(q.getAnswerOption());
                    qd.setSubjectiveAnswer(q.getSubjectiveAnswer());
                    qd.setImage(q.getImage());

                    if (q.getOptions() != null) {
                        List<OptionDto> optionDtos = q.getOptions()
                                .stream()
                                .map(opt -> {
                                    OptionDto od = new OptionDto();
                                    od.setOptionNumber(opt.getOptionNumber());
                                    od.setOptionText(opt.getOptionText());
                                    return od;
                                })
                                .toList();
                        qd.setOptions(optionDtos);
                    }

                    return qd;
                })
                .toList();

        dto.setQuestions(questionDtos);
        return dto;
    }

    /* ================== List í™”ë©´ìš© ================== */
    @Data
    @AllArgsConstructor
    public static class ListResponse {
        private Long quizId;
        private String title;
        private LocalDateTime createdAt;
        private LocalDateTime updatedAt;

        public static ListResponse fromEntity(Quiz quiz) {
            return new ListResponse(
                    quiz.getQuizId(),
                    quiz.getTitle(),
                    quiz.getCreatedAt(),
                    quiz.getUpdatedAt()
            );
        }
    }
}

",

76. QuizSolvedEvent.java="
package com.project.quiz.dto;

import com.project.quiz.domain.User;

import lombok.AllArgsConstructor;
import lombok.Getter;

@Getter
@AllArgsConstructor
public class QuizSolvedEvent {
    private User user;
    private boolean isCorrect;
}
",

77. QuizSubmitRequest.java="
package com.project.quiz.dto;

import lombok.Data;
import java.util.List;

@Data
public class QuizSubmitRequest {

    private Long userId;
    private List<AnswerRequest> answers;

    @Data
    public static class AnswerRequest {
        private Long questionId;
        private String answerText;
        private Integer selectedOption;
    }
}

",

78. ShopItemResponse.java="
package com.project.quiz.dto;

import com.project.quiz.domain.ShopItem;
import lombok.Getter;

@Getter
public class ShopItemResponse {
    private Long id;
    private String itemName;
    private int price;
    private String description;
    private String imageUrl;
    private boolean isOwned; // í•µì‹¬: ë³´ìœ  ì—¬ë¶€

    // ì—”í‹°í‹° -> DTO ë³€í™˜ ìƒì„±ì
    public ShopItemResponse(ShopItem item, boolean isOwned) {
        this.id = item.getId();
        this.itemName = item.getItemName();
        this.price = item.getPrice();
        this.description = item.getDescription();
        this.imageUrl = item.getImageUrl();
        this.isOwned = isOwned;
    }
}
",

79. TimelineDto.java="
package com.project.quiz.dto;

import com.project.quiz.domain.UserActivityLog;
import lombok.Getter;
import java.time.format.DateTimeFormatter;

@Getter
public class TimelineDto {
    private String description; // "OOOë‹˜ì´..."
    private String date;        // "2025.12.02"
    private String iconClass;   // ì•„ì´ì½˜ (fa-flag, fa-gift)
    private String colorClass;  // ë°°ê²½ìƒ‰ (bg-primary, bg-success)

    public TimelineDto(UserActivityLog log) {
        this.description = log.getDescription();
        this.date = log.getCreatedAt().format(DateTimeFormatter.ofPattern("yyyy.MM.dd"));
        
        String type = log.getActivityType(); // REGISTER, ATTENDANCE, POINT_USE, POINT_EARN, QUIZ
        
        // íƒ€ì…ë³„ ë””ìì¸ ë¶„ê¸°
        if ("REGISTER".equals(type)) {
            this.iconClass = "fa-flag";
            this.colorClass = "bg-primary"; // íŒŒë‘
        } 
        else if ("ATTENDANCE".equals(type)) {
            this.iconClass = "fa-calendar-check";
            this.colorClass = "bg-success"; // ì´ˆë¡
        } 
        else if ("POINT_USE".equals(type)) { 
            // ìƒì  êµ¬ë§¤ëŠ” í¬ì¸íŠ¸ ì‚¬ìš©ìœ¼ë¡œ ê¸°ë¡ë¨
            this.iconClass = "fa-shopping-cart";
            this.colorClass = "bg-warning"; // ë…¸ë‘
        }
        else if ("QUIZ".equals(type)) {
            this.iconClass = "fa-gift";
            this.colorClass = "bg-info"; // í•˜ëŠ˜ìƒ‰
        }
        else if ("UPDATE_NICKNAME".equals(type)) {
            this.iconClass = "fa-user-edit";
            this.colorClass = "bg-info"; // í•˜ëŠ˜ìƒ‰
        }
        else if ("ACHIEVEMENT".equals(type)) {
            this.iconClass = "fa-trophy"; // íŠ¸ë¡œí”¼ ì•„ì´ì½˜
            this.colorClass = "bg-warning"; // ë…¸ë€ìƒ‰/ì£¼í™©ìƒ‰ ê³„ì—´
        }
        else {
            // ê·¸ ì™¸ (ë‹¨ìˆœ í¬ì¸íŠ¸ íšë“ ë“±)
            this.iconClass = "fa-star";
            this.colorClass = "bg-secondary"; // íšŒìƒ‰
        }
    }
}
",

80. UserCreateForm.java="
package com.project.quiz.dto;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class UserCreateForm {
    private String username;
    private String email;
    private String password;
}
",

81. UserRank.java="
package com.project.quiz.dto;

import java.util.*;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class UserRank {
	private Long userId;
	private String nickname;
	private Integer score;
	private Integer rank;

	private Set<Long> correctQuestionIds = new HashSet<>();

	public void markCorrect(Long questionId) {
		correctQuestionIds.add(questionId);
	}

	public int getCorrectCount() {
		return correctQuestionIds.size();
	}
}

",

82. UserSearchResponse.java="
package com.project.quiz.dto;

import com.project.quiz.domain.User;
import lombok.*;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class UserSearchResponse {
	private Long id;
	private Long userId;
	private String email;
	private String username;
	private String profileImage;
	private String friendshipStatus;
	private Long friendshipId; // â­ ì´ ì¤„ 1ê°œë§Œ ì¶”ê°€!

	/**
	 * Userë§Œìœ¼ë¡œ ë³€í™˜ (User ID ê¸°ì¤€)
	 */
	public static UserSearchResponse from(User user) {
		return UserSearchResponse.builder().id(user.getId()).userId(user.getId()).email(user.getEmail())
				.username(user.getUserProfile() != null ? user.getUserProfile().getUsername() : null)
				.profileImage(user.getUserProfile() != null ? user.getUserProfile().getProfileImage() : null)
				.friendshipStatus(null).build();
	}

	/**
	 * User + ì¹œêµ¬ ìƒíƒœë¡œ ë³€í™˜
	 */
	public static UserSearchResponse from(User user, String friendshipStatus) {
		return UserSearchResponse.builder().id(user.getId()).userId(user.getId()).email(user.getEmail())
				.username(user.getUserProfile() != null ? user.getUserProfile().getUsername() : null)
				.profileImage(user.getUserProfile() != null ? user.getUserProfile().getProfileImage() : null)
				.friendshipStatus(friendshipStatus).build();
	}

	/**
	 * â­ User + Friendship IDë¡œ ë³€í™˜ (ë°›ì€ ìš”ì²­ìš©) id = Friendship ID (ìˆ˜ë½/ê±°ì ˆ ë²„íŠ¼ìš©) userId =
	 * ìš”ì²­ ë³´ë‚¸ ì‚¬ëŒì˜ User ID
	 */
	public static UserSearchResponse fromFriendship(User user, Long friendshipId, String friendshipStatus) {
		return UserSearchResponse.builder().id(friendshipId) // Friendship ID (ì¤‘ìš”!)
				.userId(user.getId()) // User ID
				.email(user.getEmail())
				.username(user.getUserProfile() != null ? user.getUserProfile().getUsername() : null)
				.profileImage(user.getUserProfile() != null ? user.getUserProfile().getProfileImage() : null)
				.friendshipStatus(friendshipStatus).friendshipId(friendshipId) // â­ ê·¸ë¦¬ê³  ì´ ì¤„ 1ê°œë§Œ ì¶”ê°€!
				.build();
	}
}

",

83. VoteRequest.java="
package com.project.quiz.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class VoteRequest {
    private String type;           // START, VOTE, UPDATE
    private Long voteId;           // íˆ¬í‘œ ê³ ìœ  ID
    private String question;       // íˆ¬í‘œ ì§ˆë¬¸
    private String description;    // íˆ¬í‘œ ì„¤ëª…
    private String creator;        // íˆ¬í‘œ ìƒì„±ì
    private String voter;          // íˆ¬í‘œì
    private String choice;         // AGREE, DISAGREE
    private Long timestamp;        // íƒ€ì„ìŠ¤íƒí”„
    private Integer duration;

}

",

84. VoteResponse.java="
package com.project.quiz.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.util.Map;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class VoteResponse {
    private String type;                      // START, UPDATE, END
    private Long voteId;                      // íˆ¬í‘œ ê³ ìœ  ID
    private String question;                  // íˆ¬í‘œ ì§ˆë¬¸
    private String description;               // íˆ¬í‘œ ì„¤ëª…
    private String creator;                   // íˆ¬í‘œ ìƒì„±ì
    private Map<String, Integer> results;     // íˆ¬í‘œ ê²°ê³¼ {AGREE: 5, DISAGREE: 3}
    private Integer duration;
}

",

85. ExtractCode.java="
package com.project.quiz;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.Stream;

public class ExtractCode {
public static void main(String[] args) {
        
        String targetPath = "src/main/java/com/project/quiz"; 

        System.out.println(">>> ì½”ë“œ ì¶”ì¶œì„ ì‹œì‘í•©ë‹ˆë‹¤...");
        
        // í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ (ìë™ ê°ì§€)
        String projectRoot = System.getProperty("user.dir");
        Path sourceDir = Paths.get(projectRoot, targetPath);
        File outputFile = new File("all_classes_code.txt");

        try (BufferedWriter writer = new BufferedWriter(new FileWriter(outputFile))) {
            
            if (!Files.exists(sourceDir)) {
                System.err.println("ì˜¤ë¥˜: ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ -> " + sourceDir.toAbsolutePath());
                return;
            }

            List<Path> javaFiles;
            try (Stream<Path> paths = Files.walk(sourceDir)) {
                javaFiles = paths
                        .filter(Files::isRegularFile)
                        .filter(p -> p.toString().endsWith(".java"))
                        .sorted()
                        .collect(Collectors.toList());
            }

            System.out.println(">>> ì´ " + javaFiles.size() + "ê°œì˜ ìë°” íŒŒì¼ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.");

            int count = 1;
            for (Path file : javaFiles) {
                String fileName = file.getFileName().toString();
                String content = Files.readString(file);

                // ìš”ì²­í•˜ì‹  í¬ë§·
                writer.write(count + ". " + fileName + "=\"\n");
                writer.write(content);
                writer.write("\n\",\n\n"); 
                
                System.out.println("ì²˜ë¦¬ ì¤‘... " + fileName);
                count++;
            }

            System.out.println("------------------------------------------------");
            System.out.println("ì„±ê³µ! íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: " + outputFile.getAbsolutePath());
            System.out.println("í”„ë¡œì íŠ¸ í´ë”ì—ì„œ 'all_classes_code.txt' íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.");

        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}

",

86. QuizApplication.java="
package com.project.quiz;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.scheduling.annotation.EnableScheduling;

@EnableScheduling
@SpringBootApplication
public class QuizApplication {

	public static void main(String[] args) {
		SpringApplication.run(QuizApplication.class, args);
	}

}

",

87. AchievementRepository.java="
package com.project.quiz.repository;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;

import com.project.quiz.domain.Achievement;
import com.project.quiz.domain.AchievementType;

public interface AchievementRepository extends JpaRepository<Achievement, Long> {
    // íŠ¹ì • í–‰ë™(ì˜ˆ: ì¶œì„)ì— ê±¸ë ¤ìˆëŠ” í™œì„± ì—…ì ë“¤ì„ ëª¨ë‘ ê°€ì ¸ì˜´ (ìºì‹± ê¶Œì¥)
    List<Achievement> findByAchievementTypeAndIsActiveTrue(AchievementType achievementType);
}

",

88. AttendanceRepository.java="
package com.project.quiz.repository;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserActivityAttendance;

public interface AttendanceRepository extends JpaRepository<UserActivityAttendance, Long> {
    // Log í…Œì´ë¸”ì„ í†µí•´ Userë¥¼ ì°¾ì•„ì„œ ì¡°íšŒ (ìµœì‹ ìˆœ ì •ë ¬ ë“±ì€ ì„ íƒì‚¬í•­)
    List<UserActivityAttendance> findAllByUserActivityLog_User(User user);
}
",

89. BoardRepository.java="
package com.project.quiz.repository;

import java.util.List;
import java.util.Optional;

import org.springframework.data.jpa.repository.JpaRepository;

import com.project.quiz.domain.BoardPost;

public interface BoardRepository extends JpaRepository<BoardPost, Long> {
	List<BoardPost> findByBoardTypeCodeOrderByCreatedAtDesc(String boardTypeCode);
	
	Optional<BoardPost> findFirstByBoardTypeCodeOrderByCreatedAtDesc(String boardTypeCode);
}

",

90. CodeTableRepository.java="
package com.project.quiz.repository;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;

import com.project.quiz.domain.CodeTable;

public interface CodeTableRepository extends JpaRepository<CodeTable, String> {
	List<CodeTable> findByGroupId(String groupId);
}

",

91. FriendMessageRepository.java="
package com.project.quiz.repository;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import com.project.quiz.domain.FriendMessage;

@Repository
public interface FriendMessageRepository extends JpaRepository<FriendMessage, Long> {
	List<FriendMessage> findByFriendshipIdOrderBySentAtAsc(Long friendshipId);

	List<FriendMessage> findByFriendshipIdAndSenderIdNotAndIsReadFalse(Long friendshipId, Long currentUserId);

	List<FriendMessage> findByIsReadFalseOrderBySentAtDesc();

	List<FriendMessage> findByFriendshipIdInAndSenderIdNotAndIsReadFalseOrderBySentAtDesc(List<Long> friendshipIds,
			Long senderId);

}
",

92. FriendshipRepository.java="
package com.project.quiz.repository;

import com.project.quiz.domain.Friendship;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface FriendshipRepository extends JpaRepository<Friendship, Long> {

	// ë‚´ê°€ ë³´ë‚¸ ìš”ì²­ (user_id = ë‚˜)
	List<Friendship> findByUserIdAndStatus(Long userId, String status);

	// ë‚´ê°€ ë°›ì€ ìš”ì²­ (friend_user_id = ë‚˜)
	List<Friendship> findByFriendUserIdAndStatus(Long friendUserId, String status);

	// ì¤‘ë³µ ì²´í¬
	boolean existsByUserIdAndFriendUserIdAndStatus(Long receiverId, Long senderId, String string);

	// íŠ¹ì • ë‘ ì‚¬ìš©ì ê°„ì˜ ê´€ê³„ ì¡°íšŒ
	Optional<Friendship> findByUserIdAndFriendUserId(Long userId, Long friendUserId);

	boolean existsByUserIdAndFriendUserIdAndStatusNotIn(Long senderId, Long receiverId, List<String> asList);

	List<Friendship> findByUserIdAndFriendUserIdAndStatus(Long userId, Long friendUserId, String status);

	List<Friendship> findByUserIdOrFriendUserId(Long userId, Long friendUserId);
}

",

93. NotificationRecipientRepository.java="
package com.project.quiz.repository;

import com.project.quiz.domain.NotificationRecipient;
import com.project.quiz.domain.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.util.List;

@Repository
public interface NotificationRecipientRepository extends JpaRepository<NotificationRecipient, Long> {

    // 1. íŠ¹ì • ìœ ì €ì˜ ì•Œë¦¼ ëª©ë¡ì„ ìµœì‹ ìˆœìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸° (User ê°ì²´ ê¸°ì¤€)
    List<NotificationRecipient> findByUserOrderByNotification_CreatedAtDesc(User user);

    // 2. íŠ¹ì • ìœ ì €ì˜ 'ì•ˆ ì½ì€' ì•Œë¦¼ ê°œìˆ˜ ì„¸ê¸°
    long countByUserAndIsReadFalse(User user);
}
",

94. NotificationRepository.java="
package com.project.quiz.repository;

import com.project.quiz.domain.Notification; // EntityëŠ” ë§Œë“¤ì—ˆë‹¤ê³  ê°€ì •
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface NotificationRepository extends JpaRepository<Notification, Long> {}
",

95. ParticipantRepository.java="
package com.project.quiz.repository;

import org.springframework.data.jpa.repository.JpaRepository;

import com.project.quiz.domain.Participant;
import com.project.quiz.domain.Room;
import com.project.quiz.domain.User;

import java.util.List;

public interface ParticipantRepository extends JpaRepository<Participant, Long> {
	List<Participant> findByRoom(Room room);

	boolean existsByRoomAndUser(Room room, User user);

	boolean existsByRoomAndGuestId(Room room, String guestId);

	Participant findByRoomAndUser(Room room, User user);

	Participant findByRoomAndGuestId(Room room, String guestId);

	List<Participant> findByUserIsNotNullOrderByScoreDescIdAsc();

}

",

96. QuizAnswerRepository.java="
package com.project.quiz.repository;

import com.project.quiz.domain.QuizAnswer;
import org.springframework.data.jpa.repository.JpaRepository;

public interface QuizAnswerRepository extends JpaRepository<QuizAnswer, Long> {
	
}
",

97. QuizGradingRepository.java="
package com.project.quiz.repository;

import java.util.Optional;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Lock;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import com.project.quiz.domain.QuizAnswer;
import com.project.quiz.domain.QuizGrading;

import jakarta.persistence.LockModeType;

public interface QuizGradingRepository extends JpaRepository<QuizGrading, Long> {

	// â­ QuizGrading â†’ QuizAnswer â†’ QuizSubmission â†’ userId ê²½ë¡œë¡œ ì¡°íšŒ
	@Query("SELECT COUNT(qg) FROM QuizGrading qg "
			+ "WHERE qg.answer.submission.userId = :userId AND qg.correct = true")
	long countByUserIdAndIsCorrectTrue(@Param("userId") Long userId);

	@Query("SELECT COUNT(qg) FROM QuizGrading qg "
			+ "WHERE qg.answer.submission.userId = :userId AND qg.correct = false")
	long countByUserIdAndIsCorrectFalse(@Param("userId") Long userId);
	
	@Lock(LockModeType.PESSIMISTIC_WRITE)
	@Query("select a from QuizAnswer a where a.answerId = :id")
	Optional<QuizAnswer> findByIdForUpdate(@Param("id") Long id);
	
	@Lock(LockModeType.PESSIMISTIC_WRITE)
	Optional<QuizGrading> findByAnswer_AnswerId(Long answerId);


}

",

98. QuizOptionRepository.java="
package com.project.quiz.repository;

import com.project.quiz.domain.Quiz;
import com.project.quiz.domain.QuizOption;

import org.springframework.data.jpa.repository.JpaRepository;

public interface QuizOptionRepository extends JpaRepository<QuizOption, Long> {
	
}
",

99. QuizQuestionRepository.java="
package com.project.quiz.repository;

import com.project.quiz.domain.QuizQuestion;

import org.springframework.data.jpa.repository.JpaRepository;

public interface QuizQuestionRepository extends JpaRepository<QuizQuestion, Long> {
	
}
",

100. QuizRepository.java="
package com.project.quiz.repository;

import java.util.List;
import java.util.Optional;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import com.project.quiz.domain.Quiz;
import com.project.quiz.domain.QuizQuestion;
import com.project.quiz.domain.User;

@Repository
public interface QuizRepository extends JpaRepository<Quiz, Long> {
	    List<Quiz> findAllByOrderByCreatedAtDesc();  // ìµœì‹ ìˆœ
	    List<Quiz> findAllByOrderByQuizIdDesc();     // ì¸ê¸°ìˆœ(ì˜ˆì‹œ)
	    List<QuizQuestion> findByQuizId(Long quizId);
	    List<Quiz> findByUserIdOrderByCreatedAtDesc(Long userId);
	    long countByUserId(Long UserId);

	    @Query("""
	    	    select distinct q
	    	    from Quiz q
	    	    left join fetch q.questions
	    	    where q.quizId = :id
	    	""")

	    Optional<Quiz> findByIdWithQuestions(@Param("id") Long id);
	    @Modifying
	    @Query("update Quiz q set q.scorePublic = :scorePublic where q.id = :quizId")
	    void updateScorePublic(@Param("quizId") Long quizId,
	                           @Param("scorePublic") boolean scorePublic);

}
",

101. QuizSubmissionRepository.java="
package com.project.quiz.repository;

import com.project.quiz.domain.QuizSubmission;
import org.springframework.data.jpa.repository.JpaRepository;

public interface QuizSubmissionRepository extends JpaRepository<QuizSubmission, Long> {
	
	long countByUserId(Long userId);
}

",

102. RoomQuizRepository.java="
package com.project.quiz.repository;

import com.project.quiz.domain.RoomQuiz;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.util.List;
import java.util.Optional;

@Repository
public interface RoomQuizRepository extends JpaRepository<RoomQuiz, Long> {

	// íŠ¹ì • ë°©ì˜ ëª¨ë“  í€´ì¦ˆ ì¡°íšŒ
	List<RoomQuiz> findByRoomId(Long roomId);

	// íŠ¹ì • ë°©ì˜ ê°€ì¥ ìµœê·¼ í€´ì¦ˆ ì¡°íšŒ
	Optional<RoomQuiz> findFirstByRoomIdOrderByAssignedAtDesc(Long roomId);

	void deleteByRoomId(Long roomId);
}

",

103. RoomRepository.java="
package com.project.quiz.repository;

import org.springframework.data.jpa.repository.JpaRepository;

import com.project.quiz.domain.Room;

import java.util.Optional;

public interface RoomRepository extends JpaRepository<Room, Long> {
	Optional<Room> findByRoomCode(String roomCode);
	
	boolean existsByRoomCode(String roomCode);
}

",

104. ShopItemRepository.java="
package com.project.quiz.repository;

import com.project.quiz.domain.ShopItem;
import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;

public interface ShopItemRepository extends JpaRepository<ShopItem, Long> {
    // íŒë§¤ ì¤‘ì¸ ìƒí’ˆë§Œ ê°€ì ¸ì˜¤ê¸°
    List<ShopItem> findByIsAvailableTrue();
}
",

105. UserAchievementRepository.java="
package com.project.quiz.repository;

import java.util.List;
import java.util.Optional;

import org.springframework.data.jpa.repository.JpaRepository;

import com.project.quiz.domain.Achievement;
import com.project.quiz.domain.User;
import com.project.quiz.domain.UserAchievement;

public interface UserAchievementRepository extends JpaRepository<UserAchievement, Long> {
    // ìœ ì €ì˜ íŠ¹ì • ì—…ì  ì§„í–‰ ìƒí™© ì¡°íšŒ
    Optional<UserAchievement> findByUserAndAchievement(User user, Achievement achievement);
    
    // ìœ ì €ê°€ ì™„ë£Œí•œ ì—…ì  ëª©ë¡ (í”„ë¡œí•„ í‘œì‹œìš©)
    List<UserAchievement> findByUserAndIsAchievedTrue(User user);
    
    List<UserAchievement> findAllByUser(User user);
    
    long countByUserAndIsAchievedTrue(User user);
    
    List<UserAchievement> findByUserAndIsAchievedTrueOrderByAchievedAtAsc(User user);
}
",

106. UserActivityLogRepository.java="
package com.project.quiz.repository;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserActivityLog;

public interface UserActivityLogRepository extends JpaRepository<UserActivityLog, Long> {
    
    // ì˜¤ëŠ˜ ë‚ ì§œ ë²”ìœ„(start~end)ì— í•´ë‹¹ ìœ ì €ì˜ íŠ¹ì • í™œë™(ATTENDANCE)ì´ ìˆëŠ”ì§€ í™•ì¸
    // ì¸ë±ìŠ¤ë¥¼ íƒ€ê¸° ë•Œë¬¸ì— ë§¤ìš° ë¹ ë¦„
    boolean existsByUserAndActivityTypeAndCreatedAtBetween(
        User user, 
        String activityType, 
        LocalDateTime start, 
        LocalDateTime end
    );
    
    Page<UserActivityLog> findAllByUserAndActivityTypeIn(User user, List<String> activityTypes, Pageable pageable);
    Optional<UserActivityLog> findTopByUserAndActivityTypeOrderByCreatedAtDesc(User user, String activityType);
}
",

107. UserActivityPointChangeRepository.java="
package com.project.quiz.repository;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserActivityPointChange;

public interface UserActivityPointChangeRepository extends JpaRepository<UserActivityPointChange, Long> {
    
    @Query("SELECT p FROM UserActivityPointChange p " +
           "JOIN p.userActivityLog l " +
           "WHERE l.user = :user " +
           "ORDER BY l.createdAt DESC")
    List<UserActivityPointChange> findAllByUserDesc(@Param("user") User user);
}
",

108. UserInventoryRepository.java="
package com.project.quiz.repository;

import java.util.List;
import java.util.Optional;

import org.springframework.data.jpa.repository.JpaRepository;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserInventory;

public interface UserInventoryRepository extends JpaRepository<UserInventory, Long> {
	List<UserInventory> findAllByUser(User user);
    // "ë‚´(User)ê°€ ê°€ì§„ ê²ƒ ì¤‘ì—, ì•„ì´í…œ ì¹´í…Œê³ ë¦¬(Item.Category)ê°€ ì¼ì¹˜í•˜ëŠ” ê²ƒë“¤" ì¡°íšŒ
    List<UserInventory> findAllByUserAndItem_Category(User user, String category);
    Optional<UserInventory> findByUserAndItem_CategoryAndIsEquippedTrue(User user, String category);
}
",

109. UserProfileRepository.java="
package com.project.quiz.repository;

import java.util.List;
import java.util.Optional;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;

import com.project.quiz.domain.UserProfile;

public interface UserProfileRepository extends JpaRepository<UserProfile, String> {

	Optional<UserProfile> findByUserId(Long userId);

	@Query("SELECT up FROM UserProfile up " + "WHERE up.user.id <> 1 " // userid = 1ì€ ê´€ë¦¬ì ê³„ì •ì´ë¯€ë¡œ ì œì™¸í•¨
			+ "ORDER BY up.pointBalance DESC, up.user.id ASC " + "LIMIT 10")
	List<UserProfile> findTopByPointBalance();

}
",

110. UserRepository.java="
package com.project.quiz.repository;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

import org.springframework.data.jpa.repository.JpaRepository;

import com.project.quiz.domain.User;

public interface UserRepository extends JpaRepository<User, Long> {
    // ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸í•œë‹¤ê³  ê°€ì • (usernameìœ¼ë¡œ í•˜ë ¤ë©´ findByUsername)
    Optional<User> findByEmail(String email);
    
    boolean existsByEmail(String email);

    List<User> findByEmailContaining(String email);
    
    List<User> findByStatusAndStatusChangedAtBefore(String status, LocalDateTime dateTime);
    
    List<User> findByStatus(String status);
}
",

111. AchievementService.java="
package com.project.quiz.service;

import java.time.LocalDateTime;
import java.util.List;

import org.springframework.context.event.EventListener;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.project.quiz.domain.Achievement;
import com.project.quiz.domain.AchievementType;
import com.project.quiz.domain.User;
import com.project.quiz.domain.UserAchievement;
import com.project.quiz.domain.UserActivityLog;
import com.project.quiz.domain.UserInventory;
import com.project.quiz.dto.AttendanceEvent;
import com.project.quiz.dto.ItemPurchasedEvent;
import com.project.quiz.dto.QuizSolvedEvent;
import com.project.quiz.repository.AchievementRepository;
import com.project.quiz.repository.UserAchievementRepository;
import com.project.quiz.repository.UserActivityLogRepository;
import com.project.quiz.repository.UserInventoryRepository;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@RequiredArgsConstructor
public class AchievementService {

    private final AchievementRepository achievementRepository;
    private final UserAchievementRepository userAchievementRepository;
    private final UserInventoryRepository userInventoryRepository; // ë³´ìƒ ì§€ê¸‰ìš©
    private final NotificationService notificationService; // ë©”ì‹œì§€ ì „ë‹¬
    private final UserActivityLogRepository userActivityLogRepository;

    /**
     * âœ… ì¶œì„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
     * AttendanceServiceê°€ ì¶œì„ ì´ë²¤íŠ¸ë¥¼ ë˜ì§€ë©´ ì—¬ê¸°ì„œ ë°›ìŠµë‹ˆë‹¤.
     */
    @Async // ë©”ì¸ ë¡œì§(ì¶œì„ì²´í¬)ì— ì˜í–¥ ì•ˆ ì£¼ê²Œ ë¹„ë™ê¸° ì²˜ë¦¬ ê¶Œì¥
    @EventListener
    @Transactional
    public void handleAttendance(AttendanceEvent event) {
        processAchievement(event.getUser(), AchievementType.ATTENDANCE_COUNT);
    }

    /**
     * âœ… í€´ì¦ˆ í’€ì´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
     */
    @Async
    @EventListener
    @Transactional
    public void handleQuizSolved(QuizSolvedEvent event) {
        // 1. ê·¸ëƒ¥ 'í’€ê¸°ë§Œ í•´ë„' ì˜¤ë¥´ëŠ” ì—…ì  ì²˜ë¦¬
        processAchievement(event.getUser(), AchievementType.QUIZ_SOLVED);

        // 2. 'ì •ë‹µ'ì¼ ê²½ìš°ë§Œ ì˜¤ë¥´ëŠ” ì—…ì  ì²˜ë¦¬
        if (event.isCorrect()) {
            processAchievement(event.getUser(), AchievementType.QUIZ_CORRECT);
        }
    }

    /**
     * â­ ê³µí†µ ì—…ì  ì²˜ë¦¬ ë¡œì§ (í•µì‹¬)
     * 1. í•´ë‹¹ íƒ€ì…ì˜ ì—…ì ë“¤ì„ ê°€ì ¸ì˜¨ë‹¤.
     * 2. ìœ ì €ì˜ ì§„í–‰ë„(UserAchievement)ë¥¼ ì°¾ê±°ë‚˜ ë§Œë“ ë‹¤.
     * 3. ìˆ«ìë¥¼ +1 í•œë‹¤.
     * 4. ëª©í‘œ ë‹¬ì„± ì‹œ ë³´ìƒì„ ì¤€ë‹¤.
     */
    private void processAchievement(User user, AchievementType type) {
        // 1. í•´ë‹¹ íƒ€ì…ì˜ í™œì„± ì—…ì  ì¡°íšŒ (ì˜ˆ: 50íšŒ ì¶œì„, 100íšŒ ì¶œì„ ë“±)
        List<Achievement> targets = achievementRepository.findByAchievementTypeAndIsActiveTrue(type);

        for (Achievement achievement : targets) {
            // 2. ë‚´ ì§„í–‰ ìƒí™© ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ìƒì„±)
            UserAchievement progress = userAchievementRepository.findByUserAndAchievement(user, achievement)
                    .orElseGet(() -> createNewProgress(user, achievement));

            // ì´ë¯¸ ë‹¬ì„±í–ˆìœ¼ë©´ ìŠ¤í‚µ (ì¤‘ë³µ ë³´ìƒ ë°©ì§€)
            if (progress.getIsAchieved()) {
                continue;
            }

            // 3. ì§„í–‰ë„ ì¦ê°€ (+1)
            progress.incrementValue();
            
            // (ì˜µì…˜) ì—°ì† ì¶œì„ ë¡œì§ì€ ì—¬ê¸°ì„œ lastUpdatedAt ë¹„êµí•˜ì—¬ ì´ˆê¸°í™” ë¡œì§ ì¶”ê°€ ê°€ëŠ¥

            // 4. ëª©í‘œ ë‹¬ì„± ì²´í¬
            if (progress.getCurrentValue() >= achievement.getGoalValue()) {
                achieve(progress);
            }
        }
    }

    // ì‹ ê·œ ì§„í–‰ë„ ìƒì„±
    private UserAchievement createNewProgress(User user, Achievement achievement) {
        UserAchievement ua = UserAchievement.builder()
                .user(user)
                .achievement(achievement)
                .currentValue(0L)
                .isAchieved(false)
                .isRewarded(false)
                .build();
        return userAchievementRepository.save(ua);
    }

    // ë‹¬ì„± ì²˜ë¦¬ ë° ë³´ìƒ ì§€ê¸‰
    private void achieve(UserAchievement progress) {
        progress.markAchieved(); // ë‹¬ì„± ìƒíƒœ ë³€ê²½ (DB ì—…ë°ì´íŠ¸)
        
        Achievement goal = progress.getAchievement();
        log.info("ğŸ‰ ì—…ì  ë‹¬ì„±! ìœ ì €: {}, ì—…ì : {}", progress.getUser().getEmail(), goal.getTitle());

        // â–¼â–¼â–¼ [2. ì¶”ê°€] í™œë™ ë¡œê·¸("ACHIEVEMENT") ì €ì¥ ë¡œì§ ì‹œì‘ â–¼â–¼â–¼
        UserActivityLog activityLog = UserActivityLog.builder()
                .user(progress.getUser())
                .activityType("ACHIEVEMENT") // ìš”ì²­í•˜ì‹  íƒ€ì…
                .description("ì—…ì  [" + goal.getTitle() + "] ë‹¬ì„±") // ì˜ˆ: ì—…ì  [ì„±ì‹¤í•œ ì¶œì„ëŸ¬] ë‹¬ì„±
                .createdAt(LocalDateTime.now())
                .build();
        
        userActivityLogRepository.save(activityLog);
        // â–²â–²â–² [2. ì¶”ê°€] í™œë™ ë¡œê·¸ ì €ì¥ ë¡œì§ ë â–²â–²â–²

        // ğŸ ë³´ìƒ ì•„ì´í…œ ì§€ê¸‰ (UserInventoryì— ì¶”ê°€)
        if (goal.getRewardItem() != null) {
            UserInventory reward = UserInventory.builder()
                    .user(progress.getUser())
                    .item(goal.getRewardItem())
                    .purchasedAt(LocalDateTime.now())
                    .isEquipped(false)
                    .build();
            userInventoryRepository.save(reward);
            
            progress.markRewarded(); // ë³´ìƒ ì§€ê¸‰ ì™„ë£Œ ì²˜ë¦¬
        }

        notificationService.send(
                progress.getUser(),
                "ì—…ì  ë‹¬ì„±! ğŸ‰", 
                "[" + progress.getAchievement().getTitle() + "] ë©”ë‹¬ì„ íšë“í–ˆìŠµë‹ˆë‹¤.",
                "ACHIEVEMENT"
        );
    }
    
    @Async
    @EventListener
    @Transactional
    public void handleItemPurchase(ItemPurchasedEvent event) {
        // ITEM_COLLECTOR íƒ€ì…ì˜ ì—…ì ì„ ì°¾ì•„ì„œ ì§„í–‰ë„ ì¦ê°€
        processAchievement(event.getUser(), AchievementType.ITEM_COLLECTOR);
    }
}
",

112. AttendanceService.java="
package com.project.quiz.service;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.context.ApplicationEventPublisher;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserActivityAttendance;
import com.project.quiz.domain.UserActivityLog;
import com.project.quiz.dto.AttendanceEvent;
import com.project.quiz.dto.AttendanceEventDto;
import com.project.quiz.repository.AttendanceRepository;
import com.project.quiz.repository.UserActivityLogRepository;
import com.project.quiz.repository.UserRepository;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class AttendanceService {

    private final UserActivityLogRepository logRepository;
    private final AttendanceRepository attendanceRepository;
    private final UserRepository userRepository;
    private final PointService pointService;
    private final ApplicationEventPublisher eventPublisher;

    // [ì½ê¸°] ì˜¤ëŠ˜ ì¶œì„ ì—¬ë¶€ í™•ì¸ (Log í…Œì´ë¸”ë§Œ ì¡°íšŒ)
    @Transactional(readOnly = true)
    public boolean hasCheckedInToday(String email) {
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ì ì—†ìŒ"));

        LocalDateTime start = LocalDate.now().atStartOfDay();
        LocalDateTime end = LocalDate.now().atTime(LocalTime.MAX);

        return logRepository.existsByUserAndActivityTypeAndCreatedAtBetween(
                user, "ATTENDANCE", start, end
        );
    }

    // [ì“°ê¸°] ì¶œì„ ì²´í¬ ì§„í–‰ (Log -> Attendance -> Point ìˆœì„œ)
    @Transactional
    public void checkIn(String email) {
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ì ì—†ìŒ"));

        if (hasCheckedInToday(email)) {
            throw new IllegalStateException("ì´ë¯¸ ì¶œì„í–ˆìŠµë‹ˆë‹¤.");
        }

        // [ìˆ˜ì •] ë¡œê·¸ ë©”ì‹œì§€ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ë³€ê²½
        String logDescription = user.getUserProfile().getUsername() + "ë‹˜ì´ ì¶œì„ì²´í¬ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.";

        // 1. í™œë™ ë¡œê·¸ ìƒì„± (ë¶€ëª¨ í…Œì´ë¸”: user_activity_log)
        UserActivityLog log = UserActivityLog.builder()
                .user(user)
                .activityType("ATTENDANCE") // íƒ€ì…: ì¶œì„
                .description(logDescription) // "OOOë‹˜ì´ ì¶œì„ì²´í¬ë¥¼..."
                .createdAt(LocalDateTime.now())
                .build();
        logRepository.save(log);

        // 2. ì¶œì„ ìƒì„¸ ê¸°ë¡ ì €ì¥ (ìì‹ í…Œì´ë¸”: user_activity_attendance)
        UserActivityAttendance attendance = UserActivityAttendance.builder()
                .userActivityLog(log) // ë¶€ëª¨ ë¡œê·¸ì™€ ì—°ê²°
                .checkInDate(LocalDate.now())
                .pointsEarned(100)
                .build();
        attendanceRepository.save(attendance);

        // 3. í¬ì¸íŠ¸ ì§€ê¸‰ (PointServiceê°€ ë³„ë„ ë¡œê·¸ ìƒì„±í•¨ -> "POINT_EARN" ë¡œê·¸ë„ ê°™ì´ ìŒ“ì„)
        pointService.addPoint(user, 100, "ì¼ì¼ ì¶œì„ì²´í¬ ë³´ìƒ");
        eventPublisher.publishEvent(new AttendanceEvent(user));
    }
    
    @Transactional(readOnly = true)
    public List<AttendanceEventDto> getMyAttendanceEvents(String email) {
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ì ì—†ìŒ"));

        return attendanceRepository.findAllByUserActivityLog_User(user)
                .stream()
                .map(AttendanceEventDto::new)
                .collect(Collectors.toList());
    }
}
",

113. BoardService.java="
package com.project.quiz.service;

import java.time.LocalDateTime;
import java.util.List;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.project.quiz.domain.BoardPost;
import com.project.quiz.domain.User;
import com.project.quiz.repository.BoardRepository;
import com.project.quiz.repository.UserRepository;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
@Transactional
public class BoardService {

    private final BoardRepository boardRepository;
    private final UserRepository userRepository;

    // ê³µì§€ì‚¬í•­ ëª©ë¡ ì¡°íšŒ (ì½ê¸° ì „ìš©)
    @Transactional(readOnly = true)
    public List<BoardPost> getNoticeList() {
        // ì½”ë“œ í…Œì´ë¸”ì˜ 'notice'ì™€ ì¼ì¹˜í•´ì•¼ í•¨
        return boardRepository.findByBoardTypeCodeOrderByCreatedAtDesc("notice");
    }

    // ê³µì§€ì‚¬í•­ ìƒì„¸ ì¡°íšŒ
    @Transactional(readOnly = true) // ğŸ’¡ ë‹¤ì‹œ readOnly = trueë¡œ ë³€ê²½ (ì„±ëŠ¥ í–¥ìƒ)
    public BoardPost getPost(Long postId) {
        BoardPost post = boardRepository.findById(postId)
                .orElseThrow(() -> new IllegalArgumentException("ê²Œì‹œê¸€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));
        
        // âŒ ì‚­ì œ: post.setViewCount(post.getViewCount() + 1); 
        // ì¡°íšŒìˆ˜ ì¦ê°€ ë¡œì§ ì œê±°
        
        return post;
    }

    // ê³µì§€ì‚¬í•­ ì‘ì„± (ê´€ë¦¬ì ê¶Œí•œ ì²´í¬ëŠ” Controller/Securityì—ì„œ 1ì°¨ ìˆ˜í–‰)
    public void writeNotice(String email, String title, String content) {
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ì ì—†ìŒ"));

        // (ì„ íƒ) ì—¬ê¸°ì„œ í•œ ë²ˆ ë” ADMIN ì²´í¬ë¥¼ í•  ìˆ˜ë„ ìˆìŒ
        if (!"ADMIN".equals(user.getRole())) {
             throw new IllegalStateException("ê´€ë¦¬ìë§Œ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }

        BoardPost post = new BoardPost();
        post.setBoardTypeCode("notice"); // â˜… í•µì‹¬: ì½”ë“œê°’ noticeë¡œ ê³ ì •
        post.setUserId(user.getId());
        post.setTitle(title);
        post.setContent(content);
        post.setViewCount(0);
        post.setCreatedAt(LocalDateTime.now());
        
        boardRepository.save(post);
    }
}
",

114. CustomOAuth2UserService.java="
package com.project.quiz.service;

import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.oauth2.client.userinfo.DefaultOAuth2UserService;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserRequest;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserService;
import org.springframework.security.oauth2.core.OAuth2AuthenticationException;
import org.springframework.security.oauth2.core.user.DefaultOAuth2User;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.stereotype.Service;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserProfile;
import com.project.quiz.dto.OAuthAttributes;
import com.project.quiz.repository.UserRepository;

import lombok.RequiredArgsConstructor;

@RequiredArgsConstructor
@Service
public class CustomOAuth2UserService implements OAuth2UserService<OAuth2UserRequest, OAuth2User> {

	private final UserRepository userRepository;
	private final PasswordEncoder passwordEncoder;

	@Override
	public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
		// 1. ì†Œì…œ ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ê¸°ì¡´ ì½”ë“œ)
		OAuth2UserService<OAuth2UserRequest, OAuth2User> delegate = new DefaultOAuth2UserService();
		OAuth2User oAuth2User = delegate.loadUser(userRequest);

		String registrationId = userRequest.getClientRegistration().getRegistrationId();
		String userNameAttributeName = userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint()
				.getUserNameAttributeName();

		// 2. ë°ì´í„° ì •ì œ (ê¸°ì¡´ ì½”ë“œ)
		OAuthAttributes attributes = OAuthAttributes.of(registrationId, userNameAttributeName,
				oAuth2User.getAttributes());

		// â­ [ìˆ˜ì •] ì‹ ê·œ íšŒì›ì¸ì§€ ë¨¼ì € í™•ì¸! (DBì— ì´ë©”ì¼ì´ ì—†ìœ¼ë©´ ì‹ ê·œ)
		boolean isNewUser = !userRepository.existsByEmail(attributes.getEmail());

		// 3. ì €ì¥ ë˜ëŠ” ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì½”ë“œ)
		User user = saveOrGet(attributes);

		// 4. ë¦¬í„´í•  ì†ì„± ë§µ êµ¬ì„±
		Map<String, Object> newAttributes = new HashMap<>(attributes.getAttributes());
		newAttributes.put("email", attributes.getEmail());

		// â­ [ì¶”ê°€] 'isNew'ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì‹ ê·œ íšŒì› ì—¬ë¶€ë¥¼ ë‹´ìŒ
		newAttributes.put("isNew", isNewUser);

		return new DefaultOAuth2User(Collections.singleton(new SimpleGrantedAuthority(user.getRole())), newAttributes,
				"email");
	}

	private User saveOrGet(OAuthAttributes attributes) {
		User user = userRepository.findByEmail(attributes.getEmail()).orElseGet(() -> {
			// ì‹ ê·œ ìœ ì € ìƒì„± ì‹œ
			User newUser = attributes.toEntity(); // ì—¬ê¸°ì—” email, role ë“±ë§Œ ìˆìŒ
			
			String randomPassword = UUID.randomUUID().toString();
            newUser.setPassword(passwordEncoder.encode(randomPassword));

			// í”„ë¡œí•„ ìƒì„±
			UserProfile profile = UserProfile.builder().username(attributes.getUsername()).pointBalance(100L).build();

			newUser.setUserProfile(profile);
			return newUser;
		});

		return userRepository.save(user);
	}
}
",

115. EmailService.java="
package com.project.quiz.service;

import java.io.UnsupportedEncodingException;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.stereotype.Service;

import jakarta.mail.MessagingException;
import jakarta.mail.internet.MimeMessage;
import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class EmailService {

    private final JavaMailSender javaMailSender;
    
    @Value("${spring.mail.username}")
    private String senderEmail;

    public void sendEmail(String to, String subject, String text) {
        // MimeMessage ìƒì„±
        MimeMessage message = javaMailSender.createMimeMessage();

        try {
            // MimeMessageHelper: ë³µì¡í•œ ì„¤ì •ì„ ì‰½ê²Œ ë„ì™€ì£¼ëŠ” ë„ìš°ë¯¸
            // ë‘ ë²ˆì§¸ ì¸ì true: ë©€í‹°íŒŒíŠ¸(ì²¨ë¶€íŒŒì¼ ë“±) í—ˆìš© ì—¬ë¶€ (ì—¬ê¸°ì„  í¬ê²Œ ìƒê´€ì—†ìŒ)
            // "UTF-8": í•œê¸€ ê¹¨ì§ ë°©ì§€
            MimeMessageHelper helper = new MimeMessageHelper(message, false, "UTF-8");

            helper.setTo(to);
            helper.setSubject(subject);
            helper.setText(text, false); // false: html ì•„ë‹˜ (ì¼ë°˜ í…ìŠ¤íŠ¸)

            // â–¼â–¼â–¼ í•µì‹¬: ë³´ë‚¸ ì‚¬ëŒ ì´ë¦„ ì„¤ì • â–¼â–¼â–¼
            // setFrom("ë³´ë‚´ëŠ”ì´ë©”ì¼", "í‘œì‹œë ì´ë¦„")
            // ì£¼ì˜: ë³´ë‚´ëŠ” ì´ë©”ì¼ì€ application.propertiesì˜ ê³„ì •ê³¼ ì¼ì¹˜í•´ì•¼ ì˜¤ë¥˜ê°€ ì•ˆ ë‚©ë‹ˆë‹¤.
            helper.setFrom(senderEmail, "Quinect ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°");

            javaMailSender.send(message);

        } catch (MessagingException | UnsupportedEncodingException e) {
            // ì—ëŸ¬ ë¡œê·¸ ì¶œë ¥ ë˜ëŠ” ì˜ˆì™¸ ì²˜ë¦¬
            e.printStackTrace();
            throw new RuntimeException("ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨", e);
        }
    }
}
",

116. FileStorageService.java="
package com.project.quiz.service;

import org.springframework.web.multipart.MultipartFile;

public interface FileStorageService {
    // íŒŒì¼ì„ ì €ì¥í•˜ê³  ì ‘ê·¼ ê°€ëŠ¥í•œ URL(ë˜ëŠ” íŒŒì¼ëª…)ì„ ë°˜í™˜
    String storeFile(MultipartFile file);
    
    // íŒŒì¼ ì‚­ì œ (í”„ë¡œí•„ ë³€ê²½ ì‹œ ê¸°ì¡´ íŒŒì¼ ì‚­ì œìš©)
    void deleteFile(String fileUrl);
}
",

117. FriendMessageService.java="
package com.project.quiz.service;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.project.quiz.domain.FriendMessage;
import com.project.quiz.domain.Friendship;
import com.project.quiz.domain.User;
import com.project.quiz.domain.UserProfile;
import com.project.quiz.dto.FriendMessageDTO;
import com.project.quiz.repository.FriendMessageRepository;
import com.project.quiz.repository.FriendshipRepository;
import com.project.quiz.repository.UserRepository;
import com.project.quiz.repository.UserProfileRepository;

import lombok.RequiredArgsConstructor;

@Service
@Transactional
@RequiredArgsConstructor
public class FriendMessageService {

	private final FriendMessageRepository friendMessageRepository;
	private final FriendshipRepository friendshipRepository;
	private final FriendshipService friendshipService; // â­ ì¶”ê°€
	private final UserRepository userRepository;
	private final UserProfileRepository userProfileRepository;

	/**
	 * ë©”ì‹œì§€ ì „ì†¡
	 */
	public FriendMessageDTO sendMessage(Long friendshipId, Long userId, String content) {
		// âœ… ì¹œêµ¬ ê´€ê³„ ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸
		Friendship friendship = friendshipRepository.findById(friendshipId)
				.orElseThrow(() -> new IllegalArgumentException("ì¹œêµ¬ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤"));

		// âœ… ë©”ì‹œì§€ë§Œ ì €ì¥ (friendship ì—…ë°ì´íŠ¸ X)
		FriendMessage message = new FriendMessage();
		message.setFriendship(friendship);
		message.setSenderId(userId);
		message.setMessageText(content);
		message.setIsRead(false);
		message.setSentAt(LocalDateTime.now());

		FriendMessage saved = friendMessageRepository.save(message);

		return new FriendMessageDTO(saved);
	}

	/**
	 * ë©”ì‹œì§€ ì¡°íšŒ (ë‹‰ë„¤ì„ ì²˜ë¦¬ í¬í•¨)
	 */
	public List<FriendMessageDTO> getMessages(Long friendshipId, Long currentUserId) {
		// 1. friendship ì¡°íšŒ
		Friendship friendship = friendshipRepository.findById(friendshipId)
				.orElseThrow(() -> new IllegalArgumentException("ì¹œêµ¬ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤"));

		// 2. ìƒëŒ€ë°© User ê°ì²´ êµ¬í•˜ê¸°
		User otherUser;
		if (friendship.getUser().getId().equals(currentUserId)) {
			otherUser = friendship.getFriendUser();
		} else {
			otherUser = friendship.getUser();
		}

		// 3. ì¹œêµ¬ ì‚­ì œ ì—¬ë¶€ í™•ì¸ (statusê°€ "accepted"ê°€ ì•„ë‹˜)
		boolean isFriendDeleted = !"accepted".equals(friendship.getStatus());

		// 4. ë©”ì‹œì§€ ì¡°íšŒ
		List<FriendMessage> messages = friendMessageRepository.findByFriendshipIdOrderBySentAtAsc(friendshipId);

		// 5. ë©”ì‹œì§€ë¥¼ DTOë¡œ ë³€í™˜í•˜ë©° ë‹‰ë„¤ì„ ì²˜ë¦¬
		return messages.stream().map(msg -> {
			FriendMessageDTO dto = convertToDTO(msg);

			// ìƒëŒ€ë°©ì´ ë³´ë‚¸ ë©”ì‹œì§€ì´ê³  ì¹œêµ¬ê°€ ì‚­ì œëœ ê²½ìš°
			if (msg.getSenderId().equals(otherUser.getId()) && isFriendDeleted) {
				dto.setSenderName("ì•Œ ìˆ˜ ì—†ìŒ");
			} else {
				// ë³´ë‚¸ ì‚¬ëŒì˜ ë‹‰ë„¤ì„ ì¡°íšŒ (UserProfileì—ì„œ)
				String senderName = getUserName(msg.getSenderId());
				dto.setSenderName(senderName);
			}

			return dto;
		}).collect(Collectors.toList());
	}

	/**
	 * â­ í˜„ì¬ ì‚¬ìš©ìì˜ ì•ˆ ì½ì€ ì¹œêµ¬ ë©”ì‹œì§€ 5ê°œ ì¡°íšŒ í˜„ì¬ ì‚¬ìš©ìê°€ í¬í•¨ëœ friendshipì˜ ë©”ì‹œì§€ë§Œ ì¡°íšŒ
	 */
	/**
	 * â­ ì•ˆ ì½ì€ ë©”ì‹œì§€ë¥¼ ë°œì‹ ìë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ì¡°íšŒ
	 */
	/**
	 * â­ ì•ˆ ì½ì€ ë©”ì‹œì§€ë¥¼ ë°œì‹ ìë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ì¡°íšŒ
	 */
	public List<Map<String, Object>> getUnreadMessages(Long currentUserId) {
		// â­ Step 1: í˜„ì¬ ì‚¬ìš©ìì˜ ëª¨ë“  accepted friendship ì¡°íšŒ
		List<Friendship> friendships = friendshipService.findAllFriendshipsForUser(currentUserId);

		List<Long> friendshipIds = friendships.stream().map(Friendship::getId).collect(Collectors.toList());

		if (friendshipIds.isEmpty()) {
			return new ArrayList<>();
		}

		// â­ Step 2: í˜„ì¬ ì‚¬ìš©ìê°€ ë°›ì€ ë¯¸ì½ì€ ë©”ì‹œì§€ ì¡°íšŒ
		List<FriendMessage> unreadMessages = friendMessageRepository
				.findByFriendshipIdInAndSenderIdNotAndIsReadFalseOrderBySentAtDesc(friendshipIds, currentUserId);

		if (unreadMessages.isEmpty()) {
			return new ArrayList<>();
		}

		// â­ Step 3: ë°œì‹ ìë³„ë¡œ ê·¸ë£¹í™”
		Map<Long, List<FriendMessage>> groupedBySender = unreadMessages.stream()
				.collect(Collectors.groupingBy(msg -> msg.getSenderId()));

		// â­ Step 4: ê²°ê³¼ ë§µ ìƒì„±
		List<Map<String, Object>> result = new ArrayList<>();

		for (Map.Entry<Long, List<FriendMessage>> entry : groupedBySender.entrySet()) {
			Long senderId = entry.getKey();
			List<FriendMessage> messages = entry.getValue();

			FriendMessage lastMessage = messages.get(messages.size() - 1);

			User sender = userRepository.findById(senderId).orElse(null);

			if (sender == null) {
				continue;
			}

			String senderName = "ì•Œ ìˆ˜ ì—†ìŒ";
			if (sender.getUserProfile() != null) {
				senderName = sender.getUserProfile().getUsername();
			} else {
				senderName = sender.getEmail();
			}

			String profileImage = null;
			if (sender.getUserProfile() != null) {
				profileImage = sender.getUserProfile().getProfileImage();
			}

			Map<String, Object> messageGroup = new HashMap<>();
			messageGroup.put("senderId", senderId);
			messageGroup.put("senderName", senderName);
			messageGroup.put("messageCount", messages.size()); // â­ ì¤‘ìš”!
			messageGroup.put("lastMessage", lastMessage.getMessageText());
			messageGroup.put("profileImage", profileImage);
			messageGroup.put("sentAt", lastMessage.getSentAt());

			result.add(messageGroup);

		}

		// â­ Step 5: ì‹œê°„ ì—­ìˆœ ì •ë ¬
		result.sort((a, b) -> {
			LocalDateTime timeA = (LocalDateTime) a.get("sentAt");
			LocalDateTime timeB = (LocalDateTime) b.get("sentAt");
			return timeB.compareTo(timeA);
		});

		return result;
	}

	/**
	 * ì¹œêµ¬ ì‚­ì œ (status ë³€ê²½)
	 */
	@Transactional
	public void deleteFriendship(Long friendshipId) {
		Friendship friendship = friendshipRepository.findById(friendshipId)
				.orElseThrow(() -> new IllegalArgumentException("ì¹œêµ¬ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤"));

		friendship.setStatus("rejected"); // ë˜ëŠ” "blocked" ë“±ìœ¼ë¡œ ë³€ê²½
		friendship.setUpdatedAt(LocalDateTime.now());
		friendshipRepository.save(friendship);
	}

	/**
	 * ì¹œêµ¬ ë³µêµ¬
	 */
	@Transactional
	public void restoreFriendship(Long friendshipId) {
		Friendship friendship = friendshipRepository.findById(friendshipId)
				.orElseThrow(() -> new IllegalArgumentException("ì¹œêµ¬ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤"));

		friendship.setStatus("accepted");
		friendship.setUpdatedAt(LocalDateTime.now());
		friendshipRepository.save(friendship);
	}

	/**
	 * â­ íŠ¹ì • friendshipì˜ ì‚¬ìš©ìê°€ ë°›ì€ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì½ìŒ ì²˜ë¦¬
	 */
	@Transactional
	public void markChatRoomAsRead(Long friendshipId, Long currentUserId) {
		// 1ë‹¨ê³„: í˜„ì¬ ì‚¬ìš©ìê°€ ë°›ì€ ì•ˆ ì½ì€ ë©”ì‹œì§€ë“¤ ì¡°íšŒ
		List<FriendMessage> unreadMessages = friendMessageRepository
				.findByFriendshipIdAndSenderIdNotAndIsReadFalse(friendshipId, currentUserId);

		// 2ë‹¨ê³„: ê° ë©”ì‹œì§€ë¥¼ ì½ìŒ ì²˜ë¦¬
		unreadMessages.forEach(message -> {
			message.markAsRead();
		});

		// 3ë‹¨ê³„: DBì— ì €ì¥ (ë³€ê²½ê°ì§€ë¡œ ìë™ update)
		friendMessageRepository.saveAll(unreadMessages);

	}

	/**
	 * UserProfileì—ì„œ ë‹‰ë„¤ì„ ì¡°íšŒ (Helper)
	 */
	private String getUserName(Long userId) {
		try {
			User user = userRepository.findById(userId).orElse(null);
			if (user == null) {
				return "ì•Œ ìˆ˜ ì—†ìŒ";
			}

			UserProfile profile = userProfileRepository.findByUserId(userId).orElse(null);
			if (profile != null && profile.getUsername() != null) {
				return profile.getUsername();
			}

			return "ì•Œ ìˆ˜ ì—†ìŒ";
		} catch (Exception e) {
			return "ì•Œ ìˆ˜ ì—†ìŒ";
		}
	}

	private FriendMessageDTO convertToDTO(FriendMessage message) {
		FriendMessageDTO dto = new FriendMessageDTO(message);
		dto.setSenderName(getUserName(message.getSenderId()));
		return dto;
	}

}

",

118. FriendshipService.java="
package com.project.quiz.service;

import com.project.quiz.domain.Friendship;
import com.project.quiz.domain.User;
import com.project.quiz.dto.UserSearchResponse;
import com.project.quiz.repository.FriendshipRepository;
import com.project.quiz.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class FriendshipService {

	private final UserRepository userRepository;
	private final FriendshipRepository friendshipRepository;

	/**
	 * ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ê²€ìƒ‰í•˜ê³  ì¹œêµ¬ ìƒíƒœ í¬í•¨í•´ì„œ ë°˜í™˜
	 */
	public List<UserSearchResponse> searchUsersByEmail(String email, Long currentUserId) {
		List<User> users = userRepository.findByEmailContaining(email);

		List<User> filteredUsers = users.stream().filter(user -> !user.getId().equals(currentUserId))
				.collect(Collectors.toList());

		if (filteredUsers.isEmpty()) {
			return List.of();
		}

		// ë‚´ê°€ ë³´ë‚¸ ìš”ì²­ (user_id = ë‚˜)
		Map<Long, String> sentRequests = friendshipRepository.findByUserIdAndStatus(currentUserId, "pending").stream()
				.collect(Collectors.toMap(f -> f.getFriendUser().getId(), f -> "PENDING_SENT"));

		// ë‚´ê°€ ë°›ì€ ìš”ì²­ (friend_user_id = ë‚˜)
		Map<Long, String> receivedRequests = friendshipRepository.findByFriendUserIdAndStatus(currentUserId, "pending")
				.stream().collect(Collectors.toMap(f -> f.getUser().getId(), f -> "PENDING_RECEIVED"));

		// ìˆ˜ë½ëœ ì¹œêµ¬ (user_id = ë‚˜ì¸ ê²½ìš°)
		List<Friendship> acceptedFriendshipsAsSender = friendshipRepository.findByUserIdAndStatus(currentUserId,
				"accepted");
		Map<Long, String> acceptedFriendsAsSender = acceptedFriendshipsAsSender.stream()
				.collect(Collectors.toMap(f -> f.getFriendUser().getId(), f -> "ACCEPTED"));

		// ìˆ˜ë½ëœ ì¹œêµ¬ (friend_user_id = ë‚˜ì¸ ê²½ìš°)
		List<Friendship> acceptedFriendshipsAsReceiver = friendshipRepository.findByFriendUserIdAndStatus(currentUserId,
				"accepted");
		Map<Long, String> acceptedFriendsAsReceiver = acceptedFriendshipsAsReceiver.stream()
				.collect(Collectors.toMap(f -> f.getUser().getId(), f -> "ACCEPTED"));

		return filteredUsers.stream().map(user -> {
			String status = sentRequests.getOrDefault(user.getId(),
					receivedRequests.getOrDefault(user.getId(), acceptedFriendsAsSender.getOrDefault(user.getId(),
							acceptedFriendsAsReceiver.getOrDefault(user.getId(), "NONE"))));
			return UserSearchResponse.from(user, status);
		}).collect(Collectors.toList());
	}

	/**
	 * ë‚´ê°€ ë°›ì€ ì¹œêµ¬ ìš”ì²­ (Friendship ID í¬í•¨)
	 */
	public List<UserSearchResponse> getReceivedRequests(Long currentUserId) {
		List<Friendship> friendships = friendshipRepository.findByFriendUserIdAndStatus(currentUserId, "pending");

		return friendships.stream()
				.map(f -> UserSearchResponse.fromFriendship(f.getUser(), f.getId(), "PENDING_RECEIVED"))
				.collect(Collectors.toList());
	}

	/**
	 * ë‚´ê°€ ë³´ë‚¸ ì¹œêµ¬ ìš”ì²­ (Friendship ID í¬í•¨)
	 */
	public List<UserSearchResponse> getSentRequests(Long currentUserId) {
		List<Friendship> friendships = friendshipRepository.findByUserIdAndStatus(currentUserId, "pending");

		return friendships.stream()
				.map(f -> UserSearchResponse.fromFriendship(f.getFriendUser(), f.getId(), "PENDING_SENT"))
				.collect(Collectors.toList());
	}

	/**
	 * â­ ìˆ˜ë½ëœ ì¹œêµ¬ ëª©ë¡ (Friendship ID í¬í•¨) user_id = ë‚˜ì¸ ê²½ìš° + friend_user_id = ë‚˜ì¸ ê²½ìš° ëª¨ë‘ í¬í•¨
	 */
	public List<UserSearchResponse> getAcceptedFriendsWithIds(Long currentUserId) {
		// user_id = ë‚˜ì¸ ê²½ìš° (ë‚´ê°€ ë³´ë‚¸ ìš”ì²­ì´ ìˆ˜ë½ë¨)
		List<Friendship> friendshipsAsSender = friendshipRepository.findByUserIdAndStatus(currentUserId, "accepted");

		// friend_user_id = ë‚˜ì¸ ê²½ìš° (ë‚´ê°€ ë°›ì€ ìš”ì²­ì´ ìˆ˜ë½ë¨)
		List<Friendship> friendshipsAsReceiver = friendshipRepository.findByFriendUserIdAndStatus(currentUserId,
				"accepted");

		List<UserSearchResponse> accepted = new ArrayList<>();

		// ë‚´ê°€ ë³´ë‚¸ ìš”ì²­ì´ ìˆ˜ë½ëœ ê²½ìš°
		accepted.addAll(friendshipsAsSender.stream()
				.map(f -> UserSearchResponse.fromFriendship(f.getFriendUser(), f.getId(), "ACCEPTED"))
				.collect(Collectors.toList()));

		// ë‚´ê°€ ë°›ì€ ìš”ì²­ì´ ìˆ˜ë½ëœ ê²½ìš°
		accepted.addAll(friendshipsAsReceiver.stream()
				.map(f -> UserSearchResponse.fromFriendship(f.getUser(), f.getId(), "ACCEPTED"))
				.collect(Collectors.toList()));

		return accepted;
	}

	/**
	 * ìˆ˜ë½ëœ ì¹œêµ¬ ëª©ë¡ (Friendship ID í¬í•¨)
	 */
	public List<UserSearchResponse> getAcceptedFriends(Long currentUserId) {
		// user_id = ë‚˜ì¸ ê²½ìš° (ë‚´ê°€ ë³´ë‚¸ ìš”ì²­ì´ ìˆ˜ë½ë¨)
		List<Friendship> friendshipsAsSender = friendshipRepository.findByUserIdAndStatus(currentUserId, "accepted");

		// friend_user_id = ë‚˜ì¸ ê²½ìš° (ë‚´ê°€ ë°›ì€ ìš”ì²­ì´ ìˆ˜ë½ë¨)
		List<Friendship> friendshipsAsReceiver = friendshipRepository.findByFriendUserIdAndStatus(currentUserId,
				"accepted");

		List<UserSearchResponse> accepted = new ArrayList<>();

		// ë‚´ê°€ ë³´ë‚¸ ìš”ì²­ì´ ìˆ˜ë½ëœ ê²½ìš° - âœ… fromFriendship() ì‚¬ìš©!
		accepted.addAll(friendshipsAsSender.stream()
				.map(f -> UserSearchResponse.fromFriendship(f.getFriendUser(), f.getId(), "ACCEPTED"))
				.collect(Collectors.toList()));

		// ë‚´ê°€ ë°›ì€ ìš”ì²­ì´ ìˆ˜ë½ëœ ê²½ìš° - âœ… fromFriendship() ì‚¬ìš©!
		accepted.addAll(friendshipsAsReceiver.stream()
				.map(f -> UserSearchResponse.fromFriendship(f.getUser(), f.getId(), "ACCEPTED"))
				.collect(Collectors.toList()));

		return accepted;
	}

	/**
	 * â­ ëª¨ë“  ì¹œêµ¬ ê´€ê³„ ë¡œë“œ (ë°›ì€ ìš”ì²­ + ë³´ë‚¸ ìš”ì²­ + ìˆ˜ë½ëœ ì¹œêµ¬)
	 */
	public Map<String, Object> getAllFriendships(Long currentUserId) {
		List<UserSearchResponse> received = getReceivedRequests(currentUserId);
		List<UserSearchResponse> sent = getSentRequests(currentUserId);
		List<UserSearchResponse> accepted = getAcceptedFriendsWithIds(currentUserId);

		Map<String, Object> result = new HashMap<>();
		result.put("received", received);
		result.put("sent", sent);
		result.put("accepted", accepted);

		return result;
	}

	/**
	 * ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸°
	 */
	@Transactional
	public void sendFriendRequest(Long senderId, Long receiverId) {
		System.out.println("ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸°: senderId=" + senderId + ", receiverId=" + receiverId);

		// â­ banned, deleted, rejectedê°€ ì•„ë‹Œ ê¸°ì¡´ ê´€ê³„ë§Œ í™•ì¸
		if (friendshipRepository.existsByUserIdAndFriendUserIdAndStatusNotIn(senderId, receiverId,
				java.util.Arrays.asList("deleted", "rejected", "banned"))) {
			System.out.println("ì´ë¯¸ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆê±°ë‚˜ ì¹œêµ¬ì„");
			throw new RuntimeException("ì´ë¯¸ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆê±°ë‚˜ ì¹œêµ¬ì…ë‹ˆë‹¤.");
		}

		if (friendshipRepository.existsByUserIdAndFriendUserIdAndStatusNotIn(receiverId, senderId,
				java.util.Arrays.asList("deleted", "rejected", "banned"))) {
			System.out.println("ìƒëŒ€ë°©ì´ ì´ë¯¸ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŒ");
			throw new RuntimeException("ìƒëŒ€ë°©ì´ ì´ë¯¸ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.");
		}

		// â­ ì°¨ë‹¨ë˜ì—ˆëŠ”ì§€ í™•ì¸ (receiverê°€ senderë¥¼ ì°¨ë‹¨í–ˆëŠ”ì§€)
		if (friendshipRepository.existsByUserIdAndFriendUserIdAndStatus(receiverId, senderId, "banned")) {
			System.out.println("ìƒëŒ€ë°©ì—ê²Œ ì°¨ë‹¨ë˜ì–´ ìš”ì²­ ë¶ˆê°€");
			throw new RuntimeException("ìƒëŒ€ë°©ì´ ì°¨ë‹¨í•œ ì‚¬ìš©ìëŠ” ì¹œêµ¬ ìš”ì²­ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		}

		User sender = userRepository.findById(senderId).orElseThrow(() -> new RuntimeException("ë³´ë‚´ëŠ” ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
		User receiver = userRepository.findById(receiverId)
				.orElseThrow(() -> new RuntimeException("ë°›ëŠ” ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

		// deleted ë˜ëŠ” rejected ìƒíƒœë¡œ ìˆëŠ” ê´€ê³„ê°€ ìˆìœ¼ë©´ ìƒíƒœ ë³€ê²½
		Friendship existingFriendship = friendshipRepository.findByUserIdAndFriendUserId(senderId, receiverId)
				.orElse(null);

		if (existingFriendship != null && ("deleted".equals(existingFriendship.getStatus())
				|| "rejected".equals(existingFriendship.getStatus()))) {
			System.out.println("ê¸°ì¡´ " + existingFriendship.getStatus() + " ìƒíƒœì˜ ì¹œêµ¬ ê´€ê³„ë¥¼ pendingìœ¼ë¡œ ë³€ê²½");
			existingFriendship.setStatus("pending");
			friendshipRepository.save(existingFriendship);
		} else {
			Friendship friendship = Friendship.builder().user(sender).friendUser(receiver).status("pending").build();
			friendshipRepository.save(friendship);
		}

		System.out.println("ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸° ì™„ë£Œ");
	}

	/**
	 * â­ ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½
	 */
	@Transactional
	public void acceptFriendRequest(Long friendshipId, Long currentUserId) {
		System.out.println("ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½ ì‹œì‘: friendshipId=" + friendshipId + ", currentUserId=" + currentUserId);

		Friendship friendship = friendshipRepository.findById(friendshipId)
				.orElseThrow(() -> new RuntimeException("ì¹œêµ¬ ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

		System.out.println("friendship.getFriendUser().getId()=" + friendship.getFriendUser().getId());

		// ë‚˜(currentUserId)ê°€ friendUser(ë°›ì€ ì‚¬ëŒ)ì¸ì§€ í™•ì¸
		if (!friendship.getFriendUser().getId().equals(currentUserId)) {
			throw new RuntimeException("ìˆ˜ë½í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
		}

		System.out.println("ì´ì „ ìƒíƒœ: " + friendship.getStatus());
		friendship.setStatus("accepted");
		System.out.println("ë³€ê²½ëœ ìƒíƒœ: " + friendship.getStatus());

		// â­ ë³€ê²½ì‚¬í•­ ì €ì¥
		friendshipRepository.save(friendship);
		System.out.println("ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½ ì™„ë£Œ");
	}

	/**
	 * ì¹œêµ¬ ìš”ì²­ ê±°ì ˆ (ìƒëŒ€ë°©ì´ ë‹¤ì‹œ ìš”ì²­ ê°€ëŠ¥)
	 */
	@Transactional
	public void rejectFriendRequest(Long friendshipId, Long currentUserId) {
		System.out.println("ì¹œêµ¬ ìš”ì²­ ê±°ì ˆ ì‹œì‘: friendshipId=" + friendshipId + ", currentUserId=" + currentUserId);

		Friendship friendship = friendshipRepository.findById(friendshipId)
				.orElseThrow(() -> new RuntimeException("ì¹œêµ¬ ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

		if (!friendship.getFriendUser().getId().equals(currentUserId)) {
			throw new RuntimeException("ê±°ì ˆí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
		}

		System.out.println("ì´ì „ ìƒíƒœ: " + friendship.getStatus());
		friendship.setStatus("rejected");
		System.out.println("ë³€ê²½ëœ ìƒíƒœ: " + friendship.getStatus());

		friendshipRepository.save(friendship);
		System.out.println("âœ… ì¹œêµ¬ ìš”ì²­ ê±°ì ˆ ì™„ë£Œ");
	}

	/**
	 * ì¹œêµ¬ ìš”ì²­ ì°¨ë‹¨ (ìƒëŒ€ë°©ì´ ë‹¤ì‹œ ìš”ì²­ ë¶ˆê°€)
	 */
	@Transactional
	public void banFriendRequest(Long friendshipId, Long currentUserId) {
		System.out.println("ì¹œêµ¬ ìš”ì²­ ì°¨ë‹¨ ì‹œì‘: friendshipId=" + friendshipId + ", currentUserId=" + currentUserId);

		Friendship friendship = friendshipRepository.findById(friendshipId)
				.orElseThrow(() -> new RuntimeException("ì¹œêµ¬ ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

		if (!friendship.getFriendUser().getId().equals(currentUserId)) {
			throw new RuntimeException("ì°¨ë‹¨í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
		}

		System.out.println("ì´ì „ ìƒíƒœ: " + friendship.getStatus());
		friendship.setStatus("banned");
		System.out.println("ë³€ê²½ëœ ìƒíƒœ: " + friendship.getStatus());

		friendshipRepository.save(friendship);
		System.out.println("âœ… ì¹œêµ¬ ìš”ì²­ ì°¨ë‹¨ ì™„ë£Œ");
	}

	/**
	 * ì¹œêµ¬ ì‚­ì œ (DB ì‚­ì œ ì•„ë‹ˆë¼ ìƒíƒœ ë³€ê²½: deleted)
	 */
	@Transactional
	public void removeFriend(Long friendshipId, Long currentUserId) {
		System.out.println("ì¹œêµ¬ ì‚­ì œ ì‹œì‘: friendshipId=" + friendshipId + ", currentUserId=" + currentUserId);

		Friendship friendship = friendshipRepository.findById(friendshipId)
				.orElseThrow(() -> new RuntimeException("ì¹œêµ¬ ê´€ê³„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

		if (!friendship.getUser().getId().equals(currentUserId)
				&& !friendship.getFriendUser().getId().equals(currentUserId)) {
			throw new RuntimeException("ì‚­ì œí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
		}

		System.out.println("ì´ì „ ìƒíƒœ: " + friendship.getStatus());
		// â­ DB ì‚­ì œ ëŒ€ì‹  ìƒíƒœë¥¼ "deleted"ë¡œ ë³€ê²½
		friendship.setStatus("deleted");
		System.out.println("ë³€ê²½ëœ ìƒíƒœ: " + friendship.getStatus());

		friendshipRepository.save(friendship);
		System.out.println("âœ… ì¹œêµ¬ ì‚­ì œ(ìƒíƒœ ë³€ê²½) ì™„ë£Œ");
	}

	/**
	 * â­ ë‘ ì‚¬ìš©ì ê°„ì˜ friendship ì¡°íšŒ (ì–‘ë°©í–¥)
	 */
	public Friendship findFriendship(Long userId1, Long userId2) {
		return friendshipRepository.findByUserIdAndFriendUserId(userId1, userId2)
				.orElseGet(() -> friendshipRepository.findByUserIdAndFriendUserId(userId2, userId1).orElse(null));
	}

	/**
	 * â­ í˜„ì¬ ì‚¬ìš©ìê°€ í¬í•¨ëœ ëª¨ë“  friendship ì¡°íšŒ (ì–‘ë°©í–¥)
	 */
	public List<Friendship> findAllFriendshipsForUser(Long userId) {
		// ë‚´ê°€ user_idì¸ ê²½ìš°
		List<Friendship> userSide = friendshipRepository.findByUserIdAndStatus(userId, "accepted");

		// ë‚´ê°€ friend_user_idì¸ ê²½ìš°
		List<Friendship> friendUserSide = friendshipRepository.findByFriendUserIdAndStatus(userId, "accepted");

		// ë‘˜ ë‹¤ í•©ì¹˜ê¸°
		List<Friendship> result = new ArrayList<>();
		result.addAll(userSide);
		result.addAll(friendUserSide);

		return result;
	}

}

",

119. GeminiTestService.java="
package com.project.quiz.service;

import dev.langchain4j.service.SystemMessage;
import dev.langchain4j.service.UserMessage;
import dev.langchain4j.service.V;
import com.project.quiz.dto.AiQuizResponse;

public interface GeminiTestService {

    @SystemMessage("""
        ë‹¹ì‹ ì€ í€´ì¦ˆ ìƒì„± ë„ìš°ë¯¸ì…ë‹ˆë‹¤.
        ì‚¬ìš©ìê°€ ì£¼ì œë¥¼ ì£¼ë©´ 4ì§€ ì„ ë‹¤í˜• í€´ì¦ˆ 3ë¬¸ì œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
        ë‚œì´ë„ëŠ” 'ì¤‘'ì…ë‹ˆë‹¤.
        ë°˜ë“œì‹œ ì£¼ì–´ì§„ JSON í˜•ì‹(AiQuizResponse)ì— ë§ì¶°ì„œ ëŒ€ë‹µí•˜ì„¸ìš”.
    """)
    @UserMessage("ì£¼ì œ: {{topic}}")
    AiQuizResponse createQuiz(@V("topic") String topic);
}
",

120. GuestUserService.java="
package com.project.quiz.service;

import org.springframework.stereotype.Service;

@Service
public class GuestUserService {

    // ë‹‰ë„¤ì„/ìºë¦­í„° ìœ íš¨ì„± ì²´í¬ ë“± ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì˜ˆì‹œ
    public boolean validateNickname(String nickname) {
        // ì˜ˆì‹œ: ê¸ˆì¹™ì–´ í•„í„°, ê¸¸ì´, ì¤‘ë³µ ë“±
        return nickname != null && !nickname.trim().isEmpty() && nickname.length() < 20;
    }

    public boolean validateCharacter(String characterImageUrl) {
        // ì˜ˆì‹œ: í—ˆìš©ëœ ì´ë¯¸ì§€ ëª©ë¡, URL íŒ¨í„´ ë“±
        return characterImageUrl != null && characterImageUrl.endsWith(".svg");
    }
}

",

121. InventoryService.java="
package com.project.quiz.service;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserInventory;
import com.project.quiz.repository.UserInventoryRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@RequiredArgsConstructor
public class InventoryService {

    private final UserInventoryRepository userInventoryRepository;

    // 1. ëª©ë¡ ì¡°íšŒ (í™”ë©´ ë Œë”ë§ìš©)
    @Transactional(readOnly = true)
    public List<UserInventory> getMyInventoryByCategory(User user, String category) {
        return userInventoryRepository.findAllByUserAndItem_Category(user, category);
    }

    // 2. ì•„ì´í…œ ì¥ì°© (êµì²´)
    @Transactional
    public void equipItem(User user, String category, Long itemId) {
        // (1) ë‚´ ì¸ë²¤í† ë¦¬ì—ì„œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ì•„ì´í…œ ì‹¹ ê°€ì ¸ì˜´
        List<UserInventory> myItems = userInventoryRepository.findAllByUserAndItem_Category(user, category);

        // (2) ì¼ë‹¨ ì „ë¶€ ì¥ì°© í•´ì œ (ì´ˆê¸°í™”)
        for (UserInventory inventory : myItems) {
            inventory.setEquipped(false);
        }

        // (3) ì„ íƒí•œ ì•„ì´í…œ(itemId)ì´ nullì´ ì•„ë‹ˆë©´(ê¸°ë³¸ ì•„ë‹˜) ì°¾ì•„ì„œ ì¥ì°©
        if (itemId != null) {
            myItems.stream()
                .filter(inv -> inv.getItem().getId().equals(itemId))
                .findFirst()
                .ifPresent(target -> target.setEquipped(true));
        }
    }
    
    @Transactional(readOnly = true)
    public String getEquippedItemUrl(User user, String category) {
        return userInventoryRepository.findByUserAndItem_CategoryAndIsEquippedTrue(user, category)
                .map(inventory -> inventory.getItem().getImageUrl())
                .orElse(null);
    }
}
",

122. LocalFileStorageService.java="
package com.project.quiz.service;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.*;
import java.util.UUID;

@Service
public class LocalFileStorageService implements FileStorageService {

    // ì§€ê¸ˆì€ í”„ë¡œì íŠ¸ ë£¨íŠ¸ í´ë” ì˜†ì— 'uploads' í´ë”ë¥¼ ìë™ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
	// !ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!
	// ì´ ì„œë¹„ìŠ¤ëŠ” ë‚˜ì¤‘ì— ì„œë²„ ì—°ê²°í•˜ë©´ ë°”ê¿€ ì„œë¹„ìŠ¤
	// !ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!ì¤‘ìš”!
    private final Path fileStorageLocation;

    public LocalFileStorageService() {
        // í”„ë¡œì íŠ¸ ì‹¤í–‰ ìœ„ì¹˜ì˜ 'uploads' í´ë” ì§€ì •
        this.fileStorageLocation = Paths.get(System.getProperty("user.dir") + "/uploads")
                .toAbsolutePath().normalize();

        try {
            Files.createDirectories(this.fileStorageLocation);
        } catch (Exception ex) {
            throw new RuntimeException("ì—…ë¡œë“œ í´ë”ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", ex);
        }
    }

    @Override
    public String storeFile(MultipartFile file) {
        // íŒŒì¼ëª… ì •ì œ (UUIDë¡œ ì¤‘ë³µ ë°©ì§€)
        String originalFileName = StringUtils.cleanPath(file.getOriginalFilename());
        String extension = originalFileName.substring(originalFileName.lastIndexOf("."));
        String savedFileName = UUID.randomUUID().toString() + extension;

        try {
            // íŒŒì¼ ì €ì¥
            Path targetLocation = this.fileStorageLocation.resolve(savedFileName);
            Files.copy(file.getInputStream(), targetLocation, StandardCopyOption.REPLACE_EXISTING);

            // ì ‘ê·¼ ê°€ëŠ¥í•œ URL ê²½ë¡œ ë°˜í™˜ (ë‚˜ì¤‘ì— WebMvcConfigì—ì„œ ë§¤í•‘)
            return "/uploads/" + savedFileName;
        } catch (IOException ex) {
            throw new RuntimeException("íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: " + savedFileName, ex);
        }
    }

    @Override
    public void deleteFile(String fileUrl) {
        // ë¡œì»¬ì—ì„œëŠ” êµ³ì´ ì‚­ì œ ë¡œì§ì„ ì—„ê²©í•˜ê²Œ êµ¬í˜„ ì•ˆ í•´ë„ ë¨ (ìƒëµ ê°€ëŠ¥)
    }
}
",

123. NotificationService.java="
package com.project.quiz.service;

import com.project.quiz.domain.*;
import com.project.quiz.dto.NotificationResponse;
import com.project.quiz.repository.*;
import lombok.RequiredArgsConstructor;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;

@Service
@RequiredArgsConstructor
public class NotificationService {

    private final NotificationRepository notificationRepository;
    private final NotificationRecipientRepository recipientRepository;
    private final SimpMessagingTemplate messagingTemplate; // ì›¹ì†Œì¼“ ë°œì†¡ê¸°

    @Transactional
    public void send(User user, String title, String content, String type) {
        // 1. ì•Œë¦¼ ë‚´ìš© ìƒì„± (Notification í…Œì´ë¸”)
        Notification notification = new Notification();
        notification.setTitle(title);
        notification.setContent(content);
        notification.setNotificationType(type);
        notification.setCreatedAt(LocalDateTime.now());
        notification.setIsBroadcast(false); 
        
        // â˜…â˜…â˜… [ìˆ˜ì •] ì €ì¥ëœ ê°ì²´(IDê°€ ìˆëŠ” ê°ì²´)ë¥¼ ë³€ìˆ˜ë¡œ ë°›ìŠµë‹ˆë‹¤.
        Notification savedNotification = notificationRepository.save(notification);

        // 2. ìˆ˜ì‹ ì ë§¤í•‘ (NotificationRecipient í…Œì´ë¸”)
        NotificationRecipient recipient = new NotificationRecipient();
        
        // â˜…â˜…â˜… [ìˆ˜ì •] ìœ„ì—ì„œ ì €ì¥í•œ savedNotificationì„ ë„£ì–´ì¤ë‹ˆë‹¤.
        recipient.setNotification(savedNotification); 
        
        recipient.setUser(user);
        recipient.setIsRead(false); // ì•ˆ ì½ìŒ
        
        // Recipient ì €ì¥ (ì´ì œ ë¶€ëª¨ IDê°€ í™•ì‹¤í•˜ë¯€ë¡œ ì—ëŸ¬ê°€ ì•ˆ ë‚©ë‹ˆë‹¤)
        NotificationRecipient savedRecipient = recipientRepository.save(recipient);

        // [ì¶”ê°€/ìˆ˜ì •] URL ê²°ì • ë¡œì§ (ì´ì „ ë‹¨ê³„ì—ì„œ ì ìš©í•œ ë‚´ìš© ìœ ì§€)
        String targetUrl = "/"; 
        if ("ACHIEVEMENT".equals(type)) {
            targetUrl = "/achievement";
        }
        
        // 3. ì‹¤ì‹œê°„ ì›¹ì†Œì¼“ ì „ì†¡
        NotificationResponse response = NotificationResponse.builder()
                .id(savedRecipient.getId())
                .title(title)
                .content(content)
                .type(type)
                .url(targetUrl)
                .createdAt(LocalDateTime.now())
                .build();

        messagingTemplate.convertAndSendToUser(
                user.getEmail(), 
                "/queue/notifications", 
                response
        );
    }
}
",

124. ParticipantService.java="
package com.project.quiz.service;

import java.time.LocalDateTime;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.project.quiz.domain.Participant;
import com.project.quiz.domain.Quiz;
import com.project.quiz.domain.QuizAnswer;
import com.project.quiz.domain.QuizGrading;
import com.project.quiz.domain.QuizQuestion;
import com.project.quiz.domain.QuizSubmission;
import com.project.quiz.domain.Room;
import com.project.quiz.domain.User;
import com.project.quiz.domain.UserActivityLog;
import com.project.quiz.dto.UserRank;
import com.project.quiz.repository.ParticipantRepository;
import com.project.quiz.repository.QuizRepository;
import com.project.quiz.repository.QuizSubmissionRepository;
import com.project.quiz.repository.UserActivityLogRepository;
import com.project.quiz.repository.UserRepository;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Service
@RequiredArgsConstructor
@Slf4j
public class ParticipantService {
	
	@Autowired private QuizSubmissionRepository quizSubmissionRepository;
	@Autowired private QuizRepository quizRepository;
	@Autowired private PointService pointService;
	@Autowired private UserActivityLogRepository userActivityLogRepository;
	@Autowired private UserRepository userRepository;
	
	private final ParticipantRepository participantRepository;

	// ì°¸ê°€ì ì €ì¥
	public Participant saveParticipant(Participant participant) {
		return participantRepository.save(participant);
	}

	public boolean existsByRoomAndUser(Room room, User user) {
		return participantRepository.existsByRoomAndUser(room, user);
	}

	public boolean existsByRoomAndGuestId(Room room, String guestId) {
		return participantRepository.existsByRoomAndGuestId(room, guestId);
	}

	public List<Participant> findByRoom(Room room) {
		return participantRepository.findByRoom(room);
	}

	public void joinRoomIfNotExists(Room room, User user, String guestId, String nickname, String avatarUrl) {
		// ê²ŒìŠ¤íŠ¸ì¸ ê²½ìš°
		if (user == null && guestId != null) {
			Participant existing = participantRepository.findByRoomAndGuestId(room, guestId);
			if (existing == null) {
				Participant participant = new Participant();
				participant.setRoom(room);
				participant.setGuestId(guestId);
				participant.setNickname(nickname);
				participant.setAvatarUrl(avatarUrl);
				participant.setJoinAt(LocalDateTime.now());
				participantRepository.save(participant);
			}
		}
		// ë¡œê·¸ì¸ ì‚¬ìš©ìì¸ ê²½ìš°
		else if (user != null) {
			Participant existing = participantRepository.findByRoomAndUser(room, user);
			if (existing == null) {
				Participant participant = new Participant();
				participant.setRoom(room);
				participant.setUser(user);

				// UserProfileì—ì„œ ê°€ì ¸ì˜¤ê¸°
				if (user.getUserProfile() != null) {
					participant.setNickname(user.getUserProfile().getUsername());
					participant.setAvatarUrl(user.getUserProfile().getProfileImage());
				} else {
					participant.setNickname(user.getEmail());
					participant.setAvatarUrl(null);
				}

				participant.setJoinAt(LocalDateTime.now());
				participantRepository.save(participant);
			}
		}
	}

	public void saveQuizResults(Room room, List<UserRank> finalRanking) {
		try {
			if (room == null) {
				log.error("ë°©ì´ nullì…ë‹ˆë‹¤");
				return;
			}

			// ì´ ë°©ì˜ ëª¨ë“  ì°¸ê°€ì ì¡°íšŒ
			List<Participant> participants = participantRepository.findByRoom(room);

			// ìµœì¢… ìˆœìœ„ ì •ë³´ë¡œ ê° ì°¸ê°€ì ì—…ë°ì´íŠ¸
			for (Participant participant : participants) {
				// ì´ ì°¸ê°€ìê°€ finalRankingì— ìˆëŠ”ì§€ í™•ì¸ (ë‹‰ë„¤ì„ìœ¼ë¡œ ë§¤ì¹­)
				UserRank userRank = finalRanking.stream()
						.filter(ur -> ur.getNickname().equals(participant.getNickname())).findFirst().orElse(null);

				if (userRank != null) {
					participant.setScore(userRank.getScore().longValue());
					participant.setRanking(userRank.getRank().longValue());
					log.info("âœ… ì°¸ê°€ì ê²°ê³¼ ì €ì¥ - {}: ìˆœìœ„={}, ì ìˆ˜={}", participant.getNickname(), userRank.getRank(),
							userRank.getScore());
				}
			}

			// DBì— ì €ì¥
			participantRepository.saveAll(participants);
			log.info("ğŸ¯ ë°© {} ì˜ ëª¨ë“  ì°¸ê°€ì ê²°ê³¼ ì €ì¥ ì™„ë£Œ", room.getRoomCode());

		} catch (Exception e) {
			log.error("âŒ í€´ì¦ˆ ê²°ê³¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
		}
	}
	
	@Transactional // â­ íŠ¸ëœì­ì…˜ ë³´ì¥ (ê°€ì¥ ì¤‘ìš”)
	public void processQuizRewards(Room room, List<UserRank> finalRanking, Long quizId, Map<Long, Set<Long>> correctQuestionsMap) {
	    // 1. í€´ì¦ˆ ì—”í‹°í‹° ì¡°íšŒ (í™•ì‹¤í•˜ê²Œ ì˜ì† ìƒíƒœë¡œ ê°€ì ¸ì˜´)
	    Quiz quizEntity = quizRepository.findById(quizId).orElseThrow(() -> new IllegalArgumentException("í€´ì¦ˆ ì—†ìŒ"));
	    String quizTitle = quizEntity.getTitle();

	    for (UserRank rank : finalRanking) {
	        if (rank.getUserId() != null) {
	            User user = userRepository.findById(rank.getUserId()).orElse(null);
	            
	            if (user != null) {
	                // A. ì œì¶œ ê¸°ë¡(Submission) ìƒì„±
	                QuizSubmission submission = new QuizSubmission();
	                submission.setQuiz(quizEntity);
	                submission.setUserId(user.getId());
	                submission.setTotalScore(rank.getScore());
	                submission.setGraded(true);
	                submission.setSubmittedAt(LocalDateTime.now());

	                // â­â­ B. [í•µì‹¬] ë¬¸ì œë³„ ìƒì„¸ ì±„ì  ê¸°ë¡(Answer + Grading) ìƒì„± â­â­
	                // ìœ ì €ê°€ ë§ì¶˜ ë¬¸ì œ ID ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
	                Set<Long> userCorrectIds = correctQuestionsMap.getOrDefault(user.getId(), new HashSet<>());

	                for (QuizQuestion q : quizEntity.getQuestions()) {
	                    // 1) ë‹µì•ˆ(Answer) ê°ì²´ ìƒì„± (í†µê³„ìš© ë”ë¯¸ ë°ì´í„°)
	                    QuizAnswer answer = new QuizAnswer();
	                    answer.setQuestion(q);
	                    // ë©€í‹°í”Œë ˆì´ëŠ” ì‹¤ì œ ì…ë ¥ê°’ ì €ì¥ì´ ì–´ë ¤ìš°ë¯€ë¡œ, í†µê³„ë¥¼ ìœ„í•´ ë¹ˆ ê°’ì´ë‚˜ ë”ë¯¸ê°’ ì €ì¥
	                    answer.setAnswerText(userCorrectIds.contains(q.getQuestionId()) ? "Correct" : "Wrong"); 
	                    
	                    // 2) ì±„ì (Grading) ê°ì²´ ìƒì„±
	                    QuizGrading grading = new QuizGrading();
	                    boolean isCorrect = userCorrectIds.contains(q.getQuestionId());
	                    
	                    grading.setCorrect(isCorrect);
	                    grading.setScore(isCorrect ? q.getPoint() : 0);
	                    grading.setGrader("AUTO_MULTI");
	                    grading.setGradedAt(LocalDateTime.now());
	                    
	                    // 3) ì—°ê²° (Submission -> Answer -> Grading)
	                    answer.setGrading(grading); // Answerì— Grading ì—°ê²°
	                    submission.addAnswer(answer); // Submissionì— Answer ì—°ê²°
	                }

	                // C. ì €ì¥ (Cascadeë¡œ ì¸í•´ Submission ì €ì¥ ì‹œ Answer, Gradingë„ ìë™ ì €ì¥ë¨)
	                quizSubmissionRepository.save(submission);

	                // D. í¬ì¸íŠ¸ ë° ë¡œê·¸ (ê¸°ì¡´ê³¼ ë™ì¼)
	                if (rank.getScore() > 0) {
	                    pointService.addPoint(user, rank.getScore(), "ë©€í‹°í”Œë ˆì´ í€´ì¦ˆ ë³´ìƒ: " + quizTitle);
	                    UserActivityLog log = UserActivityLog.builder()
	                            .user(user)
	                            .activityType("QUIZ")
	                            .description(user.getUserProfile().getUsername() + "ë‹˜ì´ [" + quizTitle + "] ë©€í‹°í”Œë ˆì´ í€´ì¦ˆë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.")
	                            .createdAt(LocalDateTime.now())
	                            .build();
	                    userActivityLogRepository.save(log);
	                }
	            }
	        }
	    }
	}
}

",

125. PointService.java="
package com.project.quiz.service;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserActivityLog;
import com.project.quiz.domain.UserActivityPointChange;
import com.project.quiz.domain.UserProfile;
import com.project.quiz.dto.PointHistoryDto;
import com.project.quiz.repository.UserActivityLogRepository;
import com.project.quiz.repository.UserActivityPointChangeRepository;
import com.project.quiz.repository.UserRepository;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class PointService {

	private final UserRepository userRepository;
	private final UserActivityLogRepository logRepository;
	private final UserActivityPointChangeRepository pointChangeRepository;

	// 1. í¬ì¸íŠ¸ ì‚¬ìš© (ì°¨ê°) ë©”ì„œë“œ
	@Transactional
	public void usePoint(User user, int amount, String reason) {
		UserProfile profile = user.getUserProfile();

		// ì”ì•¡ ê²€ì‚¬
		if (profile.getPointBalance() < amount) {
			throw new IllegalStateException("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
		}

		// (1) ì”ì•¡ ì°¨ê°
		profile.setPointBalance(profile.getPointBalance() - amount);

		// (2) ë¡œê·¸ ê¸°ë¡ (ì‚¬ìš©ì€ ìŒìˆ˜ë¡œ ê¸°ë¡)
		savePointLog(user, "POINT_USE", -amount, reason);
	}

	// 2. í¬ì¸íŠ¸ ì ë¦½ ë©”ì„œë“œ
	@Transactional
	public void addPoint(User user, int amount, String reason) {
		UserProfile profile = user.getUserProfile();

		// (1) ì”ì•¡ ì¦ê°€
		profile.setPointBalance(profile.getPointBalance() + amount);

		// (2) ë¡œê·¸ ê¸°ë¡ (ì ë¦½ì€ ì–‘ìˆ˜ë¡œ ê¸°ë¡)
		savePointLog(user, "POINT_EARN", amount, reason);
	}

	// (ë‚´ë¶€ ë©”ì„œë“œ) ë¡œê·¸ ì €ì¥ ë¡œì§ ê³µí†µí™”
	private void savePointLog(User user, String type, int amount, String reason) {
		// 1. í™œë™ ë¡œê·¸ ìƒì„± (ë¶€ëª¨)
		UserActivityLog log = UserActivityLog.builder().user(user).activityType(type).description(reason) // "ì „ì„¤ì˜ ê²€ êµ¬ë§¤"
				.createdAt(LocalDateTime.now()).build();
		logRepository.save(log);

		// 2. í¬ì¸íŠ¸ ìƒì„¸ ë‚´ì—­ ìƒì„± (ìì‹)
		UserActivityPointChange pointChange = UserActivityPointChange.builder().userActivityLog(log).amount(amount) // -500
																													// or
																													// +300
				.reason(reason).build();
		pointChangeRepository.save(pointChange);
	}

	// 3. í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ
	@Transactional(readOnly = true)
	public List<PointHistoryDto> getPointHistory(String email) {
		User user = userRepository.findByEmail(email).orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ì ì—†ìŒ"));

		// 1. UserActivityLogë¥¼ í†µí•´ í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ (ìµœì‹ ìˆœ ì •ë ¬ í•„ìš”)
		List<UserActivityPointChange> historyList = pointChangeRepository
				.findAllByUserDesc(user);

		// 2. DTOë¡œ ë³€í™˜
		return historyList.stream().map(PointHistoryDto::new).collect(Collectors.toList());
	}
}
",

126. QuizAiService.java="
package com.project.quiz.service;

import dev.langchain4j.service.SystemMessage;
import dev.langchain4j.service.UserMessage;
import dev.langchain4j.service.V;

public interface QuizAiService {

    @SystemMessage("""
        ì—­í• : ë‹¹ì‹ ì€ í€´ì¦ˆ ì¶œì œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
        
        [ì œì•½ì‚¬í•­]
        1. ì„œë¡ , ê²°ë¡ , ë§ˆí¬ë‹¤ìš´(```json) ì—†ì´ **ì˜¤ì§ ìˆœìˆ˜ JSON**ë§Œ ë°˜í™˜í•˜ì„¸ìš”.
        2. **quizTypeCode**: 1(ì£¼ê´€ì‹), 2(ê°ê´€ì‹) ì¤€ìˆ˜.
        
        [í•„ìˆ˜ JSON ë°˜í™˜ êµ¬ì¡°]
        {
          "title": "ì œëª©",
          "description": "ì„¤ëª…",
          "questions": [
            {
              "questionText": "ì§ˆë¬¸ ë‚´ìš©",
              "quizTypeCode": 1 ë˜ëŠ” 2,
              "point": 10,
              "options": [ "ë³´ê¸°1", "ë³´ê¸°2", "ë³´ê¸°3", "ë³´ê¸°4" ] (â€» ì¤‘ìš”: ê°ì²´ ê¸ˆì§€. ë‹¨ìˆœ ë¬¸ìì—´ ë°°ì—´ë¡œ ë°˜í™˜. ì£¼ê´€ì‹ì€ ë¹ˆë°°ì—´ []),
              "answerOption": "1" (â€» ê°ê´€ì‹ ì •ë‹µ ë²ˆí˜¸ '1'~'4'. ì£¼ê´€ì‹ null),
              "subjectiveAnswer": "ì •ë‹µ" (â€» ì£¼ê´€ì‹ ì •ë‹µ. ê°ê´€ì‹ null)
            }
          ]
        }
    """)
    @UserMessage("""
        ì£¼ì œ: {{topic}}
        ë‚œì´ë„: {{difficulty}}
        ë¬¸ì œ ìˆ˜: {{count}}ê°œ
        ìœ í˜•: {{type}}
        
        ìœ„ ì¡°ê±´ì— ë§ì¶° í•œêµ­ì–´ë¡œ í€´ì¦ˆë¥¼ ìƒì„±í•˜ì„¸ìš”.
    """)
    String generateQuiz(
        @V("topic") String topic, 
        @V("difficulty") String difficulty, 
        @V("count") int count, 
        @V("type") String type
    );
}
",

127. QuizGradingService.java="
package com.project.quiz.service;

import com.project.quiz.domain.*;
import com.project.quiz.dto.QuizSolvedEvent;
import com.project.quiz.repository.*;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Slf4j
@Service
@RequiredArgsConstructor
public class QuizGradingService {

	private final QuizSubmissionRepository submissionRepository;
	private final QuizGradingRepository gradingRepository;
	private final QuizAnswerRepository quizAnswerRepository;

	// â­ [ì¶”ê°€] ì—°ê²°ì„ ìœ„í•´ í•„ìš”í•œ ì˜ì¡´ì„± ì£¼ì…
	private final UserRepository userRepository;
	private final UserActivityLogRepository logRepository; // íƒ€ì„ë¼ì¸ìš© ë¡œê·¸
	private final PointService pointService; // í¬ì¸íŠ¸ ì§€ê¸‰
	private final ApplicationEventPublisher eventPublisher;// ì—…ì  ì´ë²¤íŠ¸ ë°œí–‰

	/**
	 * ì œì¶œëœ ë‹µì•ˆ ì „ì²´ ì±„ì  (ìë™)
	 */
	@Transactional
	public void grade(Long submissionId) {

		// 1. ì œì¶œ ì •ë³´ ì¡°íšŒ
		QuizSubmission submission = submissionRepository.findById(submissionId)
				.orElseThrow(() -> new RuntimeException("ì œì¶œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

		int totalScore = 0;
		List<QuizAnswer> answers = new ArrayList<>(submission.getAnswers());

		// 2. ì±„ì  ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
		for (QuizAnswer answer : answers) {
			QuizQuestion question = answer.getQuestion();
			boolean isCorrect = false;
			int score = 0;

			// ê°ê´€ì‹
			if (question.getQuizTypeCode() == 2) {
				if (answer.getSelectedOption() != null && question.getAnswerOption() != null) {
					if (question.getAnswerOption().trim().equals(answer.getSelectedOption().toString().trim())) {
						isCorrect = true;
						score = (question.getPoint() != null) ? question.getPoint() : 0;
					}
				}
			}
			// ì„œìˆ í˜•
			else if (question.getQuizTypeCode() == 1) {
				if (answer.getAnswerText() != null && question.getSubjectiveAnswer() != null) {
					String userAnswer = answer.getAnswerText().trim().replaceAll("\\s+", " ");
					String correctAnswer = question.getSubjectiveAnswer().trim().replaceAll("\\s+", " ");
					if (userAnswer.equalsIgnoreCase(correctAnswer)) {
						isCorrect = true;
						score = (question.getPoint() != null) ? question.getPoint() : 0;
					}
				}
			}

			// ê²°ê³¼ ì €ì¥
			boolean finalCorrect = isCorrect;
			int finalScore = score;

			QuizGrading grading = gradingRepository.findByAnswer_AnswerId(answer.getAnswerId()).orElseGet(() -> {
				QuizGrading g = new QuizGrading();
				g.setAnswer(answer);
				return g;
			});

			grading.setCorrect(finalCorrect);
			grading.setScore(finalScore);
			grading.setGrader("AUTO");
			grading.setGradedAt(LocalDateTime.now());

			if (grading.getGradingId() == null) {
				answer.setGrading(grading);
			}
			gradingRepository.save(grading);

			totalScore += finalScore;
		}

		// 3. ì œì¶œ ì •ë³´ ì—…ë°ì´íŠ¸
		submission.setTotalScore(totalScore);
		submission.setGraded(true);
		submissionRepository.save(submission);

		// ============================================================
		// â­ [ì¶”ê°€ë¨] ë¡œê·¸, í¬ì¸íŠ¸, ì—…ì  ì—°ê²° ë¡œì§
		// ============================================================

		// ìœ ì € ì •ë³´ ì¡°íšŒ
		User user = userRepository.findById(submission.getUserId()).orElse(null);

		if (user != null) {
			String quizTitle = submission.getQuiz().getTitle();

			// 1ï¸âƒ£ [íƒ€ì„ë¼ì¸] í™œë™ ë¡œê·¸ ê¸°ë¡ (ActivityType: "QUIZ")
			// TimelineServiceê°€ ì´ ë¡œê·¸ë¥¼ ì½ì–´ì„œ íƒ€ì„ë¼ì¸ì— í‘œì‹œí•¨ [cite: 1050, 1053]
			UserActivityLog activityLog = UserActivityLog.builder().user(user).activityType("QUIZ")
					.description(user.getUserProfile().getUsername() + "ë‹˜ì´ [" + quizTitle + "] í€´ì¦ˆë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.")
					.createdAt(LocalDateTime.now()).build();
			logRepository.save(activityLog);

			// 2ï¸âƒ£ [í¬ì¸íŠ¸] ì ìˆ˜ë§Œí¼ í¬ì¸íŠ¸ ì§€ê¸‰
			// PointService ë‚´ë¶€ì—ì„œ í¬ì¸íŠ¸ ë¡œê·¸("POINT_EARN")ë„ ìë™ìœ¼ë¡œ ë‚¨ê¹€ [cite: 974, 975]
			if (totalScore > 0) {
				try {
					pointService.addPoint(user, totalScore, "í€´ì¦ˆ ë³´ìƒ: " + quizTitle);
					log.info("ğŸ’° í¬ì¸íŠ¸ ì§€ê¸‰ ì™„ë£Œ: {}P", totalScore);
				} catch (Exception e) {
					log.error("í¬ì¸íŠ¸ ì§€ê¸‰ ì‹¤íŒ¨", e);
				}
			}

			// 3ï¸âƒ£ [ì—…ì ] ì´ë²¤íŠ¸ ë°œí–‰ -> AchievementServiceê°€ ìˆ˜ì‹ 
			// AchievementService.handleQuizSolved()ê°€ ì‹¤í–‰ë¨
			// isCorrectê°€ trueë©´ 'ì •ë‹µ ê´€ë ¨ ì—…ì ', ê·¸ëƒ¥ í’€ê¸°ë§Œ í•´ë„ 'ì°¸ì—¬ ì—…ì ' ì¹´ìš´íŠ¸ ì¦ê°€
			boolean isPerfect = (totalScore > 0); // ì¼ë‹¨ 0ì  ì´ìƒì´ë©´ 'ì„±ê³µ'ìœ¼ë¡œ ê°„ì£¼ (ì¡°ê±´ ë³€ê²½ ê°€ëŠ¥)
			eventPublisher.publishEvent(new QuizSolvedEvent(user, isPerfect));

			log.info("âœ… í€´ì¦ˆ í™œë™ ê¸°ë¡ ì™„ë£Œ (íƒ€ì„ë¼ì¸/í¬ì¸íŠ¸/ì—…ì )");
		}
	}

	/**
	 * ê°œë³„ ë¬¸í•­ ìˆ˜ë™/ì¬ì±„ì ìš© (í•„ìš” ì‹œ ì‚¬ìš©)
	 */
	@Transactional
	public void grade(Long answerId, int score, boolean correct) {

		QuizGrading grading = gradingRepository.findByAnswer_AnswerId(answerId).orElseGet(() -> {
			QuizGrading g = new QuizGrading();
			g.setAnswer(quizAnswerRepository.getReferenceById(answerId));
			return g;
		});

		grading.setScore(score);
		grading.setCorrect(correct);
		grading.setGrader("MANUAL"); // ìˆ˜ë™ ì±„ì ì„ì„ í‘œì‹œ
		grading.setGradedAt(LocalDateTime.now());

		gradingRepository.save(grading);
	}
}
",

128. QuizService.java="
package com.project.quiz.service;

import java.io.File;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import com.project.quiz.domain.Quiz;
import com.project.quiz.domain.QuizOption;
import com.project.quiz.domain.QuizQuestion;
import com.project.quiz.dto.QuizDto;
import com.project.quiz.repository.QuizQuestionRepository;
import com.project.quiz.repository.QuizRepository;
import com.project.quiz.repository.UserRepository;

import lombok.RequiredArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;

@Service
@RequiredArgsConstructor
@Transactional
public class QuizService {

	private final QuizRepository quizRepository;
	private final UserRepository userRepository;

	/* ================== ì €ì¥ ================== */
	@Transactional
	public Long saveQuiz(QuizDto quizDto) {
	    Quiz quiz;

	    if (quizDto.getQuizId() != null) {
	        quiz = quizRepository.findById(quizDto.getQuizId())
	                .orElseThrow(() -> new IllegalArgumentException("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í€´ì¦ˆ ID: " + quizDto.getQuizId()));

	        quiz.setTitle(quizDto.getTitle());
	        quiz.setDescription(quizDto.getDescription());
	        quiz.setScorePublic(quizDto.isScorePublic());
	        quiz.setUpdatedAt(LocalDateTime.now());
	        
	        // quiz.getQuestions().clear(); <- ì´ ë¶€ë¶„ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.
	    } else {
	        quiz = new Quiz();
	        quiz.setTitle(quizDto.getTitle());
	        quiz.setDescription(quizDto.getDescription());
	        quiz.setScorePublic(quizDto.isScorePublic());
	        quiz.setUserId(getLoginUserId());
	        quiz.setCreatedAt(LocalDateTime.now());
	        quiz.setUpdatedAt(LocalDateTime.now());
	    }

	    // [ìˆ˜ì •/ì¶”ê°€ ë¡œì§ ì‹œì‘]
	    for (QuizDto.QuestionDto q : quizDto.getQuestions()) {
	        QuizQuestion question = null;

	        // 1. ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ê¸°ì¡´ ì§ˆë¬¸ì´ ìˆëŠ”ì§€ IDë¡œ í™•ì¸
	        if (quizDto.getQuizId() != null && q.getQuestionId() != null) {
	            question = quiz.getQuestions().stream()
	                    .filter(existingQ -> existingQ.getQuestionId().equals(q.getQuestionId()))
	                    .findFirst()
	                    .orElse(null);
	        }

	        // 2. ê¸°ì¡´ ì§ˆë¬¸ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±, ìˆìœ¼ë©´ ê¸°ì¡´ ê°ì²´ ì‚¬ìš©
	        if (question == null) {
	            question = new QuizQuestion();
	            quiz.addQuestion(question); // ì‹ ê·œì¼ ë•Œë§Œ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
	        }

	        question.setQuestionText(q.getQuestionText());
	        question.setQuizTypeCode(q.getQuizTypeCode());
	        question.setPoint(q.getPoint());
	        question.setImage(q.getImage());

	        /* ===== ê°ê´€ì‹ ===== */
	        if (q.getQuizTypeCode() == 2) {
	            question.setAnswerOption(q.getAnswerOption());
	            question.setSubjectiveAnswer(null);

	            // ë³´ê¸°ëŠ” ê´€ê³„ê°€ ë³µì¡í•˜ë¯€ë¡œ ìˆ˜ì • ì‹œ ì¼ë‹¨ ë¹„ìš°ê³  ìƒˆë¡œ ë„£ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤ (addOption ì‚¬ìš©)
	            if (question.getOptions() != null) {
	                question.getOptions().clear();
	            }

	            if (q.getOptions() != null) {
	                for (QuizDto.OptionDto opt : q.getOptions()) {
	                    QuizOption option = new QuizOption();
	                    option.setOptionNumber(opt.getOptionNumber());
	                    option.setOptionText(opt.getOptionText());
	                    question.addOption(option);
	                }
	            }
	        /* ===== ì„œìˆ í˜• ===== */
	        } else {
	            question.setSubjectiveAnswer(q.getSubjectiveAnswer());
	            question.setAnswerOption(null);
	            if (question.getOptions() != null) {
	                question.getOptions().clear();
	            }
	        }
	    }

	    quizRepository.save(quiz);
	    return quiz.getQuizId();
	}

	public String storeImage(MultipartFile file) throws Exception {

		if (file == null || file.isEmpty()) {
			throw new Exception("Empty file");
		}

		String uploadDir = System.getProperty("user.dir") + "/uploads/quiz/";
		File dir = new File(uploadDir);
		if (!dir.exists())
			dir.mkdirs();

		String original = file.getOriginalFilename();
		String ext = original.substring(original.lastIndexOf("."));
		String fileName = UUID.randomUUID() + ext;

		File target = new File(uploadDir + fileName);
		file.transferTo(target);

		return fileName;
	}

	/* ================== ì¡°íšŒ ================== */
	public QuizDto findQuizDto(Long id) {
		Quiz quiz = quizRepository.findByIdWithQuestions(id)
				.orElseThrow(() -> new IllegalArgumentException("Quiz not found: " + id));
		return QuizDto.fromEntity(quiz);
	}

	public Quiz findById(Long id) {
		return quizRepository.findById(id).orElse(null);
	}

	public List<Quiz> findAll() {
		return quizRepository.findAll();
	}

	private Long getLoginUserId() {

		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();

		if (authentication == null || !authentication.isAuthenticated()
				|| authentication.getPrincipal().equals("anonymousUser")) {
			throw new IllegalStateException("ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ");
		}

		Object principal = authentication.getPrincipal();

		System.out.println("principal class = " + principal.getClass());

		String email = null;

		// 1ï¸âƒ£ ì¼ë°˜ ë¡œê·¸ì¸ (Form Login)
		if (principal instanceof UserDetails userDetails) {
			email = userDetails.getUsername();
		}

		// 2ï¸âƒ£ OAuth2 ë¡œê·¸ì¸
		else if (principal instanceof org.springframework.security.oauth2.core.user.OAuth2User oauthUser) {
			email = oauthUser.getAttribute("email");
		}

		// 3ï¸âƒ£ ì§„ì§œ ìµœí›„ì˜ ë³´ë£¨
		else if (principal instanceof String str) {
			email = str;
		}

		if (email == null) {
			throw new IllegalStateException("email ì¶”ì¶œ ì‹¤íŒ¨");
		}

		return userRepository.findByEmail(email).orElseThrow(() -> new IllegalStateException("ìœ ì € ì—†ìŒ")).getId();
	}

	public List<Quiz> findMyQuizzes() {
		Long userId = getLoginUserId();
		return quizRepository.findByUserIdOrderByCreatedAtDesc(userId);
	}

	@Transactional(readOnly = true)
	public QuizDto getQuizForPlay(Long quizId) {
		Quiz quiz = quizRepository.findByIdWithQuestions(quizId)
				.orElseThrow(() -> new IllegalArgumentException("Quiz not found: " + quizId));

		return QuizDto.fromEntity(quiz);
	}

}

",

129. QuizSubmitService.java="
package com.project.quiz.service;

import com.project.quiz.domain.*;
import com.project.quiz.dto.QuizSubmitRequest;
import com.project.quiz.repository.*;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
@Transactional
public class QuizSubmitService {

    private final QuizRepository quizRepository;
    private final QuizQuestionRepository quizQuestionRepository;
    private final QuizSubmissionRepository submissionRepository;
    private final QuizGradingService gradingService;
    
    @Transactional
    public Long submit(Long quizId, QuizSubmitRequest request) {

        Quiz quiz = quizRepository.findById(quizId)
                .orElseThrow(() -> new IllegalArgumentException("í€´ì¦ˆ ì—†ìŒ"));

        QuizSubmission submission = new QuizSubmission();
        submission.setQuiz(quiz);
        submission.setUserId(request.getUserId());
        submission.setGraded(false);

        /* answer ìƒì„± + ì—°ê²° */
        for (QuizSubmitRequest.AnswerRequest ar : request.getAnswers()) {

            QuizQuestion question = quizQuestionRepository.findById(ar.getQuestionId())
                    .orElseThrow(() -> new IllegalArgumentException("ë¬¸ì œ ì—†ìŒ"));

            QuizAnswer answer = new QuizAnswer();
            answer.setQuestion(question);
            answer.setAnswerText(ar.getAnswerText());
            answer.setSelectedOption(ar.getSelectedOption());

            submission.addAnswer(answer); // â­ í•µì‹¬
        }

        submissionRepository.save(submission);

        /* ìë™ ì±„ì  */
        gradingService.grade(submission.getSubmissionId());

        return submission.getSubmissionId();
    }

}

",

130. RoomQuizService.java="
package com.project.quiz.service;

import com.project.quiz.domain.Quiz;
import com.project.quiz.domain.RoomQuiz;
import com.project.quiz.repository.RoomQuizRepository;
import com.project.quiz.repository.QuizRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.Date;
import java.util.Optional;

@Service
public class RoomQuizService {

	@Autowired
	private RoomQuizRepository roomQuizRepository;

	@Autowired
	private QuizRepository quizRepository;

	/**
	 * ë°©ì— í€´ì¦ˆ ì¶”ê°€
	 */
	public RoomQuiz createRoomQuiz(Long roomId, Long quizId) {
		RoomQuiz roomQuiz = new RoomQuiz();
		roomQuiz.setRoomId(roomId);
		roomQuiz.setQuizId(quizId);
		roomQuiz.setAssignedAt(LocalDateTime.now());

		return roomQuizRepository.save(roomQuiz);
	}

	/**
	 * ë°©ì˜ ê°€ì¥ ìµœê·¼ í€´ì¦ˆ ì¡°íšŒ
	 */
	public Quiz getLatestQuizByRoom(Long roomId) {
		Optional<RoomQuiz> roomQuiz = roomQuizRepository.findFirstByRoomIdOrderByAssignedAtDesc(roomId);

		if (roomQuiz.isPresent()) {
			return quizRepository.findById(roomQuiz.get().getQuizId()).orElse(null);
		}

		return null;
	}

	// RoomQuizServiceì— ì´ ë©”ì„œë“œê°€ ìˆëŠ”ì§€ í™•ì¸ (ì—†ìœ¼ë©´ ì¶”ê°€)
	public Long getLatestQuizIdByRoom(Long roomId) {
		return roomQuizRepository.findFirstByRoomIdOrderByAssignedAtDesc(roomId).map(RoomQuiz::getQuizId).orElse(null);
	}

	// RoomQuizService.java
	@Transactional
	public void saveRoomQuiz(Long roomId, Long quizId) {
		RoomQuiz roomQuiz = RoomQuiz.builder().roomId(roomId).quizId(quizId).assignedAt(LocalDateTime.now()).build();
		roomQuizRepository.save(roomQuiz);
	}

	@Transactional
	public void deleteByRoomId(Long roomId) {
		roomQuizRepository.deleteByRoomId(roomId);
	}

}

",

131. RoomService.java="
package com.project.quiz.service;

import com.project.quiz.domain.Room;
import com.project.quiz.repository.RoomRepository;

import java.time.LocalDateTime;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class RoomService {
	@Autowired
	private RoomRepository roomRepository;

	@Transactional
	public Room createRoom(Long hostUserId, String statusCode) {
		// ê³ ìœ  room_code ì¤‘ë³µ ì²´í¬
		String roomCode;
		do {
			roomCode = Room.generateRoomCode();
		} while (roomRepository.existsByRoomCode(roomCode));

		Room room = Room.builder().createdAt(java.time.LocalDateTime.now()).hostUserId(hostUserId)
				.statusCode(statusCode).roomCode(roomCode).build();

		return roomRepository.save(room);
	}

	public Room getRoomByCode(String code) {
		return roomRepository.findByRoomCode(code).orElse(null);
	}

	@Transactional
	public void closeRoom(String roomCode) {
		Room room = roomRepository.findByRoomCode(roomCode)
				.orElseThrow(() -> new IllegalArgumentException("ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
		room.setStatusCode("CLOSED");
		room.setClosedAt(LocalDateTime.now());
	}
}

",

132. ShopService.java="
package com.project.quiz.service;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

import org.springframework.context.ApplicationEventPublisher;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.project.quiz.domain.ShopItem;
import com.project.quiz.domain.User;
import com.project.quiz.domain.UserInventory;
import com.project.quiz.dto.ItemPurchasedEvent;
import com.project.quiz.dto.ShopItemResponse;
import com.project.quiz.repository.ShopItemRepository;
import com.project.quiz.repository.UserInventoryRepository;
import com.project.quiz.repository.UserRepository;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class ShopService {

	private final PointService pointService;
    private final ShopItemRepository shopItemRepository;
    private final UserRepository userRepository;
    private final UserInventoryRepository userInventoryRepository;
    private final ApplicationEventPublisher eventPublisher;
    

    // 1. ìƒì  ëª©ë¡ ì¡°íšŒ
    public List<ShopItem> getAvailableItems() {
        return shopItemRepository.findByIsAvailableTrue();
    }

    // 2. ì•„ì´í…œ êµ¬ë§¤ ë¡œì§

    @Transactional
    public void buyItem(String email, Long itemId) {
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ì ì—†ìŒ"));
        ShopItem item = shopItemRepository.findById(itemId)
                .orElseThrow(() -> new IllegalArgumentException("ì•„ì´í…œ ì—†ìŒ"));
        
        String logDescription = user.getUserProfile().getUsername() + "ë‹˜ì´ ìƒì ì—ì„œ [" + item.getItemName() + "] ì•„ì´í…œì„ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤.";
        
        pointService.usePoint(user, item.getPrice(), logDescription);

        // ì¸ë²¤í† ë¦¬ ì§€ê¸‰ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ShopServiceê°€ ë‹´ë‹¹
        UserInventory inventory = UserInventory.builder()
                .user(user)
                .item(item)
                .purchasedAt(LocalDateTime.now())
                .build();
        
        userInventoryRepository.save(inventory);
        eventPublisher.publishEvent(new ItemPurchasedEvent(user));
    }
    
    
    
    @Transactional(readOnly = true)
    public List<ShopItemResponse> getAvailableItems(String email) {
        // 1. í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ì°¾ê¸°
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ì ì—†ìŒ"));

        // 2. ìƒì ì˜ ëª¨ë“  ì•„ì´í…œ ê°€ì ¸ì˜¤ê¸°
        List<ShopItem> allItems = shopItemRepository.findByIsAvailableTrue();

        // 3. [í•µì‹¬] ë‚´ê°€ ê°€ì§„ ì•„ì´í…œ IDë“¤ë§Œ ë½‘ì•„ì„œ Setìœ¼ë¡œ ë§Œë“¦ (ê²€ìƒ‰ ì†ë„ O(1)ë¡œ ìµœì í™”)
        // ì˜ˆ: [1, 5, 7]
        Set<Long> myInventoryItemIds = userInventoryRepository.findAllByUser(user)
                .stream()
                .map(inventory -> inventory.getItem().getId())
                .collect(Collectors.toSet());

        // 4. ì•„ì´í…œì„ DTOë¡œ ë³€í™˜í•˜ë©´ì„œ 'ë³´ìœ  ì—¬ë¶€(isOwned)' ì„¸íŒ…
        return allItems.stream()
                .map(item -> new ShopItemResponse(item, myInventoryItemIds.contains(item.getId())))
                .collect(Collectors.toList());
    }
}
",

133. TimelineService.java="
package com.project.quiz.service;

import java.util.List;
import java.util.stream.Collectors;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserActivityLog;
import com.project.quiz.dto.TimelineDto;
import com.project.quiz.repository.UserActivityLogRepository;
import com.project.quiz.repository.UserRepository;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class TimelineService {

    private final UserActivityLogRepository logRepository;
    private final UserRepository userRepository;
    // íƒ€ì„ë¼ì¸ì— í•„í„°ë§í•  ë‚´ìš©ë“¤, ë‹¤ë¥¸ ê¸°ëŠ¥ ì¶”ê°€ë˜ë©´ í•„í„°ë§ ì¶”ê°€í•„ìš”!
    private static final List<String> TARGET_ACTIVITIES = List.of("ATTENDANCE", "POINT_USE", "QUIZ", "UPDATE_NICKNAME", "ACHIEVEMENT");

    // 1. [í”„ë¡œí•„ìš©] ìµœì‹ ìˆœìœ¼ë¡œ ë”± 2ê°œë§Œ ê°€ì ¸ì˜¤ê¸°
    @Transactional(readOnly = true)
    public List<TimelineDto> getProfileTimeline(String email) {
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ì ì—†ìŒ"));
        
        PageRequest pageRequest = PageRequest.of(0, 2, Sort.by(Sort.Direction.DESC, "createdAt"));
        
        // [ìˆ˜ì •] í•„í„°ë§ ë©”ì„œë“œ í˜¸ì¶œ
        Page<UserActivityLog> page = logRepository.findAllByUserAndActivityTypeIn(user, TARGET_ACTIVITIES, pageRequest);
        
        return page.stream().map(TimelineDto::new).collect(Collectors.toList());
    }

    // 2. [íƒ€ì„ë¼ì¸ í˜ì´ì§€ìš©] í˜ì´ì§• ì²˜ë¦¬í•˜ì—¬ ê°€ì ¸ì˜¤ê¸° (ë¬´í•œ ìŠ¤í¬ë¡¤)
    @Transactional(readOnly = true)
    public List<TimelineDto> getTimelineByPage(String email, int page, int size) {
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ì ì—†ìŒ"));
        
        PageRequest pageRequest = PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, "createdAt"));
        
        // [ìˆ˜ì •] í•„í„°ë§ ë©”ì„œë“œ í˜¸ì¶œ
        Page<UserActivityLog> resultPage = logRepository.findAllByUserAndActivityTypeIn(user, TARGET_ACTIVITIES, pageRequest);

        return resultPage.stream().map(TimelineDto::new).collect(Collectors.toList());
    }
}
",

134. UserHardDeleteService.java="
package com.project.quiz.service;

import com.project.quiz.domain.User;
import com.project.quiz.repository.UserRepository;
import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Lazy;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Slf4j
@Service
@RequiredArgsConstructor
public class UserHardDeleteService {

    private final UserRepository userRepository;

    // âœ… JPA EntityManager: ë¦¬í¬ì§€í† ë¦¬ ì—†ì´ DBì— ì§ì ‘ ëª…ë ¹ì„ ë‚´ë¦¬ëŠ” ë„êµ¬
    @PersistenceContext
    private EntityManager entityManager;

    @Autowired
    @Lazy
    private UserHardDeleteService self;

    // Ghost ê³„ì • ID (DBì— ìˆëŠ” ê´€ë¦¬ì ID)
    private static final Long GHOST_USER_ID = 1L;

    public String executeHardDeleteProcess() {
        if (!userRepository.existsById(GHOST_USER_ID)) {
            return "âŒ ì‹¤íŒ¨: Ghost ê³„ì •(ID=" + GHOST_USER_ID + ")ì´ ì—†ìŠµë‹ˆë‹¤.";
        }

        List<User> deletedUsers = userRepository.findByStatus("deleted");
        if (deletedUsers.isEmpty()) {
            return "âœ… ì‚­ì œí•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.";
        }

        log.info("ğŸ§¹ ì´ {}ëª…ì˜ ìœ ì € ì •ë¦¬ ì‹œì‘...", deletedUsers.size());

        int success = 0;
        int fail = 0;

        for (User user : deletedUsers) {
            if (user.getId().equals(GHOST_USER_ID)) continue;

            try {
                self.deleteSingleUser(user);
                success++;
            } catch (Exception e) {
                log.error("âŒ ìœ ì € ID {} ì •ë¦¬ ì‹¤íŒ¨: {}", user.getId(), e.getMessage());
                fail++;
            }
        }

        return String.format("âœ… ì •ë¦¬ ì™„ë£Œ: ì„±ê³µ %dëª…, ì‹¤íŒ¨ %dëª…", success, fail);
    }

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void deleteSingleUser(User user) {
        Long targetId = user.getId();
        log.info("ğŸ—‘ï¸ ìœ ì € ID {} ({}) ì‚­ì œ ì‹œì‘", targetId, user.getEmail());

        // =========================================================
        // âœ… 1. ì½˜í…ì¸  ì†Œìœ ê¶Œ ì´ê´€ (ë¦¬í¬ì§€í† ë¦¬ X -> ì§ì ‘ SQL ì‚¬ìš©)
        // =========================================================
        // ê²Œì‹œê¸€, ëŒ“ê¸€, í€´ì¦ˆ, ë°©ì¥ ê¶Œí•œ ë“±ì„ Ghost ê³„ì •ìœ¼ë¡œ ë„˜ê¹ë‹ˆë‹¤.
        
        updateOwner("board_post", "user_id", targetId);       // ê²Œì‹œê¸€
        updateOwner("board_comment", "user_id", targetId);    // ëŒ“ê¸€
        updateOwner("quiz", "user_id", targetId);             // í€´ì¦ˆ
        updateOwner("quiz_submission", "user_id", targetId);  // í€´ì¦ˆ ì œì¶œ ê¸°ë¡
        updateOwner("room", "host_user_id", targetId);        // ë°©ì¥ ê¶Œí•œ

        // =========================================================
        // âœ… 2. ì°Œêº¼ê¸° ë°ì´í„° ê°•ì œ ì‚­ì œ (Native SQL)
        // =========================================================
        
        // (1) ì¹œêµ¬ ë©”ì‹œì§€ ì‚­ì œ (ì¡°ì¸ ì‚­ì œ)
        // "ì´ ìœ ì €ê°€ ë‚€ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ëŠ” ë‹¤ ì§€ì›Œë¼"
        entityManager.createNativeQuery(
            "DELETE fm FROM friend_message fm " +
            "JOIN friendship f ON fm.friendship_id = f.id " +
            "WHERE f.user_id = :uid OR f.friend_user_id = :uid")
            .setParameter("uid", targetId)
            .executeUpdate();

        // (2) ì¹œêµ¬ ê´€ê³„ ì‚­ì œ
        entityManager.createNativeQuery(
            "DELETE FROM friendship WHERE user_id = :uid OR friend_user_id = :uid")
            .setParameter("uid", targetId)
            .executeUpdate();

        // (3) ë‹¨ìˆœ ì¢…ì† í…Œì´ë¸” ì‚­ì œ
        deleteFromTable("user_inventory", "user_id", targetId);
        deleteFromTable("user_achievement", "user_id", targetId);
        deleteFromTable("notification_recipient", "user_id", targetId);
        deleteFromTable("participant", "user_id", targetId);

        // (4) í™œë™ ë¡œê·¸ ì‚­ì œ (ìì‹ -> ë¶€ëª¨ ìˆœì„œ)
        // ë¡œê·¸ì˜ ìì‹ë“¤(ì¶œì„, í¬ì¸íŠ¸) ë¨¼ì € ì‚­ì œ
        entityManager.createNativeQuery(
            "DELETE FROM user_activity_attendance WHERE activity_log_id IN (SELECT id FROM user_activity_log WHERE user_id = :uid)")
            .setParameter("uid", targetId).executeUpdate();
            
        entityManager.createNativeQuery(
            "DELETE FROM user_activity_point_change WHERE activity_log_id IN (SELECT id FROM user_activity_log WHERE user_id = :uid)")
            .setParameter("uid", targetId).executeUpdate();

        // ë¡œê·¸ ë³¸ì²´ ì‚­ì œ
        deleteFromTable("user_activity_log", "user_id", targetId);

        // =========================================================
        // âœ… 3. ìœ ì € ì™„ì „ ì‚­ì œ
        // =========================================================
        userRepository.delete(user);
        
        log.info("âœ¨ ìœ ì € ID {} ì‚­ì œ ì™„ë£Œ", targetId);
    }

    // [í—¬í¼ ë©”ì„œë“œ 1] ì†Œìœ ê¶Œ ì´ê´€ SQL ì‹¤í–‰ê¸°
    private void updateOwner(String tableName, String columnName, Long targetId) {
        String sql = String.format("UPDATE %s SET %s = :ghostId WHERE %s = :targetId", tableName, columnName, columnName);
        entityManager.createNativeQuery(sql)
                .setParameter("ghostId", GHOST_USER_ID)
                .setParameter("targetId", targetId)
                .executeUpdate();
    }

    // [í—¬í¼ ë©”ì„œë“œ 2] ë‹¨ìˆœ ì‚­ì œ SQL ì‹¤í–‰ê¸°
    private void deleteFromTable(String tableName, String columnName, Long userId) {
        String sql = String.format("DELETE FROM %s WHERE %s = :uid", tableName, columnName);
        entityManager.createNativeQuery(sql)
                .setParameter("uid", userId)
                .executeUpdate();
    }
}
",

135. UserSecurityService.java="
package com.project.quiz.service;

import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import com.project.quiz.domain.User;
import com.project.quiz.repository.UserRepository;

import lombok.RequiredArgsConstructor;

@RequiredArgsConstructor
@Service
public class UserSecurityService implements UserDetailsService {

    private final UserRepository userRepository;

    @Override
    public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException {
        // DBì—ì„œ ì´ë©”ì¼ë¡œ ì¡°íšŒ
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new UsernameNotFoundException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

        // UserDetails ê°ì²´ë¡œ ë°˜í™˜ (ê¶Œí•œ ë¡œì§ì€ í•„ìš”ì‹œ ì¶”ê°€)
        return org.springframework.security.core.userdetails.User.builder()
                .username(user.getEmail())
                .password(user.getPassword())
                .roles(user.getRole() != null ? user.getRole() : "USER") // ERDì˜ role ì»¬ëŸ¼ ì‚¬ìš©
                .build();
    }
}
",

136. UserService.java="
package com.project.quiz.service;

import java.time.Duration;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;
import java.util.Random;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;

import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import com.project.quiz.domain.User;
import com.project.quiz.domain.UserActivityLog;
import com.project.quiz.domain.UserProfile;
import com.project.quiz.repository.QuizGradingRepository;
import com.project.quiz.repository.UserActivityLogRepository;
import com.project.quiz.repository.UserProfileRepository;
import com.project.quiz.repository.UserRepository;

import lombok.RequiredArgsConstructor;

@RequiredArgsConstructor
@Service
public class UserService {

	private final UserRepository userRepository;
	private final UserProfileRepository userProfileRepository;
	private final QuizGradingRepository quizGradingRepository;
	private final PasswordEncoder passwordEncoder;
	private final EmailService emailService;
	private final FileStorageService fileStorageService;
	private final UserActivityLogRepository logRepository;

	public User create(String username, String email, String password) {
		User user = new User();
		user.setEmail(email);
		user.setPassword(passwordEncoder.encode(password));
		user.setRole("USER");
		user.setStatus("ACTIVE");
		user.setCreatedAt(LocalDateTime.now());

		// â–¼â–¼â–¼ í”„ë¡œí•„ ë³„ë„ ìƒì„± í›„ ì—°ê²° â–¼â–¼â–¼
		UserProfile profile = UserProfile.builder().username(username) // ë‹‰ë„¤ì„
				.build();

		user.setUserProfile(profile); // ì—°ê´€ê´€ê³„ ì„¤ì • (User ì €ì¥ ì‹œ Profileë„ ìë™ ì €ì¥ë¨)

		return userRepository.save(user);
	}

	public User findByEmail(String name) {
		return userRepository.findByEmail(name).orElse(null);
	}

	/*
	 * @Transactional // DB ë³€ê²½ì´ ì¼ì–´ë‚˜ë¯€ë¡œ íŠ¸ëœì­ì…˜ í•„ìˆ˜ public void updateProfile(String
	 * email, String newNickname, String newOrganization, String newBio) { // 1. ìœ ì €
	 * ì¡°íšŒ User user = userRepository.findByEmail(email) .orElseThrow(() -> new
	 * IllegalArgumentException("íšŒì›ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));
	 * 
	 * // 2. ì—°ê²°ëœ í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸° UserProfile profile = user.getUserProfile();
	 * 
	 * // 3. ê°’ ë³€ê²½ (Dirty Checkingì— ì˜í•´ ìë™ ì €ì¥ë¨) if(profile != null) {
	 * profile.setUsername(newNickname); profile.setOrganization(newOrganization);
	 * profile.setBio(newBio); } // (ë§Œì•½ profileì´ nullì¼ ê²½ìš°ëŠ” íšŒì›ê°€ì… ë¡œì§ìƒ ì—†ê² ì§€ë§Œ, í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì„œ
	 * ìƒì„± ë¡œì§ ì¶”ê°€ ê°€ëŠ¥) }
	 */

	// ì—¬ê¸°ì„œë¶€í„° ì´ë©”ì¼ ì¸ì¦
	private static class VerificationInfo {
		String code;
		LocalDateTime createAt;

		public VerificationInfo(String code) {
			this.code = code;
			this.createAt = LocalDateTime.now();
		}
	}

	private final Map<String, VerificationInfo> verificationCodes = new ConcurrentHashMap<>();

	public void sendVerificationCode(String email) {
		// 1. ìœ ì € ì¡´ì¬ ì—¬ë¶€ í™•ì¸
		User user = userRepository.findByEmail(email)
				.orElseThrow(() -> new IllegalArgumentException("ê°€ì…ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤."));

		// 2. ì†Œì…œ ë¡œê·¸ì¸ ìœ ì €ì¸ì§€ í™•ì¸ (ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ë¶ˆê°€)
		if (user.getProvider() != null) {
			throw new IllegalArgumentException("ì†Œì…œ ì—°ë™ ê³„ì •ì…ë‹ˆë‹¤. í•´ë‹¹ í”Œë«í¼ì—ì„œ ë¡œê·¸ì¸ì„ ì‹œë„í•´ì£¼ì„¸ìš”.");
		}

		// 3. ì¸ì¦ ë²ˆí˜¸ 6ìë¦¬ ìƒì„±
		String code = generateRandomCode();

		// 4. ì €ì¥ì†Œì— ì €ì¥ (ì´ë¯¸ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°)
		verificationCodes.put(email, new VerificationInfo(code));

		// 5. ì´ë©”ì¼ ë°œì†¡
		String subject = "[Quinect] ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ì¸ì¦ ì½”ë“œ";
		String text = "ì¸ì¦ ì½”ë“œ: " + code + "\n\nì´ ì½”ë“œë¥¼ ì…ë ¥í•˜ì—¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ì„¤ì •í•˜ì„¸ìš”.";
		emailService.sendEmail(email, subject, text);
	}

	// â–¼â–¼â–¼ [ì¶”ê°€] 2. ì¸ì¦ ë²ˆí˜¸ ê²€ì¦ ë©”ì„œë“œ â–¼â–¼â–¼
	public boolean verifyCode(String email, String code) {
		// 1. ë©”ëª¨ë¦¬ì— ì €ì¥ëœ ì¸ì¦ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
		VerificationInfo info = verificationCodes.get(email);

		// 2. ì¸ì¦ ë²ˆí˜¸ê°€ ì—†ê±°ë‚˜ í‹€ë¦¬ë©´ ì¦‰ì‹œ ì‹¤íŒ¨
		if (info == null || !info.code.equals(code)) {
			return false;
		}

		long secondsDiff = Duration.between(info.createAt, LocalDateTime.now()).getSeconds();
		if (secondsDiff > 180) {
			verificationCodes.remove(email); // ë§Œë£Œëœ ì½”ë“œ ì‚­ì œ
			return false; // ì‹œê°„ ì´ˆê³¼ë¡œ ì‹¤íŒ¨ ì²˜ë¦¬
		}
		// â–¼â–¼â–¼ [ì¶”ê°€ëœ ë¡œì§] DBì—ì„œ ìœ ì € ìƒíƒœ ì¬í™•ì¸ (Double Check) â–¼â–¼â–¼
		// ì¸ì¦ ë²ˆí˜¸ê°€ ë§ì•˜ë”ë¼ë„, ì‹¤ì œ ìœ ì €ê°€ ACTIVE ìƒíƒœì¸ì§€ í•œ ë²ˆ ë” ê²€ì‚¬í•©ë‹ˆë‹¤.
		User user = userRepository.findByEmail(email).orElse(null);

		if (user == null || !"ACTIVE".equals(user.getStatus())) {
			// ìœ ì €ê°€ ì—†ê±°ë‚˜, í™œë™ ì •ì§€(INACTIVE) ë“±ì˜ ìƒíƒœë¼ë©´ ì¸ì¦ ê±°ë¶€
			verificationCodes.remove(email); // ë³´ì•ˆìƒ ì¸ì¦ ì½”ë“œë„ íŒŒê¸°
			return false;
		}
		// â–²â–²â–² ì¶”ê°€ ë â–²â–²â–²

		// 3. ëª¨ë“  ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìœ¼ë¯€ë¡œ ì„±ê³µ ì²˜ë¦¬
		verificationCodes.remove(email); // ì¬ì‚¬ìš© ë°©ì§€ ì‚­ì œ
		return true;
	}

	// â–¼â–¼â–¼ [ì¶”ê°€] 3. ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë©”ì„œë“œ â–¼â–¼â–¼
	@Transactional
	public void updatePassword(String email, String newPassword) {
		User user = userRepository.findByEmail(email).orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤."));

		user.setPassword(passwordEncoder.encode(newPassword));
	}

	// (ë‚´ë¶€ìš©) 6ìë¦¬ ë‚œìˆ˜ ìƒì„±ê¸°
	private String generateRandomCode() {
		Random random = new Random();
		int code = 100000 + random.nextInt(900000); // 100000 ~ 999999
		return String.valueOf(code);
	}

	// í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ
	@Transactional
	public void updateProfile(String email, String nickname, String organization, String bio,
			MultipartFile profileImageFile, String defaultProfileImage) {

		User user = userRepository.findByEmail(email).orElseThrow(() -> new IllegalArgumentException("íšŒì›ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));
		UserProfile profile = user.getUserProfile();

		if (!profile.getUsername().equals(nickname)) {
			String logDesc = String.format("%së‹˜ì´ ë‹‰ë„¤ì„ì„ %s(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.", profile.getUsername(), nickname); // "í™ê¸¸ë™ë‹˜ì´ ë‹‰ë„¤ì„ì„
																											// ê³ ê¸¸ë™(ìœ¼)ë¡œ..."

			UserActivityLog log = UserActivityLog.builder().user(user).activityType("UPDATE_NICKNAME") // ìƒˆë¡œìš´ íƒ€ì…
					.description(logDesc).createdAt(LocalDateTime.now()).build();

			logRepository.save(log);
		}
		// 1. í…ìŠ¤íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
		profile.setUsername(nickname);
		profile.setOrganization(organization);
		profile.setBio(bio);

		// 2. ì´ë¯¸ì§€ ì²˜ë¦¬ ë¡œì§ (ìš°ì„ ìˆœìœ„: íŒŒì¼ ì—…ë¡œë“œ > ê¸°ë³¸ ì´ë¯¸ì§€ ì„ íƒ)
		if (profileImageFile != null && !profileImageFile.isEmpty()) {
			// (A) íŒŒì¼ì´ ì—…ë¡œë“œëœ ê²½ìš° -> íŒŒì¼ ì €ì¥ í›„ URL ì‚¬ìš©
			String imageUrl = fileStorageService.storeFile(profileImageFile);
			profile.setProfileImage(imageUrl);

		} else if (defaultProfileImage != null && !defaultProfileImage.isEmpty()) {
			// (B) íŒŒì¼ì€ ì—†ëŠ”ë° ê¸°ë³¸ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•œ ê²½ìš° -> í•´ë‹¹ ê²½ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
			// (ë³´ì•ˆìƒ /img/ ë¡œ ì‹œì‘í•˜ëŠ”ì§€ ì²´í¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ)
			if (defaultProfileImage.startsWith("/img/")) {
				profile.setProfileImage(defaultProfileImage);
			}
		}
		// (C) ë‘˜ ë‹¤ ì—†ìœ¼ë©´ -> ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€
	}

	public User getUserByEmail(String email) {
		return userRepository.findByEmail(email)
				.orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + email));
	}

	@Transactional
	public void withdraw(String email) {
		User user = userRepository.findByEmail(email)
				.orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

		user.setStatus("pending");
		user.setStatusChangedAt(LocalDateTime.now());
		// í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì„œ user.setRefreshToken(null) ë“± í† í° ì‚­ì œ ë¡œì§ ì¶”ê°€
	}

	/**
	 * ê³„ì • ë³µêµ¬ (Reactivate)
	 */
	@Transactional
	public void reactivate(String email) {
		User user = userRepository.findByEmail(email)
				.orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

		if ("pending".equals(user.getStatus())) {
			user.setStatus("ACTIVE"); // ëŒ€ë¬¸ìë¡œ í†µì¼ ê¶Œì¥ (ACTIVE)
			user.setStatusChangedAt(null);
		}
	}

	@Transactional
	public void cleanupWithdrawnUsers() {
		// 1. í˜„ì¬ ì‹œê°„ ê¸°ì¤€ 7ì¼ ì „
		// LocalDateTime sevenDaysAgo = LocalDateTime.now().minusMinutes(1); í…ŒìŠ¤íŠ¸ìš©
		LocalDateTime sevenDaysAgo = LocalDateTime.now().minusDays(7);

		// 2. ëŒ€ìƒ ì¡°íšŒ (pending ìƒíƒœ + 7ì¼ ê²½ê³¼)
		List<User> users = userRepository.findByStatusAndStatusChangedAtBefore("pending", sevenDaysAgo);

		for (User user : users) {
			// (1) ì´ë©”ì¼ ìµëª…í™” (Unique ì œì•½ì¡°ê±´ íšŒí”¼ë¥¼ ìœ„í•´ UUID ì‚¬ìš©)
			// ì˜ˆ: deleted_550e8400-e29b...@quinect.com
			String randomStr = UUID.randomUUID().toString().substring(0, 8);
			user.setEmail("deleted_" + user.getId() + "_" + randomStr + "@quinect.com");

			// (2) ì†Œì…œ ë¡œê·¸ì¸ ì •ë³´ íŒŒê¸°
			user.setProvider(null);
			user.setProviderId(null);
			user.setPassword(null); // í˜¹ì‹œ ëª¨ë¥¼ ë¹„ë²ˆ ì‚­ì œ

			// (3) í”„ë¡œí•„ ì •ë³´ ìµëª…í™”
			UserProfile profile = user.getUserProfile();
			if (profile != null) {
				profile.setUsername("(ì•Œ ìˆ˜ ì—†ìŒ)"); // ë‹‰ë„¤ì„ ë³€ê²½
				profile.setBio(null); // ìê¸°ì†Œê°œ ì‚­ì œ
				profile.setOrganization(null); // ì†Œì† ì‚­ì œ
				profile.setProfileImage(null); // í”„ì‚¬ ì‚­ì œ (ê¸°ë³¸ì´ë¯¸ì§€ë¡œ)
				// í¬ì¸íŠ¸ëŠ” ë‚¨ê¸¸ì§€ ë§ì§€ ì„ íƒ (ë³´í†µì€ 0ìœ¼ë¡œ ì´ˆê¸°í™”)
				// profile.setPointBalance(0L);
			}

			// (4) ìƒíƒœ ë³€ê²½ (ìµœì¢… ì‚­ì œ ì²˜ë¦¬)
			user.setStatus("deleted");
			user.setStatusChangedAt(LocalDateTime.now());
		}
	}

	@Transactional
	public List<UserProfile> getTopUsersByPointBalance() {
		return userProfileRepository.findTopByPointBalance();
	}

	/**
	 * í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ìì˜ ì •ë‹µ/ì˜¤ë‹µ ê°œìˆ˜
	 */
	@Transactional(readOnly = true)
	public Map<String, Long> getUserAnswerStats(Long userId) {
		long correctCount = quizGradingRepository.countByUserIdAndIsCorrectTrue(userId);
		long wrongCount = quizGradingRepository.countByUserIdAndIsCorrectFalse(userId);

		return Map.of("correct", correctCount, "wrong", wrongCount);
	}

}
",

137. VoteManager.java="
package com.project.quiz.service;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.*;

import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Service;

import com.project.quiz.dto.VoteResponse;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@RequiredArgsConstructor
public class VoteManager {

	// WebSocketìœ¼ë¡œ ë©”ì‹œì§€ ë³´ë‚´ê¸° ìœ„í•œ í…œí”Œë¦¿
	private final SimpMessagingTemplate messagingTemplate;

	// ë°© ì½”ë“œë³„ë¡œ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ íˆ¬í‘œ ì„¸ì…˜ í•˜ë‚˜ì”© ê´€ë¦¬
	// key: roomCode, value: ê·¸ ë°©ì˜ í˜„ì¬ íˆ¬í‘œ ì •ë³´
	private final ConcurrentHashMap<String, VoteSession> activeVotes = new ConcurrentHashMap<>();

	// íˆ¬í‘œ ì¢…ë£Œë¥¼ ìœ„í•œ íƒ€ì´ë¨¸ ìŠ¤ë ˆë“œí’€
	private final ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(4);

	/**
	 * íˆ¬í‘œ ì‹œì‘ (ë°©ì¥ì´ ì‹œì‘ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ í˜¸ì¶œ)
	 */
	public void startVote(String roomCode, Long voteId, String question, String description, String creator,
			int durationSeconds) {

		// ë°©ë§ˆë‹¤ í•˜ë‚˜ì˜ ì„¸ì…˜ë§Œ ìœ ì§€ (ê¸°ì¡´ íˆ¬í‘œ ìˆìœ¼ë©´ ë®ì–´ì”€)
		VoteSession session = new VoteSession(voteId, question, description, creator);
		activeVotes.put(roomCode, session);

		log.info("íˆ¬í‘œ ì‹œì‘: roomCode={}, question={}, duration={}s", roomCode, question, durationSeconds);

		// durationSeconds í›„ ìë™ ì¢…ë£Œ
		ScheduledFuture<?> timer = scheduler.schedule(() -> endVote(roomCode), durationSeconds, TimeUnit.SECONDS);
		session.setTimer(timer);
	}

	/**
	 * ëˆ„êµ°ê°€ ì°¬ì„±/ë°˜ëŒ€ë¥¼ ëˆŒë €ì„ ë•Œ í˜¸ì¶œ
	 */
	public void submitVote(String roomCode, Long voteId, String voter, String choice) {

		VoteSession session = activeVotes.get(roomCode);
		if (session == null) {
			log.warn("ì§„í–‰ ì¤‘ì¸ íˆ¬í‘œê°€ ì—†ëŠ” ë°©ì…ë‹ˆë‹¤. roomCode={}", roomCode);
			return;
		}
		if (!session.getVoteId().equals(voteId)) {
			log.warn("íˆ¬í‘œ IDê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. roomCode={}, voteId={}", roomCode, voteId);
			return;
		}

		String oldChoice = session.getVotes().get(voter);
		if (oldChoice != null) {
			log.info("íˆ¬í‘œ ë³€ê²½: voter={}, oldChoice={}, newChoice={}", voter, oldChoice, choice);
		}

		// íˆ¬í‘œ ë°˜ì˜
		session.addVote(voter, choice);

		// í˜„ì¬ ê²°ê³¼ ê³„ì‚°
		Map<String, Integer> results = session.getCurrentResults();
		log.info("í˜„ì¬ íˆ¬í‘œ ê²°ê³¼: roomCode={}, results={}", roomCode, results);

		// ì‹¤ì‹œê°„ ê²°ê³¼ë¥¼ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ WebSocketìœ¼ë¡œ ì „ì†¡
		VoteResponse response = VoteResponse.builder().type("UPDATE").voteId(voteId).results(results).build();

		messagingTemplate.convertAndSend("/topic/vote/" + roomCode, response);
	}

	/**
	 * íƒ€ì´ë¨¸ì— ì˜í•´ ë˜ëŠ” ìˆ˜ë™ìœ¼ë¡œ íˆ¬í‘œ ì¢…ë£Œ
	 */
	public void endVote(String roomCode) {
		VoteSession session = activeVotes.remove(roomCode);
		if (session == null) {
			return;
		}

		// íƒ€ì´ë¨¸ ì·¨ì†Œ
		ScheduledFuture<?> timer = session.getTimer();
		if (timer != null && !timer.isDone()) {
			timer.cancel(true);
		}

		Map<String, Integer> finalResults = session.getCurrentResults();
		int agree = finalResults.getOrDefault("AGREE", 0);
		int disagree = finalResults.getOrDefault("DISAGREE", 0);
		int total = agree + disagree;

		// 1) í´ë¼ì´ì–¸íŠ¸ ìª½ íˆ¬í‘œ UI ì •ë¦¬ë¥¼ ìœ„í•œ END ë©”ì‹œì§€
		VoteResponse endResponse = VoteResponse.builder().type("END").voteId(session.getVoteId()).results(finalResults)
				.build();
		messagingTemplate.convertAndSend("/topic/vote/" + roomCode, endResponse);

		// 2) ì±„íŒ…ì°½ì— ìµœì¢… ê²°ê³¼ë¥¼ í•œ ì¤„ë¡œ ì¶œë ¥
		VoteResultChatMessage chatMsg = new VoteResultChatMessage(session.getQuestion(), agree, disagree, total);
		messagingTemplate.convertAndSend("/topic/chat/" + roomCode, chatMsg);

		log.info("íˆ¬í‘œ ì¢…ë£Œ: roomCode={}, question={}, results={}", roomCode, session.getQuestion(), finalResults);
	}

	/**
	 * ë°©ì´ ì™„ì „íˆ ë‹«í ë•Œ í˜¸ì¶œí•˜ë©´ ê¹”ë”í•˜ê²Œ ì •ë¦¬ ê°€ëŠ¥ (ì„ íƒ)
	 */
	public void clearRoom(String roomCode) {
		endVote(roomCode);
	}

	// ================= ë‚´ë¶€ í´ë˜ìŠ¤ë“¤ =================

	/**
	 * í•œ ë°©ì—ì„œ ì§„í–‰ ì¤‘ì¸ íˆ¬í‘œ 1ê°œì— ëŒ€í•œ ìƒíƒœ
	 */
	private static class VoteSession {
		private final Long voteId;
		private final String question;
		// ëˆ„ê°€ ì–´ë–¤ ì„ íƒì„ í–ˆëŠ”ì§€ (voter -> choice)
		private final ConcurrentHashMap<String, String> votes = new ConcurrentHashMap<>();
		// íˆ¬í‘œ ì¢…ë£Œ ì˜ˆì•½ íƒ€ì´ë¨¸
		private ScheduledFuture<?> timer;

		VoteSession(Long voteId, String question, String description, String creator) {
			this.voteId = voteId;
			this.question = question;
		}

		Long getVoteId() {
			return voteId;
		}

		String getQuestion() {
			return question;
		}

		ScheduledFuture<?> getTimer() {
			return timer;
		}

		void setTimer(ScheduledFuture<?> timer) {
			this.timer = timer;
		}

		ConcurrentHashMap<String, String> getVotes() {
			return votes;
		}

		void addVote(String voter, String choice) {
			votes.put(voter, choice);
		}

		Map<String, Integer> getCurrentResults() {
			Map<String, Integer> result = new HashMap<>();
			result.put("AGREE", 0);
			result.put("DISAGREE", 0);

			for (String choice : votes.values()) {
				if ("AGREE".equals(choice)) {
					result.put("AGREE", result.get("AGREE") + 1);
				} else if ("DISAGREE".equals(choice)) {
					result.put("DISAGREE", result.get("DISAGREE") + 1);
				}
			}
			return result;
		}
	}

	/**
	 * ì±„íŒ…ì°½ì— ë¿Œë¦´ ìµœì¢… ê²°ê³¼ìš© ë©”ì‹œì§€ DTO (ê¸°ì¡´ ì±„íŒ…ê³¼ ë™ì¼í•˜ê²Œ sender, contentë§Œ ì“°ë©´ ë¨)
	 */
	public static class VoteResultChatMessage {
		public String sender = "íˆ¬í‘œ ì‹œìŠ¤í…œ";
		public String content;

		public VoteResultChatMessage(String question, int agree, int disagree, int total) {
			double agreePercent = total > 0 ? (agree * 100.0 / total) : 0.0;
			double disagreePercent = total > 0 ? (disagree * 100.0 / total) : 0.0;

			this.content = String.format("[íˆ¬í‘œ ì¢…ë£Œ]\n%s\nì°¬ì„±: %dëª… (%.1f%%), ë°˜ëŒ€: %dëª… (%.1f%%), ì´ %dëª… ì°¸ì—¬", question, agree,
					agreePercent, disagree, disagreePercent, total);
		}
	}
}

",

138. UserCleanupScheduler.java="
package com.project.quiz;

import com.project.quiz.service.UserService;
import lombok.RequiredArgsConstructor;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
public class UserCleanupScheduler {

    private final UserService userService;

    // ë§¤ì¼ ìì •(0ì´ˆ 0ë¶„ 0ì‹œ)ì— ì‹¤í–‰
    //@Scheduled(cron = "0/30 * * * * *") í…ŒìŠ¤íŠ¸ìš©
    @Scheduled(cron = "0 0 0 * * *")
    public void runCleanup() {
        System.out.println("ğŸ§¹ [Scheduler] íƒˆí‡´ ìœ ì € ë°ì´í„° ìµëª…í™” ì‘ì—… ì‹œì‘...");
        userService.cleanupWithdrawnUsers();
        System.out.println("âœ¨ [Scheduler] ì‘ì—… ì™„ë£Œ.");
    }
}
",

